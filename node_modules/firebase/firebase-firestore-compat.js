<<<<<<< HEAD
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(gg,mg){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(gg);function n(t){const n=[];let r=0;for(let s=0;s<t.length;s++){let e=t.charCodeAt(s);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++s)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const s=[];for(let h=0;h<n.length;h+=3){var i=n[h],a=h+1<n.length,o=a?n[h+1]:0,u=h+2<n.length,c=u?n[h+2]:0;let e=(15&o)<<2|c>>6,t=63&c;u||(t=64,a||(e=64)),s.push(r[i>>2],r[(3&i)<<4|o>>4],r[e],r[t])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var s,i,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(s=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&s)):239<a&&a<365?(i=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(i>>10)),t[r++]=String.fromCharCode(56320+(1023&i))):(s=e[n++],i=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&s)<<6|63&i))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let u=0;u<e.length;){var s=n[e.charAt(u++)],i=u<e.length?n[e.charAt(u)]:0;++u;var a=u<e.length?n[e.charAt(u)]:64;++u;var o=u<e.length?n[e.charAt(u)]:64;if(++u,null==s||null==i||null==a||null==o)throw Error();r.push(s<<2|i>>4),64!==a&&(r.push(i<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},a=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};const s=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,i=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return r.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},o=()=>{try{return s()||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||i()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function c(){return!function(){var e=null===(e=o())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class h extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,h.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,d.prototype.create)}}class d{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},s=`${this.service}/${e}`,i=this.errors[e],i=i?(r=n,i.replace(f,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",i=`${this.serviceName}: ${i} (${s}).`;return new h(s,i,n)}}const f=/\{\$([^}]+)}/g;function m(e){return e&&e._delegate?e._delegate:e}class g{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(gd=l=l||{})[gd.DEBUG=0]="DEBUG",gd[gd.VERBOSE=1]="VERBOSE",gd[gd.INFO=2]="INFO",gd[gd.WARN=3]="WARN",gd[gd.ERROR=4]="ERROR",gd[gd.SILENT=5]="SILENT";const p={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},y=l.INFO,v={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},w=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=v[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var I,b="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},E={},T=b||self;function _(){}function S(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function x(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var D="closure_uid_"+(1e9*Math.random()>>>0),A=0;function C(e,t,n){return e.call.apply(e.bind,arguments)}function N(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function k(e,t,n){return(k=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?C:N).apply(null,arguments)}function R(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function L(e,i){function t(){}t.prototype=i.prototype,e.X=i.prototype,e.prototype=new t,(e.prototype.constructor=e).Wb=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function M(){this.s=this.s,this.o=this.o}M.prototype.s=!1,M.prototype.na=function(){var e;!this.s&&(this.s=!0,this.M(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,D)&&e[D]||(e[D]=++A))},M.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const F=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function O(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function V(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(S(n)){var r=t.length||0,s=n.length||0;t.length=r+s;for(let e=0;e<s;e++)t[r+e]=n[e]}else t.push(n)}}function P(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}P.prototype.h=function(){this.defaultPrevented=!0};var q=function(){if(!T.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{T.addEventListener("test",_,t),T.removeEventListener("test",_,t)}catch(e){}return e}();function B(e){return/^[\s\xa0]*$/.test(e)}var U=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function G(e,t){return e<t?-1:t<e?1:0}function K(){var e=T.navigator;return(e=e&&e.userAgent)?e:""}function j(e){return-1!=K().indexOf(e)}function $(e){return $[" "](e),e}$[" "]=_;var Q,z=j("Opera"),W=j("Trident")||j("MSIE"),H=j("Edge"),Y=H||W,X=j("Gecko")&&!(-1!=K().toLowerCase().indexOf("webkit")&&!j("Edge"))&&!(j("Trident")||j("MSIE"))&&!j("Edge"),J=-1!=K().toLowerCase().indexOf("webkit")&&!j("Edge");function Z(){var e=T.document;return e?e.documentMode:void 0}e:{var ee="",te=(te=K(),X?/rv:([^\);]+)(\)|;)/.exec(te):H?/Edge\/([\d\.]+)/.exec(te):W?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(te):J?/WebKit\/(\S+)/.exec(te):z?/(?:Version)[ \/]?(\S+)/.exec(te):void 0);if(te&&(ee=te?te[1]:""),W){te=Z();if(null!=te&&te>parseFloat(ee)){Q=String(te);break e}}Q=ee}var ne={};function re(){return e=function(){let e=0;var t=U(String(Q)).split("."),n=U("9").split("."),r=Math.max(t.length,n.length);for(let a=0;0==e&&a<r;a++)for(var s=t[a]||"",i=n[a]||"";s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],(0!=s[0].length||0!=i[0].length)&&(e=G(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||G(0==s[2].length,0==i[2].length)||G(s[2],i[2]),s=s[3],i=i[3],0==e););return 0<=e},t=ne,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=e(9);var e,t}var se=T.document&&W&&(Z()||parseInt(Q,10))||void 0;function ie(e,t){if(P.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(X){e:{try{$(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:ae[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&ie.X.h.call(this)}}L(ie,P);var ae={2:"touch",3:"pen",4:"mouse"};ie.prototype.h=function(){ie.X.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var oe="closure_listenable_"+(1e6*Math.random()|0),ue=0;function ce(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=s,this.key=++ue,this.ba=this.ea=!1}function he(e){e.ba=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function le(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function de(e){const t={};for(const n in e)t[n]=e[n];return t}const fe="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ge(t){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s])t[n]=r[n];for(let e=0;e<fe.length;e++)n=fe[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function me(e){this.src=e,this.g={},this.h=0}function pe(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=F(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(he(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function ye(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.ba&&i.listener==t&&i.capture==!!n&&i.ha==r)return s}return-1}me.prototype.add=function(e,t,n,r,s){var i=e.toString();(e=this.g[i])||(e=this.g[i]=[],this.h++);var a=ye(e,t,r,s);return-1<a?(t=e[a],n||(t.ea=!1)):((t=new ce(t,this.src,i,!!r,s)).ea=n,e.push(t)),t};var ve="closure_lm_"+(1e6*Math.random()|0),we={};function Ie(e,t,n,r,s){if(r&&r.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}r=De(r);return t&&t[oe]?t.O(n,r,x(s)?!!s.capture:!!s,i):be(t,n,r,!0,s,i)}(e,t,n,r,s);if(Array.isArray(t)){for(var i=0;i<t.length;i++)Ie(e,t[i],n,r,s);return null}return n=De(n),e&&e[oe]?e.N(t,n,x(r)?!!r.capture:!!r,s):be(e,t,n,!1,r,s)}function be(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var a=x(s)?!!s.capture:!!s,o=Se(e);if(o||(e[ve]=o=new me(e)),(n=o.add(t,n,r,a,i)).proxy)return n;if(r=function(){const n=_e;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=!q?a:s)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(Te(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Ee(e){var t,n,r;"number"!=typeof e&&e&&!e.ba&&((t=e.src)&&t[oe]?pe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Te(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Se(t))?(pe(n,e),0==n.h&&(n.src=null,t[ve]=null)):he(e)))}function Te(e){return e in we?we[e]:we[e]="on"+e}function _e(e,t){var n,r;return e=!!e.ba||(t=new ie(t,this),n=e.listener,r=e.ha||e.src,e.ea&&Ee(e),n.call(r,t))}function Se(e){return(e=e[ve])instanceof me?e:null}var xe="__closure_events_fn_"+(1e9*Math.random()>>>0);function De(t){return"function"==typeof t?t:(t[xe]||(t[xe]=function(e){return t.handleEvent(e)}),t[xe])}function Ae(){M.call(this),this.i=new me(this),(this.P=this).I=null}function Ce(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t?t=new P(t,e):t instanceof P?t.target=t.target||e:(a=t,ge(t=new P(r,e),a)),a=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],a=Ne(i,r,!0,t)&&a;if(a=Ne(i=t.g=e,r,!0,t)&&a,a=Ne(i,r,!1,t)&&a,n)for(s=0;s<n.length;s++)a=Ne(i=t.g=n[s],r,!1,t)&&a}function Ne(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var a,o,u=t[i];u&&!u.ba&&u.capture==n&&(a=u.listener,o=u.ha||u.src,u.ea&&pe(e.i,u),s=!1!==a.call(o,r)&&s)}return s&&!r.defaultPrevented}L(Ae,M),Ae.prototype[oe]=!0,Ae.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);else s=x(s)?!!s.capture:!!s,r=De(r),t&&t[oe]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=ye(a=t.g[n],r,s,i))&&(he(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&Se(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?ye(n,r,s,i):t)?n[t]:null)&&Ee(r))}(this,e,t,n,r)},Ae.prototype.M=function(){if(Ae.X.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)he(n[r]);delete t.g[e],t.h--}}this.I=null},Ae.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Ae.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var ke=T.JSON.stringify;var Re,Le=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Me,e=>e.reset());class Me{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function Fe(e,t){var n;Re||(n=T.Promise.resolve(void 0),Re=function(){n.then(Pe)}),Oe||(Re(),Oe=!0),Ve.add(e,t)}var Oe=!1,Ve=new class{constructor(){this.h=this.g=null}add(e,t){const n=Le.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function Pe(){for(var e;e=function(){var e=Ve;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){T.setTimeout(()=>{throw e},0)}(e)}var t=Le;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Oe=!1}function qe(e,t){Ae.call(this),this.h=e||1,this.g=t||T,this.j=k(this.lb,this),this.l=Date.now()}function Be(e){e.ca=!1,e.R&&(e.g.clearTimeout(e.R),e.R=null)}function Ue(e,t,n){if("function"==typeof e)n&&(e=k(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=k(e.handleEvent,e)}return 2147483647<Number(t)?-1:T.setTimeout(e,t||0)}L(qe,Ae),(I=qe.prototype).ca=!1,I.R=null,I.lb=function(){var e;this.ca&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-e):(this.R&&(this.g.clearTimeout(this.R),this.R=null),Ce(this,"tick"),this.ca&&(Be(this),this.start())))},I.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},I.M=function(){qe.X.M.call(this),Be(this),delete this.g};class Ge extends M{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Ue(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}M(){super.M(),this.g&&(T.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ke(e){M.call(this),this.h=e,this.g={}}L(Ke,M);var je=[];function $e(e,t,n,r){Array.isArray(n)||(n&&(je[0]=n.toString()),n=je);for(var s=0;s<n.length;s++){var i=Ie(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function Qe(e){le(e.g,function(e,t){this.g.hasOwnProperty(t)&&Ee(e)},e),e.g={}}function ze(){this.g=!0}function We(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var a=1;a<s.length;a++)s[a]=""}}}return ke(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Ke.prototype.M=function(){Ke.X.M.call(this),Qe(this)},Ke.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ze.prototype.Aa=function(){this.g=!1},ze.prototype.info=function(){};var He={},Ye=null;function Xe(){return Ye=Ye||new Ae}function Je(e){P.call(this,He.Pa,e)}function Ze(){var e=Xe();Ce(e,new Je(e))}function et(e,t){P.call(this,He.STAT_EVENT,e),this.stat=t}function tt(e){var t=Xe();Ce(t,new et(t,e))}function nt(e,t){P.call(this,He.Qa,e),this.size=t}function rt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return T.setTimeout(function(){e()},t)}He.Pa="serverreachability",L(Je,P),He.STAT_EVENT="statevent",L(et,P),He.Qa="timingevent",L(nt,P);var st={NO_ERROR:0,mb:1,zb:2,yb:3,tb:4,xb:5,Ab:6,Ma:7,TIMEOUT:8,Db:9},it={rb:"complete",Nb:"success",Na:"error",Ma:"abort",Fb:"ready",Gb:"readystatechange",TIMEOUT:"timeout",Bb:"incrementaldata",Eb:"progress",ub:"downloadprogress",Vb:"uploadprogress"};function at(){}function ot(e){return e.h||(e.h=e.i())}function ut(){}at.prototype.h=null;b={OPEN:"a",qb:"b",Na:"c",Cb:"d"};function ct(){P.call(this,"d")}function ht(){P.call(this,"c")}function lt(){}function dt(e,t,n,r){this.l=e,this.j=t,this.m=n,this.U=r||1,this.S=new Ke(this),this.O=mt,this.T=new qe(e=Y?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new ft}function ft(){this.i=null,this.g="",this.h=!1}L(ct,P),L(ht,P),L(lt,at),lt.prototype.g=function(){return new XMLHttpRequest},lt.prototype.i=function(){return{}};var gt=new lt,mt=45e3,pt={},yt={};function vt(e,t,n){e.K=1,e.v=Ot(kt(t)),e.s=n,e.P=!0,wt(e,null)}function wt(e,t){e.F=Date.now(),Et(e),e.A=kt(e.v);var a,o,u,c,h,l,n=e.A,r=e.U;Array.isArray(r)||(r=[String(r)]),Ht(n.i,"t",r),e.C=0,n=e.l.H,e.h=new ft,e.g=Hn(e.l,n?t:null,!e.s),0<e.N&&(e.L=new Ge(k(e.La,e,e.g),e.N)),$e(e.S,e.g,"readystatechange",e.ib),t=e.H?de(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.da(e.A,e.u,e.s,t)):(e.u="GET",e.g.da(e.A,e.u,null,t)),Ze(),a=e.j,o=e.u,u=e.A,c=e.m,h=e.U,l=e.s,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function It(e){return e.g&&("GET"==e.u&&2!=e.K&&e.l.Da)}function bt(e,t,n){let r=!0,s;for(;!e.I&&e.C<n.length;){if(s=(a=n,u=o=void 0,o=(i=e).C,-1==(u=a.indexOf("\n",o))?yt:(o=Number(a.substring(o,u)),isNaN(o)?pt:(u+=1)+o>a.length?yt:(a=a.substr(u,o),i.C=u+o,a))),s==yt){4==t&&(e.o=4,tt(14),r=!1),We(e.j,e.m,null,"[Incomplete Response]");break}if(s==pt){e.o=4,tt(15),We(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}We(e.j,e.m,s,null),Dt(e,s)}var i,a,o,u;It(e)&&s!=yt&&s!=pt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,tt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.$&&(e.$=!0,(t=e.l).g==e&&t.$&&!t.K&&(t.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),Un(t),t.K=!0,tt(11))):(We(e.j,e.m,n,"[Invalid Chunked Response]"),xt(e),St(e))}function Et(e){e.V=Date.now()+e.O,Tt(e,e.O)}function Tt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=rt(k(e.gb,e),t)}function _t(e){e.B&&(T.clearTimeout(e.B),e.B=null)}function St(e){0==e.l.G||e.I||jn(e.l,e)}function xt(e){_t(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,Be(e.T),Qe(e.S),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function Dt(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||nn(n.h,e)))if(!e.J&&nn(n.h,e)&&3==n.G){try{var r=n.Fa.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;Kn(n),Ln(n)}Bn(n),tt(18)}}else n.Ba=s[1],0<n.Ba-n.T&&s[2]<37500&&n.L&&0==n.A&&!n.v&&(n.v=rt(k(n.cb,n),6e3));if(tn(n.h)<=1&&n.ja){try{n.ja()}catch(e){}n.ja=void 0}}else Qn(n,11)}else if(!e.J&&n.g!=e||Kn(n),!B(t))for(s=n.Fa.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.T=i[0],i=i[1],2==n.G)if("c"==i[0]){n.I=i[1],n.ka=i[2];var a=i[3];null!=a&&(n.ma=a,n.j.info("VER="+n.ma));var o=i[4];null!=o&&(n.Ca=o,n.j.info("SVER="+n.Ca));var u,c,h=i[5];null!=h&&"number"==typeof h&&0<h&&(r=1.5*h,n.J=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const g=e.g;if(g){const m=g.g?g.g.getResponseHeader("X-Client-Wire-Protocol"):null;m&&((u=r.h).g||-1==m.indexOf("spdy")&&-1==m.indexOf("quic")&&-1==m.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(rn(u,u.h),u.h=null))),!r.D||(c=g.g?g.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.za=c,Ft(r.F,r.D,c))}n.G=3,n.l&&n.l.xa(),n.$&&(n.P=Date.now()-e.F,n.j.info("Handshake RTT: "+n.P+"ms"));var l,d,f=e;(r=n).sa=Wn(r,r.H?r.ka:null,r.V),f.J?(sn(r.h,f),l=f,(d=r.J)&&l.setTimeout(d),l.B&&(_t(l),Et(l)),r.g=f):qn(r),0<n.i.length&&Fn(n)}else"stop"!=i[0]&&"close"!=i[0]||Qn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Qn(n,7):Rn(n):"noop"!=i[0]&&n.l&&n.l.wa(i),n.A=0)}Ze()}catch(e){}}function At(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(S(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.oa&&"function"==typeof e.oa)return e.oa();if(!e.W||"function"!=typeof e.W){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(S(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.W&&"function"==typeof e.W)return e.W();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(S(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),s=r.length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}(I=dt.prototype).setTimeout=function(e){this.O=e},I.ib=function(e){e=e.target;const t=this.L;t&&3==xn(e)?t.l():this.La(e)},I.La=function(e){try{if(e==this.g)e:{var t=xn(this.g),n=this.g.Ea();this.g.aa();if(!(t<3)&&(3!=t||Y||this.g&&(this.h.h||this.g.fa()||Dn(this.g)))){this.I||4!=t||7==n||Ze(),_t(this);var r=this.g.aa();this.Y=r;t:if(It(this)){var s=Dn(this.g);e="";var i=s.length,a=4==xn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){xt(this),St(this);var o="";break t}this.h.i=new T.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:a&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.fa();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.U,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.Z&&!this.J){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!B(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.o=3,tt(12),xt(this),St(this);break e}We(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Dt(this,r)}this.P?(bt(this,t,o),Y&&this.i&&3==t&&($e(this.S,this.T,"tick",this.hb),this.T.start())):(We(this.j,this.m,o,null),Dt(this,o)),4==t&&xt(this),this.i&&!this.I&&(4==t?jn(this.l,this):(this.i=!1,Et(this)))}else 400==r&&0<o.indexOf("Unknown SID")?(this.o=3,tt(12)):(this.o=0,tt(13)),xt(this),St(this)}}}catch(e){}var l,d,f,g,m,p,y},I.hb=function(){var e,t;this.g&&(e=xn(this.g),t=this.g.fa(),this.C<t.length&&(_t(this),bt(this,e,t),this.i&&4!=e&&Et(this)))},I.cancel=function(){this.I=!0,xt(this)},I.gb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.V?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.K&&(Ze(),tt(17)),xt(this),this.o=2,St(this)):Tt(this,this.V-n)};var Ct=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Nt(e,t){var n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof Nt?(this.h=void 0!==t?t:e.h,Rt(this,e.j),this.s=e.s,this.g=e.g,Lt(this,e.m),this.l=e.l,t=e.i,(n=new $t).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Mt(this,n),this.o=e.o):e&&(n=String(e).match(Ct))?(this.h=!!t,Rt(this,n[1]||"",!0),this.s=Vt(n[2]||""),this.g=Vt(n[3]||"",!0),Lt(this,n[4]),this.l=Vt(n[5]||"",!0),Mt(this,n[6]||"",!0),this.o=Vt(n[7]||"")):(this.h=!!t,this.i=new $t(null,this.h))}function kt(e){return new Nt(e)}function Rt(e,t,n){e.j=n?Vt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Lt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Mt(e,t,n){var r,s;t instanceof $t?(e.i=t,r=e.i,(s=e.h)&&!r.j&&(Qt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(zt(this,t),Ht(this,n,e))},r)),r.j=s):(n||(t=Pt(t,Kt)),e.i=new $t(t,e.h))}function Ft(e,t,n){e.i.set(t,n)}function Ot(e){return Ft(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Vt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Pt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,qt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function qt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Nt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Pt(t,Bt,!0),":");var n=this.g;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Pt(t,Bt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Pt(n,"/"==n.charAt(0)?Gt:Ut,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Pt(n,jt)),e.join("")};var Bt=/[#\/\?@]/g,Ut=/[#\?:]/g,Gt=/[#\?]/g,Kt=/[#\?@]/g,jt=/#/g;function $t(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Qt(n){n.g||(n.g=new Map,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,s=e[n].indexOf("="),i=null;0<=s?(r=e[n].substring(0,s),i=e[n].substring(s+1)):r=e[n],t(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function zt(e,t){Qt(e),t=Yt(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function Wt(e,t){return Qt(e),t=Yt(e,t),e.g.has(t)}function Ht(e,t,n){zt(e,t),0<n.length&&(e.i=null,e.g.set(Yt(e,t),O(n)),e.h+=n.length)}function Yt(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(I=$t.prototype).add=function(e,t){Qt(this),this.i=null,e=Yt(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},I.forEach=function(n,r){Qt(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},I.oa=function(){Qt(this);const t=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let i=0;i<n.length;i++){var s=t[i];for(let e=0;e<s.length;e++)r.push(n[i])}return r},I.W=function(t){Qt(this);let n=[];if("string"==typeof t)Wt(this,t)&&(n=n.concat(this.g.get(Yt(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},I.set=function(e,t){return Qt(this),this.i=null,Wt(this,e=Yt(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},I.get=function(e,t){return e&&0<(e=this.W(e)).length?String(e[0]):t},I.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),i=this.W(r),r=0;r<i.length;r++){var a=s;""!==i[r]&&(a+="="+encodeURIComponent(String(i[r]))),e.push(a)}return this.i=e.join("&")};var Xt=class{constructor(e,t){this.h=e,this.g=t}};function Jt(e){this.l=e||10,e=T.PerformanceNavigationTiming?0<(e=T.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(T.g&&T.g.Ga&&T.g.Ga()&&T.g.Ga().$b),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var Zt;function en(e){return e.h||e.g&&e.g.size>=e.j}function tn(e){return e.h?1:e.g?e.g.size:0}function nn(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function rn(e,t){e.g?e.g.add(t):e.h=t}function sn(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function an(t){if(null!=t.h)return t.i.concat(t.h.D);if(null==t.g||0===t.g.size)return O(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}}function on(){}function un(){this.g=new on}function cn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function hn(e){this.l=e.ac||null,this.j=e.jb||!1}function ln(e,t){Ae.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=dn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}Jt.prototype.cancel=function(){if(this.i=an(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},on.prototype.stringify=function(e){return T.JSON.stringify(e,void 0)},on.prototype.parse=function(e){return T.JSON.parse(e,void 0)},L(hn,at),hn.prototype.g=function(){return new ln(this.l,this.j)},hn.prototype.i=(Zt={},function(){return Zt}),L(ln,Ae);var dn=0;function fn(e){e.j.read().then(e.Ta.bind(e)).catch(e.ga.bind(e))}function gn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,mn(e)}function mn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(I=ln.prototype).open=function(e,t){if(this.readyState!=dn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,mn(this)},I.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||T).fetch(new Request(this.B,t)).then(this.Wa.bind(this),this.ga.bind(this))},I.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,gn(this)),this.readyState=dn},I.Wa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,mn(this)),this.g&&(this.readyState=3,mn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ua.bind(this),this.ga.bind(this));else if(void 0!==T.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;fn(this)}else e.text().then(this.Va.bind(this),this.ga.bind(this))},I.Ta=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?gn:mn)(this),3==this.readyState&&fn(this))},I.Va=function(e){this.g&&(this.response=this.responseText=e,gn(this))},I.Ua=function(e){this.g&&(this.response=e,gn(this))},I.ga=function(){this.g&&gn(this)},I.setRequestHeader=function(e,t){this.v.append(e,t)},I.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},I.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(ln.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var pn=T.JSON.parse;function yn(e){Ae.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=vn,this.K=this.L=!1}L(yn,Ae);var vn="",wn=/^https?$/i,In=["POST","PUT"];function bn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,En(e),_n(e)}function En(e){e.D||(e.D=!0,Ce(e,"complete"),Ce(e,"error"))}function Tn(e){if(e.h&&void 0!==E&&(!e.C[1]||4!=xn(e)||2!=e.aa()))if(e.v&&4==xn(e))Ue(e.Ha,0,e);else if(Ce(e,"readystatechange"),4==xn(e)){e.h=!1;try{var t,n,r,s,i=e.aa();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break e;default:a=!1}if((t=a)||((n=0===i)&&(!(s=String(e.H).match(Ct)[1]||null)&&T.self&&T.self.location&&(s=(r=T.self.location.protocol).substr(0,r.length-1)),n=!wn.test(s?s.toLowerCase():"")),t=n),t)Ce(e,"complete"),Ce(e,"success");else{e.m=6;try{var o=2<xn(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.aa()+"]",En(e)}}finally{_n(e)}}}function _n(e,t){if(e.g){Sn(e);const n=e.g,r=e.C[0]?_:null;e.g=null,e.C=null,t||Ce(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Sn(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(T.clearTimeout(e.A),e.A=null)}function xn(e){return e.g?e.g.readyState:0}function Dn(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case vn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function An(e){let n="";return le(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}function Cn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=An(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Ft(e,t,n))}function Nn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function kn(e){this.Ca=0,this.i=[],this.j=new ze,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.ab=this.U=0,this.Za=Nn("failFast",!1,e),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Xa=Nn("baseRetryDelayMs",5e3,e),this.bb=Nn("retryDelaySeedMs",1e4,e),this.$a=Nn("forwardChannelMaxRetries",2,e),this.ta=Nn("forwardChannelRequestTimeoutMs",2e4,e),this.ra=e&&e.xmlHttpFactory||void 0,this.Da=e&&e.Zb||!1,this.J=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.I="",this.h=new Jt(e&&e.concurrentRequestLimit),this.Fa=new un,this.O=e&&e.fastHandshake||!1,this.N=e&&e.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Ya=e&&e.Xb||!1,e&&e.Aa&&this.j.Aa(),e&&e.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&e&&e.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function Rn(e){var t,n;Mn(e),3==e.G&&(t=e.U++,Ft(n=kt(e.F),"SID",e.I),Ft(n,"RID",t),Ft(n,"TYPE","terminate"),Vn(e,n),(t=new dt(e,e.j,t,void 0)).K=2,t.v=Ot(kt(n)),n=!1,!(n=T.navigator&&T.navigator.sendBeacon?T.navigator.sendBeacon(t.v.toString(),""):n)&&T.Image&&((new Image).src=t.v,n=!0),n||(t.g=Hn(t.l,null),t.g.da(t.v)),t.F=Date.now(),Et(t)),zn(e)}function Ln(e){e.g&&(Un(e),e.g.cancel(),e.g=null)}function Mn(e){Ln(e),e.u&&(T.clearTimeout(e.u),e.u=null),Kn(e),e.h.cancel(),e.m&&("number"==typeof e.m&&T.clearTimeout(e.m),e.m=null)}function Fn(e){en(e.h)||e.m||(e.m=!0,Fe(e.Ja,e),e.C=0)}function On(e,t){var n=t?t.m:e.U++,r=kt(e.F);Ft(r,"SID",e.I),Ft(r,"RID",n),Ft(r,"AID",e.T),Vn(e,r),e.o&&e.s&&Cn(r,e.o,e.s),n=new dt(e,e.j,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.i=t.D.concat(e.i)),t=Pn(e,n,1e3),n.setTimeout(Math.round(.5*e.ta)+Math.round(.5*e.ta*Math.random())),rn(e.h,n),vt(n,r,t)}function Vn(e,n){e.ia&&le(e.ia,function(e,t){Ft(n,t,e)}),e.l&&At({},function(e,t){Ft(n,t,e)})}function Pn(e,t,r){r=Math.min(e.i.length,r);var s=e.l?k(e.l.Ra,e.l,e):null;e:{var i=e.i;let n=-1;for(;;){const u=["count="+r];-1==n?0<r?(n=i[0].h,u.push("ofs="+n)):n=0:u.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=i[t].h,o=i[t].g;if((a-=n)<0)n=Math.max(0,i[t].h-100),e=!1;else try{!function(e,r,t){const s=t||"";try{At(e,function(e,t){let n=e;x(e)&&(n=ke(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+a+"_")}catch(e){s&&s(o)}}if(e){s=u.join("&");break e}}}return e=e.i.splice(0,r),t.D=e,s}function qn(e){e.g||e.u||(e.Z=1,Fe(e.Ia,e),e.A=0)}function Bn(e){return!(e.g||e.u||3<=e.A)&&(e.Z++,e.u=rt(k(e.Ia,e),$n(e,e.A)),e.A++,1)}function Un(e){null!=e.B&&(T.clearTimeout(e.B),e.B=null)}function Gn(e){e.g=new dt(e,e.j,"rpc",e.Z),null===e.o&&(e.g.H=e.s),e.g.N=0;var t=kt(e.sa);Ft(t,"RID","rpc"),Ft(t,"SID",e.I),Ft(t,"CI",e.L?"0":"1"),Ft(t,"AID",e.T),Ft(t,"TYPE","xmlhttp"),Vn(e,t),e.o&&e.s&&Cn(t,e.o,e.s),e.J&&e.g.setTimeout(e.J);var n=e.g;e=e.ka,n.K=1,n.v=Ot(kt(t)),n.s=null,n.P=!0,wt(n,e)}function Kn(e){null!=e.v&&(T.clearTimeout(e.v),e.v=null)}function jn(e,t){var n,r,s,i=null;if(e.g==t){Kn(e),Un(e),e.g=null;var a=2}else{if(!nn(e.h,t))return;i=t.D,sn(e.h,t),a=1}if(0!=e.G)if(e.pa=t.Y,t.i)1==a?(i=t.s?t.s.length:0,t=Date.now()-t.F,n=e.C,Ce(a=Xe(),new nt(a,i)),Fn(e)):qn(e);else if(3==(n=t.o)||0==n&&0<e.pa||(1!=a||(s=t,tn((r=e).h)>=r.h.j-(r.m?1:0)||(r.m?(r.i=s.D.concat(r.i),0):1==r.G||2==r.G||r.C>=(r.Za?0:r.$a)||(r.m=rt(k(r.Ja,r,s),$n(r,r.C)),r.C++,0))))&&(2!=a||!Bn(e)))switch(i&&0<i.length&&(t=e.h,t.i=t.i.concat(i)),n){case 1:Qn(e,5);break;case 4:Qn(e,10);break;case 3:Qn(e,6);break;default:Qn(e,2)}}function $n(e,t){let n=e.Xa+Math.floor(Math.random()*e.bb);return e.l||(n*=2),n*t}function Qn(e,t){var n,r;e.j.info("Error code "+t),2==t?(n=null,e.l&&(n=null),r=k(e.kb,e),n||(n=new Nt("//www.google.com/images/cleardot.gif"),T.location&&"http"==T.location.protocol||Rt(n,"https"),Ot(n)),function(e,t){var n=new ze;if(T.Image){const r=new Image;r.onload=R(cn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=R(cn,n,r,"TestLoadImage: error",!1,t),r.onabort=R(cn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=R(cn,n,r,"TestLoadImage: timeout",!1,t),T.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):tt(2),e.G=0,e.l&&e.l.va(t),zn(e),Mn(e)}function zn(e){var t;e.G=0,e.la=[],e.l&&(0==(t=an(e.h)).length&&0==e.i.length||(V(e.la,t),V(e.la,e.i),e.h.i.length=0,O(e.i),e.i.length=0),e.l.ua())}function Wn(e,t,n){var r,s,i=n instanceof Nt?kt(n):new Nt(n,void 0);return""!=i.g?(t&&(i.g=t+"."+i.g),Lt(i,i.m)):(i=(r=T.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,s=new Nt(null,void 0),i&&Rt(s,i),t&&(s.g=t),r&&Lt(s,r),n&&(s.l=n),i=s),n=e.D,t=e.za,n&&t&&Ft(i,n,t),Ft(i,"VER",e.ma),Vn(e,i),i}function Hn(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Da&&!e.ra?new yn(new hn({jb:!0})):new yn(e.ra)).Ka(e.H),t}function Yn(){}function Xn(){if(W&&!(10<=Number(se)))throw Error("Environmental error: no available transport.")}function Jn(e,t){Ae.call(this),this.g=new kn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.S=e,(e=t&&t.Yb)&&!B(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!B(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new tr(this)}function Zn(e){ct.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function er(){ht.call(this),this.status=1}function tr(e){this.g=e}(I=yn.prototype).Ka=function(e){this.L=e},I.da=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||gt).g(),this.C=this.u?ot(this.u):ot(gt),this.g.onreadystatechange=k(this.Ha,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void bn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),s=T.FormData&&e instanceof T.FormData,0<=F(In,t)&&!r&&!s&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[i,a]of n)this.g.setRequestHeader(i,a);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Sn(this),0<this.B&&((this.K=(o=this.g,W&&re()&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=k(this.qa,this)):this.A=Ue(this.qa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){bn(this,e)}var o},I.qa=function(){void 0!==E&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Ce(this,"timeout"),this.abort(8))},I.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Ce(this,"complete"),Ce(this,"abort"),_n(this))},I.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),_n(this,!0)),yn.X.M.call(this)},I.Ha=function(){this.s||(this.F||this.v||this.l?Tn(this):this.fb())},I.fb=function(){Tn(this)},I.aa=function(){try{return 2<xn(this)?this.g.status:-1}catch(e){return-1}},I.fa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},I.Sa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),pn(t)}},I.Ea=function(){return this.m},I.Oa=function(){return"string"==typeof this.j?this.j:String(this.j)},(I=kn.prototype).ma=8,I.G=1,I.Ja=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.U=Math.floor(1e5*Math.random()),t=this.U++;const i=new dt(this,this.j,t,void 0);let e=this.s;if(this.S&&(e?(e=de(e),ge(e,this.S)):e=this.S),null!==this.o||this.N||(i.H=e,e=null),this.O)e:{for(var n=0,r=0;r<this.i.length;r++){var s=this.i[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.i.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Pn(this,i,n),Ft(r=kt(this.F),"RID",t),Ft(r,"CVER",22),this.D&&Ft(r,"X-HTTP-Session-Id",this.D),Vn(this,r),e&&(this.N?n="headers="+encodeURIComponent(String(An(e)))+"&"+n:this.o&&Cn(r,this.o,e)),rn(this.h,i),this.Ya&&Ft(r,"TYPE","init"),this.O?(Ft(r,"$req",n),Ft(r,"SID","null"),i.Z=!0,vt(i,r,null)):vt(i,r,n),this.G=2}}else 3==this.G&&(t?On(this,t):0==this.i.length||en(this.h)||On(this))},I.Ia=function(){var e;this.u=null,Gn(this),this.$&&!(this.K||null==this.g||this.P<=0)&&(e=2*this.P,this.j.info("BP detection timer enabled: "+e),this.B=rt(k(this.eb,this),e))},I.eb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,tt(10),Ln(this),Gn(this))},I.cb=function(){null!=this.v&&(this.v=null,Ln(this),Bn(this),tt(19))},I.kb=function(e){e?(this.j.info("Successfully pinged google.com"),tt(2)):(this.j.info("Failed to ping google.com"),tt(1))},(I=Yn.prototype).xa=function(){},I.wa=function(){},I.va=function(){},I.ua=function(){},I.Ra=function(){},Xn.prototype.g=function(e,t){return new Jn(e,t)},L(Jn,Ae),Jn.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;tt(0),e.V=t,e.ia=n||{},e.L=e.Y,e.F=Wn(e,null,e.V),Fn(e)},Jn.prototype.close=function(){Rn(this.g)},Jn.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=ke(e),e=t),n.i.push(new Xt(n.ab++,e)),3==n.G&&Fn(n)},Jn.prototype.M=function(){this.g.l=null,delete this.j,Rn(this.g),delete this.g,Jn.X.M.call(this)},L(Zn,ct),L(er,ht),L(tr,Yn),tr.prototype.xa=function(){Ce(this.g,"a")},tr.prototype.wa=function(e){Ce(this.g,new Zn(e))},tr.prototype.va=function(e){Ce(this.g,new er)},tr.prototype.ua=function(){Ce(this.g,"b")},Xn.prototype.createWebChannel=Xn.prototype.g,Jn.prototype.send=Jn.prototype.u,Jn.prototype.open=Jn.prototype.m,st.NO_ERROR=0,st.TIMEOUT=8,st.HTTP_ERROR=6,it.COMPLETE="complete",(ut.EventType=b).OPEN="a",b.CLOSE="b",b.ERROR="c",b.MESSAGE="d",Ae.prototype.listen=Ae.prototype.N,yn.prototype.listenOnce=yn.prototype.O,yn.prototype.getLastError=yn.prototype.Oa,yn.prototype.getLastErrorCode=yn.prototype.Ea,yn.prototype.getStatus=yn.prototype.aa,yn.prototype.getResponseJson=yn.prototype.Sa,yn.prototype.getResponseText=yn.prototype.fa,yn.prototype.send=yn.prototype.da,yn.prototype.setWithCredentials=yn.prototype.Ka;var nr,rr=Xe,sr=st,ir=it,ar=He,or=10,ur=11,cr=hn,hr=ut,lr=yn;const dr="@firebase/firestore";class fr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}fr.UNAUTHENTICATED=new fr(null),fr.GOOGLE_CREDENTIALS=new fr("google-credentials-uid"),fr.FIRST_PARTY=new fr("first-party-uid"),fr.MOCK_USER=new fr("mock-user");let gr="9.16.0";const mr=new class{constructor(e){this.name=e,this._logLevel=y,this._logHandler=w,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?p[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function pr(){return mr.logLevel}function yr(e,...t){var n;mr.logLevel<=l.DEBUG&&(n=t.map(Ir),mr.debug(`Firestore (${gr}): ${e}`,...n))}function vr(e,...t){var n;mr.logLevel<=l.ERROR&&(n=t.map(Ir),mr.error(`Firestore (${gr}): ${e}`,...n))}function wr(e,...t){var n;mr.logLevel<=l.WARN&&(n=t.map(Ir),mr.warn(`Firestore (${gr}): ${e}`,...n))}function Ir(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function br(e="Unexpected state"){var t=`FIRESTORE (${gr}) INTERNAL ASSERTION FAILED: `+e;throw vr(t),new Error(t)}function Er(e){e||br()}const Tr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class _r extends h{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Sr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class xr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Dr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(fr.UNAUTHENTICATED))}shutdown(){}}class Ar{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Cr{constructor(e){this.t=e,this.currentUser=fr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new Sr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Sr,t.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},o=e=>{yr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(yr("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Sr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(yr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Er("string"==typeof e.accessToken),new xr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Er(null===e||"string"==typeof e),new fr(e)}}class Nr{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r,this.type="FirstParty",this.user=fr.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(Er(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);var e=this.I();return e&&this.p.set("Authorization",e),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class kr{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r}getToken(){return Promise.resolve(new Nr(this.h,this.l,this.m,this.g))}start(e,t){e.enqueueRetryable(()=>t(fr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Rr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Lr{constructor(e){this.T=e,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(t,n){const r=e=>{null!=e.error&&yr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.A;return this.A=e.token,yr("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const s=e=>{yr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.T.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.T.getImmediate({optional:!0}))?s(e):yr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Er("string"==typeof e.token),this.A=e.token,new Rr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Mr{static R(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function Fr(e,t){return e<t?-1:t<e?1:0}function Or(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function Vr(e){return e+"\0"}class Pr{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new _r(Tr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new _r(Tr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new _r(Tr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new _r(Tr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Pr.fromMillis(Date.now())}static fromDate(e){return Pr.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Pr(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Fr(this.nanoseconds,e.nanoseconds):Fr(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class qr{constructor(e){this.timestamp=e}static fromTimestamp(e){return new qr(e)}static min(){return new qr(new Pr(0,0))}static max(){return new qr(new Pr(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Br{constructor(e,t,n){void 0===t?t=0:t>e.length&&br(),void 0===n?n=e.length-t:n>e.length-t&&br(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Br.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Br?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Ur extends Br{construct(e,t,n){return new Ur(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new _r(Tr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new Ur(t)}static emptyPath(){return new Ur([])}}const Gr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Kr extends Br{construct(e,t,n){return new Kr(e,t,n)}static isValidIdentifier(e){return Gr.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!Kr.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Kr(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new _r(Tr.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new _r(Tr.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new _r(Tr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new _r(Tr.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Kr(t)}static emptyPath(){return new Kr([])}}class jr{constructor(e){this.path=e}static fromPath(e){return new jr(Ur.fromString(e))}static fromName(e){return new jr(Ur.fromString(e).popFirst(5))}static empty(){return new jr(Ur.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Ur.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Ur.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new jr(new Ur(e.slice()))}}class $r{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Qr(e){return e.fields.find(e=>2===e.kind)}function zr(e){return e.fields.filter(e=>2!==e.kind)}$r.UNKNOWN_ID=-1;class Wr{constructor(e,t){this.fieldPath=e,this.kind=t}}class Hr{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Hr(0,Jr.min())}}function Yr(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,r=qr.fromTimestamp(1e9===r?new Pr(n+1,0):new Pr(n,r));return new Jr(r,jr.empty(),t)}function Xr(e){return new Jr(e.readTime,e.key,-1)}class Jr{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Jr(qr.min(),jr.empty(),-1)}static max(){return new Jr(qr.max(),jr.empty(),-1)}}function Zr(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=jr.comparator(e.documentKey,t.documentKey),0!==n?n:Fr(e.largestBatchId,t.largestBatchId))}const es="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ts{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function ns(e){if(e.code!==Tr.FAILED_PRECONDITION||e.message!==es)throw e;yr("LocalStore","Unexpectedly lost primary lease")}class rs{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&br(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new rs((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof rs?t:rs.resolve(t)}catch(e){return rs.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):rs.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):rs.reject(t)}static resolve(n){return new rs((e,t)=>{e(n)})}static reject(n){return new rs((e,t)=>{t(n)})}static waitFor(e){return new rs((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=rs.resolve(!1);for(const n of e)t=t.next(e=>e?rs.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new rs((t,n)=>{const r=o.length,s=new Array(r);let i=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{s[a]=e,++i,i===r&&t(s)},e=>n(e))}})}static doWhile(r,s){return new rs((e,t)=>{const n=()=>{!0===r()?s().next(()=>{n()},t):e()};n()})}}class ss{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.P=new Sr,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{e.error?this.P.reject(new os(n,e.error)):this.P.resolve()},this.transaction.onerror=e=>{var t=ds(e.target.error);this.P.reject(new os(n,t))}}static open(e,t,n,r){try{return new ss(t,e.transaction(r,n))}catch(e){throw new os(t,e)}}get v(){return this.P.promise}abort(e){e&&this.P.reject(e),this.aborted||(yr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new cs(t)}}class is{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===is.D(u())&&vr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return yr("SimpleDb","Removing database:",e),hs(window.indexedDB.deleteDatabase(e)).toPromise()}static C(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(is.N())return!0;const e=u(),t=is.D(e),n=0<t&&t<10,r=is.k(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static N(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.O)}static M(e,t){return e.store(t)}static D(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(i){return this.db||(yr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{var t=e.target.result;n(t)},s.onblocked=()=>{r(new os(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new _r(Tr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new _r(Tr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new os(i,t))},s.onupgradeneeded=e=>{yr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.S.$(t,s.transaction,e.oldVersion,this.version).next(()=>{yr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.F(e);const t=ss.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.V(),e)).catch(e=>(t.abort(e),rs.reject(e))).toPromise();return i.catch(()=>{}),await t.v,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(yr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class as{constructor(e){this.q=e,this.U=!1,this.K=null}get isDone(){return this.U}get G(){return this.K}set cursor(e){this.q=e}done(){this.U=!0}j(e){this.K=e}delete(){return hs(this.q.delete())}}class os extends _r{constructor(e,t){super(Tr.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function us(e){return"IndexedDbTransactionError"===e.name}class cs{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(yr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(yr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),hs(n)}add(e){return yr("SimpleDb","ADD",this.store.name,e,e),hs(this.store.add(e))}get(t){return hs(this.store.get(t)).next(e=>(yr("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return yr("SimpleDb","DELETE",this.store.name,e),hs(this.store.delete(e))}count(){return yr("SimpleDb","COUNT",this.store.name),hs(this.store.count())}W(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.H(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new rs((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}J(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new rs((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}Y(e,t){yr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.X=!1;var r=this.cursor(n);return this.H(r,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.H(r,t)}tt(s){const e=this.cursor({});return new rs((n,r)=>{e.onerror=e=>{var t=ds(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?s(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}H(e,i){const a=[];return new rs((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new as(t),r=i(t.primaryKey,t.value,n);if(r instanceof rs){const e=r.catch(e=>(n.done(),rs.reject(e)));a.push(e)}n.isDone?s():null===n.G?t.continue():t.continue(n.G)}else s()}}).next(()=>rs.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function hs(e){return new rs((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=ds(e.target.error);r(t)}})}let ls=!1;function ds(e){const t=is.D(u());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new _r("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ls||(ls=!0,setTimeout(()=>{throw e},0)),e}}return e}class fs{constructor(e,t){this.asyncQueue=e,this.et=t,this.task=null}start(){this.nt(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(e){yr("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{yr("IndexBackiller",`Documents written: ${await this.et.st()}`)}catch(e){us(e)?yr("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await ns(e)}await this.nt(6e4)})}}class gs{constructor(e,t){this.localStore=e,this.persistence=t}async st(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.it(e,t))}it(e,t){const n=new Set;let r=t,s=!0;return rs.doWhile(()=>!0===s&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(s=!1):(yr("IndexBackiller",`Processing collection: ${t}`),this.rt(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}rt(r,s,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,s).next(n=>this.localStore.localDocuments.getNextDocuments(r,s,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.ot(n,e)).next(e=>(yr("IndexBackiller",`Updating offset: ${e}`),this.localStore.indexManager.updateCollectionGroup(r,s,e))).next(()=>t.size)}))}ot(e,t){let r=e;return t.changes.forEach((e,t)=>{var n=Xr(t);0<Zr(n,r)&&(r=n)}),new Jr(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ms{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ut(e),this.ct=e=>t.writeSequenceNumber(e))}ut(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.ct&&this.ct(e),e}}ms.at=-1;class ps{constructor(e,t,n,r,s,i,a,o){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=a,this.useFetchStreams=o}}class ys{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new ys("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof ys&&e.projectId===this.projectId&&e.database===this.database}}function vs(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function ws(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Is(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function bs(e){return null==e}function Es(e){return 0===e&&1/e==-1/0}function Ts(e){return"number"==typeof e&&Number.isInteger(e)&&!Es(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}class _s{constructor(e){this.binaryString=e}static fromBase64String(e){var t=atob(e);return new _s(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new _s(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Fr(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}_s.EMPTY_BYTE_STRING=new _s("");const Ss=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function xs(t){if(Er(!!t),"string"!=typeof t)return{seconds:Ds(t.seconds),nanos:Ds(t.nanos)};{let e=0;var n=Ss.exec(t);Er(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function Ds(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function As(e){return"string"==typeof e?_s.fromBase64String(e):_s.fromUint8Array(e)}function Cs(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function Ns(e){var t=xs(e.mapValue.fields.__local_write_time__.timestampValue);return new Pr(t.seconds,t.nanos)}const ks={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Rs={nullValue:"NULL_VALUE"};function Ls(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Cs(e)?4:Qs(e)?9007199254740991:10:br()}function Ms(r,s){if(r===s)return!0;var e,t,n=Ls(r);if(n!==Ls(s))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===s.booleanValue;case 4:return Ns(r).isEqual(Ns(s));case 3:return function(e){if("string"==typeof r.timestampValue&&"string"==typeof e.timestampValue&&r.timestampValue.length===e.timestampValue.length)return r.timestampValue===e.timestampValue;var t=xs(r.timestampValue),n=xs(e.timestampValue);return t.seconds===n.seconds&&t.nanos===n.nanos}(s);case 5:return r.stringValue===s.stringValue;case 6:return t=s,As(r.bytesValue).isEqual(As(t.bytesValue));case 7:return r.referenceValue===s.referenceValue;case 8:return e=s,Ds((t=r).geoPointValue.latitude)===Ds(e.geoPointValue.latitude)&&Ds(t.geoPointValue.longitude)===Ds(e.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Ds(e.integerValue)===Ds(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Ds(e.doubleValue),r=Ds(t.doubleValue);return n===r?Es(n)===Es(r):isNaN(n)&&isNaN(r)}return!1}(r,s);case 9:return Or(r.arrayValue.values||[],s.arrayValue.values||[],Ms);case 10:return function(e){const t=e.mapValue.fields||{},n=s.mapValue.fields||{};if(vs(t)!==vs(n))return!1;for(const e in t)if(t.hasOwnProperty(e)&&(void 0===n[e]||!Ms(t[e],n[e])))return!1;return!0}(r);default:return br()}}function Fs(e,t){return void 0!==(e.values||[]).find(e=>Ms(e,t))}function Os(e,t){if(e===t)return 0;var n,r,s,i,a=Ls(e),o=Ls(t);if(a!==o)return Fr(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return Fr(e.booleanValue,t.booleanValue);case 2:return r=t,s=Ds(e.integerValue||e.doubleValue),i=Ds(r.integerValue||r.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return Vs(e.timestampValue,t.timestampValue);case 4:return Vs(Ns(e),Ns(t));case 5:return Fr(e.stringValue,t.stringValue);case 6:return function(e,t){const n=As(e),r=As(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=Fr(n[s],r[s]);if(0!==t)return t}return Fr(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(i=Fr(Ds(n.latitude),Ds(r.latitude)))?i:Fr(Ds(n.longitude),Ds(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=Os(n[s],r[s]);if(t)return t}return Fr(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===ks.mapValue&&t===ks.mapValue)return 0;if(e===ks.mapValue)return 1;if(t===ks.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=Fr(r[o],i[o]);if(0!==t)return t;var a=Os(n[r[o]],s[i[o]]);if(0!==a)return a}return Fr(r.length,i.length)}(e.mapValue,t.mapValue);default:throw br()}}function Vs(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Fr(e,t);var n=xs(e),r=xs(t),s=Fr(n.seconds,r.seconds);return 0!==s?s:Fr(n.nanos,r.nanos)}function Ps(e){return function i(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=xs(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?As(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,jr.fromName(t).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=i(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${i(e.fields[s])}`;return n+"}"}(e.mapValue):br();var t}(e)}function qs(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Bs(e){return e&&"integerValue"in e}function Us(e){return!!e&&"arrayValue"in e}function Gs(e){return e&&"nullValue"in e}function Ks(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function js(e){return e&&"mapValue"in e}function $s(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return ws(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=$s(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=$s(t.arrayValue.values[e]);return r}return Object.assign({},t)}function Qs(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function zs(e,t){var n=Os(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Ws(e,t){var n=Os(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Hs{constructor(e,t){this.position=e,this.inclusive=t}}function Ys(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],a=e.position[s];if(r=i.field.isKeyField()?jr.comparator(jr.fromName(a.referenceValue),n.key):Os(a,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Xs(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Ms(e.position[n],t.position[n]))return!1;return!0}class Js{}class Zs extends Js{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new oi(e,t,n):"array-contains"===t?new li(e,n):"in"===t?new di(e,n):"not-in"===t?new fi(e,n):"array-contains-any"===t?new gi(e,n):new Zs(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?ui:ci)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Os(t,this.value)):null!==t&&Ls(this.value)===Ls(t)&&this.matchesComparison(Os(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return br()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class ei extends Js{constructor(e,t){super(),this.filters=e,this.op=t,this.ht=null}static create(e,t){return new ei(e,t)}matches(t){return ti(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null!==this.ht||(this.ht=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ht}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){var e=this.lt(e=>e.isInequality());return null!==e?e.field:null}lt(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function ti(e){return"and"===e.op}function ni(e){return"or"===e.op}function ri(e){return si(e)&&ti(e)}function si(e){for(const t of e.filters)if(t instanceof ei)return!1;return!0}function ii(e,t){var n=e.filters.concat(t);return ei.create(n,e.op)}function ai(e){return e instanceof Zs?`${(t=e).field.canonicalString()} ${t.op} ${Ps(t.value)}`:e instanceof ei?(e=e).op.toString()+" {"+e.getFilters().map(ai).join(" ,")+"}":"Filter";var t}class oi extends Zs{constructor(e,t,n){super(e,t,n),this.key=jr.fromName(n.referenceValue)}matches(e){var t=jr.comparator(e.key,this.key);return this.matchesComparison(t)}}class ui extends Zs{constructor(e,t){super(e,"in",t),this.keys=hi(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class ci extends Zs{constructor(e,t){super(e,"not-in",t),this.keys=hi(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function hi(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>jr.fromName(e.referenceValue))}class li extends Zs{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return Us(t)&&Fs(t.arrayValue,this.value)}}class di extends Zs{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&Fs(this.value.arrayValue,t)}}class fi extends Zs{constructor(e,t){super(e,"not-in",t)}matches(e){if(Fs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Fs(this.value.arrayValue,t)}}class gi extends Zs{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Us(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Fs(this.value.arrayValue,e))}}class mi{constructor(e,t="asc"){this.field=e,this.dir=t}}class pi{constructor(e,t){this.comparator=e,this.root=t||vi.EMPTY}insert(e,t){return new pi(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,vi.BLACK,null,null))}remove(e){return new pi(this.comparator,this.root.remove(e,this.comparator).copy(null,null,vi.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new yi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new yi(this.root,e,this.comparator,!1)}getReverseIterator(){return new yi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new yi(this.root,e,this.comparator,!0)}}class yi{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class vi{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:vi.RED,this.left=null!=r?r:vi.EMPTY,this.right=null!=s?s:vi.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new vi(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return vi.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return vi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,vi.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,vi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw br();if(this.right.isRed())throw br();var e=this.left.check();if(e!==this.right.check())throw br();return e+(this.isRed()?0:1)}}vi.EMPTY=null,vi.RED=!0,vi.BLACK=!1,vi.EMPTY=new class{constructor(){this.size=0}get key(){throw br()}get value(){throw br()}get color(){throw br()}get left(){throw br()}get right(){throw br()}copy(e,t,n,r,s){return this}insert(e,t,n){return new vi(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class wi{constructor(e){this.comparator=e,this.data=new pi(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Ii(this.data.getIterator())}getIteratorFrom(e){return new Ii(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof wi))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new wi(this.comparator);return t.data=e,t}}class Ii{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function bi(e){return e.hasNext()?e.getNext():void 0}class Ei{constructor(e){(this.fields=e).sort(Kr.comparator)}static empty(){return new Ei([])}unionWith(e){let t=new wi(Kr.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new Ei(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Or(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class Ti{constructor(e){this.value=e}static empty(){return new Ti({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!js(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=$s(t)}setAll(e){let n=Kr.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=$s(e):s.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,s)}delete(e){const t=this.field(e.popLast());js(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ms(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];js(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){ws(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Ti($s(this.value))}}class _i{constructor(e,t,n,r,s,i,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=a}static newInvalidDocument(e){return new _i(e,0,qr.min(),qr.min(),qr.min(),Ti.empty(),0)}static newFoundDocument(e,t,n,r){return new _i(e,1,t,qr.min(),n,r,0)}static newNoDocument(e,t){return new _i(e,2,t,qr.min(),qr.min(),Ti.empty(),0)}static newUnknownDocument(e,t){return new _i(e,3,t,qr.min(),qr.min(),Ti.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(qr.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ti.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ti.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=qr.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof _i&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new _i(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Si{constructor(e,t=null,n=[],r=[],s=null,i=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=a,this.ft=null}}function xi(e,t=null,n=[],r=[],s=null,i=null,a=null){return new Si(e,t,n,r,s,i,a)}function Di(e){const t=e;if(null===t.ft){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>function t(e){if(e instanceof Zs)return e.field.canonicalString()+e.op.toString()+Ps(e.value);if(ri(e))return e.filters.map(e=>t(e)).join(",");var n=e.filters.map(e=>t(e)).join(",");return`${e.op}(${n})`}(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),bs(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Ps(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Ps(e)).join(",")),t.ft=e}return t.ft}function Ai(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let s=0;s<e.orderBy.length;s++)if(n=e.orderBy[s],r=t.orderBy[s],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r;if(e.filters.length!==t.filters.length)return!1;for(let i=0;i<e.filters.length;i++)if(!function r(e,t){return e instanceof Zs?(n=e,(i=t)instanceof Zs&&n.op===i.op&&n.field.isEqual(i.field)&&Ms(n.value,i.value)):e instanceof ei?(s=t)instanceof ei&&e.op===s.op&&e.filters.length===s.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,s.filters[n]),!0):void br();var s,n,i}(e.filters[i],t.filters[i]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Xs(e.startAt,t.startAt)&&Xs(e.endAt,t.endAt)}function Ci(e){return jr.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Ni(e,t){return e.filters.filter(e=>e instanceof Zs&&e.field.isEqual(t))}function ki(t,n,r){let s=Rs,i=!0;for(const r of Ni(t,n)){let e=Rs,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?Rs:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?qs(ys.empty(),jr.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:br();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=Rs}zs({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];zs({value:s,inclusive:i},{value:t,inclusive:r.inclusive})<0&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}function Ri(t,n,r){let s=ks,i=!0;for(const r of Ni(t,n)){let e=ks,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?qs(ys.empty(),jr.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?ks:br(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=ks}0<Ws({value:s,inclusive:i},{value:e,inclusive:t})&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<Ws({value:s,inclusive:i},{value:t,inclusive:r.inclusive})&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}class Li{constructor(e,t=null,n=[],r=[],s=null,i="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=a,this.endAt=o,this.dt=null,this._t=null,this.startAt,this.endAt}}function Mi(e,t,n,r,s,i,a,o){return new Li(e,t,n,r,s,i,a,o)}function Fi(e){return new Li(e)}function Oi(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Vi(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function Pi(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function qi(e){return null!==e.collectionGroup}function Bi(t){const n=t;if(null===n.dt){n.dt=[];const t=Pi(n),e=Vi(n);if(null!==t&&null===e)t.isKeyField()||n.dt.push(new mi(t)),n.dt.push(new mi(Kr.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.dt.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.dt.push(new mi(Kr.keyField(),t))}}}return n.dt}function Ui(e){const t=e;if(!t._t)if("F"===t.limitType)t._t=xi(t.path,t.collectionGroup,Bi(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of Bi(t)){const t="desc"===s.dir?"asc":"desc";e.push(new mi(s.field,t))}var n=t.endAt?new Hs(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Hs(t.startAt.position,t.startAt.inclusive):null;t._t=xi(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t._t}function Gi(e,t){t.getFirstInequalityField(),Pi(e);var n=e.filters.concat([t]);return new Li(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Ki(e,t,n){return new Li(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function ji(e,t){return Ai(Ui(e),Ui(t))&&e.limitType===t.limitType}function $i(e){return`${Di(Ui(e))}|lt:${e.limitType}`}function Qi(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>ai(e)).join(", ")}]`),bs(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Ps(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Ps(e)).join(",")),`Target(${t})`}(Ui(e))}; limitType=${e.limitType})`}function zi(n,e){return e.isFoundDocument()&&(s=n,a=(i=e).key.path,null!==s.collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(a):jr.isDocumentKey(s.path)?s.path.isEqual(a):s.path.isImmediateParentOf(a))&&function(e){for(const t of Bi(n))if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(s=e,(!(e=n).startAt||(t=e.startAt,r=Ys(t,Bi(e),s),t.inclusive?r<=0:r<0))&&(!e.endAt||(t=e.endAt,r=Ys(t,Bi(e),s),t.inclusive?0<=r:0<r)));var t,r,s,i,a}function Wi(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Hi(s){return(e,t)=>{let n=!1;for(const r of Bi(s)){const s=function(e,s,t){var n=e.field.isKeyField()?jr.comparator(s.key,t.key):function(e,t){var n=s.data.field(e),r=t.data.field(e);return null!==n&&null!==r?Os(n,r):br()}(e.field,t);switch(e.dir){case"asc":return n;case"desc":return-1*n;default:return br()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function Yi(e,t){if(e.wt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Es(t)?"-0":t}}function Xi(e){return{integerValue:""+e}}function Ji(e,t){return Ts(t)?Xi(t):Yi(e,t)}class Zi{constructor(){this._=void 0}}function ea(e,t){return e instanceof aa?Bs(n=t)||n&&"doubleValue"in n?t:{integerValue:0}:null;var n}class ta extends Zi{}class na extends Zi{constructor(e){super(),this.elements=e}}function ra(e,t){const n=ua(t);for(const t of e.elements)n.some(e=>Ms(e,t))||n.push(t);return{arrayValue:{values:n}}}class sa extends Zi{constructor(e){super(),this.elements=e}}function ia(e,t){let n=ua(t);for(const t of e.elements)n=n.filter(e=>!Ms(e,t));return{arrayValue:{values:n}}}class aa extends Zi{constructor(e,t){super(),this.yt=e,this.gt=t}}function oa(e){return Ds(e.integerValue||e.doubleValue)}function ua(e){return Us(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class ca{constructor(e,t){this.field=e,this.transform=t}}class ha{constructor(e,t){this.version=e,this.transformResults=t}}class la{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new la}static exists(e){return new la(void 0,e)}static updateTime(e){return new la(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function da(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class fa{}function ga(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new Ta(e.key,la.none()):new va(e.key,e.data,la.none());{const s=e.data,i=Ti.empty();let t=new wi(Kr.comparator);for(var r of n.fields)if(!t.has(r)){let e=s.field(r);null===e&&1<r.length&&(r=r.popLast(),e=s.field(r)),null===e?i.delete(r):i.set(r,e),t=t.add(r)}return new wa(e.key,i,new Ei(t.toArray()),la.none())}}function ma(e,t,n){e instanceof va?function(e,t,n){const r=e.value.clone(),s=ba(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof wa?function(e,t,n){if(!da(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=ba(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Ia(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function pa(e,t,n,r){return e instanceof va?function(e,t,n,r){if(!da(e.precondition,t))return n;const s=e.value.clone(),i=Ea(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof wa?function(e,t,n,r){if(!da(e.precondition,t))return n;const s=Ea(e.fieldTransforms,r,t),i=t.data;return i.setAll(Ia(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):(t=t,n=n,da(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n)}function ya(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Or(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof na&&t instanceof na||e instanceof sa&&t instanceof sa?Or(e.elements,t.elements,Ms):e instanceof aa&&t instanceof aa?Ms(e.gt,t.gt):e instanceof ta&&t instanceof ta)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class va extends fa{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class wa extends fa{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Ia(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function ba(e,t,n){const r=new Map;Er(e.length===n.length);for(let h=0;h<n.length;h++){var s=e[h],i=s.transform,a=t.data.field(s.field);r.set(s.field,(o=i,u=a,c=n[h],o instanceof na?ra(o,u):o instanceof sa?ia(o,u):c))}var o,u,c;return r}function Ea(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(s=e,i=h,a=t,u=o=void 0,s instanceof ta?function(){const e={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:a.seconds,nanos:a.nanoseconds}}}};return i&&(e.fields.__previous_value__=i),{mapValue:e}}():s instanceof na?ra(s,i):s instanceof sa?ia(s,i):(o=ea(s=s,i),u=oa(o)+oa(s.gt),Bs(o)&&Bs(s.gt)?Xi(u):Yi(s.yt,u))))}var s,i,a,o,u;return r}class Ta extends fa{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class _a extends fa{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Sa{constructor(e){this.count=e}}function xa(e){switch(e){default:return br(),0;case Tr.CANCELLED:case Tr.UNKNOWN:case Tr.DEADLINE_EXCEEDED:case Tr.RESOURCE_EXHAUSTED:case Tr.INTERNAL:case Tr.UNAVAILABLE:case Tr.UNAUTHENTICATED:return;case Tr.INVALID_ARGUMENT:case Tr.NOT_FOUND:case Tr.ALREADY_EXISTS:case Tr.PERMISSION_DENIED:case Tr.FAILED_PRECONDITION:case Tr.ABORTED:case Tr.OUT_OF_RANGE:case Tr.UNIMPLEMENTED:case Tr.DATA_LOSS:return 1}}function Da(e){if(void 0===e)return vr("GRPC error has no .code"),Tr.UNKNOWN;switch(e){case nr.OK:return Tr.OK;case nr.CANCELLED:return Tr.CANCELLED;case nr.UNKNOWN:return Tr.UNKNOWN;case nr.DEADLINE_EXCEEDED:return Tr.DEADLINE_EXCEEDED;case nr.RESOURCE_EXHAUSTED:return Tr.RESOURCE_EXHAUSTED;case nr.INTERNAL:return Tr.INTERNAL;case nr.UNAVAILABLE:return Tr.UNAVAILABLE;case nr.UNAUTHENTICATED:return Tr.UNAUTHENTICATED;case nr.INVALID_ARGUMENT:return Tr.INVALID_ARGUMENT;case nr.NOT_FOUND:return Tr.NOT_FOUND;case nr.ALREADY_EXISTS:return Tr.ALREADY_EXISTS;case nr.PERMISSION_DENIED:return Tr.PERMISSION_DENIED;case nr.FAILED_PRECONDITION:return Tr.FAILED_PRECONDITION;case nr.ABORTED:return Tr.ABORTED;case nr.OUT_OF_RANGE:return Tr.OUT_OF_RANGE;case nr.UNIMPLEMENTED:return Tr.UNIMPLEMENTED;case nr.DATA_LOSS:return Tr.DATA_LOSS;default:return br()}}(it=nr=nr||{})[it.OK=0]="OK",it[it.CANCELLED=1]="CANCELLED",it[it.UNKNOWN=2]="UNKNOWN",it[it.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",it[it.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",it[it.NOT_FOUND=5]="NOT_FOUND",it[it.ALREADY_EXISTS=6]="ALREADY_EXISTS",it[it.PERMISSION_DENIED=7]="PERMISSION_DENIED",it[it.UNAUTHENTICATED=16]="UNAUTHENTICATED",it[it.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",it[it.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",it[it.ABORTED=10]="ABORTED",it[it.OUT_OF_RANGE=11]="OUT_OF_RANGE",it[it.UNIMPLEMENTED=12]="UNIMPLEMENTED",it[it.INTERNAL=13]="INTERNAL",it[it.UNAVAILABLE=14]="UNAVAILABLE",it[it.DATA_LOSS=15]="DATA_LOSS";class Aa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(r){ws(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return Is(this.inner)}size(){return this.innerSize}}const Ca=new pi(jr.comparator);const Na=new pi(jr.comparator);function ka(...e){let t=Na;for(const n of e)t=t.insert(n.key,n);return t}function Ra(e){let n=Na;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function La(){return new Aa(e=>e.toString(),(e,t)=>e.isEqual(t))}const Ma=new pi(jr.comparator),Fa=new wi(jr.comparator);function Oa(...e){let t=Fa;for(const n of e)t=t.add(n);return t}const Va=new wi(Fr);class Pa{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,qa.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Pa(qr.min(),r,Va,Ca,Oa())}}class qa{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new qa(n,t,Oa(),Oa(),Oa())}}class Ba{constructor(e,t,n,r){this.It=e,this.removedTargetIds=t,this.key=n,this.Tt=r}}class Ua{constructor(e,t){this.targetId=e,this.Et=t}}class Ga{constructor(e,t,n=_s.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Ka{constructor(){this.At=0,this.Rt=Qa(),this.bt=_s.EMPTY_BYTE_STRING,this.Pt=!1,this.vt=!0}get current(){return this.Pt}get resumeToken(){return this.bt}get Vt(){return 0!==this.At}get St(){return this.vt}Dt(e){0<e.approximateByteSize()&&(this.vt=!0,this.bt=e)}Ct(){let n=Oa(),r=Oa(),s=Oa();return this.Rt.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:br()}}),new qa(this.bt,this.Pt,n,r,s)}xt(){this.vt=!1,this.Rt=Qa()}Nt(e,t){this.vt=!0,this.Rt=this.Rt.insert(e,t)}kt(e){this.vt=!0,this.Rt=this.Rt.remove(e)}Ot(){this.At+=1}Mt(){--this.At}Ft(){this.vt=!0,this.Pt=!0}}class ja{constructor(e){this.$t=e,this.Bt=new Map,this.Lt=Ca,this.qt=$a(),this.Ut=new wi(Fr)}Kt(e){for(const t of e.It)e.Tt&&e.Tt.isFoundDocument()?this.Gt(t,e.Tt):this.Qt(t,e.key,e.Tt);for(const n of e.removedTargetIds)this.Qt(n,e.key,e.Tt)}jt(n){this.forEachTarget(n,e=>{const t=this.Wt(e);switch(n.state){case 0:this.zt(e)&&t.Dt(n.resumeToken);break;case 1:t.Mt(),t.Vt||t.xt(),t.Dt(n.resumeToken);break;case 2:t.Mt(),t.Vt||this.removeTarget(e);break;case 3:this.zt(e)&&(t.Ft(),t.Dt(n.resumeToken));break;case 4:this.zt(e)&&(this.Ht(e),t.Dt(n.resumeToken));break;default:br()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Bt.forEach((e,t)=>{this.zt(t)&&n(t)})}Jt(e){const t=e.targetId,n=e.Et.count,r=this.Yt(t);if(r){const e=r.target;if(Ci(e))if(0===n){const n=new jr(e.path);this.Qt(t,n,_i.newNoDocument(n,qr.min()))}else Er(1===n);else this.Xt(t)!==n&&(this.Ht(t),this.Ut=this.Ut.add(t))}}Zt(r){const s=new Map;this.Bt.forEach((e,t)=>{var n=this.Yt(t);if(n){if(e.current&&Ci(n.target)){const s=new jr(n.target.path);null!==this.Lt.get(s)||this.te(t,s)||this.Qt(t,s,_i.newNoDocument(s,r))}e.St&&(s.set(t,e.Ct()),e.xt())}});let i=Oa();this.qt.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.Yt(e);return!t||2===t.purpose||(n=!1)}),n&&(i=i.add(e))}),this.Lt.forEach((e,t)=>t.setReadTime(r));var e=new Pa(r,s,this.Ut,this.Lt,i);return this.Lt=Ca,this.qt=$a(),this.Ut=new wi(Fr),e}Gt(e,t){var n;this.zt(e)&&(n=this.te(e,t.key)?2:0,this.Wt(e).Nt(t.key,n),this.Lt=this.Lt.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ee(t.key).add(e)))}Qt(e,t,n){if(this.zt(e)){const r=this.Wt(e);this.te(e,t)?r.Nt(t,1):r.kt(t),this.qt=this.qt.insert(t,this.ee(t).delete(e)),n&&(this.Lt=this.Lt.insert(t,n))}}removeTarget(e){this.Bt.delete(e)}Xt(e){var t=this.Wt(e).Ct();return this.$t.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ot(e){this.Wt(e).Ot()}Wt(e){let t=this.Bt.get(e);return t||(t=new Ka,this.Bt.set(e,t)),t}ee(e){let t=this.qt.get(e);return t||(t=new wi(Fr),this.qt=this.qt.insert(e,t)),t}zt(e){var t=null!==this.Yt(e);return t||yr("WatchChangeAggregator","Detected inactive target",e),t}Yt(e){var t=this.Bt.get(e);return t&&t.Vt?null:this.$t.ne(e)}Ht(t){this.Bt.set(t,new Ka),this.$t.getRemoteKeysForTarget(t).forEach(e=>{this.Qt(t,e,null)})}te(e,t){return this.$t.getRemoteKeysForTarget(e).has(t)}}function $a(){return new pi(jr.comparator)}function Qa(){return new pi(jr.comparator)}const za={asc:"ASCENDING",desc:"DESCENDING"},Wa={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Ha={and:"AND",or:"OR"};class Ya{constructor(e,t){this.databaseId=e,this.wt=t}}function Xa(e,t){return e.wt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Ja(e,t){return e.wt?t.toBase64():t.toUint8Array()}function Za(e){return Er(!!e),qr.fromTimestamp((t=xs(e),new Pr(t.seconds,t.nanos)));var t}function eo(e,t){return e=e,new Ur(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function to(e){var t=Ur.fromString(e);return Er(Io(t)),t}function no(e,t){return eo(e.databaseId,t.path)}function ro(e,t){const n=to(t);if(n.get(1)!==e.databaseId.projectId)throw new _r(Tr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new _r(Tr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new jr(oo(n))}function so(e,t){return eo(e.databaseId,t)}function io(e){var t=to(e);return 4===t.length?Ur.emptyPath():oo(t)}function ao(e){return new Ur(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function oo(e){return Er(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function uo(e,t,n){return{name:no(e,t),fields:n.value.mapValue.fields}}function co(e,t,n){const r=ro(e,t.name),s=Za(t.updateTime),i=t.createTime?Za(t.createTime):qr.min(),a=new Ti({mapValue:{fields:t.fields}}),o=_i.newFoundDocument(r,s,i,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ho(e,t){let n;if(t instanceof va)n={update:uo(e,t.key,t.value)};else if(t instanceof Ta)n={delete:no(e,t.key)};else if(t instanceof wa)n={update:uo(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof _a))return br();n={verify:no(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof ta)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof na)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof sa)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof aa)return{fieldPath:e.field.canonicalString(),increment:t.gt};throw br()}(e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:(t=r.updateTime,Xa(e,t.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:br()),n;var r}function lo(t,n){const e=n.currentDocument?void 0!==(s=n.currentDocument).updateTime?la.updateTime(Za(s.updateTime)):void 0!==s.exists?la.exists(s.exists):la.none():la.none(),r=n.updateTransforms?n.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)Er("REQUEST_TIME"===t.setToServerValue),n=new ta;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new na(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new sa(e)}else"increment"in t?n=new aa(e,t.increment):br();var r=Kr.fromServerFormat(t.fieldPath);return new ca(r,n)}(t,e)):[];var s;if(n.update){n.update.name;var i=ro(t,n.update.name),a=new Ti({mapValue:{fields:n.update.fields}});if(n.updateMask){const t=function(){const e=n.updateMask.fieldPaths||[];return new Ei(e.map(e=>Kr.fromServerFormat(e)))}();return new wa(i,a,t,e,r)}return new va(i,a,e,r)}if(n.delete){const r=ro(t,n.delete);return new Ta(r,e)}if(n.verify){const r=ro(t,n.verify);return new _a(r,e)}return br()}function fo(e,t){return{documents:[so(e,t.path)]}}function go(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=so(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=so(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length)return function n(e){return e instanceof Zs?function(e){if("=="===e.op){if(Ks(e.value))return{unaryFilter:{field:vo(e.field),op:"IS_NAN"}};if(Gs(e.value))return{unaryFilter:{field:vo(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ks(e.value))return{unaryFilter:{field:vo(e.field),op:"IS_NOT_NAN"}};if(Gs(e.value))return{unaryFilter:{field:vo(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:vo(e.field),op:po(e.op),value:e.value}}}(e):e instanceof ei?function(e){const t=e.getFilters().map(e=>n(e));return 1===t.length?t[0]:{compositeFilter:{op:yo(e.op),filters:t}}}(e):br()}(ei.create(e,"and"))}(t.filters);s&&(n.structuredQuery.where=s);s=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:vo(e.field),direction:(e=e.dir,za[e])}}(e))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);var i,s=(i=t.limit,e.wt||bs(i)?i:{value:i});return null!==s&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(s=t.startAt).inclusive,values:s.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function mo(e){let t=io(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){Er(1===r);const g=n.from[0];g.allDescendants?s=g.collectionId:t=t.child(g.collectionId)}let i=[];n.where&&(i=function(){const e=function t(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=wo(e.unaryFilter.field);return Zs.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=wo(e.unaryFilter.field);return Zs.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=wo(e.unaryFilter.field);return Zs.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=wo(e.unaryFilter.field);return Zs.create(s,"!=",{nullValue:"NULL_VALUE"});default:return br()}}(e):void 0!==e.fieldFilter?function(e){return Zs.create(wo(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return br()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return ei.create(e.compositeFilter.filters.map(e=>t(e)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return br()}}(e.compositeFilter.op))}(e):br()}(n.where);return e instanceof ei&&ri(e)?e.getFilters():[e]}());let a=[];n.orderBy&&(a=n.orderBy.map(e=>function(e){return new mi(wo(e.field),function(){switch(e.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(e)));let o=null;var u,c,h,l;n.limit&&(o=(e=n.limit,bs(u="object"==typeof e?e.value:e)?null:u));let d=null;n.startAt&&(d=(c=n.startAt,l=!!c.before,h=c.values||[],new Hs(h,l)));let f=null;return n.endAt&&(f=(c=n.endAt,h=!c.before,l=c.values||[],new Hs(l,h))),Mi(t,s,a,i,o,"F",d,f)}function po(e){return Wa[e]}function yo(e){return Ha[e]}function vo(e){return{fieldPath:e.canonicalString()}}function wo(e){return Kr.fromServerFormat(e.fieldPath)}function Io(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}function bo(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=Eo(t)),t=function(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const r=e.charAt(s);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return Eo(t)}function Eo(e){return e+""}function To(t){const n=t.length;if(Er(2<=n),2===n)return Er(""===t.charAt(0)&&""===t.charAt(1)),Ur.emptyPath();const r=n-2,s=[];let i="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>r)&&br(),t.charAt(n+1)){case"":const r=t.substring(a,n);let e;0===i.length?e=r:(i+=r,e=i,i=""),s.push(e);break;case"":i+=t.substring(a,n),i+="\0";break;case"":i+=t.substring(a,n+1);break;default:br()}a=n+2}return new Ur(s)}const _o=["userId","batchId"];function So(e,t){return[e,bo(t)]}function xo(e,t,n){return[e,bo(t),n]}const Do={},Ao=["prefixPath","collectionGroup","readTime","documentId"],Co=["prefixPath","collectionGroup","documentId"],No=["collectionGroup","readTime","prefixPath","documentId"],ko=["canonicalId","targetId"],Ro=["targetId","path"],Lo=["path","targetId"],Mo=["collectionId","parent"],Fo=["indexId","uid"],Oo=["uid","sequenceNumber"],Vo=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Po=["indexId","uid","orderedDocumentKey"],qo=["userId","collectionPath","documentId"],Bo=["userId","collectionPath","largestBatchId"],Uo=["userId","collectionGroup","largestBatchId"],Go=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Ko=[...Go,"documentOverlays"],jo=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],$o=jo,Qo=[...$o,"indexConfiguration","indexState","indexEntries"];class zo extends ts{constructor(e,t){super(),this.se=e,this.currentSequenceNumber=t}}function Wo(e,t){var n=e;return is.M(n.se,t)}class Ho{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const s=this.mutations[r];s.key.isEqual(e.key)&&ma(s,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=pa(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=pa(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(i,a){const o=La();return this.mutations.forEach(e=>{const t=i.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var s=ga(n,r);null!==s&&o.set(e.key,s),n.isValidDocument()||n.convertToNoDocument(qr.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),Oa())}isEqual(e){return this.batchId===e.batchId&&Or(this.mutations,e.mutations,(e,t)=>ya(e,t))&&Or(this.baseMutations,e.baseMutations,(e,t)=>ya(e,t))}}class Yo{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Er(e.mutations.length===n.length);let r=Ma;var s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new Yo(e,t,n,r)}}class Xo{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Jo{constructor(e,t,n,r,s=qr.min(),i=qr.min(),a=_s.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=a}withSequenceNumber(e){return new Jo(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new Jo(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new Jo(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Zo{constructor(e){this.ie=e}}function eu(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:tu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:no(s=e.ie,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:Xa(s,e.version.toTimestamp()),createTime:Xa(s,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:nu(t.version)};else{if(!t.isUnknownDocument())return br();r.unknownDocument={path:n.path.toArray(),version:nu(t.version)}}var s;return r}function tu(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function nu(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ru(e){var t=new Pr(e.seconds,e.nanoseconds);return qr.fromTimestamp(t)}function su(t,e){const n=(e.baseMutations||[]).map(e=>lo(t.ie,e));for(let i=0;i<e.mutations.length-1;++i){const n=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const r=e.mutations[i+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map(e=>lo(t.ie,e)),s=Pr.fromMillis(e.localWriteTimeMs);return new Ho(e.batchId,s,n,r)}function iu(e){var t,n=ru(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?ru(e.lastLimboFreeSnapshotVersion):qr.min();let s;return s=void 0!==e.query.documents?(Er(1===(t=e.query).documents.length),Ui(Fi(io(t.documents[0])))):Ui(mo(e.query)),new Jo(s,e.targetId,0,e.lastListenSequenceNumber,n,r,_s.fromBase64String(e.resumeToken))}function au(e,t){var n=nu(t.snapshotVersion),r=nu(t.lastLimboFreeSnapshotVersion),s=(Ci(t.target)?fo:go)(e.ie,t.target),i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:Di(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function ou(e){var t=mo({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Ki(t,t.limit,"L"):t}function uu(e,t){return new Xo(t.largestBatchId,lo(e.ie,t.overlayMutation))}function cu(e,t){var n=t.path.lastSegment();return[e,bo(t.path.popLast()),n]}function hu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:nu(r.readTime),documentKey:bo(r.documentKey.path),largestBatchId:r.largestBatchId}}class lu{getBundleMetadata(e,t){return du(e).get(t).next(e=>{if(e)return{id:(t=e).bundleId,createTime:ru(t.createTime),version:t.version};var t})}saveBundleMetadata(e,t){return du(e).put({bundleId:(n=t).id,createTime:nu(Za(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return fu(e).get(t).next(e=>{if(e)return{name:(t=e).name,query:ou(t.bundledQuery),readTime:ru(t.readTime)};var t})}saveNamedQuery(e,t){return fu(e).put({name:(t=t).name,readTime:nu(Za(t.readTime)),bundledQuery:t.bundledQuery})}}function du(e){return Wo(e,"bundles")}function fu(e){return Wo(e,"namedQueries")}class gu{constructor(e,t){this.yt=e,this.userId=t}static re(e,t){var n=t.uid||"";return new gu(e,n)}getOverlay(e,t){return mu(e).get(cu(this.userId,t)).next(e=>e?uu(this.yt,e):null)}getOverlays(e,t){const n=La();return rs.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(r,s,e){const i=[];return e.forEach((e,t)=>{var n=new Xo(s,t);i.push(this.oe(r,n))}),rs.waitFor(i)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(bo(e.getCollectionPath())));const s=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);s.push(mu(n).Y("collectionPathOverlayIndex",t))}),rs.waitFor(s)}getOverlaysForCollection(e,t,n){const r=La(),s=bo(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return mu(e).W("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=uu(this.yt,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=La();let a;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return mu(e).Z({index:"collectionGroupOverlayIndex",range:r},(e,t,n)=>{const r=uu(this.yt,t);i.size()<s||r.largestBatchId===a?(i.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>i)}oe(e,t){return mu(e).put(function(e,t,n){var[,r,s]=cu(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ho(e.ie,n.mutation)}}(this.yt,this.userId,t))}}function mu(e){return Wo(e,"documentOverlays")}class pu{constructor(){}ue(e,t){this.ce(e,t),t.ae()}ce(e,t){var n,r;"nullValue"in e?this.he(t,5):"booleanValue"in e?(this.he(t,10),t.le(e.booleanValue?1:0)):"integerValue"in e?(this.he(t,15),t.le(Ds(e.integerValue))):"doubleValue"in e?(n=Ds(e.doubleValue),isNaN(n)?this.he(t,13):(this.he(t,15),Es(n)?t.le(0):t.le(n))):"timestampValue"in e?(r=e.timestampValue,this.he(t,20),"string"==typeof r?t.fe(r):(t.fe(`${r.seconds||""}`),t.le(r.nanos||0))):"stringValue"in e?(this.de(e.stringValue,t),this._e(t)):"bytesValue"in e?(this.he(t,30),t.we(As(e.bytesValue)),this._e(t)):"referenceValue"in e?this.me(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.he(t,45),t.le(r.latitude||0),t.le(r.longitude||0)):"mapValue"in e?Qs(e)?this.he(t,Number.MAX_SAFE_INTEGER):(this.ge(e.mapValue,t),this._e(t)):"arrayValue"in e?(this.ye(e.arrayValue,t),this._e(t)):br()}de(e,t){this.he(t,25),this.pe(e,t)}pe(e,t){t.fe(e)}ge(e,t){var n=e.fields||{};this.he(t,55);for(const e of Object.keys(n))this.de(e,t),this.ce(n[e],t)}ye(e,t){var n=e.values||[];this.he(t,50);for(const e of n)this.ce(e,t)}me(e,t){this.he(t,37),jr.fromName(e).path.forEach(e=>{this.he(t,60),this.pe(e,t)})}he(e,t){e.le(t)}_e(e){e.le(2)}}function yu(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}pu.Ie=new pu;class vu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Te(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ee(n.value),n=t.next();this.Ae()}Re(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.be(n.value),n=t.next();this.Pe()}ve(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ee(e);else if(e<2048)this.Ee(960|e>>>6),this.Ee(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ee(480|e>>>12),this.Ee(128|63&e>>>6),this.Ee(128|63&e);else{const e=t.codePointAt(0);this.Ee(240|e>>>18),this.Ee(128|63&e>>>12),this.Ee(128|63&e>>>6),this.Ee(128|63&e)}}this.Ae()}Ve(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.be(e);else if(e<2048)this.be(960|e>>>6),this.be(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.be(480|e>>>12),this.be(128|63&e>>>6),this.be(128|63&e);else{const e=t.codePointAt(0);this.be(240|e>>>18),this.be(128|63&e>>>12),this.be(128|63&e>>>6),this.be(128|63&e)}}this.Pe()}Se(e){var t=this.De(e),n=yu(t);this.Ce(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}xe(e){var t=this.De(e),n=yu(t);this.Ce(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}Ne(){this.ke(255),this.ke(255)}Oe(){this.Me(255),this.Me(255)}reset(){this.position=0}seed(e){this.Ce(e.length),this.buffer.set(e,this.position),this.position+=e.length}Fe(){return this.buffer.slice(0,this.position)}De(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Ee(e){var t=255&e;0==t?(this.ke(0),this.ke(255)):255==t?(this.ke(255),this.ke(0)):this.ke(t)}be(e){var t=255&e;0==t?(this.Me(0),this.Me(255)):255==t?(this.Me(255),this.Me(0)):this.Me(e)}Ae(){this.ke(0),this.ke(1)}Pe(){this.Me(0),this.Me(1)}ke(e){this.Ce(1),this.buffer[this.position++]=e}Me(e){this.Ce(1),this.buffer[this.position++]=~e}Ce(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class wu{constructor(e){this.$e=e}we(e){this.$e.Te(e)}fe(e){this.$e.ve(e)}le(e){this.$e.Se(e)}ae(){this.$e.Ne()}}class Iu{constructor(e){this.$e=e}we(e){this.$e.Re(e)}fe(e){this.$e.Ve(e)}le(e){this.$e.xe(e)}ae(){this.$e.Oe()}}class bu{constructor(){this.$e=new vu,this.Be=new wu(this.$e),this.Le=new Iu(this.$e)}seed(e){this.$e.seed(e)}qe(e){return 0===e?this.Be:this.Le}Fe(){return this.$e.Fe()}reset(){this.$e.reset()}}class Eu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ue(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Eu(this.indexId,this.documentKey,this.arrayValue,n)}}function Tu(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=_u(e.arrayValue,t.arrayValue),0!==n?n:(n=_u(e.directionalValue,t.directionalValue),0!==n?n:jr.comparator(e.documentKey,t.documentKey)))}function _u(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class Su{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ke=e.orderBy,this.Ge=[];for(const t of e.filters){const e=t;e.isInequality()?this.Qe=e:this.Ge.push(e)}}je(e){Er(e.collectionGroup===this.collectionId);var t=Qr(e);if(void 0!==t&&!this.We(t))return!1;var n=zr(e);let r=0,s=0;for(;r<n.length&&this.We(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.Qe){const e=n[r];if(!this.ze(this.Qe,e)||!this.He(this.Ke[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ke.length||!this.He(this.Ke[s++],e))return!1}return!0}We(e){for(const t of this.Ge)if(this.ze(t,e))return!0;return!1}ze(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}He(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function xu(e){if(0===e.getFilters().length)return[];const t=function t(e){if(Er(e instanceof Zs||e instanceof ei),e instanceof Zs)return e;if(1===e.filters.length)return t(e.filters[0]);const n=e.filters.map(e=>t(e));let r=ei.create(n,e.op);return r=Ru(r),Cu(r)?r:(Er(r instanceof ei),Er(ti(r)),Er(1<r.filters.length),r.filters.reduce((e,t)=>Nu(e,t)))}(function t(n){var e;if(Er(n instanceof Zs||n instanceof ei),n instanceof Zs){if(n instanceof di){const r=(null===(e=null===(e=n.value.arrayValue)||void 0===e?void 0:e.values)||void 0===e?void 0:e.map(e=>Zs.create(n.field,"==",e)))||[];return ei.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return ei.create(r,n.op)}(e));return Er(Cu(t)),Du(t)||Au(t)?[t]:t.getFilters()}function Du(e){return e instanceof Zs}function Au(e){return e instanceof ei&&ri(e)}function Cu(e){return Du(e)||Au(e)||function(e){if(e instanceof ei&&ni(e)){for(const t of e.getFilters())if(!Du(t)&&!Au(t))return!1;return!0}return!1}(e)}function Nu(e,t){var n,r;return Er(e instanceof Zs||e instanceof ei),Er(t instanceof Zs||t instanceof ei),Ru(e instanceof Zs?t instanceof Zs?(n=e,r=t,ei.create([n,r],"and")):ku(e,t):t instanceof Zs?ku(t,e):function(e,t){if(Er(0<e.filters.length&&0<t.filters.length),ti(e)&&ti(t))return ii(e,t.getFilters());const n=ni(e)?e:t,r=ni(e)?t:e,s=n.filters.map(e=>Nu(e,r));return ei.create(s,"or")}(e,t))}function ku(t,e){if(ti(e))return ii(e,t.getFilters());var n=e.filters.map(e=>Nu(t,e));return ei.create(n,"or")}function Ru(t){if(Er(t instanceof Zs||t instanceof ei),t instanceof Zs)return t;const e=t.getFilters();if(1===e.length)return Ru(e[0]);if(si(t))return t;const n=e.map(e=>Ru(e)),r=[];return n.forEach(e=>{e instanceof Zs?r.push(e):e instanceof ei&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:ei.create(r,t.op)}class Lu{constructor(){this.Je=new Mu}addToCollectionParentIndex(e,t){return this.Je.add(t),rs.resolve()}getCollectionParents(e,t){return rs.resolve(this.Je.getEntries(t))}addFieldIndex(e,t){return rs.resolve()}deleteFieldIndex(e,t){return rs.resolve()}getDocumentsMatchingTarget(e,t){return rs.resolve(null)}getIndexType(e,t){return rs.resolve(0)}getFieldIndexes(e,t){return rs.resolve([])}getNextCollectionGroupToUpdate(e){return rs.resolve(null)}getMinOffset(e,t){return rs.resolve(Jr.min())}getMinOffsetFromCollectionGroup(e,t){return rs.resolve(Jr.min())}updateCollectionGroup(e,t,n){return rs.resolve()}updateIndexEntries(e,t){return rs.resolve()}}class Mu{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new wi(Ur.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new wi(Ur.comparator)).toArray()}}const Fu=new Uint8Array(0);class Ou{constructor(e,t){this.user=e,this.databaseId=t,this.Ye=new Mu,this.Xe=new Aa(e=>Di(e),(e,t)=>Ai(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.Ye.has(t))return rs.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.Ye.add(t)});r={collectionId:n,parent:bo(r)};return Vu(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[Vr(n),""],!1,!0);return Vu(e).W(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(To(t.parent))}return r})}addFieldIndex(e,t){const n=qu(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const s=n.add(r);if(t.indexState){const n=Bu(e);return s.next(e=>{n.put(hu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=qu(e),r=Bu(e),s=Pu(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,c){const h=Pu(e);let l=!0;const n=new Map;return rs.forEach(this.Ze(c),t=>this.tn(e,t).next(e=>{l=l&&!!e,n.set(t,e)})).next(()=>{if(l){let u=Oa();const l=[];return rs.forEach(n,(e,t)=>{yr("IndexedDbIndexManager",`Using index ${o=e,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${Di(c)}`);var n=function(e,t){var n=Qr(t);if(void 0===n)return null;for(const t of Ni(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){const n=new Map;for(const r of zr(t))for(const t of Ni(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const s of zr(t)){const t=(0===s.kind?ki:Ri)(e,s.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Hs(n,r)}(t,e),i=function(e,t){const n=[];let r=!0;for(const s of zr(t)){const t=(0===s.kind?Ri:ki)(e,s.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Hs(n,r)}(t,e),a=this.en(e,t,s),o=this.en(e,t,i),r=this.nn(e,t,r),r=this.sn(e.indexId,n,a,s.inclusive,o,i.inclusive,r);return rs.forEach(r,e=>h.J(e,c.limit).next(e=>{e.forEach(e=>{var t=jr.fromSegments(e.documentKey);u.has(t)||(u=u.add(t),l.push(t))})}))}).next(()=>l)}return rs.resolve(null)})}Ze(t){let e=this.Xe.get(t);return e||(e=0===t.filters.length?[t]:xu(ei.create(t.filters,"and")).map(e=>xi(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this.Xe.set(t,e),e)}sn(t,e,n,r,s,i,a){const o=(null!=e?e.length:1)*Math.max(n.length,s.length),u=o/(null!=e?e.length:1),c=[];for(let h=0;h<o;++h){const o=e?this.rn(e[h/u]):Fu,l=this.on(t,o,n[h%u],r),d=this.un(t,o,s[h%u],i),f=a.map(e=>this.on(t,o,e,!0));c.push(...this.createRange(l,d,f))}return c}on(e,t,n,r){const s=new Eu(e,jr.empty(),t,n);return r?s:s.Ue()}un(e,t,n,r){const s=new Eu(e,jr.empty(),t,n);return r?s.Ue():s}tn(e,t){const r=new Su(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.je(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.Ze(t);return rs.forEach(r,t=>this.tn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new wi(Kr.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&1<r.length&&2===n?1:n)}cn(e,t){const n=new bu;for(const s of zr(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.qe(s.kind);pu.Ie.ue(e,r)}return n.Fe()}rn(e){const t=new bu;return pu.Ie.ue(e,t.qe(0)),t.Fe()}an(e,t){const n=new bu;return pu.Ie.ue(qs(this.databaseId,t),n.qe(0===(r=zr(e)).length?0:r[r.length-1].kind)),n.Fe();var r}nn(e,t,n){if(null===n)return[];let r=[];r.push(new bu);let s=0;for(const i of zr(e)){const e=n[s++];for(const n of r)if(this.hn(t,i.fieldPath)&&Us(e))r=this.ln(r,i,e);else{const t=n.qe(i.kind);pu.Ie.ue(e,t)}}return this.fn(r)}en(e,t,n){return this.nn(e,t,n.position)}fn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Fe();return t}ln(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new bu;r.seed(n.Fe()),pu.Ie.ue(e,r.qe(t.kind)),s.push(r)}return s}hn(e,t){return!!e.filters.find(e=>e instanceof Zs&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=qu(e),r=Bu(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next(e=>{const i=[];return rs.forEach(e,s=>r.get([s.indexId,this.uid]).next(e=>{var t,n,r;i.push((t=s,n=(e=e)?new Hr(e.sequenceNumber,new Jr(ru(e.readTime),new jr(To(e.documentKey)),e.largestBatchId)):Hr.empty(),r=t.fields.map(([e,t])=>new Wr(Kr.fromServerFormat(e),t)),new $r(t.indexId,t.collectionGroup,r,n)))})).next(()=>i)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:Fr(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=qu(e),i=Bu(e);return this.dn(e).next(t=>s.W("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>rs.forEach(e,e=>i.put(hu(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return rs.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?rs.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),rs.forEach(e,n=>this._n(s,t,n).next(e=>{var t=this.wn(r,n);return e.isEqual(t)?rs.resolve():this.mn(s,r,n,e,t)}))))})}gn(e,t,n,r){return Pu(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.an(n,t.key),documentKey:t.key.path.toArray()})}yn(e,t,n,r){return Pu(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.an(n,t.key),t.key.path.toArray()])}_n(e,n,r){const t=Pu(e);let s=new wi(Tu);return t.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.an(r,n)])},(e,t)=>{s=s.add(new Eu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}wn(e,t){let n=new wi(Tu);var r=this.cn(t,e);if(null==r)return n;const s=Qr(t);if(null!=s){var i=e.data.field(s.fieldPath);if(Us(i))for(const s of i.arrayValue.values||[])n=n.add(new Eu(t.indexId,e.key,this.rn(s),r))}else n=n.add(new Eu(t.indexId,e.key,Fu,r));return n}mn(t,n,r,c,e){yr("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const s=[];return function(e,n,r,s){var i=c.getIterator(),a=e.getIterator();let o=bi(i),u=bi(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=bi(a)):t?(s(o),o=bi(i)):(o=bi(i),u=bi(a))}}(e,Tu,e=>{s.push(this.gn(t,n,r,e))},e=>{s.push(this.yn(t,n,r,e))}),rs.waitFor(s)}dn(e){let r=1;return Bu(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>Tu(e,t)).filter((e,t,n)=>!t||0!==Tu(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=Tu(s,e),i=Tu(s,t);if(0===n)r[0]=e.Ue();else if(0<n&&i<0)r.push(s),r.push(s.Ue());else if(0<i)break}r.push(t);const s=[];for(let a=0;a<r.length;a+=2){if(this.pn(r[a],r[a+1]))return[];const t=[r[a].indexId,this.uid,r[a].arrayValue,r[a].directionalValue,Fu,[]],n=[r[a+1].indexId,this.uid,r[a+1].arrayValue,r[a+1].directionalValue,Fu,[]];s.push(IDBKeyRange.bound(t,n))}return s}pn(e,t){return 0<Tu(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Uu)}getMinOffset(t,e){return rs.mapArray(this.Ze(e),e=>this.tn(t,e).next(e=>e||br())).next(Uu)}}function Vu(e){return Wo(e,"collectionParents")}function Pu(e){return Wo(e,"indexEntries")}function qu(e){return Wo(e,"indexConfiguration")}function Bu(e){return Wo(e,"indexState")}function Uu(e){Er(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let s=1;s<e.length;s++){var r=e[s].indexState.offset;Zr(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new Jr(t.readTime,t.documentKey,n)}const Gu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Ku{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Ku(e,Ku.DEFAULT_COLLECTION_PERCENTILE,Ku.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function ju(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Z({range:a},(e,t,n)=>(o++,n.delete()));i.push(u.next(()=>{Er(1===o)}));const c=[];for(const e of n.mutations){const r=xo(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return rs.waitFor(i).next(()=>c)}function $u(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw br();t=e.noDocument}return JSON.stringify(t).length}Ku.DEFAULT_COLLECTION_PERCENTILE=10,Ku.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Ku.DEFAULT=new Ku(41943040,Ku.DEFAULT_COLLECTION_PERCENTILE,Ku.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Ku.DISABLED=new Ku(-1,0,0);class Qu{constructor(e,t,n,r){this.userId=e,this.yt=t,this.indexManager=n,this.referenceDelegate=r,this.In={}}static re(e,t,n,r){Er(""!==e.uid);var s=e.isAuthenticated()?e.uid:"";return new Qu(s,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Wu(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=Hu(h),m=Wu(h);return m.add({}).next(e=>{Er("number"==typeof e);const t=new Ho(e,l,d,f),n=(s=this.yt,i=this.userId,a=t,o=a.baseMutations.map(e=>ho(s.ie,e)),u=a.mutations.map(e=>ho(s.ie,e)),{userId:i,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var s,i,a,o,u;let c=new wi((e,t)=>Fr(e.canonicalString(),t.canonicalString()));for(const h of f){const l=xo(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Do))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.In[e]=t.keys()}),rs.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return Wu(e).get(t).next(e=>e?(Er(e.userId===this.userId),su(this.yt,e)):null)}Tn(e,n){return this.In[n]?rs.resolve(this.In[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.In[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Wu(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(Er(t.batchId>=r),s=su(this.yt,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Wu(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Wu(e).W("userMutationsIndex",t).next(e=>e.map(e=>su(this.yt,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=So(this.userId,o.path),t=IDBKeyRange.lowerBound(e),u=[];return Hu(a).Z({range:t},(e,t,n)=>{var[r,s,i]=e,s=To(s);if(r===this.userId&&o.path.isEqual(s))return Wu(a).get(i).next(e=>{if(!e)throw br();Er(e.userId===this.userId),u.push(su(this.yt,e))});n.done()}).next(()=>u)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new wi(Fr);const n=[];return e.forEach(a=>{var e=So(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=Hu(t).Z({range:e},(e,t,n)=>{var[r,s,i]=e,s=To(s);r===this.userId&&a.path.isEqual(s)?o=o.add(i):n.done()});n.push(e)}),rs.waitFor(n).next(()=>this.En(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=So(this.userId,a),r=IDBKeyRange.lowerBound(n);let u=new wi(Fr);return Hu(e).Z({range:r},(e,t,n)=>{var[r,s,i]=e,s=To(s);r===this.userId&&a.isPrefixOf(s)?s.length===o&&(u=u.add(i)):n.done()}).next(()=>this.En(e,u))}En(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Wu(t).get(e).next(e=>{if(null===e)throw br();Er(e.userId===this.userId),n.push(su(this.yt,e))}))}),rs.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return ju(t.se,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.An(n.batchId)}),rs.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}An(e){delete this.In[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return rs.resolve();var t=IDBKeyRange.lowerBound([this.userId]);const r=[];return Hu(n).Z({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=To(e[1]);r.push(t)}else n.done()}).next(()=>{Er(0===r.length)})})}containsKey(e,t){return zu(e,this.userId,t)}Rn(e){return Yu(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function zu(e,i,t){const n=So(i,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return Hu(e).Z({range:r,X:!0},(e,t,n)=>{var[r,s]=e;r===i&&s===a&&(o=!0),n.done()}).next(()=>o)}function Wu(e){return Wo(e,"mutations")}function Hu(e){return Wo(e,"documentMutations")}function Yu(e){return Wo(e,"mutationQueues")}class Xu{constructor(e){this.bn=e}next(){return this.bn+=2,this.bn}static Pn(){return new Xu(0)}static vn(){return new Xu(-1)}}class Ju{constructor(e,t){this.referenceDelegate=e,this.yt=t}allocateTargetId(n){return this.Vn(n).next(e=>{const t=new Xu(e.highestTargetId);return e.highestTargetId=t.next(),this.Sn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Vn(e).next(e=>qr.fromTimestamp(new Pr(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Vn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Vn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Sn(t,e)))}addTargetData(t,n){return this.Dn(t,n).next(()=>this.Vn(t).next(e=>(e.targetCount+=1,this.Cn(n,e),this.Sn(t,e))))}updateTargetData(e,t){return this.Dn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Zu(t).delete(e.targetId)).next(()=>this.Vn(t)).next(e=>(Er(0<e.targetCount),--e.targetCount,this.Sn(t,e)))}removeTargets(r,s,i){let a=0;const o=[];return Zu(r).Z((e,t)=>{var n=iu(t);n.sequenceNumber<=s&&null===i.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>rs.waitFor(o)).next(()=>a)}forEachTarget(e,r){return Zu(e).Z((e,t)=>{var n=iu(t);r(n)})}Vn(e){return ec(e).get("targetGlobalKey").next(e=>(Er(null!==e),e))}Sn(e,t){return ec(e).put("targetGlobalKey",t)}Dn(e,t){return Zu(e).put(au(this.yt,t))}Cn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Vn(e).next(e=>e.targetCount)}getTargetData(e,s){var t=Di(s),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let i=null;return Zu(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{var r=iu(t);Ai(s,r.target)&&(i=r,n.done())}).next(()=>i)}addMatchingKeys(n,e,r){const s=[],i=tc(n);return e.forEach(e=>{var t=bo(e.path);s.push(i.put({targetId:r,path:t})),s.push(this.referenceDelegate.addReference(n,r,e))}),rs.waitFor(s)}removeMatchingKeys(n,e,r){const s=tc(n);return rs.forEach(e,e=>{var t=bo(e.path);return rs.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=tc(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=tc(e);let s=Oa();return r.Z({range:n,X:!0},(e,t,n)=>{var r=To(e[1]),r=new jr(r);s=s.add(r)}).next(()=>s)}containsKey(e,t){var n=bo(t.path),n=IDBKeyRange.bound([n],[Vr(n)],!1,!0);let r=0;return tc(e).Z({index:"documentTargetsIndex",X:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}ne(e,t){return Zu(e).get(t).next(e=>e?iu(e):null)}}function Zu(e){return Wo(e,"targets")}function ec(e){return Wo(e,"targetGlobal")}function tc(e){return Wo(e,"targetDocuments")}function nc([e,t],[n,r]){var s=Fr(e,n);return 0===s?Fr(t,r):s}class rc{constructor(e){this.xn=e,this.buffer=new wi(nc),this.Nn=0}kn(){return++this.Nn}On(e){var t=[e,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();nc(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class sc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Mn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.Mn&&(this.Mn.cancel(),this.Mn=null)}get started(){return null!==this.Mn}Fn(e){yr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Mn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Mn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){us(e)?yr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ns(e)}await this.Fn(3e5)})}}class ic{constructor(e,t){this.$n=e,this.params=t}calculateTargetCount(e,t){return this.$n.Bn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return rs.resolve(ms.at);const n=new rc(t);return this.$n.forEachTarget(e,e=>n.On(e.sequenceNumber)).next(()=>this.$n.Ln(e,e=>n.On(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.$n.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.$n.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(yr("LruGarbageCollector","Garbage collection skipped; disabled"),rs.resolve(Gu)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(yr("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Gu):this.qn(t,n))}getCacheSize(e){return this.$n.getCacheSize(e)}qn(t,n){let r,s,i,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(yr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),pr()<=l.DEBUG&&yr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${s} in `+(o-a)+"ms\n"+`\tRemoved ${i} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),rs.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class ac{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new ic(e,t))}Bn(e){const n=this.Un(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Un(e){let t=0;return this.Ln(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Ln(e,n){return this.Kn(e,(e,t)=>n(t))}addReference(e,t,n){return oc(e,n)}removeReference(e,t,n){return oc(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return oc(e,t)}Gn(t,n){let r=!1;return Yu(t).tt(e=>zu(t,e,n).next(e=>(e&&(r=!0),rs.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let a=0;return this.Kn(n,(t,e)=>{if(e<=r){const r=this.Gn(n,t).next(e=>{if(!e)return a++,s.getEntry(n,t).next(()=>(s.removeEntry(t,qr.min()),tc(n).delete([0,bo(t.path)])))});i.push(r)}}).next(()=>rs.waitFor(i)).next(()=>s.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return oc(e,t)}Kn(e,r){const t=tc(e);let s,i=ms.at;return t.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==ms.at&&r(new jr(To(s)),i),i=n,s=t):i=ms.at}).next(()=>{i!==ms.at&&r(new jr(To(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function oc(e,t){return tc(e).put((e=e.currentSequenceNumber,{targetId:0,path:bo(t.path),sequenceNumber:e}))}class uc{constructor(){this.changes=new Aa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,_i.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?rs.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class cc{constructor(e){this.yt=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return fc(e).put(n)}removeEntry(e,n,t){return fc(e).delete(function(e){const t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],tu(e),t[t.length-1]]}(t))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.Qn(t,e)))}getEntry(e,n){let r=_i.newInvalidDocument(n);return fc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(gc(n))},(e,t)=>{r=this.jn(n,t)}).next(()=>r)}Wn(e,n){let r={size:0,document:_i.newInvalidDocument(n)};return fc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(gc(n))},(e,t)=>{r={document:this.jn(n,t),size:$u(t)}}).next(()=>r)}getEntries(e,t){let r=Ca;return this.zn(e,t,(e,t)=>{var n=this.jn(e,t);r=r.insert(e,n)}).next(()=>r)}Hn(e,t){let r=Ca,s=new pi(jr.comparator);return this.zn(e,t,(e,t)=>{var n=this.jn(e,t);r=r.insert(e,n),s=s.insert(e,$u(t))}).next(()=>({documents:r,Jn:s}))}zn(e,t,s){if(t.isEmpty())return rs.resolve();let n=new wi(pc);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(gc(n.first()),gc(n.last())),i=n.getIterator();let a=i.getNext();return fc(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=jr.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&pc(a,r)<0;)s(a,null),a=i.getNext();a&&a.isEqual(r)&&(s(a,t),a=i.hasNext()?i.getNext():null),a?n.j(gc(a)):n.done()}).next(()=>{for(;a;)s(a,null),a=i.hasNext()?i.getNext():null})}getAllFromCollection(e,t,n){var r=[t.popLast().toArray(),t.lastSegment(),tu(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],s=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return fc(e).W(IDBKeyRange.bound(r,s,!0)).next(e=>{let t=Ca;for(const n of e){const e=this.jn(jr.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t})}getAllFromCollectionGroup(e,t,n,s){let i=Ca;var r=mc(t,n),a=mc(t,Jr.max());return fc(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,a,!0)},(e,t,n)=>{var r=this.jn(jr.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);i=i.insert(r.key,r),i.size===s&&n.done()}).next(()=>i)}newChangeBuffer(e){return new lc(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return dc(e).get("remoteDocumentGlobalKey").next(e=>(Er(!!e),e))}Qn(e,t){return dc(e).put("remoteDocumentGlobalKey",t)}jn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=co(e.ie,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=jr.fromSegments(t.noDocument.path),s=ru(t.noDocument.readTime);n=_i.newNoDocument(e,s),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return br();{const e=jr.fromSegments(t.unknownDocument.path),i=ru(t.unknownDocument.version);n=_i.newUnknownDocument(e,i)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new Pr(t[0],t[1]),qr.fromTimestamp(r))),n;var r}(this.yt,t);if(!e.isNoDocument()||!e.version.isEqual(qr.min()))return e}return _i.newInvalidDocument(e)}}function hc(e){return new cc(e)}class lc extends uc{constructor(e,t){super(),this.Yn=e,this.trackRemovals=t,this.Xn=new Aa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const a=[];let o=0,u=new wi((e,t)=>Fr(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.Xn.get(e);if(a.push(this.Yn.removeEntry(i,e,n.readTime)),t.isValidDocument()){var r=eu(this.Yn.yt,t);u=u.add(e.path.popLast());var s=$u(r);o+=s-n.size,a.push(this.Yn.addEntry(i,e,r))}else if(o-=n.size,this.trackRemovals){const o=eu(this.Yn.yt,t.convertToNoDocument(qr.min()));a.push(this.Yn.addEntry(i,e,o))}}),u.forEach(e=>{a.push(this.Yn.indexManager.addToCollectionParentIndex(i,e))}),a.push(this.Yn.updateMetadata(i,o)),rs.waitFor(a)}getFromCache(e,t){return this.Yn.Wn(e,t).next(e=>(this.Xn.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Yn.Hn(e,t).next(({documents:n,Jn:e})=>(e.forEach((e,t)=>{this.Xn.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function dc(e){return Wo(e,"remoteDocumentGlobal")}function fc(e){return Wo(e,"remoteDocumentsV14")}function gc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function mc(e,t){const n=t.documentKey.path.toArray();return[e,tu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function pc(e,t){var n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=Fr(n[i],r[i]),s)return s;return s=Fr(n.length,r.length),s||(s=Fr(n[n.length-2],r[r.length-2]),s||Fr(n[n.length-1],r[r.length-1]))}class yc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class vc{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&pa(r.mutation,e,Ei.empty(),Pr.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,Oa()).next(()=>e))}getLocalViewOfDocuments(e,t,n=Oa()){const r=La();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=ka();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=La();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,Oa()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,s){let i=Ca;const a=La(),o=La();return t.forEach((e,t)=>{const n=r.get(t.key);s.has(t.key)&&(void 0===n||n.mutation instanceof wa)?i=i.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),pa(n.mutation,t,n.mutation.getFieldMask(),Pr.now())):a.set(t.key,Ei.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new yc(t,null!==(n=a.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(i,a){const o=La();let u=new pi((e,t)=>e-t),c=Oa();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(i,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||Ei.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||Oa()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,s=La();r.forEach(e=>{var t;c.has(e)||(null!==(t=ga(a.get(e),o.get(e)))&&s.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(i,n,s))}return rs.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,jr.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):qi(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(i,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(i,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(i,t,a.largestBatchId,o-n.size):rs.resolve(La());let r=-1,s=n;return e.next(e=>rs.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?rs.resolve():this.remoteDocumentCache.getEntry(i,t).next(e=>{s=s.insert(t,e)}))).next(()=>this.populateOverlays(i,e,n)).next(()=>this.computeViews(i,s,e,Oa())).next(e=>({batchId:r,changes:Ra(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new jr(t)).next(e=>{let t=ka();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(r,s,i){const a=s.collectionGroup;let o=ka();return this.indexManager.getCollectionParents(r,a).next(e=>rs.forEach(e,e=>{var t,n=(t=s,e=e.child(a),new Li(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.getDocumentsMatchingCollectionQuery(r,n,i).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,i,n){let a;return this.remoteDocumentCache.getAllFromCollection(t,i.path,n).next(e=>(a=e,this.documentOverlayCache.getOverlaysForCollection(t,i.path,n.largestBatchId))).next(r=>{r.forEach((e,t)=>{var n=t.getKey();null===a.get(n)&&(a=a.insert(n,_i.newInvalidDocument(n)))});let s=ka();return a.forEach((e,t)=>{var n=r.get(e);void 0!==n&&pa(n.mutation,t,Ei.empty(),Pr.now()),zi(i,t)&&(s=s.insert(e,t))}),s})}}class wc{constructor(e){this.yt=e,this.Zn=new Map,this.ts=new Map}getBundleMetadata(e,t){return rs.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){return this.Zn.set(t.id,{id:t.id,version:t.version,createTime:Za(t.createTime)}),rs.resolve()}getNamedQuery(e,t){return rs.resolve(this.ts.get(t))}saveNamedQuery(e,t){return this.ts.set(t.name,{name:(t=t).name,query:ou(t.bundledQuery),readTime:Za(t.readTime)}),rs.resolve()}}class Ic{constructor(){this.overlays=new pi(jr.comparator),this.es=new Map}getOverlay(e,t){return rs.resolve(this.overlays.get(t))}getOverlays(e,t){const n=La();return rs.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.oe(n,r,t)}),rs.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.es.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.es.delete(n)),rs.resolve()}getOverlaysForCollection(e,t,n){const r=La(),s=t.length+1,i=new jr(t.child("")),a=this.overlays.getIteratorFrom(i);for(;a.hasNext();){const e=a.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return rs.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new pi((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=La(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=La(),o=s.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return rs.resolve(a)}oe(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.es.get(r.largestBatchId).delete(n.key);this.es.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Xo(t,n));let s=this.es.get(t);void 0===s&&(s=Oa(),this.es.set(t,s)),this.es.set(t,s.add(n.key))}}class bc{constructor(){this.ns=new wi(Ec.ss),this.rs=new wi(Ec.os)}isEmpty(){return this.ns.isEmpty()}addReference(e,t){var n=new Ec(e,t);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.cs(new Ec(e,t))}hs(e,t){e.forEach(e=>this.removeReference(e,t))}ls(e){const t=new jr(new Ur([])),n=new Ec(t,e),r=new Ec(t,e+1),s=[];return this.rs.forEachInRange([n,r],e=>{this.cs(e),s.push(e.key)}),s}fs(){this.ns.forEach(e=>this.cs(e))}cs(e){this.ns=this.ns.delete(e),this.rs=this.rs.delete(e)}ds(e){var t=new jr(new Ur([])),n=new Ec(t,e),t=new Ec(t,e+1);let r=Oa();return this.rs.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Ec(e,0),t=this.ns.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class Ec{constructor(e,t){this.key=e,this._s=t}static ss(e,t){return jr.comparator(e.key,t.key)||Fr(e._s,t._s)}static os(e,t){return Fr(e._s,t._s)||jr.comparator(e.key,t.key)}}class Tc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this.gs=new wi(Ec.ss)}checkEmpty(e){return rs.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var s=this.ws;this.ws++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var i=new Ho(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.gs=this.gs.add(new Ec(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return rs.resolve(i)}lookupMutationBatch(e,t){return rs.resolve(this.ys(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.ps(t+1),n=n<0?0:n;return rs.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return rs.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return rs.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Ec(t,0),r=new Ec(t,Number.POSITIVE_INFINITY),s=[];return this.gs.forEachInRange([n,r],e=>{var t=this.ys(e._s);s.push(t)}),rs.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new wi(Fr);return t.forEach(e=>{var t=new Ec(e,0),n=new Ec(e,Number.POSITIVE_INFINITY);this.gs.forEachInRange([t,n],e=>{r=r.add(e._s)})}),rs.resolve(this.Is(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;jr.isDocumentKey(s)||(s=s.child(""));var i=new Ec(new jr(s),0);let a=new wi(Fr);return this.gs.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e._s)),!0)},i),rs.resolve(this.Is(a))}Is(e){const n=[];return e.forEach(e=>{var t=this.ys(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){Er(0===this.Ts(r.batchId,"removed")),this.mutationQueue.shift();let s=this.gs;return rs.forEach(r.mutations,e=>{var t=new Ec(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.gs=s})}An(e){}containsKey(e,t){var n=new Ec(t,0),n=this.gs.firstAfterOrEqual(n);return rs.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,rs.resolve()}Ts(e,t){return this.ps(e)}ps(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ys(e){var t=this.ps(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class _c{constructor(e){this.Es=e,this.docs=new pi(jr.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Es(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return rs.resolve(n?n.document.mutableCopy():_i.newInvalidDocument(t))}getEntries(e,t){let n=Ca;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():_i.newInvalidDocument(e))}),rs.resolve(n)}getAllFromCollection(e,t,n){let r=Ca;const s=new jr(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||Zr(Xr(s),n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return rs.resolve(r)}getAllFromCollectionGroup(e,t,n,r){br()}As(e,t){return rs.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Sc(this)}getSize(e){return rs.resolve(this.size)}}class Sc extends uc{constructor(e){super(),this.Yn=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.Yn.addEntry(n,t)):this.Yn.removeEntry(e)}),rs.waitFor(r)}getFromCache(e,t){return this.Yn.getEntry(e,t)}getAllFromCache(e,t){return this.Yn.getEntries(e,t)}}class xc{constructor(e){this.persistence=e,this.Rs=new Aa(e=>Di(e),Ai),this.lastRemoteSnapshotVersion=qr.min(),this.highestTargetId=0,this.bs=0,this.Ps=new bc,this.targetCount=0,this.vs=Xu.Pn()}forEachTarget(e,n){return this.Rs.forEach((e,t)=>n(t)),rs.resolve()}getLastRemoteSnapshotVersion(e){return rs.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return rs.resolve(this.bs)}allocateTargetId(e){return this.highestTargetId=this.vs.next(),rs.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.bs&&(this.bs=t),rs.resolve()}Dn(e){this.Rs.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.vs=new Xu(t),this.highestTargetId=t),e.sequenceNumber>this.bs&&(this.bs=e.sequenceNumber)}addTargetData(e,t){return this.Dn(t),this.targetCount+=1,rs.resolve()}updateTargetData(e,t){return this.Dn(t),rs.resolve()}removeTargetData(e,t){return this.Rs.delete(t.target),this.Ps.ls(t.targetId),--this.targetCount,rs.resolve()}removeTargets(n,r,s){let i=0;const a=[];return this.Rs.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.Rs.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),rs.waitFor(a).next(()=>i)}getTargetCount(e){return rs.resolve(this.targetCount)}getTargetData(e,t){var n=this.Rs.get(t)||null;return rs.resolve(n)}addMatchingKeys(e,t,n){return this.Ps.us(t,n),rs.resolve()}removeMatchingKeys(t,e,n){this.Ps.hs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),rs.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Ps.ls(t),rs.resolve()}getMatchingKeysForTargetId(e,t){var n=this.Ps.ds(t);return rs.resolve(n)}containsKey(e,t){return rs.resolve(this.Ps.containsKey(t))}}class Dc{constructor(e,t){this.Vs={},this.overlays={},this.Ss=new ms(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=e(this),this.Cs=new xc(this),this.indexManager=new Lu,this.remoteDocumentCache=(e=e=>this.referenceDelegate.xs(e),new _c(e)),this.yt=new Zo(t),this.Ns=new wc(this.yt)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Ic,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Vs[e.toKey()];return n||(n=new Tc(t,this.referenceDelegate),this.Vs[e.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(e,t,n){yr("MemoryPersistence","Starting transaction:",e);const r=new Ac(this.Ss.next());return this.referenceDelegate.ks(),n(r).next(e=>this.referenceDelegate.Os(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ms(t,n){return rs.or(Object.values(this.Vs).map(e=>()=>e.containsKey(t,n)))}}class Ac extends ts{constructor(e){super(),this.currentSequenceNumber=e}}class Cc{constructor(e){this.persistence=e,this.Fs=new bc,this.$s=null}static Bs(e){return new Cc(e)}get Ls(){if(this.$s)return this.$s;throw br()}addReference(e,t,n){return this.Fs.addReference(n,t),this.Ls.delete(n.toString()),rs.resolve()}removeReference(e,t,n){return this.Fs.removeReference(n,t),this.Ls.add(n.toString()),rs.resolve()}markPotentiallyOrphaned(e,t){return this.Ls.add(t.toString()),rs.resolve()}removeTarget(e,t){this.Fs.ls(t.targetId).forEach(e=>this.Ls.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Ls.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}ks(){this.$s=new Set}Os(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return rs.forEach(this.Ls,e=>{const t=jr.fromPath(e);return this.qs(n,t).next(e=>{e||r.removeEntry(t,qr.min())})}).next(()=>(this.$s=null,r.apply(n)))}updateLimboDocument(e,t){return this.qs(e,t).next(e=>{e?this.Ls.delete(t.toString()):this.Ls.add(t.toString())})}xs(e){return 0}qs(e,t){return rs.or([()=>rs.resolve(this.Fs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ms(e,t)])}}class Nc{constructor(e){this.yt=e}$(t,e,n,r){const s=new ss("createOrUpgrade",e);var i;n<1&&1<=r&&(t.createObjectStore("owner"),(i=t).createObjectStore("mutationQueues",{keyPath:"userId"}),i.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",_o,{unique:!0}),i.createObjectStore("documentMutations"),kc(t),t.createObjectStore("remoteDocuments"));let a=rs.resolve();return n<3&&3<=r&&(0!==n&&((i=t).deleteObjectStore("targetDocuments"),i.deleteObjectStore("targets"),i.deleteObjectStore("targetGlobal"),kc(t)),a=a.next(()=>function(){const e=s.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:qr.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}())),n<4&&4<=r&&(0!==n&&(a=a.next(()=>function(r,s){return s.store("mutations").W().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",_o,{unique:!0});const t=s.store("mutations"),n=e.map(e=>t.put(e));return rs.waitFor(n)})}(t,s))),a=a.next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.Us(s))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.Ks(s)))),n<7&&7<=r&&(a=a.next(()=>this.Gs(s))),n<8&&8<=r&&(a=a.next(()=>this.Qs(t,s))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.js(s))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{!function(){const e=t.createObjectStore("documentOverlays",{keyPath:qo});e.createIndex("collectionPathOverlayIndex",Bo,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",Uo,{unique:!1})}()})),n<13&&13<=r&&(a=a.next(()=>function(){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Ao});e.createIndex("documentKeyIndex",Co),e.createIndex("collectionGroupIndex",No)}()).next(()=>this.Ws(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.zs(t,s))),n<15&&15<=r&&(a=a.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Fo}).createIndex("sequenceNumberIndex",Oo,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Vo}).createIndex("documentKeyIndex",Po,{unique:!1})}(t))),a}Ks(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=$u(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}Us(r){const e=r.store("mutationQueues"),t=r.store("mutations");return e.W().next(e=>rs.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.W("userMutationsIndex",e).next(e=>rs.forEach(e,e=>{Er(e.userId===n.userId);var t=su(this.yt,e);return ju(r,n.userId,t).next(()=>{})}))}))}Gs(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(s=>{const i=[];return t.Z((e,t)=>{const n=new Ur(e),r=[0,bo(n)];i.push(a.get(r).next(e=>e?rs.resolve():(e=>a.put({targetId:0,path:bo(e),sequenceNumber:s.highestListenSequenceNumber}))(n)))}).next(()=>rs.waitFor(i))})}Qs(e,t){e.createObjectStore("collectionParents",{keyPath:Mo});const n=t.store("collectionParents"),r=new Mu,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:bo(r)})}};return t.store("remoteDocuments").Z({X:!0},(e,t)=>{const n=new Ur(e);return s(n.popLast())}).next(()=>t.store("documentMutations").Z({X:!0},([,e],t)=>{const n=To(e);return s(n.popLast())}))}js(e){const r=e.store("targets");return r.Z((e,t)=>{var n=iu(t),n=au(this.yt,n);return r.put(n)})}Ws(e,i){const t=i.store("remoteDocuments"),a=[];return t.Z((e,t)=>{const n=i.store("remoteDocumentsV14"),r=((s=t).document?new jr(Ur.fromString(s.document.name).popFirst(5)):s.noDocument?jr.fromSegments(s.noDocument.path):s.unknownDocument?jr.fromSegments(s.unknownDocument.path):br()).path.toArray();var s={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};a.push(n.put(s))}).next(()=>rs.waitFor(a))}zs(e,i){const t=i.store("mutations"),a=hc(this.yt),o=new Dc(Cc.Bs,this.yt.ie);return t.W().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:Oa();su(this.yt,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),rs.forEach(r,(e,t)=>{var n=new fr(t),r=gu.re(this.yt,n),s=o.getIndexManager(n),n=Qu.re(n,this.yt,s,o.referenceDelegate);return new vc(a,n,r,s).recalculateAndSaveOverlaysForDocumentKeys(new zo(i,ms.at),e).next()})})}}function kc(e){e.createObjectStore("targetDocuments",{keyPath:Ro}).createIndex("documentTargetsIndex",Lo,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",ko,{unique:!0}),e.createObjectStore("targetGlobal")}const Rc="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Lc{constructor(e,t,n,r,s,i,a,o,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Hs=s,this.window=i,this.document=a,this.Js=u,this.Ys=c,this.Xs=h,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=e=>Promise.resolve(),!Lc.C())throw new _r(Tr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ac(this,r),this.ii=t+"main",this.yt=new Zo(o),this.ri=new is(this.ii,this.Xs,new Nc(this.yt)),this.Cs=new Ju(this.referenceDelegate,this.yt),this.remoteDocumentCache=hc(this.yt),this.Ns=new lu,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===c&&vr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new _r(Tr.FAILED_PRECONDITION,Rc);return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Cs.getHighestSequenceNumber(e))}).then(e=>{this.Ss=new ms(e,this.Js)}).then(()=>{this.Ds=!0}).catch(e=>(this.ri&&this.ri.close(),Promise.reject(e)))}li(t){return this.si=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ri.L(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Hs.enqueueAndForget(async()=>{this.started&&await this.ui()}))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>Fc(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.Hs.enqueueRetryable(()=>this.si(!1)))})}).next(()=>this.di(t)).next(e=>this.isPrimary&&!e?this._i(t).next(()=>!1):!!e&&this.wi(t).next(()=>!0))).catch(e=>{if(us(e))return yr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return yr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Hs.enqueueRetryable(()=>this.si(e)),this.isPrimary=e})}fi(e){return Mc(e).get("owner").next(e=>rs.resolve(this.mi(e)))}gi(e){return Fc(e).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=Wo(e,"clientMetadata");return r.W().next(e=>{const t=this.Ii(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return rs.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.oi)for(const t of e)this.oi.removeItem(this.Ti(t.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.ui().then(()=>this.yi()).then(()=>this.hi()))}mi(e){return!!e&&e.ownerId===this.clientId}di(t){return this.Ys?rs.resolve(!0):Mc(t).get("owner").next(e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)){if(this.mi(e)&&this.networkEnabled)return!0;if(!this.mi(e)){if(!e.allowTabSynchronization)throw new _r(Tr.FAILED_PRECONDITION,Rc);return!1}}return!(!this.networkEnabled||!this.inForeground)||Fc(t).W().next(e=>void 0===this.Ii(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&yr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new zo(e,ms.at);return this._i(t).next(()=>this.gi(t))}),this.ri.close(),this.Pi()}Ii(e,t){return e.filter(e=>this.pi(e.updateTimeMs,t)&&!this.Ei(e.clientId))}vi(){return this.runTransaction("getActiveClients","readonly",e=>Fc(e).W().next(e=>this.Ii(e,18e5).map(e=>e.clientId)))}get started(){return this.Ds}getMutationQueue(e,t){return Qu.re(e,this.yt,t,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Ou(e,this.yt.ie.databaseId)}getDocumentOverlayCache(e){return gu.re(this.yt,e)}getBundleCache(){return this.Ns}runTransaction(t,n,r){yr("IndexedDbPersistence","Starting transaction:",t);var e,s="readonly"===n?"readonly":"readwrite",e=15===(e=this.Xs)?Qo:14===e?$o:13===e?jo:12===e?Ko:11===e?Go:void br();let i;return this.ri.runTransaction(t,s,e,e=>(i=new zo(e,this.Ss?this.Ss.next():ms.at),"readwrite-primary"===n?this.fi(i).next(e=>!!e||this.di(i)).next(e=>{if(!e)throw vr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable(()=>this.si(!1)),new _r(Tr.FAILED_PRECONDITION,es);return r(i)}).next(e=>this.wi(i).next(()=>e)):this.Vi(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Vi(e){return Mc(e).get("owner").next(e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)&&!this.mi(e)&&!(this.Ys||this.allowTabSynchronization&&e.allowTabSynchronization))throw new _r(Tr.FAILED_PRECONDITION,Rc)})}wi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Mc(e).put("owner",t)}static C(){return is.C()}_i(e){const t=Mc(e);return t.get("owner").next(e=>this.mi(e)?(yr("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):rs.resolve())}pi(e,t){var n=Date.now();return!(e<n-t||n<e&&(vr(`Detected an update time that is in the future: ${e} > ${n}`),1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.ui()))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Zs=()=>{this.Ai(),c()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(e){var t;try{var n=null!==(null===(t=this.oi)||void 0===t?void 0:t.getItem(this.Ti(e)));return yr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return vr("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(e){vr("Failed to set zombie client id.",e)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(e){}}Ti(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Mc(e){return Wo(e,"owner")}function Fc(e){return Wo(e,"clientMetadata")}function Oc(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Vc{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Si=n,this.Di=r}static Ci(e,t){let n=Oa(),r=Oa();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Vc(e,t.fromCache,n,r)}}class Pc{constructor(){this.xi=!1}initialize(e,t){this.Ni=e,this.indexManager=t,this.xi=!0}getDocumentsMatchingQuery(t,n,r,s){return this.ki(t,n).next(e=>e||this.Oi(t,n,s,r)).next(e=>e||this.Mi(t,n))}ki(s,i){if(Oi(i))return rs.resolve(null);let t=Ui(i);return this.indexManager.getIndexType(s,t).next(e=>0===e?null:(null!==i.limit&&1===e&&(i=Ki(i,null,"F"),t=Ui(i)),this.indexManager.getDocumentsMatchingTarget(s,t).next(e=>{const r=Oa(...e);return this.Ni.getDocuments(s,r).next(n=>this.indexManager.getMinOffset(s,t).next(e=>{var t=this.Fi(i,n);return this.$i(i,t,r,e.readTime)?this.ki(s,Ki(i,null,"F")):this.Bi(s,t,i,e)}))})))}Oi(n,r,s,i){return Oi(r)||i.isEqual(qr.min())?this.Mi(n,r):this.Ni.getDocuments(n,s).next(e=>{var t=this.Fi(r,e);return this.$i(r,t,s,i)?this.Mi(n,r):(pr()<=l.DEBUG&&yr("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Qi(r)),this.Bi(n,t,r,Yr(i,-1)))})}Fi(n,e){let r=new wi(Hi(n));return e.forEach((e,t)=>{zi(n,t)&&(r=r.add(t))}),r}$i(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Mi(e,t){return pr()<=l.DEBUG&&yr("QueryEngine","Using full collection scan to execute query:",Qi(t)),this.Ni.getDocumentsMatchingQuery(e,t,Jr.min())}Bi(e,n,t,r){return this.Ni.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class qc{constructor(e,t,n,r){this.persistence=e,this.Li=t,this.yt=r,this.qi=new pi(Fr),this.Ui=new Aa(e=>Di(e),Ai),this.Ki=new Map,this.Gi=e.getRemoteDocumentCache(),this.Cs=e.getTargetCache(),this.Ns=e.getBundleCache(),this.Qi(n)}Qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new vc(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.qi))}}function Bc(e,t,n,r){return new qc(e,t,n,r)}async function Uc(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",s=>{let i;return a.mutationQueue.getAllMutationBatches(s).next(e=>(i=e,a.Qi(t),a.mutationQueue.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=Oa();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(s,r).next(e=>({ji:e,removedBatchIds:t,addedBatchIds:n}))})})}function Gc(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Cs.getLastRemoteSnapshotVersion(e))}function Kc(e,c){const h=e,l=c.snapshotVersion;let d=h.qi;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.Gi.newChangeBuffer({trackRemovals:!0});d=h.qi;const u=[];c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.Cs.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.Cs.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var s,i,a;c.targetMismatches.has(n)?e=e.withResumeToken(_s.EMPTY_BYTE_STRING,qr.min()).withLastLimboFreeSnapshotVersion(qr.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),s=r,i=e,a=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.Cs.updateTargetData(o,e))}});let t=Ca,n=Oa();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(jc(o,e,c.documentUpdates).next(e=>{t=e.Wi,n=e.zi})),!l.isEqual(qr.min())){const c=h.Cs.getLastRemoteSnapshotVersion(o).next(e=>h.Cs.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return rs.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.qi=d,e))}function jc(e,i,t){let n=Oa(),a=Oa();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=Ca;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(qr.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):yr("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{Wi:s,zi:a}})}function $c(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.Cs.getTargetData(t,r).next(e=>e?(n=e,rs.resolve(n)):s.Cs.allocateTargetId(t).next(e=>(n=new Jo(r,e,0,t.currentSequenceNumber),s.Cs.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.qi.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.qi=s.qi.insert(e.targetId,e),s.Ui.set(r,e.targetId)),e})}async function Qc(e,t,n){const r=e,s=r.qi.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!us(e))throw e;yr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.qi=r.qi.remove(t),r.Ui.delete(s.target)}function zc(e,n,r){const s=e;let i=qr.min(),a=Oa();return s.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=e,s=r.Ui.get(n);return void 0!==s?rs.resolve(r.qi.get(s)):r.Cs.getTargetData(t,n)}(s,t,Ui(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Cs.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>s.Li.getDocumentsMatchingQuery(t,n,r?i:qr.min(),r?a:Oa())).next(e=>(Yc(s,Wi(n),e),{documents:e,Hi:a})))}function Wc(e,t){const n=e,r=n.Cs,s=n.qi.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.ne(e,t).next(e=>e?e.target:null))}function Hc(e,t){const n=e,r=n.Ki.get(t)||qr.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Gi.getAllFromCollectionGroup(e,t,Yr(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(Yc(n,t,e),e))}function Yc(e,t,n){let r=e.Ki.get(t)||qr.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Ki.set(t,r)}function Xc(e,t){return`firestore_clients_${e}_${t}`}function Jc(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Zc(e,t){return`firestore_targets_${e}_${t}`}class eh{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Zi(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new _r(r.error.code,r.error.message))),i?new eh(e,t,r.state,s):(vr("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class th{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Zi(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new _r(n.error.code,n.error.message))),s?new th(e,n.state,r):(vr("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class nh{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Zi(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Va;for(let i=0;r&&i<n.activeTargetIds.length;++i)r=Ts(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new nh(e,s):(vr("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class rh{constructor(e,t){this.clientId=e,this.onlineState=t}static Zi(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new rh(t.clientId,t.onlineState):(vr("SharedClientState",`Failed to parse online state: ${e}`),null)}}class sh{constructor(){this.activeTargetIds=Va}er(e){this.activeTargetIds=this.activeTargetIds.add(e)}nr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}tr(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class ih{constructor(e,t,n,r,s){this.window=e,this.Hs=t,this.persistenceKey=n,this.sr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new pi(Fr),this.started=!1,this.cr=[];var i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ar=Xc(this.persistenceKey,this.sr),this.hr=`firestore_sequence_number_${this.persistenceKey}`,this.ur=this.ur.insert(this.sr,new sh),this.lr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.wr=`firestore_online_state_${this.persistenceKey}`,this.mr=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.ir)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.vi();for(const n of e)if(n!==this.sr){const e=this.getItem(Xc(this.persistenceKey,n));var t;!e||(t=nh.Zi(n,e))&&(this.ur=this.ur.insert(t.clientId,t))}this.gr();const n=this.storage.getItem(this.wr);if(n){const e=this.yr(n);e&&this.pr(e)}for(const e of this.cr)this.rr(e);this.cr=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.hr,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(n){let r=!1;return this.ur.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Tr(e,"pending")}updateMutationState(e,t,n){this.Tr(e,t,n),this.Er(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(Zc(this.persistenceKey,e)))||(n=th.Zi(e,n))&&(t=n.state)),this.Ar.er(e),this.gr(),t}removeLocalQueryTarget(e){this.Ar.nr(e),this.gr()}isLocalQueryTarget(e){return this.Ar.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Zc(this.persistenceKey,e))}updateQueryState(e,t,n){this.Rr(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Er(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.br(e)}notifyBundleLoaded(e){this.Pr(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return yr("SharedClientState","READ",e,t),t}setItem(e,t){yr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){yr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}rr(e){const s=e;s.storageArea===this.storage&&(yr("SharedClientState","EVENT",s.key,s.newValue),s.key!==this.ar?this.Hs.enqueueRetryable(async()=>{if(this.started){if(null!==s.key)if(this.lr.test(s.key)){if(null==s.newValue){var e=this.vr(s.key);return this.Vr(e,null)}e=this.Sr(s.key,s.newValue);if(e)return this.Vr(e.clientId,e)}else if(this.dr.test(s.key)){if(null!==s.newValue){var t=this.Dr(s.key,s.newValue);if(t)return this.Cr(t)}}else if(this._r.test(s.key)){if(null!==s.newValue){t=this.Nr(s.key,s.newValue);if(t)return this.kr(t)}}else if(s.key===this.wr){if(null!==s.newValue){var n=this.yr(s.newValue);if(n)return this.pr(n)}}else if(s.key===this.hr){n=function(e){let t=ms.at;if(null!=e)try{var n=JSON.parse(e);Er("number"==typeof n),t=n}catch(e){vr("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(s.newValue);n!==ms.at&&this.sequenceNumberHandler(n)}else if(s.key===this.mr){const r=this.Or(s.newValue);await Promise.all(r.map(e=>this.syncEngine.Mr(e)))}}else this.cr.push(s)}):vr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(e,t,n){const r=new eh(this.currentUser,e,t,n),s=Jc(this.persistenceKey,this.currentUser,e);this.setItem(s,r.tr())}Er(e){var t=Jc(this.persistenceKey,this.currentUser,e);this.removeItem(t)}br(e){var t={clientId:this.sr,onlineState:e};this.storage.setItem(this.wr,JSON.stringify(t))}Rr(e,t,n){const r=Zc(this.persistenceKey,e),s=new th(e,t,n);this.setItem(r,s.tr())}Pr(e){var t=JSON.stringify(Array.from(e));this.setItem(this.mr,t)}vr(e){var t=this.lr.exec(e);return t?t[1]:null}Sr(e,t){var n=this.vr(e);return nh.Zi(n,t)}Dr(e,t){var n=this.dr.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return eh.Zi(new fr(n),r,t)}Nr(e,t){var n=this._r.exec(e),n=Number(n[1]);return th.Zi(n,t)}yr(e){return rh.Zi(e)}Or(e){return JSON.parse(e)}async Cr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Fr(e.batchId,e.state,e.error);yr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}kr(e){return this.syncEngine.$r(e.targetId,e.state,e.error)}Vr(e,t){const n=t?this.ur.insert(e,t):this.ur.remove(e),r=this.Ir(this.ur),s=this.Ir(n),i=[],a=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||a.push(e)}),this.syncEngine.Br(i,a).then(()=>{this.ur=n})}pr(e){this.ur.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ir(e){let n=Va;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class ah{constructor(){this.Lr=new sh,this.qr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Lr.er(e),this.qr[e]||"not-current"}updateQueryState(e,t,n){this.qr[e]=t}removeLocalQueryTarget(e){this.Lr.nr(e)}isLocalQueryTarget(e){return this.Lr.activeTargetIds.has(e)}clearQueryState(e){delete this.qr[e]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(e){return this.Lr.activeTargetIds.has(e)}start(){return this.Lr=new sh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class oh{Ur(e){}shutdown(){}}class uh{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}Ur(e){this.Wr.push(e)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){yr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Wr)e(0)}jr(){yr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Wr)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const ch={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class hh{constructor(e){this.Hr=e.Hr,this.Jr=e.Jr}Yr(e){this.Xr=e}Zr(e){this.eo=e}onMessage(e){this.no=e}close(){this.Jr()}send(e){this.Hr(e)}so(){this.Xr()}io(e){this.eo(e)}ro(e){this.no(e)}}class lh extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.oo=t+"://"+e.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get co(){return!1}ao(t,e,n,r,s){const i=this.ho(t,e);yr("RestConnection","Sending: ",i,n);var a={};return this.lo(a,r,s),this.fo(t,i,a,n).then(e=>(yr("RestConnection","Received: ",e),e),e=>{throw wr("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e})}_o(e,t,n,r,s,i){return this.ao(e,t,n,r,s)}lo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+gr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}ho(e,t){var n=ch[e];return`${this.oo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}fo(o,t,n,r){return new Promise((s,i)=>{const a=new lr;a.setWithCredentials(!0),a.listenOnce(ir.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case sr.NO_ERROR:var e=a.getResponseJson();yr("Connection","XHR received:",JSON.stringify(e)),s(e);break;case sr.TIMEOUT:yr("Connection",'RPC "'+o+'" timed out'),i(new _r(Tr.DEADLINE_EXCEEDED,"Request time out"));break;case sr.HTTP_ERROR:var t=a.getStatus();if(yr("Connection",'RPC "'+o+'" failed with status:',t,"response text:",a.getResponseText()),0<t){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);var n=null==e?void 0:e.error;if(n&&n.status&&n.message){const o=(r=n.status.toLowerCase().replace(/_/g,"-"),0<=Object.values(Tr).indexOf(r)?r:Tr.UNKNOWN);i(new _r(o,n.message))}else i(new _r(Tr.UNKNOWN,"Server responded with status "+a.getStatus()))}else i(new _r(Tr.UNAVAILABLE,"Connection failed."));break;default:br()}}finally{yr("Connection",'RPC "'+o+'" completed.')}var r});var e=JSON.stringify(r);a.send(t,"POST",e,n,15)})}wo(e,t,n){const r=[this.oo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=new Xn,i=rr(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new cr({})),this.lo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;var o=r.join("");yr("Connection","Creating WebChannel: "+o,a);const u=s.createWebChannel(o,a);let c=!1,h=!1;const l=new hh({Hr:e=>{h?yr("Connection","Not sending because WebChannel is closed:",e):(c||(yr("Connection","Opening WebChannel transport."),u.open(),c=!0),yr("Connection","WebChannel sending:",e),u.send(e))},Jr:()=>u.close()}),d=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return d(u,hr.EventType.OPEN,()=>{h||yr("Connection","WebChannel transport opened.")}),d(u,hr.EventType.CLOSE,()=>{h||(h=!0,yr("Connection","WebChannel transport closed"),l.io())}),d(u,hr.EventType.ERROR,e=>{h||(h=!0,wr("Connection","WebChannel transport errored:",e),l.io(new _r(Tr.UNAVAILABLE,"The operation could not be completed")))}),d(u,hr.EventType.MESSAGE,n=>{if(!h){var e=n.data[0];Er(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){yr("Connection","WebChannel received error:",r);const n=r.status;let e=function(e){var t=nr[e];if(void 0!==t)return Da(t)}(n),t=r.message;void 0===e&&(e=Tr.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),h=!0,l.io(new _r(e,t)),u.close()}else yr("Connection","WebChannel received:",e),l.ro(e)}}),d(i,ar.STAT_EVENT,e=>{e.stat===or?yr("Connection","Detected buffering proxy"):e.stat===ur&&yr("Connection","Detected no buffering proxy")}),setTimeout(()=>{l.so()},0),l}}function dh(){return"undefined"!=typeof window?window:null}function fh(){return"undefined"!=typeof document?document:null}function gh(e){return new Ya(e,!0)}class mh{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Hs=e,this.timerId=t,this.mo=n,this.yo=r,this.po=s,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(e){this.cancel();var t=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),r=Math.max(0,t-n);0<r&&yr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Io} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.To=this.Hs.enqueueAfterDelay(this.timerId,r,()=>(this.Eo=Date.now(),e())),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class ph{constructor(e,t,n,r,s,i,a,o){this.Hs=e,this.vo=n,this.Vo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new mh(e,t)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.No()&&await this.close(0)}Mo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.vo,6e4,()=>this.$o()))}Bo(e){this.Lo(),this.stream.send(e)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}qo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(e,t){this.Lo(),this.qo(),this.xo.cancel(),this.So++,4!==e?this.xo.reset():t&&t.code===Tr.RESOURCE_EXHAUSTED?(vr(t.toString()),vr("Using maximum backoff delay to prevent overloading the backend."),this.xo.Ao()):t&&t.code===Tr.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Uo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}Uo(){}auth(){this.state=1;const e=this.Ko(this.So),n=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.So===n&&this.Go(e,t)},t=>{e(()=>{var e=new _r(Tr.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Qo(e)})})}Go(e,t){const n=this.Ko(this.So);this.stream=this.jo(e,t),this.stream.Yr(()=>{n(()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.Vo,1e4,()=>(this.ko()&&(this.state=3),Promise.resolve())),this.listener.Yr()))}),this.stream.Zr(e=>{n(()=>this.Qo(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Oo(){this.state=5,this.xo.Ro(async()=>{this.state=0,this.start()})}Qo(e){return yr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Ko(t){return e=>{this.Hs.enqueueAndForget(()=>this.So===t?e():(yr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class yh extends ph{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.yt=s}jo(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.xo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:br(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.wt?(Er(void 0===f||"string"==typeof f),_s.fromBase64String(f||"")):(Er(void 0===f||f instanceof Uint8Array),_s.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?Tr.UNKNOWN:Da(f.code),new _r(o,f.message||""));n=new Ga(r,s,i,o||null)}else if("documentChange"in t){t.documentChange;var u=t.documentChange;u.document,u.document.name,u.document.updateTime;var i=ro(e,u.document.name),o=Za(u.document.updateTime),c=u.document.createTime?Za(u.document.createTime):qr.min(),h=new Ti({mapValue:{fields:u.document.fields}}),c=_i.newFoundDocument(i,o,c,h),h=u.targetIds||[],u=u.removedTargetIds||[];n=new Ba(h,u,c.key,c)}else if("documentDelete"in t){t.documentDelete;h=t.documentDelete;h.document;u=ro(e,h.document),c=h.readTime?Za(h.readTime):qr.min(),c=_i.newNoDocument(u,c),h=h.removedTargetIds||[];n=new Ba([],h,c.key,c)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=ro(e,l.document),l=l.removedTargetIds||[];n=new Ba([],l,d,null)}else{if(!("filter"in t))return br();{t.filter;const e=t.filter;e.targetId;l=e.count||0,d=new Sa(l),l=e.targetId;n=new Ua(l,d)}}var o,f;return n}(this.yt,e),n=function(e){if(!("targetChange"in e))return qr.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?Za(t.readTime):qr.min()}(e);return this.listener.Wo(t,n)}zo(e){const t={};t.database=ao(this.yt),t.addTarget=function(e,t){let n;var r=t.target;return n=Ci(r)?{documents:fo(e,r)}:{query:go(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()?n.resumeToken=Ja(e,t.resumeToken):0<t.snapshotVersion.compareTo(qr.min())&&(n.readTime=Xa(e,t.snapshotVersion.toTimestamp())),n}(this.yt,e);var n,r,r=(this.yt,n=e,null==(r=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return br()}}())?null:{"goog-listen-tags":r});r&&(t.labels=r),this.Bo(t)}Ho(e){const t={};t.database=ao(this.yt),t.removeTarget=e,this.Bo(t)}}class vh extends ph{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.yt=s,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}Uo(){this.Jo&&this.Xo([])}jo(e,t){return this.connection.wo("Write",e,t)}onMessage(e){if(Er(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Jo){this.xo.reset();var t=(r=e.writeResults,s=e.commitTime,r&&0<r.length?(Er(void 0!==s),r.map(e=>function(e,t){let n=e.updateTime?Za(e.updateTime):Za(t);return n.isEqual(qr.min())&&(n=Za(t)),new ha(n,e.transformResults||[])}(e,s))):[]),n=Za(e.commitTime);return this.listener.Zo(n,t)}var r,s;return Er(!e.writeResults||0===e.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const e={};e.database=ao(this.yt),this.Bo(e)}Xo(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>ho(this.yt,e))};this.Bo(t)}}class wh extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.yt=r,this.nu=!1}su(){if(this.nu)throw new _r(Tr.FAILED_PRECONDITION,"The client has already been terminated.")}ao(n,r,s){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.ao(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Tr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _r(Tr.UNKNOWN,e.toString())})}_o(n,r,s,i){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection._o(n,r,s,e,t,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Tr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _r(Tr.UNKNOWN,e.toString())})}terminate(){this.nu=!0}}class Ih{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve())))}hu(e){"Online"===this.state?this.cu("Unknown"):(this.iu++,1<=this.iu&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.cu("Offline")))}set(e){this.lu(),this.iu=0,"Online"===e&&(this.ou=!1),this.cu(e)}cu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}au(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(vr(t),this.ou=!1):yr("OnlineStateTracker",t)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class bh{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=s,this.mu.Ur(e=>{n.enqueueAndForget(async()=>{Nh(this)&&(yr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t._u.add(4),await Th(t),t.gu.set("Unknown"),t._u.delete(4),await Eh(t)}(this))})}),this.gu=new Ih(n,r)}}async function Eh(e){if(Nh(e))for(const t of e.wu)await t(!0)}async function Th(e){for(const t of e.wu)await t(!1)}function _h(e,t){const n=e;n.du.has(t.targetId)||(n.du.set(t.targetId,t),Ch(n)?Ah(n):qh(n).ko()&&xh(n,t))}function Sh(e,t){const n=e,r=qh(n);n.du.delete(t),r.ko()&&Dh(n,t),0===n.du.size&&(r.ko()?r.Fo():Nh(n)&&n.gu.set("Unknown"))}function xh(e,t){e.yu.Ot(t.targetId),qh(e).zo(t)}function Dh(e,t){e.yu.Ot(t),qh(e).Ho(t)}function Ah(t){t.yu=new ja({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),ne:e=>t.du.get(e)||null}),qh(t).start(),t.gu.uu()}function Ch(e){return Nh(e)&&!qh(e).No()&&0<e.du.size}function Nh(e){return 0===e._u.size}function kh(e){e.yu=void 0}async function Rh(e,t,n){if(!us(t))throw t;e._u.add(1),await Th(e),e.gu.set("Offline"),n=n||(()=>Gc(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{yr("RemoteStore","Retrying IndexedDB access"),await n(),e._u.delete(1),await Eh(e)})}function Lh(t,n){return n().catch(e=>Rh(t,e,n))}async function Mh(e){const t=e,n=Bh(t);let r=0<t.fu.length?t.fu[t.fu.length-1].batchId:-1;for(;Nh(s=t)&&s.fu.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.fu.length&&n.Fo();break}r=e.batchId,function(e,t){e.fu.push(t);const n=Bh(e);n.ko()&&n.Yo&&n.Xo(t.mutations)}(t,e)}catch(e){await Rh(t,e)}var s;Fh(t)&&Oh(t)}function Fh(e){return Nh(e)&&!Bh(e).No()&&0<e.fu.length}function Oh(e){Bh(e).start()}async function Vh(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),yr("RemoteStore","RemoteStore received new credentials");var r=Nh(n);n._u.add(3),await Th(n),r&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n._u.delete(3),await Eh(n)}async function Ph(e,t){const n=e;t?(n._u.delete(2),await Eh(n)):(n._u.add(2),await Th(n),n.gu.set("Unknown"))}function qh(t){return t.pu||(t.pu=function(e,t,n){const r=e;return r.su(),new yh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.yt,n)}(t.datastore,t.asyncQueue,{Yr:(async function(n){n.du.forEach((e,t)=>{xh(n,e)})}).bind(null,t),Zr:(async function(e,t){kh(e),Ch(e)?(e.gu.hu(t),Ah(e)):e.gu.set("Unknown")}).bind(null,t),Wo:(async function(e,r,t){if(e.gu.set("Online"),r instanceof Ga&&2===r.state&&r.cause)try{await async function(e){var t=r.cause;for(const n of r.targetIds)e.du.has(n)&&(await e.remoteSyncer.rejectListen(n,t),e.du.delete(n),e.yu.removeTarget(n))}(e)}catch(t){yr("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),t),await Rh(e,t)}else if(r instanceof Ba?e.yu.Kt(r):r instanceof Ua?e.yu.Jt(r):e.yu.jt(r),!t.isEqual(qr.min()))try{const r=await Gc(e.localStore);0<=t.compareTo(r)&&await function(r,s){const e=r.yu.Zt(s);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=r.du.get(t);n&&r.du.set(t,n.withResumeToken(e.resumeToken,s))}}),e.targetMismatches.forEach(e=>{const t=r.du.get(e);var n;t&&(r.du.set(e,t.withResumeToken(_s.EMPTY_BYTE_STRING,t.snapshotVersion)),Dh(r,e),n=new Jo(t.target,e,1,t.sequenceNumber),xh(r,n))}),r.remoteSyncer.applyRemoteEvent(e)}(e,t)}catch(r){yr("RemoteStore","Failed to raise snapshot:",r),await Rh(e,r)}}).bind(null,t)}),t.wu.push(async e=>{e?(t.pu.Mo(),Ch(t)?Ah(t):t.gu.set("Unknown")):(await t.pu.stop(),kh(t))})),t.pu}function Bh(t){return t.Iu||(t.Iu=function(e,t,n){const r=e;return r.su(),new vh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.yt,n)}(t.datastore,t.asyncQueue,{Yr:(async function(e){Bh(e).eu()}).bind(null,t),Zr:(async function(e,t){t&&Bh(e).Yo&&await async function(e,t){if(xa(n=t.code)&&n!==Tr.ABORTED){const n=e.fu.shift();Bh(e).Mo(),await Lh(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await Mh(e)}var n}(e,t),Fh(e)&&Oh(e)}).bind(null,t),tu:(async function(e){const t=Bh(e);for(const n of e.fu)t.Xo(n.mutations)}).bind(null,t),Zo:(async function(e,t,n){const r=e.fu.shift(),s=Yo.from(r,t,n);await Lh(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await Mh(e)}).bind(null,t)}),t.wu.push(async e=>{e?(t.Iu.Mo(),await Mh(t)):(await t.Iu.stop(),0<t.fu.length&&(yr("RemoteStore",`Stopping write stream with ${t.fu.length} pending writes`),t.fu=[]))})),t.Iu}class Uh{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Sr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,a=new Uh(e,t,i,r,s);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new _r(Tr.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Gh(e,t){if(vr("AsyncQueue",`${t}: ${e}`),us(e))return new _r(Tr.UNAVAILABLE,`${t}: ${e}`);throw e}class Kh{constructor(n){this.comparator=n?(e,t)=>n(e,t)||jr.comparator(e.key,t.key):(e,t)=>jr.comparator(e.key,t.key),this.keyedMap=ka(),this.sortedSet=new pi(this.comparator)}static emptySet(e){return new Kh(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Kh))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new Kh;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class jh{constructor(){this.Tu=new pi(jr.comparator)}track(e){var t=e.doc.key,n=this.Tu.get(t);!n||0!==e.type&&3===n.type?this.Tu=this.Tu.insert(t,e):3===e.type&&1!==n.type?this.Tu=this.Tu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Tu=this.Tu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Tu=this.Tu.remove(t):1===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):br()}Eu(){const n=[];return this.Tu.inorderTraversal((e,t)=>{n.push(t)}),n}}class $h{constructor(e,t,n,r,s,i,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new $h(e,t,Kh.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&ji(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Qh{constructor(){this.Au=void 0,this.listeners=[]}}class zh{constructor(){this.queries=new Aa(e=>$i(e),ji),this.onlineState="Unknown",this.Ru=new Set}}async function Wh(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Qh),s)try{i.Au=await n.onListen(r)}catch(e){const n=Gh(e,`Initialization of query '${Qi(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.bu(n.onlineState),!i.Au||t.Pu(i.Au)&&Yh(n)}async function Hh(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Yh(e){e.Ru.forEach(e=>{e.next()})}class Xh{constructor(e,t,n){this.query=e,this.vu=t,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new $h(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Vu?this.Du(e)&&(this.vu.next(e),t=!0):this.Cu(e,this.onlineState)&&(this.xu(e),t=!0),this.Su=e,t}onError(e){this.vu.error(e)}bu(e){this.onlineState=e;let t=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,e)&&(this.xu(this.Su),t=!0),t}Cu(e,t){return!e.fromCache||(!this.options.Nu||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Du(e){if(0<e.docChanges.length)return!0;var t=this.Su&&this.Su.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}xu(e){e=$h.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Vu=!0,this.vu.next(e)}}class Jh{constructor(e,t){this.ku=e,this.byteLength=t}Ou(){return"metadata"in this.ku}}class Zh{constructor(e){this.yt=e}Ji(e){return ro(this.yt,e)}Yi(e){return e.metadata.exists?co(this.yt,e.document,!1):_i.newNoDocument(this.Ji(e.metadata.name),this.Xi(e.metadata.readTime))}Xi(e){return Za(e)}}class el{constructor(e,t,n){this.Mu=e,this.localStore=t,this.yt=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=tl(e)}Fu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ku.namedQuery)this.queries.push(e.ku.namedQuery);else if(e.ku.documentMetadata){this.documents.push({metadata:e.ku.documentMetadata}),e.ku.documentMetadata.exists||++t;const n=Ur.fromString(e.ku.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.ku.document&&(this.documents[this.documents.length-1].document=e.ku.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}$u(e){const t=new Map,n=new Zh(this.yt);for(const s of e)if(s.metadata.queries){const e=n.Ji(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||Oa()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=Oa(),a=Ca;for(const e of n){const n=t.Ji(e.metadata.name);e.document&&(i=i.add(n));const c=t.Yi(e);c.setReadTime(t.Xi(e.metadata.readTime)),a=a.insert(n,c)}const o=s.Gi.newChangeBuffer({trackRemovals:!0}),u=await $c(s,(r=r,Ui(Fi(Ur.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>jc(t,o,a).next(e=>(o.apply(t),e)).next(e=>s.Cs.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.Cs.addMatchingKeys(t,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(t,e.Wi,e.zi)).next(()=>e.Wi)))}(this.localStore,new Zh(this.yt),this.documents,this.Mu.id),t=this.$u(this.documents);for(const e of this.queries)await async function(e,n,r=Oa()){const s=await $c(e,Ui(ou(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=Za(n.readTime);if(0<=s.snapshotVersion.compareTo(t))return i.Ns.saveNamedQuery(e,n);t=s.withResumeToken(_s.EMPTY_BYTE_STRING,t);return i.qi=i.qi.insert(t.targetId,t),i.Cs.updateTargetData(e,t).next(()=>i.Cs.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.Cs.addMatchingKeys(e,r,s.targetId)).next(()=>i.Ns.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Bu:this.collectionGroups,Lu:e}}}function tl(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class nl{constructor(e){this.key=e}}class rl{constructor(e){this.key=e}}class sl{constructor(e,t){this.query=e,this.qu=t,this.Uu=null,this.hasCachedResults=!1,this.current=!1,this.Ku=Oa(),this.mutatedKeys=Oa(),this.Gu=Hi(e),this.Qu=new Kh(this.Gu)}get ju(){return this.qu}Wu(e,t){const o=t?t.zu:new jh,u=(t||this).Qu;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=zi(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(o.track({type:3,doc:r}),a=!0):this.Hu(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.Gu(r,d)||f&&this.Gu(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),i?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{Qu:h,zu:o,$i:l,mutatedKeys:c}}Hu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.Qu;this.Qu=e.Qu,this.mutatedKeys=e.mutatedKeys;const s=e.zu.Eu();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return br()}};return n(e)-n(t)}(e.type,t.type)||this.Gu(e.doc,t.doc)),this.Ju(n);var i=t?this.Yu():[],a=0===this.Ku.size&&this.current?1:0,o=a!==this.Uu;return this.Uu=a,0!==s.length||o?{snapshot:new $h(this.query,e.Qu,r,s,e.mutatedKeys,0==a,o,!1,!!n&&0<n.resumeToken.approximateByteSize()),Xu:i}:{Xu:i}}bu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new jh,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Xu:[]}}Zu(e){return!this.qu.has(e)&&!!this.Qu.has(e)&&!this.Qu.get(e).hasLocalMutations}Ju(e){e&&(e.addedDocuments.forEach(e=>this.qu=this.qu.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.qu=this.qu.delete(e)),this.current=e.current)}Yu(){if(!this.current)return[];const t=this.Ku;this.Ku=Oa(),this.Qu.forEach(e=>{this.Zu(e.key)&&(this.Ku=this.Ku.add(e.key))});const n=[];return t.forEach(e=>{this.Ku.has(e)||n.push(new rl(e))}),this.Ku.forEach(e=>{t.has(e)||n.push(new nl(e))}),n}tc(e){this.qu=e.Hi,this.Ku=Oa();var t=this.Wu(e.documents);return this.applyChanges(t,!0)}ec(){return $h.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.Uu,this.hasCachedResults)}}class il{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class al{constructor(e){this.key=e,this.nc=!1}}class ol{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.sc={},this.ic=new Aa(e=>$i(e),ji),this.rc=new Map,this.oc=new Set,this.uc=new pi(jr.comparator),this.cc=new Map,this.ac=new bc,this.hc={},this.lc=new Map,this.fc=Xu.vn(),this.onlineState="Unknown",this.dc=void 0}get isPrimaryClient(){return!0===this.dc}}async function ul(n,e,t,r,s){n._c=(e,i,t)=>async function(e,t,n){let r=t.view.Wu(i);r.$i&&(r=await zc(e.localStore,t.query,!1).then(({documents:e})=>t.view.Wu(e,r)));var s=n&&n.targetChanges.get(t.targetId),s=t.view.applyChanges(r,e.isPrimaryClient,s);return yl(e,t.targetId,s.Xu),s.snapshot}(n,e,t);const i=await zc(n.localStore,e,!0),a=new sl(e,i.Hi),o=a.Wu(i.documents),u=qa.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,s),c=a.applyChanges(o,n.isPrimaryClient,u);yl(n,t,c.Xu);var h=new il(e,t,a);return n.ic.set(e,h),n.rc.has(t)?n.rc.get(t).push(e):n.rc.set(t,[e]),c.snapshot}async function cl(e,t,n){const r=_l(e);try{const e=await function(e,s){const i=e,a=Pr.now(),o=s.reduce((e,t)=>e.add(t.key),Oa());let u,c;return i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Ca,r=Oa();return i.Gi.getEntries(n,o).next(e=>{t=e,t.forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of s){const s=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=ea(r.transform,e||null);null!=s&&(null===n&&(n=Ti.empty()),n.set(r.field,s))}return n||null}(n,u.get(n.key).overlayedDocument);null!=s&&t.push(new wa(n.key,s,function r(e){const s=[];return ws(e.fields,(e,t)=>{const n=new Kr([e]);if(js(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new Ei(s)}(s.value.mapValue),la.exists(!0)))}return i.mutationQueue.addMutationBatch(n,a,t,s)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return i.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:Ra(u)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.hc[e.currentUser.toKey()];r=r||new pi(Fr),r=r.insert(t,n),e.hc[e.currentUser.toKey()]=r}(r,e.batchId,n),await wl(r,e.changes),await Mh(r.remoteStore)}catch(e){const t=Gh(e,"Failed to persist write");n.reject(t)}}async function hl(e,t){const r=e;try{const e=await Kc(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.cc.get(t);n&&(Er(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.nc=!0:0<e.modifiedDocuments.size?Er(n.nc):0<e.removedDocuments.size&&(Er(n.nc),n.nc=!1))}),await wl(r,e,t)}catch(e){await ns(e)}}function ll(r,s,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.ic.forEach((e,t)=>{var n=t.view.bu(s);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.bu(n)&&(r=!0)}),r&&Yh(t)}(t.eventManager,s),r.length&&t.sc.Wo(r),t.onlineState=s,t.isPrimaryClient&&t.sharedClientState.setOnlineState(s)}}async function dl(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.Gi.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let a=rs.resolve();return n.forEach(n=>{a=a.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);Er(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.mutationQueue.performConsistencyCheck(e)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Oa();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(r))).next(()=>s.localDocuments.getDocuments(e,t))})}(n.localStore,t);gl(n,r,null),fl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await wl(n,e)}catch(e){await ns(e)}}function fl(e,t){(e.lc.get(t)||[]).forEach(e=>{e.resolve()}),e.lc.delete(t)}function gl(e,t,n){const r=e;let s=r.hc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.hc[r.currentUser.toKey()]=s}}function ml(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.rc.get(e))t.ic.delete(r),n&&t.sc.wc(r,n);t.rc.delete(e),t.isPrimaryClient&&t.ac.ls(e).forEach(e=>{t.ac.containsKey(e)||pl(t,e)})}function pl(e,t){e.oc.delete(t.path.canonicalString());var n=e.uc.get(t);null!==n&&(Sh(e.remoteStore,n),e.uc=e.uc.remove(t),e.cc.delete(n),vl(e))}function yl(e,t,n){for(const r of n)r instanceof nl?(e.ac.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.uc.get(n)||e.oc.has(r)||(yr("SyncEngine","New document in limbo: "+n),e.oc.add(r),vl(e))}(e,r)):r instanceof rl?(yr("SyncEngine","Document no longer in limbo: "+r.key),e.ac.removeReference(r.key,t),e.ac.containsKey(r.key)||pl(e,r.key)):br()}function vl(e){for(;0<e.oc.size&&e.uc.size<e.maxConcurrentLimboResolutions;){var t=e.oc.values().next().value;e.oc.delete(t);var n=new jr(Ur.fromString(t)),t=e.fc.next();e.cc.set(t,new al(n)),e.uc=e.uc.insert(n,t),_h(e.remoteStore,new Jo(Ui(Fi(n.path)),t,2,ms.at))}}async function wl(e,t,r){const s=e,i=[],a=[],o=[];s.ic.isEmpty()||(s.ic.forEach((e,n)=>{o.push(s._c(n,t,r).then(e=>{var t;(e||r)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(n.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(i.push(e),t=Vc.Ci(n.targetId,e),a.push(t))}))}),await Promise.all(o),s.sc.Wo(i),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>rs.forEach(t,t=>rs.forEach(t.Si,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>rs.forEach(t.Di,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!us(e))throw e;yr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.qi.get(t),n=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(n);r.qi=r.qi.insert(t,s)}}}(s.localStore,a))}async function Il(r,e){const s=r;if(Tl(s),_l(s),!0===e&&!0!==s.dc){const r=s.sharedClientState.getAllActiveQueryTargets(),e=await bl(s,r.toArray());s.dc=!0,await Ph(s.remoteStore,!0);for(const r of e)_h(s.remoteStore,r)}else if(!1===e&&!1!==s.dc){const r=[];let n=Promise.resolve();s.rc.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(ml(s,t),Qc(s.localStore,t,!0))),Sh(s.remoteStore,t)}),await n,await bl(s,r),function(){const n=s;n.cc.forEach((e,t)=>{Sh(n.remoteStore,t)}),n.ac.fs(),n.cc=new Map,n.uc=new pi(jr.comparator)}(),s.dc=!1,await Ph(s.remoteStore,!1)}}async function bl(t,n){const r=t,s=[],i=[];for(const t of n){let e;const h=r.rc.get(t);if(h&&0!==h.length){e=await $c(r.localStore,Ui(h[0]));for(const t of h){const n=r.ic.get(t),h=(a=r,o=n,c=u=void 0,c=await zc((u=a).localStore,o.query,!0),c=o.view.tc(c),u.isPrimaryClient&&yl(u,o.targetId,c.Xu),await c);h.snapshot&&i.push(h.snapshot)}}else{const h=await Wc(r.localStore,t);e=await $c(r.localStore,h),await ul(r,El(h),t,!1,e.resumeToken)}s.push(e)}var a,o,u,c;return r.sc.Wo(i),s}function El(e){return Mi(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Tl(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=hl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.cc.get(t);if(r&&r.nc)return Oa().add(r.key);{let e=Oa();const r=n.rc.get(t);if(!r)return e;for(const t of r){const r=n.ic.get(t);e=e.unionWith(r.view.ju)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.cc.get(t),i=s&&s.key;if(i){let e=new pi(jr.comparator);e=e.insert(i,_i.newNoDocument(i,qr.min()));const n=Oa().add(i),s=new Pa(qr.min(),new Map,new wi(Fr),e,n);await hl(r,s),r.uc=r.uc.remove(i),r.cc.delete(t),vl(r)}else await Qc(r.localStore,t,!1).then(()=>ml(r,t,n)).catch(ns)}).bind(null,t),t.sc.Wo=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.Pu(e)&&(r=!0);s.Au=e}}r&&Yh(n)}).bind(null,t.eventManager),t.sc.wc=(function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function _l(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=dl.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.mutationQueue.lookupMutationBatch(t,r).next(e=>(Er(null!==e),n=e.keys(),s.mutationQueue.removeMutationBatch(t,e))).next(()=>s.mutationQueue.performConsistencyCheck(t)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>s.localDocuments.getDocuments(t,n))})}(r.localStore,t);gl(r,t,n),fl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await wl(r,e)}catch(n){await ns(n)}}).bind(null,t),t}class Sl{constructor(){this.synchronizeTabs=!1}async initialize(e){this.yt=gh(e.databaseInfo.databaseId),this.sharedClientState=this.gc(e),this.persistence=this.yc(e),await this.persistence.start(),this.localStore=this.Ic(e),this.gcScheduler=this.Tc(e,this.localStore),this.indexBackfillerScheduler=this.Ec(e,this.localStore)}Tc(e,t){return null}Ec(e,t){return null}Ic(e){return Bc(this.persistence,new Pc,e.initialUser,this.yt)}yc(e){return new Dc(Cc.Bs,this.yt)}gc(e){return new ah}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class xl extends Sl{constructor(e,t,n){super(),this.Ac=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ac.initialize(this,e),await _l(this.Ac.syncEngine),await Mh(this.Ac.remoteStore),await this.persistence.li(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}Ic(e){return Bc(this.persistence,new Pc,e.initialUser,this.yt)}Tc(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new sc(n,e.asyncQueue,t)}Ec(e,t){var n=new gs(t,this.persistence);return new fs(e.asyncQueue,n)}yc(e){var t=Oc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Ku.withCacheSize(this.cacheSizeBytes):Ku.DEFAULT;return new Lc(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,dh(),fh(),this.yt,this.sharedClientState,!!this.forceOwnership)}gc(e){return new ah}}class Dl extends xl{constructor(e,t){super(e,t,!1),this.Ac=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.Ac.syncEngine;this.sharedClientState instanceof ih&&(this.sharedClientState.syncEngine={Fr:(async function(e,t,n,r){var s=e,i=await function(e,n){const r=e,s=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.Tn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):rs.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await Mh(s.remoteStore):"acknowledged"===n||"rejected"===n?(gl(s,t,r||null),fl(s,t),s.localStore.mutationQueue.An(t)):br(),await wl(s,i)):yr("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),$r:(async function(e,t,n,r){const s=e;if(s.dc)yr("SyncEngine","Ignoring unexpected query state notification.");else{var i=s.rc.get(t);if(i&&0<i.length)switch(n){case"current":case"not-current":{const e=await Hc(s.localStore,Wi(i[0])),r=Pa.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,_s.EMPTY_BYTE_STRING);await wl(s,e,r);break}case"rejected":await Qc(s.localStore,t,!0),ml(s,t,r);break;default:br()}}}).bind(null,t),Br:(async function(e,t,n){const r=Tl(e);if(r.dc){for(const e of t)if(r.rc.has(e))yr("SyncEngine","Adding an already active target "+e);else{const t=await Wc(r.localStore,e),n=await $c(r.localStore,t);await ul(r,El(t),n.targetId,!1,n.resumeToken),_h(r.remoteStore,n)}for(const e of n)r.rc.has(e)&&await Qc(r.localStore,e,!1).then(()=>{Sh(r.remoteStore,e),ml(r,e)}).catch(ns)}}).bind(null,t),vi:(function(e){return e.localStore.persistence.vi()}).bind(null,t),Mr:(async function(e,t){const n=e;return Hc(n.localStore,t).then(e=>wl(n,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.li(async e=>{await Il(this.Ac.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}gc(e){var t=dh();if(!ih.C(t))throw new _r(Tr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=Oc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new ih(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Al{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>ll(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){yr("SyncEngine","User change. New user:",t.toKey());const r=await Uc(n.localStore,t);n.currentUser=t,(e=n).lc.forEach(e=>{e.forEach(e=>{e.reject(new _r(Tr.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.lc.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await wl(n,r.ji)}}).bind(null,this.syncEngine),await Ph(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new zh}createDatastore(e){var t,n,r,s,i=gh(e.databaseInfo.databaseId),t=(t=e.databaseInfo,new lh(t));return n=e.authCredentials,r=e.appCheckCredentials,s=t,e=i,new wh(n,r,s,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>ll(this.syncEngine,e,0),i=new(uh.C()?uh:oh),new bh(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,a){const o=new ol(e,t,n,r,s,i);return a&&(o.dc=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;yr("RemoteStore","RemoteStore shutting down."),t._u.add(5),await Th(t),t.mu.shutdown(),t.gu.set("Unknown")}(this.remoteStore)}}function Cl(e,t,n){if(!n)throw new _r(Tr.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Nl(e,t,n,r){if(!0===t&&!0===r)throw new _r(Tr.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function kl(e){if(!jr.isDocumentKey(e))throw new _r(Tr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Rl(e){if(jr.isDocumentKey(e))throw new _r(Tr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Ll(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":br();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Ml(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new _r(Tr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Ll(e);throw new _r(Tr.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function Fl(e,t){if(t<=0)throw new _r(Tr.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}const Ol=new Map;class Vl{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new _r(Tr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new _r(Tr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Nl("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Pl{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Vl({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new _r(Tr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new _r(Tr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Vl(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Dr;switch(e.type){case"gapi":var t=e.client;return new kr(t,e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new _r(Tr.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Ol.get(e);t&&(yr("ComponentProvider","Removing Datastore"),Ol.delete(e),t.terminate())}(this),Promise.resolve()}}function ql(n,e,t,r={}){var s;const i=(n=Ml(n,Pl))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&wr("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${t}`,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=fr.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,s=e.sub||e.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},e),[a(JSON.stringify({alg:"none",type:"JWT"})),a(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(s=n._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new _r(Tr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new fr(i)}n._authCredentials=new Ar(new xr(e,t))}}class Bl{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Gl(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Bl(this.firestore,e,this._key)}}class Ul{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Ul(this.firestore,e,this._query)}}class Gl extends Ul{constructor(e,t,n){super(e,t,Fi(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Bl(this.firestore,null,new jr(e))}withConverter(e){return new Gl(this.firestore,e,this._path)}}function Kl(e,t,...n){if(e=m(e),Cl("collection","path",t),e instanceof Pl){var r=Ur.fromString(t,...n);return Rl(r),new Gl(e,null,r)}if(!(e instanceof Bl||e instanceof Gl))throw new _r(Tr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Ur.fromString(t,...n));return Rl(r),new Gl(e.firestore,null,r)}function jl(e,t,...n){if(e=m(e),Cl("doc","path",t=1===arguments.length?Mr.R():t),e instanceof Pl){var r=Ur.fromString(t,...n);return kl(r),new Bl(e,null,new jr(r))}if(!(e instanceof Bl||e instanceof Gl))throw new _r(Tr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Ur.fromString(t,...n));return kl(r),new Bl(e.firestore,e instanceof Gl?e.converter:null,new jr(r))}function $l(e,t){return e=m(e),t=m(t),(e instanceof Bl||e instanceof Gl)&&(t instanceof Bl||t instanceof Gl)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Ql(e,t){return e=m(e),t=m(t),e instanceof Ul&&t instanceof Ul&&e.firestore===t.firestore&&ji(e._query,t._query)&&e.converter===t.converter}function zl(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Wl{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Rc(this.observer.next,e)}error(e){this.observer.error?this.Rc(this.observer.error,e):vr("Uncaught Error in snapshot listener:",e.toString())}bc(){this.muted=!0}Rc(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class Hl{constructor(e,t){this.Pc=e,this.yt=t,this.metadata=new Sr,this.buffer=new Uint8Array,this.vc=new TextDecoder("utf-8"),this.Vc().then(e=>{e&&e.Ou()?this.metadata.resolve(e.ku.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.ku)}`))},e=>this.metadata.reject(e))}close(){return this.Pc.cancel()}async getMetadata(){return this.metadata.promise}async mc(){return await this.getMetadata(),this.Vc()}async Vc(){var e=await this.Sc();if(null===e)return null;var t=this.vc.decode(e),n=Number(t);isNaN(n)&&this.Dc(`length string (${t}) is not valid number`);t=await this.Cc(n);return new Jh(JSON.parse(t),e.length+n)}xc(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Sc(){for(;this.xc()<0&&!await this.Nc(););if(0===this.buffer.length)return null;var e=this.xc();e<0&&this.Dc("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Cc(e){for(;this.buffer.length<e;)await this.Nc()&&this.Dc("Reached the end of bundle when more is expected.");var t=this.vc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Dc(e){throw this.Pc.cancel(),new Error(`Invalid bundle format: ${e}`)}async Nc(){var e=await this.Pc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Yl{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new _r(Tr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=ao(r.yt)+"/documents",s={documents:t.map(e=>no(r.yt,e))},i=await r._o("BatchGetDocuments",n,s,t.length),a=new Map;i.forEach(e=>{const t=(n=r.yt,"found"in(e=e)?function(e,t){Er(!!t.found),t.found.name,t.found.updateTime;var n=ro(e,t.found.name),r=Za(t.found.updateTime),s=t.found.createTime?Za(t.found.createTime):qr.min(),i=new Ti({mapValue:{fields:t.found.fields}});return _i.newFoundDocument(n,r,s,i)}(n,e):"missing"in e?function(e,t){Er(!!t.missing),Er(!!t.readTime);var n=ro(e,t.missing),r=Za(t.readTime);return _i.newNoDocument(n,r)}(n,e):br());var n;a.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{var t=a.get(e.toString());Er(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Ta(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=jr.fromPath(t);this.mutations.push(new _a(n,this.precondition(n)))}),await async function(e,t){const n=e,r=ao(n.yt)+"/documents",s={writes:t.map(e=>ho(n.yt,e))};await n.ao("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw br();t=qr.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new _r(Tr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(qr.min())?la.exists(!1):la.updateTime(t):la.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return la.exists(!0);if(t.isEqual(qr.min()))throw new _r(Tr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return la.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Xl{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.kc=n.maxAttempts,this.xo=new mh(this.asyncQueue,"transaction_retry")}run(){--this.kc,this.Oc()}Oc(){this.xo.Ro(async()=>{const t=new Yl(this.datastore),e=this.Mc(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.Fc(e)}))}).catch(e=>{this.Fc(e)})})}Mc(e){try{var t=this.updateFunction(e);return!bs(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Fc(e){0<this.kc&&this.$c(e)?(--this.kc,this.asyncQueue.enqueueAndForget(()=>(this.Oc(),Promise.resolve()))):this.deferred.reject(e)}$c(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!xa(t)}}class Jl{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=fr.UNAUTHENTICATED,this.clientId=Mr.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{yr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(yr("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _r(Tr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Sr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=Gh(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function Zl(e,t){e.asyncQueue.verifyOperationInProgress(),yr("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await Uc(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e.offlineComponents=t}async function ed(e,n){e.asyncQueue.verifyOperationInProgress();var t=await td(e);yr("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await n.initialize(t,r),e.setCredentialChangeListener(e=>Vh(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>Vh(n.remoteStore,t)),e.onlineComponents=n}async function td(e){return e.offlineComponents||(yr("FirestoreClient","Using default OfflineComponentProvider"),await Zl(e,new Sl)),e.offlineComponents}async function nd(e){return e.onlineComponents||(yr("FirestoreClient","Using default OnlineComponentProvider"),await ed(e,new Al)),e.onlineComponents}function rd(e){return td(e).then(e=>e.persistence)}function sd(e){return td(e).then(e=>e.localStore)}function id(e){return nd(e).then(e=>e.remoteStore)}function ad(e){return nd(e).then(e=>e.syncEngine)}async function od(e){const t=await nd(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=Tl(e);let r,s;const i=n.ic.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.ec();else{const e=await $c(n.localStore,Ui(t));n.isPrimaryClient&&_h(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await ul(n,t,r,"current"===i,e.resumeToken)}return s}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.ic.get(t),s=n.rc.get(r.targetId);if(1<s.length)return n.rc.set(r.targetId,s.filter(e=>!ji(e,t))),void n.ic.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Qc(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Sh(n.remoteStore,r.targetId),ml(n,r.targetId)}).catch(ns)):(ml(n,r.targetId),await Qc(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function ud(e,t,n={}){const r=new Sr;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,a){const e=new Wl({next:e=>{r.enqueueAndForget(()=>Hh(n,o));var t=e.docs.has(s);!t&&e.fromCache?a.reject(new _r(Tr.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?a.reject(new _r(Tr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new Xh(Fi(s.path),e,{includeMetadataChanges:!0,Nu:!0});return Wh(n,o)}(await od(e),e.asyncQueue,t,n,r)),r.promise}function cd(e,t,n={}){const r=new Sr;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,s){const i=new Wl({next:e=>{n.enqueueAndForget(()=>Hh(t,a)),e.fromCache&&"server"===r.source?s.reject(new _r(Tr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),a=new Xh(e,i,{includeMetadataChanges:!0,Nu:!0});return Wh(t,a)}(await od(e),e.asyncQueue,t,n,r)),r.promise}function hd(e,t,n,r){const s=(n=n,t=gh(t),i="string"==typeof n?(new TextEncoder).encode(n):n,n=function(e){if(e instanceof Uint8Array)return zl(e,void 0);if(e instanceof ArrayBuffer)return zl(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(i),t=t,new Hl(n,t));var i;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=Za(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ns.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes}),Promise.resolve(new Set);r._updateProgress(tl(s));const a=new el(s,t.localStore,n.yt);let e=await n.mc();for(;e;){const t=await a.Fu(e);t&&r._updateProgress(t),e=await n.mc()}var i=await a.complete();return await wl(t,i.Lu,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ns.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress),Promise.resolve(i.Bu)}catch(t){return wr("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await ad(e),s,r)})}class ld{constructor(){this.Bc=Promise.resolve(),this.Lc=[],this.qc=!1,this.Uc=[],this.Kc=null,this.Gc=!1,this.Qc=!1,this.jc=[],this.xo=new mh(this,"async_queue_retry"),this.Wc=()=>{var e=fh();e&&yr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.xo.Po()};const e=fh();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Wc)}get isShuttingDown(){return this.qc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.zc(),this.Hc(e)}enterRestrictedMode(e){if(!this.qc){this.qc=!0,this.Qc=e||!1;const t=fh();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Wc)}}enqueue(e){if(this.zc(),this.qc)return new Promise(()=>{});const t=new Sr;return this.Hc(()=>this.qc&&this.Qc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Lc.push(e),this.Jc()))}async Jc(){if(0!==this.Lc.length){try{await this.Lc[0](),this.Lc.shift(),this.xo.reset()}catch(e){if(!us(e))throw e;yr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Lc.length&&this.xo.Ro(()=>this.Jc())}}Hc(e){var t=this.Bc.then(()=>(this.Gc=!0,e().catch(e=>{throw this.Kc=e,this.Gc=!1,vr("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.Gc=!1,e))));return this.Bc=t}enqueueAfterDelay(e,t,n){this.zc(),-1<this.jc.indexOf(e)&&(t=0);var r=Uh.createAndSchedule(this,e,t,n,e=>this.Yc(e));return this.Uc.push(r),r}zc(){this.Kc&&br()}verifyOperationInProgress(){}async Xc(){for(var e;await(e=this.Bc),e!==this.Bc;);}Zc(e){for(const t of this.Uc)if(t.timerId===e)return!0;return!1}ta(t){return this.Xc().then(()=>{this.Uc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.Uc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Xc()})}ea(e){this.jc.push(e)}Yc(e){var t=this.Uc.indexOf(e);this.Uc.splice(t,1)}}function dd(e){return function(e){if("object"==typeof e&&null!==e){var t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return 1}}(e)}class fd{constructor(){this._progressObserver={},this._taskCompletionResolver=new Sr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var gd,md,pd;class yd extends Pl{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new ld,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||wd(this),this._firestoreClient.terminate()}}function vd(e){return e._firestoreClient||wd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function wd(e){var t,n,r,s,i,a=e._freezeSettings(),a=(n=e._databaseId,r=(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",s=e._persistenceKey,i=a,new ps(n,r,s,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams));e._firestoreClient=new Jl(e._authCredentials,e._appCheckCredentials,e._queue,a)}function Id(e,n,r){const s=new Sr;return e.asyncQueue.enqueue(async()=>{try{await Zl(e,r),await ed(e,n),s.resolve()}catch(e){const n=e;if(!("FirebaseError"===(t=n).name?t.code===Tr.FAILED_PRECONDITION||t.code===Tr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)))throw n;wr("Error enabling offline persistence. Falling back to persistence disabled: "+n),s.reject(n)}var t}).then(()=>s.promise)}function bd(e){return function(e){const t=new Sr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;Nh(n.remoteStore)||yr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.lc.get(e)||[];r.push(t),n.lc.set(e,r)}catch(e){const n=Gh(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await ad(e),t)),t.promise}(vd(e=Ml(e,yd)))}function Ed(e){return(n=vd(e=Ml(e,yd))).asyncQueue.enqueue(async()=>{const e=await rd(n),t=await id(n);return e.setNetworkEnabled(!0),function(){const e=t;return e._u.delete(0),Eh(e)}()});var n}function Td(e){return(n=vd(e=Ml(e,yd))).asyncQueue.enqueue(async()=>{const e=await rd(n),t=await id(n);return e.setNetworkEnabled(!1),async function(){const e=t;e._u.add(0),await Th(e),e.gu.set("Offline")}()});var n}function _d(t,e){return n=vd(t=Ml(t,yd)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Ns.getNamedQuery(e,t))}(await sd(n),r)).then(e=>e?new Ul(t,null,e.query):null);var n,r}function Sd(e){if(e._initialized||e._terminated)throw new _r(Tr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class xd{constructor(e){this._byteString=e}static fromBase64String(e){try{return new xd(_s.fromBase64String(e))}catch(e){throw new _r(Tr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new xd(_s.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Dd{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new _r(Tr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Kr(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Ad{constructor(e){this._methodName=e}}class Cd{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new _r(Tr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new _r(Tr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Fr(this._lat,e._lat)||Fr(this._long,e._long)}}const Nd=/^__.*__$/;class kd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new wa(e,this.data,this.fieldMask,t,this.fieldTransforms):new va(e,this.data,t,this.fieldTransforms)}}class Rd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new wa(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Ld(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw br()}}class Md{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.yt=n,this.ignoreUndefinedProperties=r,void 0===s&&this.na(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get sa(){return this.settings.sa}ia(e){return new Md(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.yt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ra(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.ua(e),r}ca(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.na(),r}aa(e){return this.ia({path:void 0,oa:!0})}ha(e){return ef(e,this.settings.methodName,this.settings.la||!1,this.path,this.settings.fa)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}na(){if(this.path)for(let e=0;e<this.path.length;e++)this.ua(this.path.get(e))}ua(e){if(0===e.length)throw this.ha("Document fields must not be empty");if(Ld(this.sa)&&Nd.test(e))throw this.ha('Document fields cannot begin and end with "__"')}}class Fd{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.yt=n||gh(e)}da(e,t,n,r=!1){return new Md({sa:e,methodName:t,fa:n,path:Kr.emptyPath(),oa:!1,la:r},this.databaseId,this.yt,this.ignoreUndefinedProperties)}}function Od(e){var t=e._freezeSettings(),n=gh(e._databaseId);return new Fd(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Vd(e,t,n,r,s,i={}){const a=e.da(i.merge||i.mergeFields?2:0,t,n,s);Yd("Data must be an object, but it was:",a,r);var o=Wd(r,a);let u,c;if(i.merge)u=new Ei(a.fieldMask),c=a.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Xd(t,r,n);if(!a.contains(s))throw new _r(Tr.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);tf(e,s)||e.push(s)}u=new Ei(e),c=a.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=a.fieldTransforms;return new kd(new Ti(o),u,c)}class Pd extends Ad{_toFieldTransform(e){if(2!==e.sa)throw 1===e.sa?e.ha(`${this._methodName}() can only appear at the top level of your update data`):e.ha(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Pd}}function qd(e,t,n){return new Md({sa:3,fa:t.settings.fa,methodName:e._methodName,oa:n},t.databaseId,t.yt,t.ignoreUndefinedProperties)}class Bd extends Ad{_toFieldTransform(e){return new ca(e.path,new ta)}isEqual(e){return e instanceof Bd}}class Ud extends Ad{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=qd(this,e,!0),n=this._a.map(e=>zd(e,t)),r=new na(n);return new ca(e.path,r)}isEqual(e){return this===e}}class Gd extends Ad{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=qd(this,e,!0),n=this._a.map(e=>zd(e,t)),r=new sa(n);return new ca(e.path,r)}isEqual(e){return this===e}}class Kd extends Ad{constructor(e,t){super(e),this.wa=t}_toFieldTransform(e){var t=new aa(e.yt,Ji(e.yt,this.wa));return new ca(e.path,t)}isEqual(e){return this===e}}function jd(e,s,i,t){const a=e.da(1,s,i);Yd("Data must be an object, but it was:",a,t);const o=[],u=Ti.empty();ws(t,(e,t)=>{var n=Zd(s,e,i);t=m(t);var r=a.ca(n);if(t instanceof Pd)o.push(n);else{const e=zd(t,r);null!=e&&(o.push(n),u.set(n,e))}});var n=new Ei(o);return new Rd(u,n,a.fieldTransforms)}function $d(e,t,n,r,s,i){const a=e.da(1,t,n),o=[Xd(t,r,n)],u=[s];if(i.length%2!=0)throw new _r(Tr.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<i.length;f+=2)o.push(Xd(t,i[f])),u.push(i[f+1]);const c=[],h=Ti.empty();for(let g=o.length-1;0<=g;--g)if(!tf(c,o[g])){const t=o[g];var l=m(l=u[g]);const r=a.ca(t);if(l instanceof Pd)c.push(t);else{const e=zd(l,r);null!=e&&(c.push(t),h.set(t,e))}}var d=new Ei(c);return new Rd(h,d,a.fieldTransforms)}function Qd(e,t,n,r=!1){return zd(n,e.da(r?4:3,t))}function zd(i,e){if(Hd(i=m(i)))return Yd("Unsupported field value:",e,i),Wd(i,e);if(i instanceof Ad)return function(e,t){if(!Ld(t.sa))throw t.ha(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.ha(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(i,e),null;if(void 0===i&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),i instanceof Array){if(e.settings.oa&&4!==e.sa)throw e.ha("Nested arrays are not supported");return function(t){const n=[];let r=0;for(const s of i){let e=zd(s,t.aa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e)}return function(e,t){if(null===(e=m(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Ji(t.yt,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=Pr.fromDate(e);return{timestampValue:Xa(t.yt,n)}}if(e instanceof Pr){n=new Pr(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Xa(t.yt,n)}}if(e instanceof Cd)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof xd)return{bytesValue:Ja(t.yt,e._byteString)};if(e instanceof Bl){const r=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(r))throw t.ha(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:eo(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.ha(`Unsupported field value: ${Ll(e)}`)}(0,e)}function Wd(e,r){const s={};return Is(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):ws(e,(e,t)=>{var n=zd(t,r.ra(e));null!=n&&(s[e]=n)}),{mapValue:{fields:s}}}function Hd(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Pr||e instanceof Cd||e instanceof xd||e instanceof Bl||e instanceof Ad)}function Yd(e,t,n){if(!Hd(n)||("object"!=typeof(s=n)||null===s||Object.getPrototypeOf(s)!==Object.prototype&&null!==Object.getPrototypeOf(s))){var r=Ll(n);throw"an object"===r?t.ha(e+" a custom object"):t.ha(e+" "+r)}var s}function Xd(e,t,n){if((t=m(t))instanceof Dd)return t._internalPath;if("string"==typeof t)return Zd(e,t);throw ef("Field path arguments must be of type string or ",e,!1,void 0,n)}const Jd=new RegExp("[~\\*/\\[\\]]");function Zd(t,n,r){if(0<=n.search(Jd))throw ef(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new Dd(...n.split("."))._internalPath}catch(e){throw ef(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function ef(e,t,n,r,s){var i=r&&!r.isEmpty(),a=void 0!==s;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(i||a)&&(u+=" (found",i&&(u+=` in field ${r}`),a&&(u+=` in document ${s}`),u+=")"),new _r(Tr.INVALID_ARGUMENT,o+e+u)}function tf(e,t){return e.some(e=>e.isEqual(t))}class nf{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Bl(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new rf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(sf("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class rf extends nf{data(){return super.data()}}function sf(e,t){return"string"==typeof t?Zd(e,t):(t instanceof Dd?t:t._delegate)._internalPath}function af(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new _r(Tr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class of{}class uf extends of{}function cf(e,t,...n){let r=[];t instanceof of&&r.push(t),r=r.concat(n),function(e){var t=e.filter(e=>e instanceof lf).length,n=e.filter(e=>e instanceof hf).length;if(1<t||0<t&&0<n)throw new _r(Tr.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class hf extends uf{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new hf(e,t,n)}_apply(e){var t=this._parse(e);return wf(e._query,t),new Ul(e.firestore,e.converter,Gi(e._query,t))}_parse(e){var t=Od(e.firestore);return function(e,t,n,r,s,i,a){let o;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new _r(Tr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){vf(a,i);const t=[];for(const n of a)t.push(yf(r,e,n));o={arrayValue:{values:t}}}else o=yf(r,e,a)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||vf(a,i),o=Qd(n,t,a,"in"===i||"not-in"===i);return Zs.create(s,i,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class lf extends of{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new lf(e,t)}_parse(t){var e=this._queryConstraints.map(e=>e._parse(t)).filter(e=>0<e.getFilters().length);return 1===e.length?e[0]:ei.create(e,this._getOperator())}_apply(e){const n=this._parse(e);return 0===n.getFilters().length?e:(function(e){let t=e;for(const e of n.getFlattenedFilters())wf(t,e),t=Gi(t,e)}(e._query),new Ul(e.firestore,e.converter,Gi(e._query,n)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class df extends uf{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new df(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new _r(Tr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new _r(Tr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,s=new mi(t,n);return n=s,null!==Vi(e=e)||null!==(r=Pi(e))&&If(0,r,n.field),s}(e._query,this._field,this._direction);return new Ul(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new Li(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class ff extends uf{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new ff(e,t,n)}_apply(e){return new Ul(e.firestore,e.converter,Ki(e._query,this._limit,this._limitType))}}class gf extends uf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new gf(e,t,n)}_apply(e){var t,n=pf(e,this.type,this._docOrFields,this._inclusive);return new Ul(e.firestore,e.converter,(t=e._query,e=n,new Li(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class mf extends uf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new mf(e,t,n)}_apply(e){var t,n=pf(e,this.type,this._docOrFields,this._inclusive);return new Ul(e.firestore,e.converter,(t=e._query,e=n,new Li(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function pf(e,t,n,r){if(n[0]=m(n[0]),n[0]instanceof nf)return function(e,t,n,r,s){if(!r)throw new _r(Tr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Bi(e))if(n.field.isKeyField())i.push(qs(t,r.key));else{const e=r.data.field(n.field);if(Cs(e))throw new _r(Tr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Hs(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var s=Od(e.firestore);return function(e,t,n,r,s,i){const a=e.explicitOrderBy;if(s.length>a.length)throw new _r(Tr.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let u=0;u<s.length;u++){const c=s[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!qi(e)&&-1!==c.indexOf("/"))throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(Ur.fromString(c));if(!jr.isDocumentKey(n))throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new jr(n);o.push(qs(t,s))}else{const e=Qd(n,r,c);o.push(e)}}return new Hs(o,i)}(e._query,e.firestore._databaseId,s,t,n,r)}function yf(e,t,n){if("string"==typeof(n=m(n))){if(""===n)throw new _r(Tr.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!qi(t)&&-1!==n.indexOf("/"))throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(Ur.fromString(n));if(!jr.isDocumentKey(r))throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return qs(e,new jr(r))}if(n instanceof Bl)return qs(e,n._key);throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Ll(n)}.`)}function vf(e,t){if(!Array.isArray(e)||0===e.length)throw new _r(Tr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(10<e.length)throw new _r(Tr.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function wf(e,t){if(t.isInequality()){const r=Pi(e),s=t.field;if(null!==r&&!r.isEqual(s))throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${s.toString()}'`);var n=Vi(e);null!==n&&If(0,s,n)}const r=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new _r(Tr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new _r(Tr.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}function If(e,t,n){if(!n.isEqual(t))throw new _r(Tr.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class bf{convertValue(e,t="none"){switch(Ls(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ds(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(As(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw br()}}convertObject(e,n){const r={};return ws(e.fields,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Cd(Ds(e.latitude),Ds(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=function e(t){var n=t.mapValue.fields.__previous_value__;return Cs(n)?e(n):n}(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ns(e));default:return null}}convertTimestamp(e){var t=xs(e);return new Pr(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Ur.fromString(e);Er(Io(n));const r=new ys(n.get(1),n.get(3)),s=new jr(n.popFirst(5));return r.isEqual(t)||vr(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Ef(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class Tf extends bf{constructor(e){super(),this.firestore=e}convertBytes(e){return new xd(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Bl(this.firestore,null,t)}}class _f{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Sf extends nf{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new xf(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(sf("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class xf extends Sf{data(e={}){return super.data(e)}}class Df{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new _f(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new xf(this._firestore,this._userDataWriter,e.key,e,new _f(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new _r(Tr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let n=0;return i._snapshot.docChanges.map(e=>{var t=new xf(i._firestore,i._userDataWriter,e.doc.key,e.doc,new _f(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new xf(i._firestore,i._userDataWriter,e.doc.key,e.doc,new _f(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return br()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Af(e,t){return e instanceof Sf&&t instanceof Sf?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Df&&t instanceof Df&&e._firestore===t._firestore&&Ql(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class Cf extends bf{constructor(e){super(),this.firestore=e}convertBytes(e){return new xd(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Bl(this.firestore,null,t)}}function Nf(t){t=Ml(t,Bl);const n=Ml(t.firestore,yd),e=vd(n),r=new Cf(n);return function(e,t){const n=new Sr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new _r(Tr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=Gh(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await sd(e),t,n)),n.promise}(e,t._key).then(e=>new Sf(n,r,t._key,e,new _f(null!==e&&e.hasLocalMutations,!0),t.converter))}function kf(t){t=Ml(t,Ul);const n=Ml(t.firestore,yd),e=vd(n),r=new Cf(n);return function(e,t){const n=new Sr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await zc(e,t,!0),i=new sl(t,s.Hi),a=i.Wu(s.documents),o=i.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=Gh(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await sd(e),t,n)),n.promise}(e,t._query).then(e=>new Df(n,r,t,e))}function Rf(e,t,n){e=Ml(e,Bl);var r=Ml(e.firestore,yd),s=Ef(e.converter,t,n);return Of(r,[Vd(Od(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,la.none())])}function Lf(e,t,n,...r){e=Ml(e,Bl);var s=Ml(e.firestore,yd),i=Od(s);let a;return a="string"==typeof(t=m(t))||t instanceof Dd?$d(i,"updateDoc",e._key,t,n,r):jd(i,"updateDoc",e._key,t),Of(s,[a.toMutation(e._key,la.exists(!0))])}function Mf(t,...n){var e;t=m(t);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||dd(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(dd(n[s])){const t=n[s];n[s]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[s+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[s+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,u;if(t instanceof Bl)o=Ml(t.firestore,yd),u=Fi(t._key.path),a={next:e=>{n[s]&&n[s](Vf(o,t,e))},error:n[s+1],complete:n[s+2]};else{const c=Ml(t,Ul);o=Ml(c.firestore,yd),u=c._query;const h=new Cf(o);a={next:e=>{n[s]&&n[s](new Df(o,h,c,e))},error:n[s+1],complete:n[s+2]},af(t._query)}return function(e,t,n,r){const s=new Wl(r),i=new Xh(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>Wh(await od(e),i)),()=>{s.bc(),e.asyncQueue.enqueueAndForget(async()=>Hh(await od(e),i))}}(vd(o),u,i,a)}function Ff(e,t){return function(e,t){const n=new Wl(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Ru.add(t),t.next()}(await od(e),n)),()=>{n.bc(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Ru.delete(t)}(await od(e),n))}}(vd(e=Ml(e,yd)),dd(t)?t:{next:t})}function Of(e,t){return function(e,t){const n=new Sr;return e.asyncQueue.enqueueAndForget(async()=>cl(await ad(e),t,n)),n.promise}(vd(e),t)}function Vf(e,t,n){var r=n.docs.get(t._key),s=new Cf(e);return new Sf(e,s,t._key,r,new _f(n.hasPendingWrites,n.fromCache),t.converter)}const Pf={maxAttempts:5};class qf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Od(e)}set(e,t,n){this._verifyNotCommitted();const r=Bf(e,this._firestore),s=Ef(r.converter,t,n),i=Vd(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,la.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var s=Bf(e,this._firestore);let i;return i="string"==typeof(t=m(t))||t instanceof Dd?$d(this._dataReader,"WriteBatch.update",s._key,t,n,r):jd(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,la.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=Bf(e,this._firestore);return this._mutations=this._mutations.concat(new Ta(t._key,la.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _r(Tr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Bf(e,t){if((e=m(e)).firestore!==t)throw new _r(Tr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Uf extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Od(e)}get(e){const n=Bf(e,this._firestore),r=new Tf(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return br();const t=e[0];if(t.isFoundDocument())return new nf(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new nf(this._firestore,r,n._key,null,n.converter);throw br()})}set(e,t,n){var r=Bf(e,this._firestore),s=Ef(r.converter,t,n),s=Vd(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){var s=Bf(e,this._firestore),i="string"==typeof(t=m(t))||t instanceof Dd?$d(this._dataReader,"Transaction.update",s._key,t,n,r):jd(this._dataReader,"Transaction.update",s._key,t);return this._transaction.update(s._key,i),this}delete(e){var t=Bf(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Bf(e,this._firestore),n=new Cf(this._firestore);return super.get(e).then(e=>new Sf(this._firestore,n,t._key,e._document,new _f(!1,!1),t.converter))}}function Gf(t,n,e){t=Ml(t,yd);var r=Object.assign(Object.assign({},Pf),e);return function(){if(r.maxAttempts<1)throw new _r(Tr.INVALID_ARGUMENT,"Max attempts must be at least 1")}(),function(t,n,r){const s=new Sr;return t.asyncQueue.enqueueAndForget(async()=>{var e=await nd(t).then(e=>e.datastore);new Xl(t.asyncQueue,e,r,n,s).run()}),s.promise}(vd(t),e=>n(new Uf(t,e)),r)}gd=mg.SDK_VERSION,gr=gd,mg._registerComponent(new g("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),s=new yd(new Cr(e.getProvider("auth-internal")),new Lr(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new _r(Tr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ys(e.options.projectId,t)}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),mg.registerVersion(dr,"3.8.1",void 0),mg.registerVersion(dr,"3.8.1","esm2017");function Kf(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new _r("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function jf(){if("undefined"==typeof Uint8Array)throw new _r("unimplemented","Uint8Arrays are not available in this environment.")}function $f(){if("undefined"==typeof atob)throw new _r("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Qf{constructor(e){this._delegate=e}static fromBase64String(e){return $f(),new Qf(xd.fromBase64String(e))}static fromUint8Array(e){return jf(),new Qf(xd.fromUint8Array(e))}toBase64(){return $f(),this._delegate.toBase64()}toUint8Array(){return jf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function zf(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class Wf{enableIndexedDbPersistence(e,t){return function(e,t){Sd(e=Ml(e,yd));var n=vd(e),r=e._freezeSettings(),s=new Al;return Id(n,s,new xl(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){Sd(e=Ml(e,yd));var t=vd(e),n=e._freezeSettings(),r=new Al;return Id(t,r,new Dl(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new _r(Tr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Sr;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!is.C())return Promise.resolve();var t=e+"main";await is.delete(t)}(Oc(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class Hf{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof ys||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||wr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){ql(this._delegate,e,t,n)}enableNetwork(){return Ed(this._delegate)}disableNetwork(){return Td(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Nl("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return bd(this._delegate)}onSnapshotsInSync(e){return Ff(this._delegate,e)}get app(){if(!this._appCompat)throw new _r("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new cg(this,Kl(this._delegate,e))}catch(e){throw tg(e,"collection()","Firestore.collection()")}}doc(e){try{return new eg(this,jl(this._delegate,e))}catch(e){throw tg(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new ag(this,function(e,t){if(e=Ml(e,Pl),Cl("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new _r(Tr.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ul(e,null,(t=t,new Li(Ur.emptyPath(),t)))}(this._delegate,e))}catch(e){throw tg(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Gf(this._delegate,e=>t(new Xf(this,e)))}batch(){return vd(this._delegate),new Jf(new qf(this._delegate,e=>Of(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=vd(t=Ml(t,yd)),r=new fd,hd(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return _d(this._delegate,e).then(e=>e?new ag(this,e):null)}}class Yf extends bf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Qf(new xd(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return eg.forKey(t,this.firestore,null)}}class Xf{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}get(e){const t=hg(e);return this._delegate.get(t).then(e=>new sg(this._firestore,new Sf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=hg(e);return n?(Kf("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=hg(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=hg(e);return this._delegate.delete(t),this}}class Jf{constructor(e){this._delegate=e}set(e,t,n){var r=hg(e);return n?(Kf("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=hg(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=hg(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Zf{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new xf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new ig(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Zf.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let s=r.get(t);return s||(s=new Zf(e,new Yf(e),t),r.set(t,s)),s}}Zf.INSTANCES=new WeakMap;class eg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}static forPath(e,t,n){if(e.length%2!=0)throw new _r("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new eg(t,new Bl(t._delegate,n,new jr(e)))}static forKey(e,t,n){return new eg(t,new Bl(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new cg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new cg(this.firestore,Kl(this._delegate,e))}catch(e){throw tg(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=m(e))instanceof Bl&&$l(this._delegate,e)}set(e,t){t=Kf("DocumentReference.set",t);try{return t?Rf(this._delegate,e,t):Rf(this._delegate,e)}catch(e){throw tg(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Lf(this._delegate,e):Lf(this._delegate,e,t,...n)}catch(e){throw tg(e,"updateDoc()","DocumentReference.update()")}}delete(){return Of(Ml((e=this._delegate).firestore,yd),[new Ta(e._key,la.none())]);var e}onSnapshot(...e){var t=ng(e),n=rg(e,e=>new sg(this.firestore,new Sf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Mf(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?Nf:"server"===(null==e?void 0:e.source)?function(t){t=Ml(t,Bl);const n=Ml(t.firestore,yd);return ud(vd(n),t._key,{source:"server"}).then(e=>Vf(n,t,e))}:function(t){t=Ml(t,Bl);const n=Ml(t.firestore,yd);return ud(vd(n),t._key).then(e=>Vf(n,t,e))})(this._delegate),t.then(e=>new sg(this.firestore,new Sf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new eg(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function tg(e,t,n){return e.message=e.message.replace(t,n),e}function ng(e){for(const t of e)if("object"==typeof t&&!zf(t))return t;return{}}function rg(e,t){var n;let r;return r=zf(e[0])?e[0]:zf(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class sg{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new eg(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Af(this._delegate,e._delegate)}}class ig extends sg{data(e){var t=this._delegate.data(e);return void 0!==t||br(),t}}class ag{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}where(e,t,n){try{return new ag(this.firestore,cf(this._delegate,(r=n,s=t,i=sf("where",e),hf._create(i,s,r))))}catch(e){throw tg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new ag(this.firestore,cf(this._delegate,([n,r="asc"]=[e,t],s=r,i=sf("orderBy",n),df._create(i,s))))}catch(e){throw tg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new ag(this.firestore,cf(this._delegate,(Fl("limit",t=e),ff._create("limit",t,"F"))))}catch(e){throw tg(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new ag(this.firestore,cf(this._delegate,(Fl("limitToLast",t=e),ff._create("limitToLast",t,"L"))))}catch(e){throw tg(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new ag(this.firestore,cf(this._delegate,function(...e){return gf._create("startAt",e,!0)}(...e)))}catch(e){throw tg(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new ag(this.firestore,cf(this._delegate,function(...e){return gf._create("startAfter",e,!1)}(...e)))}catch(e){throw tg(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new ag(this.firestore,cf(this._delegate,function(...e){return mf._create("endBefore",e,!1)}(...e)))}catch(e){throw tg(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new ag(this.firestore,cf(this._delegate,function(...e){return mf._create("endAt",e,!0)}(...e)))}catch(e){throw tg(e,"endAt()","Query.endAt()")}}isEqual(e){return Ql(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?kf:"server"===(null==e?void 0:e.source)?function(t){t=Ml(t,Ul);const n=Ml(t.firestore,yd),e=vd(n),r=new Cf(n);return cd(e,t._query,{source:"server"}).then(e=>new Df(n,r,t,e))}:function(t){t=Ml(t,Ul);const n=Ml(t.firestore,yd),e=vd(n),r=new Cf(n);return af(t._query),cd(e,t._query).then(e=>new Df(n,r,t,e))})(this._delegate),t.then(e=>new ug(this.firestore,new Df(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=ng(e),n=rg(e,e=>new ug(this.firestore,new Df(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Mf(this._delegate,t,n)}withConverter(e){return new ag(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class og{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new ig(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class ug{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new ag(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new ig(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new og(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new ig(this._firestore,e))})}isEqual(e){return Af(this._delegate,e._delegate)}}class cg extends ag{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new eg(this.firestore,e):null}doc(e){try{return void 0===e?new eg(this.firestore,jl(this._delegate)):new eg(this.firestore,jl(this._delegate,e))}catch(e){throw tg(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=Ml(e.firestore,yd),r=jl(e),s=Ef(e.converter,t);return Of(n,[Vd(Od(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,la.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new eg(this.firestore,e))}isEqual(e){return $l(this._delegate,e._delegate)}withConverter(e){return new cg(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function hg(e){return Ml(e,Bl)}const lg={Firestore:Hf,GeoPoint:Cd,Timestamp:Pr,Blob:Qf,Transaction:Xf,WriteBatch:Jf,DocumentReference:eg,DocumentSnapshot:sg,Query:ag,QueryDocumentSnapshot:ig,QuerySnapshot:ug,CollectionReference:cg,FieldPath:class dg{constructor(...e){this._delegate=new Dd(...e)}static documentId(){return new dg(Kr.keyField().canonicalString())}isEqual(e){return(e=m(e))instanceof Dd&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class fg{constructor(e){this._delegate=e}static serverTimestamp(){const e=new Bd("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new fg(e)}static delete(){const e=new Pd("deleteField");return e._methodName="FieldValue.delete",new fg(e)}static arrayUnion(...e){const t=function(...e){return new Ud("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new fg(t)}static arrayRemove(...e){const t=function(...e){return new Gd("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new fg(t)}static increment(e){const t=new Kd("increment",e);return t._methodName="FieldValue.increment",new fg(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,mr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};md=t.default,pd=(e,t)=>new Hf(e,t,new Wf),md.INTERNAL.registerComponent(new g("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return pd(t,n)},"PUBLIC").setServiceProps(Object.assign({},lg))),md.registerVersion("@firebase/firestore-compat","0.3.1")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
=======
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(Yg,Xg){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(Yg);function n(t){const n=[];let r=0;for(let i=0;i<t.length;i++){let e=t.charCodeAt(i);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&i+1<t.length&&56320==(64512&t.charCodeAt(i+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++i)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let h=0;h<n.length;h+=3){var s=n[h],a=h+1<n.length,o=a?n[h+1]:0,u=h+2<n.length,c=u?n[h+2]:0;let e=(15&o)<<2|c>>6,t=63&c;u||(t=64,a||(e=64)),i.push(r[s>>2],r[(3&s)<<4|o>>4],r[e],r[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var i,s,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(i=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&i)):239<a&&a<365?(s=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))):(i=e[n++],s=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&i)<<6|63&s))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let u=0;u<e.length;){var i=n[e.charAt(u++)],s=u<e.length?n[e.charAt(u)]:0;++u;var a=u<e.length?n[e.charAt(u)]:64;++u;var o=u<e.length?n[e.charAt(u)]:64;if(++u,null==i||null==s||null==a||null==o)throw new c;r.push(i<<2|s>>4),64!==a&&(r.push(s<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class c extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const o=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};const i=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,s=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return r.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},a=()=>{try{return i()||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||s()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){var e=null===(e=a())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class d extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,d.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,f.prototype.create)}}class f{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},i=`${this.service}/${e}`,s=this.errors[e],s=s?(r=n,s.replace(g,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",s=`${this.serviceName}: ${s} (${i}).`;return new d(i,s,n)}}const g=/\{\$([^}]+)}/g;function m(e){return e&&e._delegate?e._delegate:e}class p{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Yd=l=l||{})[Yd.DEBUG=0]="DEBUG",Yd[Yd.VERBOSE=1]="VERBOSE",Yd[Yd.INFO=2]="INFO",Yd[Yd.WARN=3]="WARN",Yd[Yd.ERROR=4]="ERROR",Yd[Yd.SILENT=5]="SILENT";const y={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},v=l.INFO,w={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},_=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=w[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};var b,I="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},E={},T=I||self;function S(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function x(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var D="closure_uid_"+(1e9*Math.random()>>>0),C=0;function A(e,t,n){return e.call.apply(e.bind,arguments)}function N(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function k(e,t,n){return(k=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?A:N).apply(null,arguments)}function R(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function M(e,s){function t(){}t.prototype=s.prototype,e.$=s.prototype,e.prototype=new t,(e.prototype.constructor=e).ac=function(e,t,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return s.prototype[t].apply(e,r)}}function L(){this.s=this.s,this.o=this.o}L.prototype.s=!1,L.prototype.sa=function(){var e;!this.s&&(this.s=!0,this.N(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,D)&&e[D]||(e[D]=++C))},L.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const F=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function O(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function P(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(S(n)){var r=t.length||0,i=n.length||0;t.length=r+i;for(let e=0;e<i;e++)t[r+e]=n[e]}else t.push(n)}}function V(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}V.prototype.h=function(){this.defaultPrevented=!0};var U=function(){if(!T.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{T.addEventListener("test",()=>{},t),T.removeEventListener("test",()=>{},t)}catch(e){}return e}();function B(e){return/^[\s\xa0]*$/.test(e)}function q(){var e=T.navigator;return(e=e&&e.userAgent)?e:""}function G(e){return-1!=q().indexOf(e)}function K(e){return K[" "](e),e}K[" "]=function(){};var j,z=G("Opera"),$=G("Trident")||G("MSIE"),Q=G("Edge"),H=Q||$,W=G("Gecko")&&!(-1!=q().toLowerCase().indexOf("webkit")&&!G("Edge"))&&!(G("Trident")||G("MSIE"))&&!G("Edge"),Y=-1!=q().toLowerCase().indexOf("webkit")&&!G("Edge");function X(){var e=T.document;return e?e.documentMode:void 0}e:{var J="",Z=(Z=q(),W?/rv:([^\);]+)(\)|;)/.exec(Z):Q?/Edge\/([\d\.]+)/.exec(Z):$?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Z):Y?/WebKit\/(\S+)/.exec(Z):z?/(?:Version)[ \/]?(\S+)/.exec(Z):void 0);if(Z&&(J=Z?Z[1]:""),$){Z=X();if(null!=Z&&Z>parseFloat(J)){j=String(Z);break e}}j=J}var ee=T.document&&$&&(X()||parseInt(j,10))||void 0;function te(e,t){if(V.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(W){e:{try{K(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:ne[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&te.$.h.call(this)}}M(te,V);var ne={2:"touch",3:"pen",4:"mouse"};te.prototype.h=function(){te.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var re="closure_listenable_"+(1e6*Math.random()|0),ie=0;function se(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=i,this.key=++ie,this.fa=this.ia=!1}function ae(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function oe(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function ue(e){const t={};for(const n in e)t[n]=e[n];return t}const ce="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function he(t){let n,r;for(let i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(let e=0;e<ce.length;e++)n=ce[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function le(e){this.src=e,this.g={},this.h=0}function de(e,t){var n,r,i,s=t.type;s in e.g&&(n=e.g[s],(i=0<=(r=F(n,t)))&&Array.prototype.splice.call(n,r,1),i&&(ae(t),0==e.g[s].length&&(delete e.g[s],e.h--)))}function fe(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.fa&&s.listener==t&&s.capture==!!n&&s.la==r)return i}return-1}le.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var a=fe(e,t,r,i);return-1<a?(t=e[a],n||(t.ia=!1)):((t=new se(t,this.src,s,!!r,i)).ia=n,e.push(t)),t};var ge="closure_lm_"+(1e6*Math.random()|0),me={};function pe(e,t,n,r,i){if(r&&r.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}r=Ee(r);return t&&t[re]?t.P(n,r,x(i)?!!i.capture:!!i,s):ye(t,n,r,!0,i,s)}(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)pe(e,t[s],n,r,i);return null}return n=Ee(n),e&&e[re]?e.O(t,n,x(r)?!!r.capture:!!r,i):ye(e,t,n,!1,r,i)}function ye(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var a=x(i)?!!i.capture:!!i,o=be(e);if(o||(e[ge]=o=new le(e)),(n=o.add(t,n,r,a,s)).proxy)return n;if(r=function(){const n=_e;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(i=!U?a:i)&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(we(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function ve(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[re]?de(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(we(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=be(t))?(de(n,e),0==n.h&&(n.src=null,t[ge]=null)):ae(e)))}function we(e){return e in me?me[e]:me[e]="on"+e}function _e(e,t){var n,r;return e=!!e.fa||(t=new te(t,this),n=e.listener,r=e.la||e.src,e.ia&&ve(e),n.call(r,t))}function be(e){return(e=e[ge])instanceof le?e:null}var Ie="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ee(t){return"function"==typeof t?t:(t[Ie]||(t[Ie]=function(e){return t.handleEvent(e)}),t[Ie])}function Te(){L.call(this),this.i=new le(this),(this.S=this).J=null}function Se(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new V(t,e):t instanceof V?t.target=t.target||e:(a=t,he(t=new V(r,e),a)),a=!0,n)for(var i=n.length-1;0<=i;i--)var s=t.g=n[i],a=xe(s,r,!0,t)&&a;if(a=xe(s=t.g=e,r,!0,t)&&a,a=xe(s,r,!1,t)&&a,n)for(i=0;i<n.length;i++)a=xe(s=t.g=n[i],r,!1,t)&&a}function xe(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a,o,u=t[s];u&&!u.fa&&u.capture==n&&(a=u.listener,o=u.la||u.src,u.ia&&de(e.i,u),i=!1!==a.call(o,r)&&i)}return i&&!r.defaultPrevented}M(Te,L),Te.prototype[re]=!0,Te.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);else i=x(i)?!!i.capture:!!i,r=Ee(r),t&&t[re]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=fe(a=t.g[n],r,i,s))&&(ae(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&be(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?fe(n,r,i,s):t)?n[t]:null)&&ve(r))}(this,e,t,n,r)},Te.prototype.N=function(){if(Te.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)ae(n[r]);delete t.g[e],t.h--}}this.J=null},Te.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Te.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var De=T.JSON.stringify;var Ce=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Ae,e=>e.reset());class Ae{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Ne,ke=!1,Re=new class{constructor(){this.h=this.g=null}add(e,t){const n=Ce.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},Me=()=>{const e=T.Promise.resolve(void 0);Ne=()=>{e.then(Le)}};var Le=()=>{for(var e;e=function(){var e=Re;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){T.setTimeout(()=>{throw e},0)}(e)}var t=Ce;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}ke=!1};function Fe(e,t){Te.call(this),this.h=e||1,this.g=t||T,this.j=k(this.qb,this),this.l=Date.now()}function Oe(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function Pe(e,t,n){if("function"==typeof e)n&&(e=k(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=k(e.handleEvent,e)}return 2147483647<Number(t)?-1:T.setTimeout(e,t||0)}M(Fe,Te),(b=Fe.prototype).ga=!1,b.T=null,b.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),Se(this,"tick"),this.ga&&(Oe(this),this.start())))},b.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},b.N=function(){Fe.$.N.call(this),Oe(this),delete this.g};class Ve extends L{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Pe(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(T.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ue(e){L.call(this),this.h=e,this.g={}}M(Ue,L);var Be=[];function qe(e,t,n,r){Array.isArray(n)||(n&&(Be[0]=n.toString()),n=Be);for(var i=0;i<n.length;i++){var s=pe(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function Ge(e){oe(e.g,function(e,t){this.g.hasOwnProperty(t)&&ve(e)},e),e.g={}}function Ke(){this.g=!0}function je(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return De(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Ue.prototype.N=function(){Ue.$.N.call(this),Ge(this)},Ue.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Ke.prototype.Ea=function(){this.g=!1},Ke.prototype.info=function(){};var ze={},$e=null;function Qe(){return $e=$e||new Te}function He(e){V.call(this,ze.Ta,e)}function We(){var e=Qe();Se(e,new He(e))}function Ye(e,t){V.call(this,ze.STAT_EVENT,e),this.stat=t}function Xe(e){var t=Qe();Se(t,new Ye(t,e))}function Je(e,t){V.call(this,ze.Ua,e),this.size=t}function Ze(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return T.setTimeout(function(){e()},t)}ze.Ta="serverreachability",M(He,V),ze.STAT_EVENT="statevent",M(Ye,V),ze.Ua="timingevent",M(Je,V);var et={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},tt={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function nt(){}function rt(e){return e.h||(e.h=e.i())}function it(){}nt.prototype.h=null;I={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function st(){V.call(this,"d")}function at(){V.call(this,"c")}function ot(){}function ut(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new Ue(this),this.P=lt,this.V=new Fe(e=H?125:void 0),this.I=null,this.i=!1,this.s=this.A=this.v=this.L=this.G=this.Y=this.B=null,this.F=[],this.g=null,this.C=0,this.o=this.u=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new ct}function ct(){this.i=null,this.g="",this.h=!1}M(st,V),M(at,V),M(ot,nt),ot.prototype.g=function(){return new XMLHttpRequest},ot.prototype.i=function(){return{}};var ht=new ot,lt=45e3,dt={},ft={};function gt(e,t,n){e.L=1,e.v=Rt(Dt(t)),e.s=n,e.S=!0,mt(e,null)}function mt(e,t){e.G=Date.now(),vt(e),e.A=Dt(e.v);var a,o,u,c,h,l,n=e.A,r=e.W;Array.isArray(r)||(r=[String(r)]),zt(n.i,"t",r),e.C=0,n=e.l.J,e.h=new ct,e.g=zn(e.l,n?t:null,!e.s),0<e.O&&(e.M=new Ve(k(e.Pa,e,e.g),e.O)),qe(e.U,e.g,"readystatechange",e.nb),t=e.I?ue(e.I):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.A,e.u,e.s,t)):(e.u="GET",e.g.ha(e.A,e.u,null,t)),We(),a=e.j,o=e.u,u=e.A,c=e.m,h=e.W,l=e.s,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,i,s=t[n].split("=");1<s.length&&(r=s[0],s=s[1],e=2<=(i=r.split("_")).length&&"type"==i[1]?e+(r+"=")+s+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function pt(e){return e.g&&("GET"==e.u&&2!=e.L&&e.l.Ha)}function yt(e,t,n){let r=!0,i;for(;!e.J&&e.C<n.length;){if(i=(a=n,u=o=void 0,o=(s=e).C,-1==(u=a.indexOf("\n",o))?ft:(o=Number(a.substring(o,u)),isNaN(o)?dt:(u+=1)+o>a.length?ft:(a=a.slice(u,u+o),s.C=u+o,a))),i==ft){4==t&&(e.o=4,Xe(14),r=!1),je(e.j,e.m,null,"[Incomplete Response]");break}if(i==dt){e.o=4,Xe(15),je(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}je(e.j,e.m,i,null),Et(e,i)}var s,a,o,u;pt(e)&&i!=ft&&i!=dt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,Xe(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),Pn(t),t.M=!0,Xe(11))):(je(e.j,e.m,n,"[Invalid Chunked Response]"),It(e),bt(e))}function vt(e){e.Y=Date.now()+e.P,wt(e,e.P)}function wt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=Ze(k(e.lb,e),t)}function _t(e){e.B&&(T.clearTimeout(e.B),e.B=null)}function bt(e){0==e.l.H||e.J||Bn(e.l,e)}function It(e){_t(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,Oe(e.V),Ge(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function Et(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||Xt(n.i,e)))if(!e.K&&Xt(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;Un(n),An(n)}On(n),Xe(18)}}else n.Fa=i[1],0<n.Fa-n.V&&i[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=Ze(k(n.ib,n),6e3));if(Yt(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else Gn(n,11)}else if(!e.K&&n.g!=e||Un(n),!B(t))for(i=n.Ja.g.parse(t),t=0;t<i.length;t++){var s=i[t];if(n.V=s[0],s=s[1],2==n.H)if("c"==s[0]){n.K=s[1],n.pa=s[2];var a=s[3];null!=a&&(n.ra=a,n.l.info("VER="+n.ra));var o=s[4];null!=o&&(n.Ga=o,n.l.info("SVER="+n.Ga));var u,c,h=s[5];null!=h&&"number"==typeof h&&0<h&&(r=1.5*h,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const g=e.g;if(g){const m=g.g?g.g.getResponseHeader("X-Client-Wire-Protocol"):null;m&&((u=r.i).g||-1==m.indexOf("spdy")&&-1==m.indexOf("quic")&&-1==m.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(Jt(u,u.h),u.h=null))),!r.F||(c=g.g?g.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=c,kt(r.I,r.F,c))}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms"));var l,d,f=e;(r=n).wa=jn(r,r.J?r.pa:null,r.Y),f.K?(Zt(r.i,f),l=f,(d=r.L)&&l.setTimeout(d),l.B&&(_t(l),vt(l)),r.g=f):Fn(r),0<n.j.length&&kn(n)}else"stop"!=s[0]&&"close"!=s[0]||Gn(n,7);else 3==n.H&&("stop"==s[0]||"close"==s[0]?"stop"==s[0]?Gn(n,7):Cn(n):"noop"!=s[0]&&n.h&&n.h.Aa(s),n.A=0)}We()}catch(e){}}function Tt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(S(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(S(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(S(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(b=ut.prototype).setTimeout=function(e){this.P=e},b.nb=function(e){e=e.target;const t=this.M;t&&3==In(e)?t.l():this.Pa(e)},b.Pa=function(e){try{if(e==this.g)e:{var t=In(this.g),n=this.g.Ia();this.g.da();if(!(t<3)&&(3!=t||H||this.g&&(this.h.h||this.g.ja()||En(this.g)))){this.J||4!=t||7==n||We(),_t(this);var r=this.g.da();this.ca=r;t:if(pt(this)){var i=En(this.g);e="";var s=i.length,a=4==In(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){It(this),bt(this);var o="";break t}this.h.i=new T.TextDecoder}for(n=0;n<s;n++)this.h.h=!0,e+=this.h.i.decode(i[n],{stream:a&&n==s-1});i.splice(0,s),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ja();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.W,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!B(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.o=3,Xe(12),It(this),bt(this);break e}je(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Et(this,r)}this.S?(yt(this,t,o),H&&this.i&&3==t&&(qe(this.U,this.V,"tick",this.mb),this.V.start())):(je(this.j,this.m,o,null),Et(this,o)),4==t&&It(this),this.i&&!this.J&&(4==t?Bn(this.l,this):(this.i=!1,vt(this)))}else(function(e){const t={};e=(e.g&&2<=In(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let i=0;i<e.length;i++)if(!B(e[i])){var n=function(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(e[i]),r=n[0];if("string"==typeof(n=n[1])){n=n.trim();const s=t[r]||[];t[r]=s,s.push(n)}}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,function(e){return e.join(", ")})})(this.g),400==r&&0<o.indexOf("Unknown SID")?(this.o=3,Xe(12)):(this.o=0,Xe(13)),It(this),bt(this)}}}catch(e){}var l,d,f,g,m,p,y},b.mb=function(){var e,t;this.g&&(e=In(this.g),t=this.g.ja(),this.C<t.length&&(_t(this),yt(this,e,t),this.i&&4!=e&&vt(this)))},b.cancel=function(){this.J=!0,It(this)},b.lb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(We(),Xe(17)),It(this),this.o=2,bt(this)):wt(this,this.Y-n)};var St=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function xt(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof xt?(this.h=e.h,Ct(this,e.j),this.s=e.s,this.g=e.g,At(this,e.m),this.l=e.l,t=e.i,(n=new qt).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Nt(this,n),this.o=e.o):e&&(t=String(e).match(St))?(this.h=!1,Ct(this,t[1]||"",!0),this.s=Mt(t[2]||""),this.g=Mt(t[3]||"",!0),At(this,t[4]),this.l=Mt(t[5]||"",!0),Nt(this,t[6]||"",!0),this.o=Mt(t[7]||"")):(this.h=!1,this.i=new qt(null,this.h))}function Dt(e){return new xt(e)}function Ct(e,t,n){e.j=n?Mt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function At(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Nt(e,t,n){var r,i;t instanceof qt?(e.i=t,r=e.i,(i=e.h)&&!r.j&&(Gt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Kt(this,t),zt(this,n,e))},r)),r.j=i):(n||(t=Lt(t,Ut)),e.i=new qt(t,e.h))}function kt(e,t,n){e.i.set(t,n)}function Rt(e){return kt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Mt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Lt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,Ft),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function Ft(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}xt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Lt(t,Ot,!0),":");var n=this.g;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Lt(t,Ot,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Lt(n,"/"==n.charAt(0)?Vt:Pt,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Lt(n,Bt)),e.join("")};var Ot=/[#\/\?@]/g,Pt=/[#\?:]/g,Vt=/[#\?]/g,Ut=/[#\?@]/g,Bt=/#/g;function qt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Gt(n){n.g||(n.g=new Map,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,i=e[n].indexOf("="),s=null;0<=i?(r=e[n].substring(0,i),s=e[n].substring(i+1)):r=e[n],t(r,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Kt(e,t){Gt(e),t=$t(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function jt(e,t){return Gt(e),t=$t(e,t),e.g.has(t)}function zt(e,t,n){Kt(e,t),0<n.length&&(e.i=null,e.g.set($t(e,t),O(n)),e.h+=n.length)}function $t(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(b=qt.prototype).add=function(e,t){Gt(this),this.i=null,e=$t(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},b.forEach=function(n,r){Gt(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},b.ta=function(){Gt(this);const t=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let s=0;s<n.length;s++){var i=t[s];for(let e=0;e<i.length;e++)r.push(n[s])}return r},b.Z=function(t){Gt(this);let n=[];if("string"==typeof t)jt(this,t)&&(n=n.concat(this.g.get($t(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},b.set=function(e,t){return Gt(this),this.i=null,jt(this,e=$t(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},b.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},b.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],i=encodeURIComponent(String(r)),s=this.Z(r),r=0;r<s.length;r++){var a=i;""!==s[r]&&(a+="="+encodeURIComponent(String(s[r]))),e.push(a)}return this.i=e.join("&")};var Qt=class{constructor(e,t){this.g=e,this.map=t}};function Ht(e){this.l=e||10,e=T.PerformanceNavigationTiming?0<(e=T.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(T.g&&T.g.Ka&&T.g.Ka()&&T.g.Ka().ec),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Wt(e){return e.h||e.g&&e.g.size>=e.j}function Yt(e){return e.h?1:e.g?e.g.size:0}function Xt(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function Jt(e,t){e.g?e.g.add(t):e.h=t}function Zt(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function en(t){if(null!=t.h)return t.i.concat(t.h.F);if(null==t.g||0===t.g.size)return O(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}}Ht.prototype.cancel=function(){if(this.i=en(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var tn,nn=class{stringify(e){return T.JSON.stringify(e,void 0)}parse(e){return T.JSON.parse(e,void 0)}};function rn(){this.g=new nn}function sn(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function an(e){this.l=e.fc||null,this.j=e.ob||!1}function on(e,t){Te.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=un,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}M(an,nt),an.prototype.g=function(){return new on(this.l,this.j)},an.prototype.i=(tn={},function(){return tn}),M(on,Te);var un=0;function cn(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function hn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,ln(e)}function ln(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(b=on.prototype).open=function(e,t){if(this.readyState!=un)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,ln(this)},b.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||T).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},b.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,hn(this)),this.readyState=un},b.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,ln(this)),this.g&&(this.readyState=3,ln(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==T.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;cn(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},b.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?hn:ln)(this),3==this.readyState&&cn(this))},b.Za=function(e){this.g&&(this.response=this.responseText=e,hn(this))},b.Ya=function(e){this.g&&(this.response=e,hn(this))},b.ka=function(){this.g&&hn(this)},b.setRequestHeader=function(e,t){this.v.append(e,t)},b.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},b.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(on.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var dn=T.JSON.parse;function fn(e){Te.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=gn,this.L=this.M=!1}M(fn,Te);var gn="",mn=/^https?$/i,pn=["POST","PUT"];function yn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,vn(e),_n(e)}function vn(e){e.F||(e.F=!0,Se(e,"complete"),Se(e,"error"))}function wn(e){if(e.h&&void 0!==E&&(!e.C[1]||4!=In(e)||2!=e.da()))if(e.v&&4==In(e))Pe(e.La,0,e);else if(Se(e,"readystatechange"),4==In(e)){e.h=!1;try{var t,n,r,i=e.da();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var s=!0;break e;default:s=!1}if((t=s)||((n=0===i)&&(!(r=String(e.I).match(St)[1]||null)&&T.self&&T.self.location&&(r=T.self.location.protocol.slice(0,-1)),n=!mn.test(r?r.toLowerCase():"")),t=n),t)Se(e,"complete"),Se(e,"success");else{e.m=6;try{var a=2<In(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.da()+"]",vn(e)}}finally{_n(e)}}}function _n(e,t){if(e.g){bn(e);const n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||Se(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function bn(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(T.clearTimeout(e.A),e.A=null)}function In(e){return e.g?e.g.readyState:0}function En(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.K){case gn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Tn(e){let n="";return oe(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}function Sn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=Tn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):kt(e,t,n))}function xn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Dn(e){this.Ga=0,this.j=[],this.l=new Ke,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=xn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=xn("baseRetryDelayMs",5e3,e),this.hb=xn("retryDelaySeedMs",1e4,e),this.eb=xn("forwardChannelMaxRetries",2,e),this.xa=xn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.dc||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new Ht(e&&e.concurrentRequestLimit),this.Ja=new rn,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Cn(e){if(Nn(e),3==e.H){var t=e.W++,n=Dt(e.I);if(kt(n,"SID",e.K),kt(n,"RID",t),kt(n,"TYPE","terminate"),Mn(e,n),(t=new ut(e,e.l,t)).L=2,t.v=Rt(Dt(n)),n=!1,T.navigator&&T.navigator.sendBeacon)try{n=T.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&T.Image&&((new Image).src=t.v,n=!0),n||(t.g=zn(t.l,null),t.g.ha(t.v)),t.G=Date.now(),vt(t)}Kn(e)}function An(e){e.g&&(Pn(e),e.g.cancel(),e.g=null)}function Nn(e){An(e),e.u&&(T.clearTimeout(e.u),e.u=null),Un(e),e.i.cancel(),e.m&&("number"==typeof e.m&&T.clearTimeout(e.m),e.m=null)}function kn(e){var t;Wt(e.i)||e.m||(e.m=!0,t=e.Na,Ne||Me(),ke||(Ne(),ke=!0),Re.add(t,e),e.C=0)}function Rn(e,t){var n=t?t.m:e.W++,r=Dt(e.I);kt(r,"SID",e.K),kt(r,"RID",n),kt(r,"AID",e.V),Mn(e,r),e.o&&e.s&&Sn(r,e.o,e.s),n=new ut(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=Ln(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),Jt(e.i,n),gt(n,r,t)}function Mn(e,n){e.na&&oe(e.na,function(e,t){kt(n,t,e)}),e.h&&Tt({},function(e,t){kt(n,t,e)})}function Ln(e,t,r){r=Math.min(e.j.length,r);var i=e.h?k(e.h.Va,e.h,e):null;e:{var s=e.j;let n=-1;for(;;){const u=["count="+r];-1==n?0<r?(n=s[0].g,u.push("ofs="+n)):n=0:u.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=s[t].g,o=s[t].map;if((a-=n)<0)n=Math.max(0,s[t].g-100),e=!1;else try{!function(e,r,t){const i=t||"";try{Tt(e,function(e,t){let n=e;x(e)&&(n=De(e)),r.push(i+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(i+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+a+"_")}catch(e){i&&i(o)}}if(e){i=u.join("&");break e}}}return e=e.j.splice(0,r),t.F=e,i}function Fn(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Ne||Me(),ke||(Ne(),ke=!0),Re.add(t,e),e.A=0)}function On(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=Ze(k(e.Ma,e),qn(e,e.A)),e.A++,1)}function Pn(e){null!=e.B&&(T.clearTimeout(e.B),e.B=null)}function Vn(e){e.g=new ut(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=Dt(e.wa);kt(t,"RID","rpc"),kt(t,"SID",e.K),kt(t,"AID",e.V),kt(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&kt(t,"TO",e.qa),kt(t,"TYPE","xmlhttp"),Mn(e,t),e.o&&e.s&&Sn(t,e.o,e.s),e.L&&e.g.setTimeout(e.L);var n=e.g;e=e.pa,n.L=1,n.v=Rt(Dt(t)),n.s=null,n.S=!0,mt(n,e)}function Un(e){null!=e.v&&(T.clearTimeout(e.v),e.v=null)}function Bn(e,t){var n,r,i,s=null;if(e.g==t){Un(e),Pn(e),e.g=null;var a=2}else{if(!Xt(e.i,t))return;s=t.F,Zt(e.i,t),a=1}if(0!=e.H)if(t.i)1==a?(s=t.s?t.s.length:0,t=Date.now()-t.G,n=e.C,Se(a=Qe(),new Je(a,s)),kn(e)):Fn(e);else if(3==(n=t.o)||0==n&&0<t.ca||(1!=a||(i=t,Yt((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.j=i.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=Ze(k(r.Na,r,i),qn(r,r.C)),r.C++,0))))&&(2!=a||!On(e)))switch(s&&0<s.length&&(t=e.i,t.i=t.i.concat(s)),n){case 1:Gn(e,5);break;case 4:Gn(e,10);break;case 3:Gn(e,6);break;default:Gn(e,2)}}function qn(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function Gn(e,t){var n,r;e.l.info("Error code "+t),2==t?(n=null,e.h&&(n=null),r=k(e.pb,e),n||(n=new xt("//www.google.com/images/cleardot.gif"),T.location&&"http"==T.location.protocol||Ct(n,"https"),Rt(n)),function(e,t){var n=new Ke;if(T.Image){const r=new Image;r.onload=R(sn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=R(sn,n,r,"TestLoadImage: error",!1,t),r.onabort=R(sn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=R(sn,n,r,"TestLoadImage: timeout",!1,t),T.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):Xe(2),e.H=0,e.h&&e.h.za(t),Kn(e),Nn(e)}function Kn(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=en(e.i)).length&&0==e.j.length||(P(e.ma,t),P(e.ma,e.j),e.i.i.length=0,O(e.j),e.j.length=0),e.h.ya())}function jn(e,t,n){var r,i,s=n instanceof xt?Dt(n):new xt(n);return""!=s.g?(t&&(s.g=t+"."+s.g),At(s,s.m)):(s=(r=T.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,i=new xt(null),s&&Ct(i,s),t&&(i.g=t),r&&At(i,r),n&&(i.l=n),s=i),n=e.F,t=e.Da,n&&t&&kt(s,n,t),kt(s,"VER",e.ra),Mn(e,s),s}function zn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ha&&!e.va?new fn(new an({ob:!0})):new fn(e.va)).Oa(e.J),t}function $n(){}function Qn(){if($&&!(10<=Number(ee)))throw Error("Environmental error: no available transport.")}function Hn(e,t){Te.call(this),this.g=new Dn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!B(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!B(t)&&(this.g.F=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new Xn(this)}function Wn(e){st.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function Yn(){at.call(this),this.status=1}function Xn(e){this.g=e}function Jn(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Zn(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1];var i=e.g[2],s=e.g[3],a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+((a=t+(s^n&(i^s))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function er(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}(b=fn.prototype).Oa=function(e){this.M=e},b.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||ht).g(),this.C=this.u?rt(this.u):rt(ht),this.g.onreadystatechange=k(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void yn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),i=T.FormData&&e instanceof T.FormData,0<=F(pn,t)&&!r&&!i&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[s,a]of n)this.g.setRequestHeader(s,a);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{bn(this),0<this.B&&((this.L=(o=this.g,$&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=k(this.ua,this)):this.A=Pe(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){yn(this,e)}var o},b.ua=function(){void 0!==E&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Se(this,"timeout"),this.abort(8))},b.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Se(this,"complete"),Se(this,"abort"),_n(this))},b.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),_n(this,!0)),fn.$.N.call(this)},b.La=function(){this.s||(this.G||this.v||this.l?wn(this):this.kb())},b.kb=function(){wn(this)},b.isActive=function(){return!!this.g},b.da=function(){try{return 2<In(this)?this.g.status:-1}catch(e){return-1}},b.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},b.Wa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),dn(t)}},b.Ia=function(){return this.m},b.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(b=Dn.prototype).ra=8,b.H=1,b.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const s=new ut(this,this.l,t);let e=this.s;if(this.U&&(e?(e=ue(e),he(e,this.U)):e=this.U),null!==this.o||this.O||(s.I=e,e=null),this.P)e:{for(var n=0,r=0;r<this.j.length;r++){var i=this.j[r];if("__data__"in i.map&&"string"==typeof(i=i.map.__data__)?i=i.length:i=void 0,void 0===i)break;if(4096<(n+=i)){n=r;break e}if(4096===n||r===this.j.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Ln(this,s,n),kt(r=Dt(this.I),"RID",t),kt(r,"CVER",22),this.F&&kt(r,"X-HTTP-Session-Id",this.F),Mn(this,r),e&&(this.O?n="headers="+encodeURIComponent(String(Tn(e)))+"&"+n:this.o&&Sn(r,this.o,e)),Jt(this.i,s),this.bb&&kt(r,"TYPE","init"),this.P?(kt(r,"$req",n),kt(r,"SID","null"),s.aa=!0,gt(s,r,null)):gt(s,r,n),this.H=2}}else 3==this.H&&(t?Rn(this,t):0==this.j.length||Wt(this.i)||Rn(this))},b.Ma=function(){var e;this.u=null,Vn(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=Ze(k(this.jb,this),e))},b.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Xe(10),An(this),Vn(this))},b.ib=function(){null!=this.v&&(this.v=null,An(this),On(this),Xe(19))},b.pb=function(e){e?(this.l.info("Successfully pinged google.com"),Xe(2)):(this.l.info("Failed to ping google.com"),Xe(1))},b.isActive=function(){return!!this.h&&this.h.isActive(this)},(b=$n.prototype).Ba=function(){},b.Aa=function(){},b.za=function(){},b.ya=function(){},b.isActive=function(){return!0},b.Va=function(){},Qn.prototype.g=function(e,t){return new Hn(e,t)},M(Hn,Te),Hn.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;Xe(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=jn(e,null,e.Y),kn(e)},Hn.prototype.close=function(){Cn(this.g)},Hn.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=De(e),e=t),n.j.push(new Qt(n.fb++,e)),3==n.H&&kn(n)},Hn.prototype.N=function(){this.g.h=null,delete this.j,Cn(this.g),delete this.g,Hn.$.N.call(this)},M(Wn,st),M(Yn,at),M(Xn,$n),Xn.prototype.Ba=function(){Se(this.g,"a")},Xn.prototype.Aa=function(e){Se(this.g,new Wn(e))},Xn.prototype.za=function(e){Se(this.g,new Yn)},Xn.prototype.ya=function(){Se(this.g,"b")},M(Jn,function(){this.blockSize=-1}),Jn.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Jn.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(0==i)for(;s<=n;)Zn(this,e,s),s+=this.blockSize;if("string"==typeof e){for(;s<t;)if(r[i++]=e.charCodeAt(s++),i==this.blockSize){Zn(this,r),i=0;break}}else for(;s<t;)if(r[i++]=e[s++],i==this.blockSize){Zn(this,r),i=0;break}}this.h=i,this.i+=t},Jn.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;for(var n=8*this.i,t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var tr={};function nr(e){return-128<=e&&e<128?(t=e,n=function(e){return new er([0|e],e<0?-1:0)},r=tr,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new er([0|e],e<0?-1:0);var t,n,r}function rr(e){if(isNaN(e)||!isFinite(e))return sr;if(e<0)return hr(rr(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=ir;return new er(t,0)}var ir=4294967296,sr=nr(0),ar=nr(1),or=nr(16777216);function ur(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function cr(e){return-1==e.h}function hr(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new er(n,~e.h).add(ar)}function lr(e,t){return e.add(hr(t))}function dr(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function fr(e,t){this.g=e,this.h=t}function gr(e,t){if(ur(t))throw Error("division by zero");if(ur(e))return new fr(sr,sr);if(cr(e))return t=gr(hr(e),t),new fr(hr(t.g),hr(t.h));if(cr(t))return t=gr(e,hr(t)),new fr(hr(t.g),t.h);if(30<e.g.length){if(cr(e)||cr(t))throw Error("slowDivide_ only works with positive integers.");for(var n=ar,r=t;r.X(e)<=0;)n=mr(n),r=mr(r);for(var i=pr(n,1),s=pr(r,1),r=pr(r,2),n=pr(n,2);!ur(r);){var a=s.add(r);a.X(e)<=0&&(i=i.add(n),s=a),r=pr(r,1),n=pr(n,1)}return t=lr(e,i.R(t)),new fr(i,t)}for(i=sr;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(s=rr(n)).R(t);cr(a)||0<a.X(e);)a=(s=rr(n-=r)).R(t);ur(s)&&(s=ar),i=i.add(s),e=lr(e,a)}return new fr(i,e)}function mr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new er(n,e.h)}function pr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,i=[],s=0;s<r;s++)i[s]=0<t?e.D(s+n)>>>t|e.D(s+n+1)<<32-t:e.D(s+n);return new er(i,e.h)}(b=er.prototype).ea=function(){if(cr(this))return-hr(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:ir+r)*t,t*=ir}return e},b.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(ur(this))return"0";if(cr(this))return"-"+hr(this).toString(e);for(var t=rr(Math.pow(e,6)),n=this,r="";;){var i=gr(n,t).g,s=((0<(n=lr(n,i.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(ur(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},b.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},b.X=function(e){return cr(e=lr(this,e))?-1:ur(e)?0:1},b.abs=function(){return cr(this)?hr(this):this},b.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,i=0;i<=t;i++){var s=r+(65535&this.D(i))+(65535&e.D(i)),a=(s>>>16)+(this.D(i)>>>16)+(e.D(i)>>>16),r=a>>>16;s&=65535,a&=65535,n[i]=a<<16|s}return new er(n,-2147483648&n[n.length-1]?-1:0)},b.R=function(e){if(ur(this)||ur(e))return sr;if(cr(this))return cr(e)?hr(this).R(hr(e)):hr(hr(this).R(e));if(cr(e))return hr(this.R(hr(e)));if(this.X(or)<0&&e.X(or)<0)return rr(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<e.g.length;i++){var s=this.D(r)>>>16,a=65535&this.D(r),o=e.D(i)>>>16,u=65535&e.D(i);n[2*r+2*i]+=a*u,dr(n,2*r+2*i),n[2*r+2*i+1]+=s*u,dr(n,2*r+2*i+1),n[2*r+2*i+1]+=a*o,dr(n,2*r+2*i+1),n[2*r+2*i+2]+=s*o,dr(n,2*r+2*i+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new er(n,0)},b.gb=function(e){return gr(this,e).h},b.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new er(n,this.h&e.h)},b.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new er(n,this.h|e.h)},b.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new er(n,this.h^e.h)},Qn.prototype.createWebChannel=Qn.prototype.g,Hn.prototype.send=Hn.prototype.u,Hn.prototype.open=Hn.prototype.m,et.NO_ERROR=0,et.TIMEOUT=8,et.HTTP_ERROR=6,tt.COMPLETE="complete",(it.EventType=I).OPEN="a",I.CLOSE="b",I.ERROR="c",I.MESSAGE="d",Te.prototype.listen=Te.prototype.O,fn.prototype.listenOnce=fn.prototype.P,fn.prototype.getLastError=fn.prototype.Sa,fn.prototype.getLastErrorCode=fn.prototype.Ia,fn.prototype.getStatus=fn.prototype.da,fn.prototype.getResponseJson=fn.prototype.Wa,fn.prototype.getResponseText=fn.prototype.ja,fn.prototype.send=fn.prototype.ha,fn.prototype.setWithCredentials=fn.prototype.Oa,Jn.prototype.digest=Jn.prototype.l,Jn.prototype.update=Jn.prototype.j,er.prototype.multiply=er.prototype.R,er.prototype.modulo=er.prototype.gb,er.prototype.compare=er.prototype.X,er.prototype.toNumber=er.prototype.ea,er.prototype.getBits=er.prototype.D,er.fromNumber=rr,er.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return hr(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=rr(Math.pow(n,8)),i=sr,s=0;s<t.length;s+=8)var a=Math.min(8,t.length-s),o=parseInt(t.substring(s,s+a),n),i=a<8?(a=rr(Math.pow(n,a)),i.R(a).add(rr(o))):(i=i.R(r)).add(rr(o));return i};var yr,vr=Qe,wr=et,_r=tt,br=ze,Ir=10,Er=11,Tr=an,Sr=it,xr=fn,Dr=Jn,Cr=er;const Ar="@firebase/firestore";class Nr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Nr.UNAUTHENTICATED=new Nr(null),Nr.GOOGLE_CREDENTIALS=new Nr("google-credentials-uid"),Nr.FIRST_PARTY=new Nr("first-party-uid"),Nr.MOCK_USER=new Nr("mock-user");let kr="10.1.0";const Rr=new class{constructor(e){this.name=e,this._logLevel=v,this._logHandler=_,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?y[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function Mr(){return Rr.logLevel}function Lr(e,...t){var n;Rr.logLevel<=l.DEBUG&&(n=t.map(Pr),Rr.debug(`Firestore (${kr}): ${e}`,...n))}function Fr(e,...t){var n;Rr.logLevel<=l.ERROR&&(n=t.map(Pr),Rr.error(`Firestore (${kr}): ${e}`,...n))}function Or(e,...t){var n;Rr.logLevel<=l.WARN&&(n=t.map(Pr),Rr.warn(`Firestore (${kr}): ${e}`,...n))}function Pr(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function Vr(e="Unexpected state"){var t=`FIRESTORE (${kr}) INTERNAL ASSERTION FAILED: `+e;throw Fr(t),new Error(t)}function Ur(e){e||Vr()}const Br={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class qr extends d{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Gr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Kr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class jr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Nr.UNAUTHENTICATED))}shutdown(){}}class zr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class $r{constructor(e){this.t=e,this.currentUser=Nr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const i=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let s=new Gr;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Gr,t.enqueueRetryable(()=>i(this.currentUser))};const a=()=>{const e=s;t.enqueueRetryable(async()=>{await e.promise,await i(this.currentUser)})},o=e=>{Lr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(Lr("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Gr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(Lr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Ur("string"==typeof e.accessToken),new Kr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Ur(null===e||"string"==typeof e),new Nr(e)}}class Qr{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=Nr.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Hr{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new Qr(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Nr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Wr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Yr{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,n){const r=e=>{null!=e.error&&Lr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.R;return this.R=e.token,Lr("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const i=e=>{Lr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>i(e)),setTimeout(()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?i(e):Lr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Ur("string"==typeof e.token),this.R=e.token,new Wr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Xr{static V(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var i=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<i.length;++e)r.length<20&&i[e]<n&&(r+=t.charAt(i[e]%t.length))}return r}}function Jr(e,t){return e<t?-1:t<e?1:0}function Zr(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function ei(e){return e+"\0"}class ti{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new qr(Br.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new qr(Br.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new qr(Br.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new qr(Br.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ti.fromMillis(Date.now())}static fromDate(e){return ti.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new ti(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Jr(this.nanoseconds,e.nanoseconds):Jr(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ni{constructor(e){this.timestamp=e}static fromTimestamp(e){return new ni(e)}static min(){return new ni(new ti(0,0))}static max(){return new ni(new ti(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ri{constructor(e,t,n){void 0===t?t=0:t>e.length&&Vr(),void 0===n?n=e.length-t:n>e.length-t&&Vr(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===ri.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof ri?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class ii extends ri{construct(e,t,n){return new ii(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new qr(Br.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new ii(t)}static emptyPath(){return new ii([])}}const si=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ai extends ri{construct(e,t,n){return new ai(e,t,n)}static isValidIdentifier(e){return si.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!ai.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new ai(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var i=()=>{if(0===n.length)throw new qr(Br.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new qr(Br.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new qr(Br.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new qr(Br.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new ai(t)}static emptyPath(){return new ai([])}}class oi{constructor(e){this.path=e}static fromPath(e){return new oi(ii.fromString(e))}static fromName(e){return new oi(ii.fromString(e).popFirst(5))}static empty(){return new oi(ii.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ii.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ii.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new oi(new ii(e.slice()))}}class ui{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function ci(e){return e.fields.find(e=>2===e.kind)}function hi(e){return e.fields.filter(e=>2!==e.kind)}ui.UNKNOWN_ID=-1;class li{constructor(e,t){this.fieldPath=e,this.kind=t}}class di{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new di(0,mi.min())}}function fi(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,r=ni.fromTimestamp(1e9===r?new ti(n+1,0):new ti(n,r));return new mi(r,oi.empty(),t)}function gi(e){return new mi(e.readTime,e.key,-1)}class mi{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new mi(ni.min(),oi.empty(),-1)}static max(){return new mi(ni.max(),oi.empty(),-1)}}function pi(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=oi.comparator(e.documentKey,t.documentKey),0!==n?n:Jr(e.largestBatchId,t.largestBatchId))}const yi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class vi{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function wi(e){if(e.code!==Br.FAILED_PRECONDITION||e.message!==yi)throw e;Lr("LocalStore","Unexpectedly lost primary lease")}class _i{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,i){return this.callbackAttached&&Vr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new _i((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(i,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof _i?t:_i.resolve(t)}catch(e){return _i.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):_i.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):_i.reject(t)}static resolve(n){return new _i((e,t)=>{e(n)})}static reject(n){return new _i((e,t)=>{t(n)})}static waitFor(e){return new _i((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=_i.resolve(!1);for(const n of e)t=t.next(e=>e?_i.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new _i((t,n)=>{const r=o.length,i=new Array(r);let s=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{i[a]=e,++s,s===r&&t(i)},e=>n(e))}})}static doWhile(r,i){return new _i((e,t)=>{const n=()=>{!0===r()?i().next(()=>{n()},t):e()};n()})}}class bi{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.m=new Gr,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{e.error?this.m.reject(new Ti(n,e.error)):this.m.resolve()},this.transaction.onerror=e=>{var t=Ai(e.target.error);this.m.reject(new Ti(n,t))}}static open(e,t,n,r){try{return new bi(t,e.transaction(r,n))}catch(e){throw new Ti(t,e)}}get g(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(Lr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}p(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new xi(t)}}class Ii{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===Ii.D(u())&&Fr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Lr("SimpleDb","Removing database:",e),Di(window.indexedDB.deleteDatabase(e)).toPromise()}static v(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(Ii.C())return!0;const e=u(),t=Ii.D(e),n=0<t&&t<10,r=Ii.F(e),i=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||i)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.M)}static O(e,t){return e.store(t)}static D(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static F(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async N(s){return this.db||(Lr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const i=indexedDB.open(this.name,this.version);i.onsuccess=e=>{var t=e.target.result;n(t)},i.onblocked=()=>{r(new Ti(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new qr(Br.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new qr(Br.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new Ti(s,t))},i.onupgradeneeded=e=>{Lr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.S.B(t,i.transaction,e.oldVersion,this.version).next(()=>{Lr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(t){this.L=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var i="readonly"===t;let s=0;for(;;){++s;try{this.db=await this.N(e);const t=bi.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.p(),e)).catch(e=>(t.abort(e),_i.reject(e))).toPromise();return s.catch(()=>{}),await t.g,s}catch(e){const t=e,n="FirebaseError"!==t.name&&s<3;if(Lr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ei{constructor(e){this.q=e,this.K=!1,this.$=null}get isDone(){return this.K}get U(){return this.$}set cursor(e){this.q=e}done(){this.K=!0}W(e){this.$=e}delete(){return Di(this.q.delete())}}class Ti extends qr{constructor(e,t){super(Br.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Si(e){return"IndexedDbTransactionError"===e.name}class xi{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(Lr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Lr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),Di(n)}add(e){return Lr("SimpleDb","ADD",this.store.name,e,e),Di(this.store.add(e))}get(t){return Di(this.store.get(t)).next(e=>(Lr("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return Lr("SimpleDb","DELETE",this.store.name,e),Di(this.store.delete(e))}count(){return Lr("SimpleDb","COUNT",this.store.name),Di(this.store.count())}G(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.j(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new _i((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}H(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new _i((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}J(e,t){Lr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;var r=this.cursor(n);return this.j(r,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.j(r,t)}X(i){const e=this.cursor({});return new _i((n,r)=>{e.onerror=e=>{var t=Ai(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?i(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}j(e,s){const a=[];return new _i((i,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new Ei(t),r=s(t.primaryKey,t.value,n);if(r instanceof _i){const e=r.catch(e=>(n.done(),_i.reject(e)));a.push(e)}n.isDone?i():null===n.U?t.continue():t.continue(n.U)}else i()}}).next(()=>_i.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Di(e){return new _i((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=Ai(e.target.error);r(t)}})}let Ci=!1;function Ai(e){const t=Ii.D(u());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new qr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ci||(Ci=!0,setTimeout(()=>{throw e},0)),e}}return e}class Ni{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){Lr("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{Lr("IndexBackiller",`Documents written: ${await this.ee.ne()}`)}catch(e){Si(e)?Lr("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await wi(e)}await this.te(6e4)})}}class ki{constructor(e,t){this.localStore=e,this.persistence=t}async ne(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.re(e,t))}re(e,t){const n=new Set;let r=t,i=!0;return _i.doWhile(()=>!0===i&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(i=!1):(Lr("IndexBackiller",`Processing collection: ${t}`),this.ie(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}ie(r,i,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,i).next(n=>this.localStore.localDocuments.getNextDocuments(r,i,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.se(n,e)).next(e=>(Lr("IndexBackiller",`Updating offset: ${e}`),this.localStore.indexManager.updateCollectionGroup(r,i,e))).next(()=>t.size)}))}se(e,t){let r=e;return t.changes.forEach((e,t)=>{var n=gi(t);0<pi(n,r)&&(r=n)}),new mi(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class Ri{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this._e&&this._e(e),e}}function Mi(e){return null==e}function Li(e){return 0===e&&1/e==-1/0}function Fi(e){return"number"==typeof e&&Number.isInteger(e)&&!Li(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Oi(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=Pi(t)),t=function(e,t){let n=t;const r=e.length;for(let i=0;i<r;i++){const r=e.charAt(i);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return Pi(t)}function Pi(e){return e+""}function Vi(t){const n=t.length;if(Ur(2<=n),2===n)return Ur(""===t.charAt(0)&&""===t.charAt(1)),ii.emptyPath();const __PRIVATE_lastReasonableEscapeIndex=n-2,r=[];let i="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>__PRIVATE_lastReasonableEscapeIndex)&&Vr(),t.charAt(n+1)){case"":var s=t.substring(a,n);let e;0===i.length?e=s:(i+=s,e=i,i=""),r.push(e);break;case"":i+=t.substring(a,n),i+="\0";break;case"":i+=t.substring(a,n+1);break;default:Vr()}a=n+2}return new ii(r)}Ri.ae=-1;const Ui=["userId","batchId"];function Bi(e,t){return[e,Oi(t)]}function qi(e,t,n){return[e,Oi(t),n]}const Gi={},Ki=["prefixPath","collectionGroup","readTime","documentId"],ji=["prefixPath","collectionGroup","documentId"],zi=["collectionGroup","readTime","prefixPath","documentId"],$i=["canonicalId","targetId"],Qi=["targetId","path"],Hi=["path","targetId"],Wi=["collectionId","parent"],Yi=["indexId","uid"],Xi=["uid","sequenceNumber"],Ji=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Zi=["indexId","uid","orderedDocumentKey"],es=["userId","collectionPath","documentId"],ts=["userId","collectionPath","largestBatchId"],ns=["userId","collectionGroup","largestBatchId"],rs=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],is=[...rs,"documentOverlays"],ss=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],as=ss,os=[...as,"indexConfiguration","indexState","indexEntries"];class us extends vi{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function cs(e,t){var n=e;return Ii.O(n.ue,t)}function hs(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function ls(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ds(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class fs{constructor(e,t){this.comparator=e,this.root=t||ms.EMPTY}insert(e,t){return new fs(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,ms.BLACK,null,null))}remove(e){return new fs(this.comparator,this.root.remove(e,this.comparator).copy(null,null,ms.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new gs(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new gs(this.root,e,this.comparator,!1)}getReverseIterator(){return new gs(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new gs(this.root,e,this.comparator,!0)}}class gs{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class ms{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:ms.RED,this.left=null!=r?r:ms.EMPTY,this.right=null!=i?i:ms.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new ms(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return ms.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return ms.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,ms.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,ms.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Vr();if(this.right.isRed())throw Vr();var e=this.left.check();if(e!==this.right.check())throw Vr();return e+(this.isRed()?0:1)}}ms.EMPTY=null,ms.RED=!0,ms.BLACK=!1,ms.EMPTY=new class{constructor(){this.size=0}get key(){throw Vr()}get value(){throw Vr()}get color(){throw Vr()}get left(){throw Vr()}get right(){throw Vr()}copy(e,t,n,r,i){return this}insert(e,t,n){return new ms(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ps{constructor(e){this.comparator=e,this.data=new fs(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ys(this.data.getIterator())}getIteratorFrom(e){return new ys(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof ps))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new ps(this.comparator);return t.data=e,t}}class ys{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function vs(e){return e.hasNext()?e.getNext():void 0}class ws{constructor(e){(this.fields=e).sort(ai.comparator)}static empty(){return new ws([])}unionWith(e){let t=new ps(ai.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ws(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Zr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class _s extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class bs{constructor(e){this.binaryString=e}static fromBase64String(e){var t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new _s("Invalid base64 string: "+e):e}}(e);return new bs(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new bs(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Jr(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}bs.EMPTY_BYTE_STRING=new bs("");const Is=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Es(t){if(Ur(!!t),"string"!=typeof t)return{seconds:Ts(t.seconds),nanos:Ts(t.nanos)};{let e=0;var n=Is.exec(t);Ur(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function Ts(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ss(e){return"string"==typeof e?bs.fromBase64String(e):bs.fromUint8Array(e)}function xs(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function Ds(e){var t=e.mapValue.fields.__previous_value__;return xs(t)?Ds(t):t}function Cs(e){var t=Es(e.mapValue.fields.__local_write_time__.timestampValue);return new ti(t.seconds,t.nanos)}class As{constructor(e,t,n,r,i,s,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class Ns{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Ns("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Ns&&e.projectId===this.projectId&&e.database===this.database}}const ks={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Rs={nullValue:"NULL_VALUE"};function Ms(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?xs(e)?4:$s(e)?9007199254740991:10:Vr()}function Ls(e,t){if(e===t)return!0;var n,r,i=Ms(e);if(i!==Ms(t))return!1;switch(i){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Cs(e).isEqual(Cs(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;var n=Es(e.timestampValue),r=Es(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return r=t,Ss(e.bytesValue).isEqual(Ss(r.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return n=t,Ts((r=e).geoPointValue.latitude)===Ts(n.geoPointValue.latitude)&&Ts(r.geoPointValue.longitude)===Ts(n.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Ts(e.integerValue)===Ts(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Ts(e.doubleValue),r=Ts(t.doubleValue);return n===r?Li(n)===Li(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return Zr(e.arrayValue.values||[],t.arrayValue.values||[],Ls);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(hs(n)!==hs(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!Ls(n[e],r[e])))return!1;return!0}(e,t);default:return Vr()}}function Fs(e,t){return void 0!==(e.values||[]).find(e=>Ls(e,t))}function Os(e,t){if(e===t)return 0;var n,r,i,s,a=Ms(e),o=Ms(t);if(a!==o)return Jr(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return Jr(e.booleanValue,t.booleanValue);case 2:return r=t,i=Ts((n=e).integerValue||n.doubleValue),s=Ts(r.integerValue||r.doubleValue),i<s?-1:s<i?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return Ps(e.timestampValue,t.timestampValue);case 4:return Ps(Cs(e),Cs(t));case 5:return Jr(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ss(e),r=Ss(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let i=0;i<n.length&&i<r.length;i++){const t=Jr(n[i],r[i]);if(0!==t)return t}return Jr(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(s=Jr(Ts(n.latitude),Ts(r.latitude)))?s:Jr(Ts(n.longitude),Ts(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let i=0;i<n.length&&i<r.length;++i){const t=Os(n[i],r[i]);if(t)return t}return Jr(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===ks.mapValue&&t===ks.mapValue)return 0;if(e===ks.mapValue)return 1;if(t===ks.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let o=0;o<r.length&&o<s.length;++o){const t=Jr(r[o],s[o]);if(0!==t)return t;var a=Os(n[r[o]],i[s[o]]);if(0!==a)return a}return Jr(r.length,s.length)}(e.mapValue,t.mapValue);default:throw Vr()}}function Ps(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Jr(e,t);var n=Es(e),r=Es(t),i=Jr(n.seconds,r.seconds);return 0!==i?i:Jr(n.nanos,r.nanos)}function Vs(e){return function s(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Es(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return Ss(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return oi.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=s(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const i of t)r?r=!1:n+=",",n+=`${i}:${s(e.fields[i])}`;return n+"}"}(e.mapValue):Vr()}(e)}function Us(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Bs(e){return!!e&&"integerValue"in e}function qs(e){return!!e&&"arrayValue"in e}function Gs(e){return e&&"nullValue"in e}function Ks(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function js(e){return e&&"mapValue"in e}function zs(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return ls(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=zs(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=zs(t.arrayValue.values[e]);return r}return Object.assign({},t)}function $s(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Qs(e,t){var n=Os(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Hs(e,t){var n=Os(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Ws{constructor(e){this.value=e}static empty(){return new Ws({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!js(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=zs(t)}setAll(e){let n=ai.emptyPath(),r={},i=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,i),r={},i=[],n=t.popLast()}e?r[t.lastSegment()]=zs(e):i.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,i)}delete(e){const t=this.field(e.popLast());js(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ls(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];js(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){ls(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Ws(zs(this.value))}}class Ys{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new Ys(e,0,ni.min(),ni.min(),ni.min(),Ws.empty(),0)}static newFoundDocument(e,t,n,r){return new Ys(e,1,t,ni.min(),n,r,0)}static newNoDocument(e,t){return new Ys(e,2,t,ni.min(),ni.min(),Ws.empty(),0)}static newUnknownDocument(e,t){return new Ys(e,3,t,ni.min(),ni.min(),Ws.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(ni.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ws.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ws.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ni.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Ys&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Ys(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Xs{constructor(e,t){this.position=e,this.inclusive=t}}function Js(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],a=e.position[i];if(r=s.field.isKeyField()?oi.comparator(oi.fromName(a.referenceValue),n.key):Os(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function Zs(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Ls(e.position[n],t.position[n]))return!1;return!0}class ea{constructor(e,t="asc"){this.field=e,this.dir=t}}class ta{}class na extends ta{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new ha(e,t,n):"array-contains"===t?new ga(e,n):"in"===t?new ma(e,n):"not-in"===t?new pa(e,n):"array-contains-any"===t?new ya(e,n):new na(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?la:da)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Os(t,this.value)):null!==t&&Ms(this.value)===Ms(t)&&this.matchesComparison(Os(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return Vr()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class ra extends ta{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new ra(e,t)}matches(t){return ia(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null!==this.ce||(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){var e=this.le(e=>e.isInequality());return null!==e?e.field:null}le(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function ia(e){return"and"===e.op}function sa(e){return"or"===e.op}function aa(e){return oa(e)&&ia(e)}function oa(e){for(const t of e.filters)if(t instanceof ra)return!1;return!0}function ua(e,t){var n=e.filters.concat(t);return ra.create(n,e.op)}function ca(e){return e instanceof na?`${(t=e).field.canonicalString()} ${t.op} ${Vs(t.value)}`:e instanceof ra?(e=e).op.toString()+" {"+e.getFilters().map(ca).join(" ,")+"}":"Filter";var t}class ha extends na{constructor(e,t,n){super(e,t,n),this.key=oi.fromName(n.referenceValue)}matches(e){var t=oi.comparator(e.key,this.key);return this.matchesComparison(t)}}class la extends na{constructor(e,t){super(e,"in",t),this.keys=fa(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class da extends na{constructor(e,t){super(e,"not-in",t),this.keys=fa(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function fa(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>oi.fromName(e.referenceValue))}class ga extends na{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return qs(t)&&Fs(t.arrayValue,this.value)}}class ma extends na{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&Fs(this.value.arrayValue,t)}}class pa extends na{constructor(e,t){super(e,"not-in",t)}matches(e){if(Fs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Fs(this.value.arrayValue,t)}}class ya extends na{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!qs(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Fs(this.value.arrayValue,e))}}class va{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.he=null}}function wa(e,t=null,n=[],r=[],i=null,s=null,a=null){return new va(e,t,n,r,i,s,a)}function _a(e){const t=e;if(null===t.he){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>function t(e){if(e instanceof na)return e.field.canonicalString()+e.op.toString()+Vs(e.value);if(aa(e))return e.filters.map(e=>t(e)).join(",");var n=e.filters.map(e=>t(e)).join(",");return`${e.op}(${n})`}(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),Mi(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Vs(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Vs(e)).join(",")),t.he=e}return t.he}function ba(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++)if(n=e.orderBy[i],r=t.orderBy[i],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r;if(e.filters.length!==t.filters.length)return!1;for(let s=0;s<e.filters.length;s++)if(!function r(e,t){return e instanceof na?(n=e,(s=t)instanceof na&&n.op===s.op&&n.field.isEqual(s.field)&&Ls(n.value,s.value)):e instanceof ra?(i=t)instanceof ra&&e.op===i.op&&e.filters.length===i.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,i.filters[n]),!0):void Vr();var i,n,s}(e.filters[s],t.filters[s]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Zs(e.startAt,t.startAt)&&Zs(e.endAt,t.endAt)}function Ia(e){return oi.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Ea(e,t){return e.filters.filter(e=>e instanceof na&&e.field.isEqual(t))}function Ta(t,n,r){let i=Rs,s=!0;for(const r of Ea(t,n)){let e=Rs,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?Rs:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Us(Ns.empty(),oi.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:Vr();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=Rs}Qs({value:i,inclusive:s},{value:e,inclusive:t})<0&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];Qs({value:i,inclusive:s},{value:t,inclusive:r.inclusive})<0&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}function Sa(t,n,r){let i=ks,s=!0;for(const r of Ea(t,n)){let e=ks,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Us(Ns.empty(),oi.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?ks:Vr(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=ks}0<Hs({value:i,inclusive:s},{value:e,inclusive:t})&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<Hs({value:i,inclusive:s},{value:t,inclusive:r.inclusive})&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}class xa{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Pe=null,this.Ie=null,this.startAt,this.endAt}}function Da(e,t,n,r,i,s,a,o){return new xa(e,t,n,r,i,s,a,o)}function Ca(e){return new xa(e)}function Aa(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Na(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function ka(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function Ra(e){return null!==e.collectionGroup}function Ma(t){const n=t;if(null===n.Pe){n.Pe=[];const t=ka(n),e=Na(n);if(null!==t&&null===e)t.isKeyField()||n.Pe.push(new ea(t)),n.Pe.push(new ea(ai.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.Pe.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.Pe.push(new ea(ai.keyField(),t))}}}return n.Pe}function La(e){const t=e;if(!t.Ie)if("F"===t.limitType)t.Ie=wa(t.path,t.collectionGroup,Ma(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const i of Ma(t)){const t="desc"===i.dir?"asc":"desc";e.push(new ea(i.field,t))}var n=t.endAt?new Xs(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Xs(t.startAt.position,t.startAt.inclusive):null;t.Ie=wa(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.Ie}function Fa(e,t){t.getFirstInequalityField(),ka(e);var n=e.filters.concat([t]);return new xa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Oa(e,t,n){return new xa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Pa(e,t){return ba(La(e),La(t))&&e.limitType===t.limitType}function Va(e){return`${_a(La(e))}|lt:${e.limitType}`}function Ua(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>ca(e)).join(", ")}]`),Mi(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Vs(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Vs(e)).join(",")),`Target(${t})`}(La(e))}; limitType=${e.limitType})`}function Ba(e,t){return t.isFoundDocument()&&(i=e,a=(s=t).key.path,null!==i.collectionGroup?s.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(a):oi.isDocumentKey(i.path)?i.path.isEqual(a):i.path.isImmediateParentOf(a))&&function(e,t){for(const n of Ma(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return;return 1}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return;return 1}(e,t)&&(i=t,(!(t=e).startAt||(n=t.startAt,e=Ma(t),r=Js(n,e,i),n.inclusive?r<=0:r<0))&&(!t.endAt||(n=t.endAt,t=Ma(t),r=Js(n,t,i),n.inclusive?0<=r:0<r)));var n,r,i,s,a}function qa(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Ga(i){return(e,t)=>{let n=!1;for(const r of Ma(i)){const i=function(e,t,n){var r=e.field.isKeyField()?oi.comparator(t.key,n.key):function(e,t,n){var r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Os(r,i):Vr()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return Vr()}}(r,e,t);if(0!==i)return i;n=n||r.field.isKeyField()}return 0}}class Ka{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return void(r[i]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(r){ls(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return ds(this.inner)}size(){return this.innerSize}}const ja=new fs(oi.comparator);const za=new fs(oi.comparator);function $a(...e){let t=za;for(const n of e)t=t.insert(n.key,n);return t}function Qa(e){let n=za;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function Ha(){return new Ka(e=>e.toString(),(e,t)=>e.isEqual(t))}const Wa=new fs(oi.comparator),Ya=new ps(oi.comparator);function Xa(...e){let t=Ya;for(const n of e)t=t.add(n);return t}const Ja=new ps(Jr);function Za(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Li(t)?"-0":t}}function eo(e){return{integerValue:""+e}}function to(e,t){return Fi(t)?eo(t):Za(e,t)}class no{constructor(){this._=void 0}}function ro(e,t){return e instanceof co?Bs(e=t)||(e=e)&&"doubleValue"in e?t:{integerValue:0}:null}class io extends no{}class so extends no{constructor(e){super(),this.elements=e}}function ao(e,t){const n=lo(t);for(const t of e.elements)n.some(e=>Ls(e,t))||n.push(t);return{arrayValue:{values:n}}}class oo extends no{constructor(e){super(),this.elements=e}}function uo(e,t){let n=lo(t);for(const t of e.elements)n=n.filter(e=>!Ls(e,t));return{arrayValue:{values:n}}}class co extends no{constructor(e,t){super(),this.serializer=e,this.Te=t}}function ho(e){return Ts(e.integerValue||e.doubleValue)}function lo(e){return qs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class fo{constructor(e,t){this.field=e,this.transform=t}}class go{constructor(e,t){this.version=e,this.transformResults=t}}class mo{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new mo}static exists(e){return new mo(void 0,e)}static updateTime(e){return new mo(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function po(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class yo{}function vo(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new Do(e.key,mo.none()):new Io(e.key,e.data,mo.none());{const i=e.data,s=Ws.empty();let t=new ps(ai.comparator);for(var r of n.fields)if(!t.has(r)){let e=i.field(r);null===e&&1<r.length&&(r=r.popLast(),e=i.field(r)),null===e?s.delete(r):s.set(r,e),t=t.add(r)}return new Eo(e.key,s,new ws(t.toArray()),mo.none())}}function wo(e,t,n){e instanceof Io?function(e,t,n){const r=e.value.clone(),i=So(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Eo?function(e,t,n){if(!po(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=So(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(To(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function _o(e,t,n,r){return e instanceof Io?function(e,t,n,r){if(!po(e.precondition,t))return n;const i=e.value.clone(),s=xo(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof Eo?function(e,t,n,r){if(!po(e.precondition,t))return n;const i=xo(e.fieldTransforms,r,t),s=t.data;return s.setAll(To(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):(t=t,n=n,po(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n)}function bo(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Zr(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof so&&t instanceof so||e instanceof oo&&t instanceof oo?Zr(e.elements,t.elements,Ls):e instanceof co&&t instanceof co?Ls(e.Te,t.Te):e instanceof io&&t instanceof io)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class Io extends yo{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Eo extends yo{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function To(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function So(e,t,n){const r=new Map;Ur(e.length===n.length);for(let h=0;h<n.length;h++){var i=e[h],s=i.transform,a=t.data.field(i.field);r.set(i.field,(o=s,u=a,c=n[h],o instanceof so?ao(o,u):o instanceof oo?uo(o,u):c))}var o,u,c;return r}function xo(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(i=e,s=h,a=t,u=o=void 0,i instanceof io?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return(t=t&&xs(t)?Ds(t):t)&&(n.fields.__previous_value__=t),{mapValue:n}}(a,s):i instanceof so?ao(i,s):i instanceof oo?uo(i,s):(o=ro(i=i,s),u=ho(o)+ho(i.Te),Bs(o)&&Bs(i.Te)?eo(u):Za(i.serializer,u))))}var i,s,a,o,u;return r}class Do extends yo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Co extends yo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Ao{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const i=this.mutations[r];i.key.isEqual(e.key)&&wo(i,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=_o(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=_o(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(s,a){const o=Ha();return this.mutations.forEach(e=>{const t=s.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var i=vo(n,r);null!==i&&o.set(e.key,i),n.isValidDocument()||n.convertToNoDocument(ni.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),Xa())}isEqual(e){return this.batchId===e.batchId&&Zr(this.mutations,e.mutations,(e,t)=>bo(e,t))&&Zr(this.baseMutations,e.baseMutations,(e,t)=>bo(e,t))}}class No{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Ur(e.mutations.length===n.length);let r=Wa;var i=e.mutations;for(let s=0;s<i.length;s++)r=r.insert(i[s].key,n[s].version);return new No(e,t,n,r)}}class ko{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Ro{constructor(e,t){this.count=e,this.unchangedNames=t}}function Mo(e){switch(e){default:return Vr();case Br.CANCELLED:case Br.UNKNOWN:case Br.DEADLINE_EXCEEDED:case Br.RESOURCE_EXHAUSTED:case Br.INTERNAL:case Br.UNAVAILABLE:case Br.UNAUTHENTICATED:return!1;case Br.INVALID_ARGUMENT:case Br.NOT_FOUND:case Br.ALREADY_EXISTS:case Br.PERMISSION_DENIED:case Br.FAILED_PRECONDITION:case Br.ABORTED:case Br.OUT_OF_RANGE:case Br.UNIMPLEMENTED:case Br.DATA_LOSS:return!0}}function Lo(e){if(void 0===e)return Fr("GRPC error has no .code"),Br.UNKNOWN;switch(e){case yr.OK:return Br.OK;case yr.CANCELLED:return Br.CANCELLED;case yr.UNKNOWN:return Br.UNKNOWN;case yr.DEADLINE_EXCEEDED:return Br.DEADLINE_EXCEEDED;case yr.RESOURCE_EXHAUSTED:return Br.RESOURCE_EXHAUSTED;case yr.INTERNAL:return Br.INTERNAL;case yr.UNAVAILABLE:return Br.UNAVAILABLE;case yr.UNAUTHENTICATED:return Br.UNAUTHENTICATED;case yr.INVALID_ARGUMENT:return Br.INVALID_ARGUMENT;case yr.NOT_FOUND:return Br.NOT_FOUND;case yr.ALREADY_EXISTS:return Br.ALREADY_EXISTS;case yr.PERMISSION_DENIED:return Br.PERMISSION_DENIED;case yr.FAILED_PRECONDITION:return Br.FAILED_PRECONDITION;case yr.ABORTED:return Br.ABORTED;case yr.OUT_OF_RANGE:return Br.OUT_OF_RANGE;case yr.UNIMPLEMENTED:return Br.UNIMPLEMENTED;case yr.DATA_LOSS:return Br.DATA_LOSS;default:return Vr()}}(tt=yr=yr||{})[tt.OK=0]="OK",tt[tt.CANCELLED=1]="CANCELLED",tt[tt.UNKNOWN=2]="UNKNOWN",tt[tt.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",tt[tt.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",tt[tt.NOT_FOUND=5]="NOT_FOUND",tt[tt.ALREADY_EXISTS=6]="ALREADY_EXISTS",tt[tt.PERMISSION_DENIED=7]="PERMISSION_DENIED",tt[tt.UNAUTHENTICATED=16]="UNAUTHENTICATED",tt[tt.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",tt[tt.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",tt[tt.ABORTED=10]="ABORTED",tt[tt.OUT_OF_RANGE=11]="OUT_OF_RANGE",tt[tt.UNIMPLEMENTED=12]="UNIMPLEMENTED",tt[tt.INTERNAL=13]="INTERNAL",tt[tt.UNAVAILABLE=14]="UNAVAILABLE",tt[tt.DATA_LOSS=15]="DATA_LOSS";class Fo{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return Oo}static getOrCreateInstance(){return null===Oo&&(Oo=new Fo),Oo}onExistenceFilterMismatch(e){const t=Symbol();return this.onExistenceFilterMismatchCallbacks.set(t,e),()=>this.onExistenceFilterMismatchCallbacks.delete(t)}notifyOnExistenceFilterMismatch(t){this.onExistenceFilterMismatchCallbacks.forEach(e=>e(t))}}let Oo=null;function Po(){return new TextEncoder}const Vo=new Cr([4294967295,4294967295],0);function Uo(e){const t=Po().encode(e),n=new Dr;return n.update(t),new Uint8Array(n.digest())}function Bo(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new Cr([n,r],0),new Cr([i,s],0)]}class qo{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new Go(`Invalid padding: ${t}`);if(n<0)throw new Go(`Invalid hash count: ${n}`);if(0<e.length&&0===this.hashCount)throw new Go(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Go(`Invalid padding when bitmap length is 0: ${t}`);this.de=8*e.length-t,this.Ae=Cr.fromNumber(this.de)}Re(e,t,n){let r=e.add(t.multiply(Cr.fromNumber(n)));return 1===r.compare(Vo)&&(r=new Cr([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Ae).toNumber()}Ve(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.de)return!1;const t=Uo(e),[n,r]=Bo(t);for(let i=0;i<this.hashCount;i++){const t=this.Re(n,r,i);if(!this.Ve(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new qo(i,r,t);return n.forEach(e=>s.insert(e)),s}insert(t){if(0!==this.de){const n=Uo(t),[r,i]=Bo(n);for(let e=0;e<this.hashCount;e++){const n=this.Re(r,i,e);this.me(n)}}}me(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Go extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Ko{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,jo.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Ko(ni.min(),r,new fs(Jr),ja,Xa())}}class jo{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new jo(n,t,Xa(),Xa(),Xa())}}class zo{constructor(e,t,n,r){this.fe=e,this.removedTargetIds=t,this.key=n,this.ge=r}}class $o{constructor(e,t){this.targetId=e,this.pe=t}}class Qo{constructor(e,t,n=bs.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Ho{constructor(){this.ye=0,this.we=Xo(),this.Se=bs.EMPTY_BYTE_STRING,this.be=!1,this.De=!0}get current(){return this.be}get resumeToken(){return this.Se}get ve(){return 0!==this.ye}get Ce(){return this.De}Fe(e){0<e.approximateByteSize()&&(this.De=!0,this.Se=e)}Me(){let n=Xa(),r=Xa(),i=Xa();return this.we.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:i=i.add(e);break;default:Vr()}}),new jo(this.Se,this.be,n,r,i)}xe(){this.De=!1,this.we=Xo()}Oe(e,t){this.De=!0,this.we=this.we.insert(e,t)}Ne(e){this.De=!0,this.we=this.we.remove(e)}Be(){this.ye+=1}Le(){--this.ye}ke(){this.De=!0,this.be=!0}}class Wo{constructor(e){this.qe=e,this.Qe=new Map,this.Ke=ja,this.$e=Yo(),this.Ue=new fs(Jr)}We(e){for(const t of e.fe)e.ge&&e.ge.isFoundDocument()?this.Ge(t,e.ge):this.ze(t,e.key,e.ge);for(const n of e.removedTargetIds)this.ze(n,e.key,e.ge)}je(n){this.forEachTarget(n,e=>{const t=this.He(e);switch(n.state){case 0:this.Je(e)&&t.Fe(n.resumeToken);break;case 1:t.Le(),t.ve||t.xe(),t.Fe(n.resumeToken);break;case 2:t.Le(),t.ve||this.removeTarget(e);break;case 3:this.Je(e)&&(t.ke(),t.Fe(n.resumeToken));break;case 4:this.Je(e)&&(this.Ye(e),t.Fe(n.resumeToken));break;default:Vr()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Qe.forEach((e,t)=>{this.Je(t)&&n(t)})}Ze(e){const t=e.targetId,n=e.pe.count,r=this.Xe(t);if(r){var i=r.target;if(Ia(i))if(0===n){const e=new oi(i.path);this.ze(t,e,Ys.newNoDocument(e,ni.min()))}else Ur(1===n);else{const r=this.et(t);if(r!==n){const n=this.tt(e,r);if(0!==n.status){this.Ye(t);const e=2===n.status?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ue=this.Ue.insert(t,e)}null===(i=Fo.instance)||void 0===i||i.notifyOnExistenceFilterMismatch(function(e,t,n,r){var i;const s={localCacheCount:n,existenceFilterCount:r.count},a=r.unchangedNames;return a&&(s.bloomFilter={applied:0===e,hashCount:null!==(i=null==a?void 0:a.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(i=null===(i=null===(i=null==a?void 0:a.bits)||void 0===i?void 0:i.bitmap)||void 0===i?void 0:i.length)&&void 0!==i?i:0,padding:null!==(i=null===(i=null==a?void 0:a.bits)||void 0===i?void 0:i.padding)&&void 0!==i?i:0},t&&(s.bloomFilter.mightContain=t)),s}(n.status,null!==(i=n.nt)&&void 0!==i?i:null,r,e.pe))}}}}tt(e,t){var{unchangedNames:n,count:r}=e.pe;if(!n||!n.bits)return{status:1};var{bits:{bitmap:i="",padding:s=0},hashCount:n=0}=n;let a,o;try{a=Ss(i).toUint8Array()}catch(e){if(e instanceof _s)return Or("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),{status:1};throw e}try{o=new qo(a,s,n)}catch(e){return Or(e instanceof Go?"BloomFilter error: ":"Applying bloom filter failed: ",e),{status:1}}n=e=>{var t=this.qe.rt();return o.mightContain(`projects/${t.projectId}/databases/${t.database}/documents/${e}`)};return 0===o.de?{status:1}:{status:r===t-this.it(e.targetId,n)?0:2,nt:n}}it(t,n){const e=this.qe.getRemoteKeysForTarget(t);let r=0;return e.forEach(e=>{n(e.path.canonicalString())||(this.ze(t,e,null),r++)}),r}st(r){const i=new Map;this.Qe.forEach((e,t)=>{var n=this.Xe(t);if(n){if(e.current&&Ia(n.target)){const i=new oi(n.target.path);null!==this.Ke.get(i)||this.ot(t,i)||this.ze(t,i,Ys.newNoDocument(i,r))}e.Ce&&(i.set(t,e.Me()),e.xe())}});let s=Xa();this.$e.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.Xe(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(n=!1)}),n&&(s=s.add(e))}),this.Ke.forEach((e,t)=>t.setReadTime(r));var e=new Ko(r,i,this.Ue,this.Ke,s);return this.Ke=ja,this.$e=Yo(),this.Ue=new fs(Jr),e}Ge(e,t){var n;this.Je(e)&&(n=this.ot(e,t.key)?2:0,this.He(e).Oe(t.key,n),this.Ke=this.Ke.insert(t.key,t),this.$e=this.$e.insert(t.key,this._t(t.key).add(e)))}ze(e,t,n){if(this.Je(e)){const r=this.He(e);this.ot(e,t)?r.Oe(t,1):r.Ne(t),this.$e=this.$e.insert(t,this._t(t).delete(e)),n&&(this.Ke=this.Ke.insert(t,n))}}removeTarget(e){this.Qe.delete(e)}et(e){var t=this.He(e).Me();return this.qe.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Be(e){this.He(e).Be()}He(e){let t=this.Qe.get(e);return t||(t=new Ho,this.Qe.set(e,t)),t}_t(e){let t=this.$e.get(e);return t||(t=new ps(Jr),this.$e=this.$e.insert(e,t)),t}Je(e){var t=null!==this.Xe(e);return t||Lr("WatchChangeAggregator","Detected inactive target",e),t}Xe(e){var t=this.Qe.get(e);return t&&t.ve?null:this.qe.ut(e)}Ye(t){this.Qe.set(t,new Ho),this.qe.getRemoteKeysForTarget(t).forEach(e=>{this.ze(t,e,null)})}ot(e,t){return this.qe.getRemoteKeysForTarget(e).has(t)}}function Yo(){return new fs(oi.comparator)}function Xo(){return new fs(oi.comparator)}const Jo={asc:"ASCENDING",desc:"DESCENDING"},Zo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},eu={and:"AND",or:"OR"};class tu{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function nu(e,t){return e.useProto3Json||Mi(t)?t:{value:t}}function ru(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function iu(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function su(e){return Ur(!!e),ni.fromTimestamp((t=Es(e),new ti(t.seconds,t.nanos)));var t}function au(e,t){return e=e,new ii(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function ou(e){var t=ii.fromString(e);return Ur(Su(t)),t}function uu(e,t){return au(e.databaseId,t.path)}function cu(e,t){const n=ou(t);if(n.get(1)!==e.databaseId.projectId)throw new qr(Br.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new qr(Br.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new oi(fu(n))}function hu(e,t){return au(e.databaseId,t)}function lu(e){var t=ou(e);return 4===t.length?ii.emptyPath():fu(t)}function du(e){return new ii(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function fu(e){return Ur(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function gu(e,t,n){return{name:uu(e,t),fields:n.value.mapValue.fields}}function mu(e,t,n){const r=cu(e,t.name),i=su(t.updateTime),s=t.createTime?su(t.createTime):ni.min(),a=new Ws({mapValue:{fields:t.fields}}),o=Ys.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function pu(e,t){let n;if(t instanceof Io)n={update:gu(e,t.key,t.value)};else if(t instanceof Do)n={delete:uu(e,t.key)};else if(t instanceof Eo)n={update:gu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof Co))return Vr();n={verify:uu(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof io)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof so)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof oo)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof co)return{fieldPath:e.field.canonicalString(),increment:t.Te};throw Vr()}(e))),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:(t=e.updateTime,ru(r,t.toTimestamp()))}:void 0!==e.exists?{exists:e.exists}:Vr())),n;var r}function yu(t,e){const n=e.currentDocument?void 0!==(i=e.currentDocument).updateTime?mo.updateTime(su(i.updateTime)):void 0!==i.exists?mo.exists(i.exists):mo.none():mo.none(),r=e.updateTransforms?e.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)Ur("REQUEST_TIME"===t.setToServerValue),n=new io;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new so(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new oo(e)}else"increment"in t?n=new co(e,t.increment):Vr();var r=ai.fromServerFormat(t.fieldPath);return new fo(r,n)}(t,e)):[];var i;if(e.update){e.update.name;var s=cu(t,e.update.name),a=new Ws({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(e){const t=e.fieldPaths||[];return new ws(t.map(e=>ai.fromServerFormat(e)))}(e.updateMask);return new Eo(s,a,t,n,r)}return new Io(s,a,n,r)}if(e.delete){const r=cu(t,e.delete);return new Do(r,n)}if(e.verify){const r=cu(t,e.verify);return new Co(r,n)}return Vr()}function vu(e,t){return{documents:[hu(e,t.path)]}}function wu(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=hu(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=hu(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var i=function(e){if(0!==e.length)return function n(e){return e instanceof na?function(e){if("=="===e.op){if(Ks(e.value))return{unaryFilter:{field:Eu(e.field),op:"IS_NAN"}};if(Gs(e.value))return{unaryFilter:{field:Eu(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ks(e.value))return{unaryFilter:{field:Eu(e.field),op:"IS_NOT_NAN"}};if(Gs(e.value))return{unaryFilter:{field:Eu(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Eu(e.field),op:bu(e.op),value:e.value}}}(e):e instanceof ra?function(e){const t=e.getFilters().map(e=>n(e));return 1===t.length?t[0]:{compositeFilter:{op:Iu(e.op),filters:t}}}(e):Vr()}(ra.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);i=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:Eu(e.field),direction:(e=e.dir,Jo[e])}}(e))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);i=nu(e,t.limit);return null!==i&&(n.structuredQuery.limit=i),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function _u(e){let t=lu(e.parent);var n,r,i,s=e.structuredQuery,a=s.from?s.from.length:0;let o=null;if(0<a){Ur(1===a);const f=s.from[0];f.allDescendants?o=f.collectionId:t=t.child(f.collectionId)}let u=[];s.where&&(u=function(e){const t=function t(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Tu(e.unaryFilter.field);return na.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Tu(e.unaryFilter.field);return na.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Tu(e.unaryFilter.field);return na.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=Tu(e.unaryFilter.field);return na.create(i,"!=",{nullValue:"NULL_VALUE"});default:return Vr()}}(e):void 0!==e.fieldFilter?function(e){return na.create(Tu(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Vr()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return ra.create(e.compositeFilter.filters.map(e=>t(e)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return Vr()}}(e.compositeFilter.op))}(e):Vr()}(e);return t instanceof ra&&aa(t)?t.getFilters():[t]}(s.where));let c=[];s.orderBy&&(c=s.orderBy.map(e=>function(e){return new ea(Tu(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)));let h=null;s.limit&&(h=(e=s.limit,Mi(n="object"==typeof e?e.value:e)?null:n));let l=null;s.startAt&&(l=(r=s.startAt,i=!!r.before,n=r.values||[],new Xs(n,i)));let d=null;return s.endAt&&(d=(r=s.endAt,i=!r.before,s=r.values||[],new Xs(s,i))),Da(t,o,c,u,h,"F",l,d)}function bu(e){return Zo[e]}function Iu(e){return eu[e]}function Eu(e){return{fieldPath:e.canonicalString()}}function Tu(e){return ai.fromServerFormat(e.fieldPath)}function Su(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class xu{constructor(e,t,n,r,i=ni.min(),s=ni.min(),a=bs.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new xu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new xu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new xu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new xu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Du{constructor(e){this.ct=e}}function Cu(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Au(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:uu(i=e.ct,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:ru(i,e.version.toTimestamp()),createTime:ru(i,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Nu(t.version)};else{if(!t.isUnknownDocument())return Vr();r.unknownDocument={path:n.path.toArray(),version:Nu(t.version)}}var i;return r}function Au(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Nu(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ku(e){var t=new ti(e.seconds,e.nanoseconds);return ni.fromTimestamp(t)}function Ru(t,e){const n=(e.baseMutations||[]).map(e=>yu(t.ct,e));for(let s=0;s<e.mutations.length-1;++s){const n=e.mutations[s];if(s+1<e.mutations.length&&void 0!==e.mutations[s+1].transform){const r=e.mutations[s+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}const r=e.mutations.map(e=>yu(t.ct,e)),i=ti.fromMillis(e.localWriteTimeMs);return new Ao(e.batchId,i,n,r)}function Mu(e){var t,n=ku(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?ku(e.lastLimboFreeSnapshotVersion):ni.min(),i=void 0!==e.query.documents?(Ur(1===(t=e.query).documents.length),La(Ca(lu(t.documents[0])))):La(_u(e.query));return new xu(i,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,bs.fromBase64String(e.resumeToken))}function Lu(e,t){var n=Nu(t.snapshotVersion),r=Nu(t.lastLimboFreeSnapshotVersion),i=(Ia(t.target)?vu:wu)(e.ct,t.target),s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:_a(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Fu(e){var t=_u({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Oa(t,t.limit,"L"):t}function Ou(e,t){return new ko(t.largestBatchId,yu(e.ct,t.overlayMutation))}function Pu(e,t){var n=t.path.lastSegment();return[e,Oi(t.path.popLast()),n]}function Vu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Nu(r.readTime),documentKey:Oi(r.documentKey.path),largestBatchId:r.largestBatchId}}class Uu{getBundleMetadata(e,t){return Bu(e).get(t).next(e=>{if(e)return{id:(e=e).bundleId,createTime:ku(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Bu(e).put({bundleId:(t=t).id,createTime:Nu(su(t.createTime)),version:t.version})}getNamedQuery(e,t){return qu(e).get(t).next(e=>{if(e)return{name:(e=e).name,query:Fu(e.bundledQuery),readTime:ku(e.readTime)}})}saveNamedQuery(e,t){return qu(e).put({name:(t=t).name,readTime:Nu(su(t.readTime)),bundledQuery:t.bundledQuery})}}function Bu(e){return cs(e,"bundles")}function qu(e){return cs(e,"namedQueries")}class Gu{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){var n=t.uid||"";return new Gu(e,n)}getOverlay(e,t){return Ku(e).get(Pu(this.userId,t)).next(e=>e?Ou(this.serializer,e):null)}getOverlays(e,t){const n=Ha();return _i.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(r,i,e){const s=[];return e.forEach((e,t)=>{var n=new ko(i,t);s.push(this.ht(r,n))}),_i.waitFor(s)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(Oi(e.getCollectionPath())));const i=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);i.push(Ku(n).J("collectionPathOverlayIndex",t))}),_i.waitFor(i)}getOverlaysForCollection(e,t,n){const r=Ha(),i=Oi(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return Ku(e).G("collectionPathOverlayIndex",s).next(e=>{for(const t of e){const e=Ou(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,i){const s=Ha();let a;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Ku(e).Z({index:"collectionGroupOverlayIndex",range:r},(e,t,n)=>{const r=Ou(this.serializer,t);s.size()<i||r.largestBatchId===a?(s.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>s)}ht(e,t){return Ku(e).put(function(e,t,n){var[,r,i]=Pu(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:pu(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function Ku(e){return cs(e,"documentOverlays")}class ju{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){var n,r;"nullValue"in e?this.Et(t,5):"booleanValue"in e?(this.Et(t,10),t.dt(e.booleanValue?1:0)):"integerValue"in e?(this.Et(t,15),t.dt(Ts(e.integerValue))):"doubleValue"in e?(n=Ts(e.doubleValue),isNaN(n)?this.Et(t,13):(this.Et(t,15),Li(n)?t.dt(0):t.dt(n))):"timestampValue"in e?(r=e.timestampValue,this.Et(t,20),"string"==typeof r?t.At(r):(t.At(`${r.seconds||""}`),t.dt(r.nanos||0))):"stringValue"in e?(this.Rt(e.stringValue,t),this.Vt(t)):"bytesValue"in e?(this.Et(t,30),t.ft(Ss(e.bytesValue)),this.Vt(t)):"referenceValue"in e?this.gt(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.Et(t,45),t.dt(r.latitude||0),t.dt(r.longitude||0)):"mapValue"in e?$s(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):Vr()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){var n=e.fields||{};this.Et(t,55);for(const e of Object.keys(n))this.Rt(e,t),this.It(n[e],t)}wt(e,t){var n=e.values||[];this.Et(t,50);for(const e of n)this.It(e,t)}gt(e,t){this.Et(t,37),oi.fromName(e).path.forEach(e=>{this.Et(t,60),this.St(e,t)})}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}function zu(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}ju.bt=new ju;class $u{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.vt(n.value),n=t.next();this.Ct()}Ft(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Mt(n.value),n=t.next();this.xt()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.vt(e);else if(e<2048)this.vt(960|e>>>6),this.vt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.vt(480|e>>>12),this.vt(128|63&e>>>6),this.vt(128|63&e);else{const e=t.codePointAt(0);this.vt(240|e>>>18),this.vt(128|63&e>>>12),this.vt(128|63&e>>>6),this.vt(128|63&e)}}this.Ct()}Nt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Mt(e);else if(e<2048)this.Mt(960|e>>>6),this.Mt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Mt(480|e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e);else{const e=t.codePointAt(0);this.Mt(240|e>>>18),this.Mt(128|63&e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e)}}this.xt()}Bt(e){var t=this.Lt(e),n=zu(t);this.kt(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}qt(e){var t=this.Lt(e),n=zu(t);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(e){this.kt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Wt(){return this.buffer.slice(0,this.position)}Lt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}vt(e){var t=255&e;0==t?(this.Kt(0),this.Kt(255)):255==t?(this.Kt(255),this.Kt(0)):this.Kt(t)}Mt(e){var t=255&e;0==t?(this.Ut(0),this.Ut(255)):255==t?(this.Ut(255),this.Ut(0)):this.Ut(e)}Ct(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(e){this.kt(1),this.buffer[this.position++]=e}Ut(e){this.kt(1),this.buffer[this.position++]=~e}kt(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class Qu{constructor(e){this.Gt=e}ft(e){this.Gt.Dt(e)}At(e){this.Gt.Ot(e)}dt(e){this.Gt.Bt(e)}Tt(){this.Gt.Qt()}}class Hu{constructor(e){this.Gt=e}ft(e){this.Gt.Ft(e)}At(e){this.Gt.Nt(e)}dt(e){this.Gt.qt(e)}Tt(){this.Gt.$t()}}class Wu{constructor(){this.Gt=new $u,this.zt=new Qu(this.Gt),this.jt=new Hu(this.Gt)}seed(e){this.Gt.seed(e)}Ht(e){return 0===e?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class Yu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Jt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Yu(this.indexId,this.documentKey,this.arrayValue,n)}}function Xu(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Ju(e.arrayValue,t.arrayValue),0!==n?n:(n=Ju(e.directionalValue,t.directionalValue),0!==n?n:oi.comparator(e.documentKey,t.documentKey)))}function Ju(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class Zu{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Yt=e.orderBy,this.Zt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Xt=e:this.Zt.push(e)}}en(e){Ur(e.collectionGroup===this.collectionId);var t=ci(e);if(void 0!==t&&!this.tn(t))return!1;const n=hi(e);let r=new Set,i=0,s=0;for(;i<n.length&&this.tn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(void 0!==this.Xt){if(!r.has(this.Xt.field.canonicalString())){const e=n[i];if(!this.nn(this.Xt,e)||!this.rn(this.Yt[s++],e))return!1}++i}for(;i<n.length;++i){const e=n[i];if(s>=this.Yt.length||!this.rn(this.Yt[s++],e))return!1}return!0}tn(e){for(const t of this.Zt)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}rn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function ec(e){if(0===e.getFilters().length)return[];const t=function t(e){if(Ur(e instanceof na||e instanceof ra),e instanceof na)return e;if(1===e.filters.length)return t(e.filters[0]);const n=e.filters.map(e=>t(e));let r=ra.create(n,e.op);return r=ac(r),rc(r)?r:(Ur(r instanceof ra),Ur(ia(r)),Ur(1<r.filters.length),r.filters.reduce((e,t)=>ic(e,t)))}(function t(n){var e;if(Ur(n instanceof na||n instanceof ra),n instanceof na){if(n instanceof ma){const r=(null===(e=null===(e=n.value.arrayValue)||void 0===e?void 0:e.values)||void 0===e?void 0:e.map(e=>na.create(n.field,"==",e)))||[];return ra.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return ra.create(r,n.op)}(e));return Ur(rc(t)),tc(t)||nc(t)?[t]:t.getFilters()}function tc(e){return e instanceof na}function nc(e){return e instanceof ra&&aa(e)}function rc(e){return tc(e)||nc(e)||function(e){if(e instanceof ra&&sa(e)){for(const t of e.getFilters())if(!tc(t)&&!nc(t))return!1;return!0}return!1}(e)}function ic(e,t){var n,r;return Ur(e instanceof na||e instanceof ra),Ur(t instanceof na||t instanceof ra),ac(e instanceof na?t instanceof na?(n=e,r=t,ra.create([n,r],"and")):sc(e,t):t instanceof na?sc(t,e):function(e,t){if(Ur(0<e.filters.length&&0<t.filters.length),ia(e)&&ia(t))return ua(e,t.getFilters());const n=sa(e)?e:t,r=sa(e)?t:e,i=n.filters.map(e=>ic(e,r));return ra.create(i,"or")}(e,t))}function sc(t,e){if(ia(e))return ua(e,t.getFilters());var n=e.filters.map(e=>ic(t,e));return ra.create(n,"or")}function ac(t){if(Ur(t instanceof na||t instanceof ra),t instanceof na)return t;const e=t.getFilters();if(1===e.length)return ac(e[0]);if(oa(t))return t;const n=e.map(e=>ac(e)),r=[];return n.forEach(e=>{e instanceof na?r.push(e):e instanceof ra&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:ra.create(r,t.op)}class oc{constructor(){this.sn=new uc}addToCollectionParentIndex(e,t){return this.sn.add(t),_i.resolve()}getCollectionParents(e,t){return _i.resolve(this.sn.getEntries(t))}addFieldIndex(e,t){return _i.resolve()}deleteFieldIndex(e,t){return _i.resolve()}getDocumentsMatchingTarget(e,t){return _i.resolve(null)}getIndexType(e,t){return _i.resolve(0)}getFieldIndexes(e,t){return _i.resolve([])}getNextCollectionGroupToUpdate(e){return _i.resolve(null)}getMinOffset(e,t){return _i.resolve(mi.min())}getMinOffsetFromCollectionGroup(e,t){return _i.resolve(mi.min())}updateCollectionGroup(e,t,n){return _i.resolve()}updateIndexEntries(e,t){return _i.resolve()}}class uc{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new ps(ii.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new ps(ii.comparator)).toArray()}}const cc=new Uint8Array(0);class hc{constructor(e,t){this.user=e,this.databaseId=t,this.on=new uc,this._n=new Ka(e=>_a(e),(e,t)=>ba(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.on.has(t))return _i.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.on.add(t)});r={collectionId:n,parent:Oi(r)};return lc(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[ei(n),""],!1,!0);return lc(e).G(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Vi(t.parent))}return r})}addFieldIndex(e,t){const n=fc(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const i=n.add(r);if(t.indexState){const n=gc(e);return i.next(e=>{n.put(Vu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){const n=fc(e),r=gc(e),i=dc(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,h){const l=dc(e);let d=!0;const n=new Map;return _i.forEach(this.an(h),t=>this.un(e,t).next(e=>{d=d&&!!e,n.set(t,e)})).next(()=>{if(d){let c=Xa();const d=[];return _i.forEach(n,(e,t)=>{var n;Lr("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=${n.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${_a(h)}`);var r=function(e,t){var n=ci(t);if(void 0===n)return null;for(const t of Ea(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),i=function(e,t){const n=new Map;for(const r of hi(t))for(const t of Ea(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const i of hi(t)){const t=(0===i.kind?Ta:Sa)(e,i.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Xs(n,r)}(t,e),a=function(e,t){const n=[];let r=!0;for(const i of hi(t)){const t=(0===i.kind?Sa:Ta)(e,i.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Xs(n,r)}(t,e),o=this.cn(e,t,s),u=this.cn(e,t,a),i=this.ln(e,t,i),i=this.hn(e.indexId,r,o,s.inclusive,u,a.inclusive,i);return _i.forEach(i,e=>l.H(e,h.limit).next(e=>{e.forEach(e=>{var t=oi.fromSegments(e.documentKey);c.has(t)||(c=c.add(t),d.push(t))})}))}).next(()=>d)}return _i.resolve(null)})}an(t){let e=this._n.get(t);return e||(e=0===t.filters.length?[t]:ec(ra.create(t.filters,"and")).map(e=>wa(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this._n.set(t,e),e)}hn(t,e,n,r,i,s,a){const o=(null!=e?e.length:1)*Math.max(n.length,i.length),u=o/(null!=e?e.length:1),c=[];for(let h=0;h<o;++h){const o=e?this.Pn(e[h/u]):cc,l=this.In(t,o,n[h%u],r),d=this.Tn(t,o,i[h%u],s),f=a.map(e=>this.In(t,o,e,!0));c.push(...this.createRange(l,d,f))}return c}In(e,t,n,r){const i=new Yu(e,oi.empty(),t,n);return r?i:i.Jt()}Tn(e,t,n,r){const i=new Yu(e,oi.empty(),t,n);return r?i.Jt():i}un(e,t){const r=new Zu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.en(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.an(t);return _i.forEach(r,t=>this.un(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new ps(ai.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>function(e){return null!==e.limit}(t)&&1<r.length&&2===n?1:n)}En(e,t){const n=new Wu;for(const i of hi(e)){const e=t.data.field(i.fieldPath);if(null==e)return null;var r=n.Ht(i.kind);ju.bt.Pt(e,r)}return n.Wt()}Pn(e){const t=new Wu;return ju.bt.Pt(e,t.Ht(0)),t.Wt()}dn(e,t){const n=new Wu;return ju.bt.Pt(Us(this.databaseId,t),n.Ht(0===(r=hi(e)).length?0:r[r.length-1].kind)),n.Wt();var r}ln(e,t,n){if(null===n)return[];let r=[];r.push(new Wu);let i=0;for(const s of hi(e)){const e=n[i++];for(const n of r)if(this.An(t,s.fieldPath)&&qs(e))r=this.Rn(r,s,e);else{const t=n.Ht(s.kind);ju.bt.Pt(e,t)}}return this.Vn(r)}cn(e,t,n){return this.ln(e,t,n.position)}Vn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Wt();return t}Rn(e,t,n){const r=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new Wu;r.seed(n.Wt()),ju.bt.Pt(e,r.Ht(t.kind)),i.push(r)}return i}An(e,t){return!!e.filters.find(e=>e instanceof na&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=fc(e),r=gc(e);return(t?n.G("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.G()).next(e=>{const s=[];return _i.forEach(e,i=>r.get([i.indexId,this.uid]).next(e=>{var t,n,r;s.push((t=i,n=(e=e)?new di(e.sequenceNumber,new mi(ku(e.readTime),new oi(Vi(e.documentKey)),e.largestBatchId)):di.empty(),r=t.fields.map(([e,t])=>new li(ai.fromServerFormat(e),t)),new ui(t.indexId,t.collectionGroup,r,n)))})).next(()=>s)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:Jr(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const i=fc(e),s=gc(e);return this.mn(e).next(t=>i.G("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>_i.forEach(e,e=>s.put(Vu(e.indexId,this.user,t,r)))))}updateIndexEntries(i,e){const n=new Map;return _i.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?_i.resolve(e):this.getFieldIndexes(i,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),_i.forEach(e,n=>this.fn(i,t,n).next(e=>{var t=this.gn(r,n);return e.isEqual(t)?_i.resolve():this.pn(i,r,n,e,t)}))))})}yn(e,t,n,r){return dc(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.dn(n,t.key),documentKey:t.key.path.toArray()})}wn(e,t,n,r){return dc(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.dn(n,t.key),t.key.path.toArray()])}fn(e,n,r){const t=dc(e);let i=new ps(Xu);return t.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.dn(r,n)])},(e,t)=>{i=i.add(new Yu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>i)}gn(e,t){let n=new ps(Xu);var r=this.En(t,e);if(null==r)return n;const i=ci(t);if(null!=i){var s=e.data.field(i.fieldPath);if(qs(s))for(const i of s.arrayValue.values||[])n=n.add(new Yu(t.indexId,e.key,this.Pn(i),r))}else n=n.add(new Yu(t.indexId,e.key,cc,r));return n}pn(t,n,r,e,i){Lr("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const s=[];return function(e,t,n,r,i){var s=e.getIterator(),a=t.getIterator();let o=vs(s),u=vs(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=vs(a)):t?(i(o),o=vs(s)):(o=vs(s),u=vs(a))}}(e,i,Xu,e=>{s.push(this.yn(t,n,r,e))},e=>{s.push(this.wn(t,n,r,e))}),_i.waitFor(s)}mn(e){let r=1;return gc(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>Xu(e,t)).filter((e,t,n)=>!t||0!==Xu(e,n[t-1]));const r=[];r.push(e);for(const i of n){const n=Xu(i,e),s=Xu(i,t);if(0===n)r[0]=e.Jt();else if(0<n&&s<0)r.push(i),r.push(i.Jt());else if(0<s)break}r.push(t);const i=[];for(let a=0;a<r.length;a+=2){if(this.Sn(r[a],r[a+1]))return[];const t=[r[a].indexId,this.uid,r[a].arrayValue,r[a].directionalValue,cc,[]],n=[r[a+1].indexId,this.uid,r[a+1].arrayValue,r[a+1].directionalValue,cc,[]];i.push(IDBKeyRange.bound(t,n))}return i}Sn(e,t){return 0<Xu(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(mc)}getMinOffset(t,e){return _i.mapArray(this.an(e),e=>this.un(t,e).next(e=>e||Vr())).next(mc)}}function lc(e){return cs(e,"collectionParents")}function dc(e){return cs(e,"indexEntries")}function fc(e){return cs(e,"indexConfiguration")}function gc(e){return cs(e,"indexState")}function mc(e){Ur(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let i=1;i<e.length;i++){var r=e[i].indexState.offset;pi(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new mi(t.readTime,t.documentKey,n)}const pc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class yc{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new yc(e,yc.DEFAULT_COLLECTION_PERCENTILE,yc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function vc(e,t,n){const r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Z({range:a},(e,t,n)=>(o++,n.delete()));s.push(u.next(()=>{Ur(1===o)}));const c=[];for(const e of n.mutations){const r=qi(t,e.key.path,n.batchId);s.push(i.delete(r)),c.push(e.key)}return _i.waitFor(s).next(()=>c)}function wc(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw Vr();t=e.noDocument}return JSON.stringify(t).length}yc.DEFAULT_COLLECTION_PERCENTILE=10,yc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,yc.DEFAULT=new yc(41943040,yc.DEFAULT_COLLECTION_PERCENTILE,yc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),yc.DISABLED=new yc(-1,0,0);class _c{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.bn={}}static lt(e,t,n,r){Ur(""!==e.uid);var i=e.isAuthenticated()?e.uid:"";return new _c(i,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ic(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=Ec(h),m=Ic(h);return m.add({}).next(e=>{Ur("number"==typeof e);const t=new Ao(e,l,d,f),n=(i=this.serializer,s=this.userId,a=t,o=a.baseMutations.map(e=>pu(i.ct,e)),u=a.mutations.map(e=>pu(i.ct,e)),{userId:s,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var i,s,a,o,u;let c=new ps((e,t)=>Jr(e.canonicalString(),t.canonicalString()));for(const h of f){const l=qi(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Gi))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.bn[e]=t.keys()}),_i.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return Ic(e).get(t).next(e=>e?(Ur(e.userId===this.userId),Ru(this.serializer,e)):null)}Dn(e,n){return this.bn[n]?_i.resolve(this.bn[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.bn[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let i=null;return Ic(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(Ur(t.batchId>=r),i=Ru(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Ic(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ic(e).G("userMutationsIndex",t).next(e=>e.map(e=>Ru(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=Bi(this.userId,o.path),t=IDBKeyRange.lowerBound(e),u=[];return Ec(a).Z({range:t},(e,t,n)=>{var[r,i,s]=e,i=Vi(i);if(r===this.userId&&o.path.isEqual(i))return Ic(a).get(s).next(e=>{if(!e)throw Vr();Ur(e.userId===this.userId),u.push(Ru(this.serializer,e))});n.done()}).next(()=>u)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new ps(Jr);const n=[];return e.forEach(a=>{var e=Bi(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=Ec(t).Z({range:e},(e,t,n)=>{var[r,i,s]=e,i=Vi(i);r===this.userId&&a.path.isEqual(i)?o=o.add(s):n.done()});n.push(e)}),_i.waitFor(n).next(()=>this.vn(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=Bi(this.userId,a),r=IDBKeyRange.lowerBound(n);let u=new ps(Jr);return Ec(e).Z({range:r},(e,t,n)=>{var[r,i,s]=e,i=Vi(i);r===this.userId&&a.isPrefixOf(i)?i.length===o&&(u=u.add(s)):n.done()}).next(()=>this.vn(e,u))}vn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Ic(t).get(e).next(e=>{if(null===e)throw Vr();Ur(e.userId===this.userId),n.push(Ru(this.serializer,e))}))}),_i.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return vc(t.ue,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.Cn(n.batchId)}),_i.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}Cn(e){delete this.bn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return _i.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return Ec(n).Z({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Vi(e[1]);r.push(t)}else n.done()}).next(()=>{Ur(0===r.length)})})}containsKey(e,t){return bc(e,this.userId,t)}Fn(e){return Tc(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function bc(e,s,t){const n=Bi(s,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return Ec(e).Z({range:r,Y:!0},(e,t,n)=>{var[r,i]=e;r===s&&i===a&&(o=!0),n.done()}).next(()=>o)}function Ic(e){return cs(e,"mutations")}function Ec(e){return cs(e,"documentMutations")}function Tc(e){return cs(e,"mutationQueues")}class Sc{constructor(e){this.Mn=e}next(){return this.Mn+=2,this.Mn}static xn(){return new Sc(0)}static On(){return new Sc(-1)}}class xc{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.Nn(n).next(e=>{const t=new Sc(e.highestTargetId);return e.highestTargetId=t.next(),this.Bn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Nn(e).next(e=>ni.fromTimestamp(new ti(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Nn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Nn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Bn(t,e)))}addTargetData(t,n){return this.Ln(t,n).next(()=>this.Nn(t).next(e=>(e.targetCount+=1,this.kn(n,e),this.Bn(t,e))))}updateTargetData(e,t){return this.Ln(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Dc(t).delete(e.targetId)).next(()=>this.Nn(t)).next(e=>(Ur(0<e.targetCount),--e.targetCount,this.Bn(t,e)))}removeTargets(r,i,s){let a=0;const o=[];return Dc(r).Z((e,t)=>{var n=Mu(t);n.sequenceNumber<=i&&null===s.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>_i.waitFor(o)).next(()=>a)}forEachTarget(e,r){return Dc(e).Z((e,t)=>{var n=Mu(t);r(n)})}Nn(e){return Cc(e).get("targetGlobalKey").next(e=>(Ur(null!==e),e))}Bn(e,t){return Cc(e).put("targetGlobalKey",t)}Ln(e,t){return Dc(e).put(Lu(this.serializer,t))}kn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Nn(e).next(e=>e.targetCount)}getTargetData(e,i){var t=_a(i),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let s=null;return Dc(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{var r=Mu(t);ba(i,r.target)&&(s=r,n.done())}).next(()=>s)}addMatchingKeys(n,e,r){const i=[],s=Ac(n);return e.forEach(e=>{var t=Oi(e.path);i.push(s.put({targetId:r,path:t})),i.push(this.referenceDelegate.addReference(n,r,e))}),_i.waitFor(i)}removeMatchingKeys(n,e,r){const i=Ac(n);return _i.forEach(e,e=>{var t=Oi(e.path);return _i.waitFor([i.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=Ac(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Ac(e);let i=Xa();return r.Z({range:n,Y:!0},(e,t,n)=>{var r=Vi(e[1]),r=new oi(r);i=i.add(r)}).next(()=>i)}containsKey(e,t){var n=Oi(t.path),n=IDBKeyRange.bound([n],[ei(n)],!1,!0);let r=0;return Ac(e).Z({index:"documentTargetsIndex",Y:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}ut(e,t){return Dc(e).get(t).next(e=>e?Mu(e):null)}}function Dc(e){return cs(e,"targets")}function Cc(e){return cs(e,"targetGlobal")}function Ac(e){return cs(e,"targetDocuments")}function Nc([e,t],[n,r]){var i=Jr(e,n);return 0===i?Jr(t,r):i}class kc{constructor(e){this.qn=e,this.buffer=new ps(Nc),this.Qn=0}Kn(){return++this.Qn}$n(e){var t=[e,this.Kn()];if(this.buffer.size<this.qn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Nc(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Rc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Un=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Wn(6e4)}stop(){this.Un&&(this.Un.cancel(),this.Un=null)}get started(){return null!==this.Un}Wn(e){Lr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Un=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Un=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Si(e)?Lr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await wi(e)}await this.Wn(3e5)})}}class Mc{constructor(e,t){this.Gn=e,this.params=t}calculateTargetCount(e,t){return this.Gn.zn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return _i.resolve(Ri.ae);const n=new kc(t);return this.Gn.forEachTarget(e,e=>n.$n(e.sequenceNumber)).next(()=>this.Gn.jn(e,e=>n.$n(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Gn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Gn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(Lr("LruGarbageCollector","Garbage collection skipped; disabled"),_i.resolve(pc)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(Lr("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),pc):this.Hn(t,n))}getCacheSize(e){return this.Gn.getCacheSize(e)}Hn(t,n){let r,i,s,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(i=e>this.params.maximumSequenceNumbersToCollect?(Lr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,i))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),Mr()<=l.DEBUG&&Lr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${i} in `+(o-a)+"ms\n"+`\tRemoved ${s} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),_i.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:e})))}}class Lc{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new Mc(e,t))}zn(e){const n=this.Jn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Jn(e){let t=0;return this.jn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}jn(e,n){return this.Yn(e,(e,t)=>n(t))}addReference(e,t,n){return Fc(e,n)}removeReference(e,t,n){return Fc(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Fc(e,t)}Zn(t,n){let r=!1;return Tc(t).X(e=>bc(t,e,n).next(e=>(e&&(r=!0),_i.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const i=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let a=0;return this.Yn(n,(t,e)=>{if(e<=r){const r=this.Zn(n,t).next(e=>{if(!e)return a++,i.getEntry(n,t).next(()=>(i.removeEntry(t,ni.min()),Ac(n).delete(function(e){return[0,Oi(e.path)]}(t))))});s.push(r)}}).next(()=>_i.waitFor(s)).next(()=>i.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Fc(e,t)}Yn(e,r){const t=Ac(e);let i,s=Ri.ae;return t.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(s!==Ri.ae&&r(new oi(Vi(i)),s),s=n,i=t):s=Ri.ae}).next(()=>{s!==Ri.ae&&r(new oi(Vi(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Fc(e,t){return Ac(e).put((e=e.currentSequenceNumber,{targetId:0,path:Oi(t.path),sequenceNumber:e}))}class Oc{constructor(){this.changes=new Ka(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Ys.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?_i.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Pc{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return qc(e).put(n)}removeEntry(e,t,n){return qc(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Au(t),n[n.length-1]]}(t,n))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.Xn(t,e)))}getEntry(e,n){let r=Ys.newInvalidDocument(n);return qc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Gc(n))},(e,t)=>{r=this.er(n,t)}).next(()=>r)}tr(e,n){let r={size:0,document:Ys.newInvalidDocument(n)};return qc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Gc(n))},(e,t)=>{r={document:this.er(n,t),size:wc(t)}}).next(()=>r)}getEntries(e,t){let r=ja;return this.nr(e,t,(e,t)=>{var n=this.er(e,t);r=r.insert(e,n)}).next(()=>r)}rr(e,t){let r=ja,i=new fs(oi.comparator);return this.nr(e,t,(e,t)=>{var n=this.er(e,t);r=r.insert(e,n),i=i.insert(e,wc(t))}).next(()=>({documents:r,ir:i}))}nr(e,t,i){if(t.isEmpty())return _i.resolve();let n=new ps(jc);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(Gc(n.first()),Gc(n.last())),s=n.getIterator();let a=s.getNext();return qc(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=oi.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&jc(a,r)<0;)i(a,null),a=s.getNext();a&&a.isEqual(r)&&(i(a,t),a=s.hasNext()?s.getNext():null),a?n.W(Gc(a)):n.done()}).next(()=>{for(;a;)i(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,r,t,i){const n=r.path,s=[n.popLast().toArray(),n.lastSegment(),Au(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],a=[n.popLast().toArray(),n.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return qc(e).G(IDBKeyRange.bound(s,a,!0)).next(e=>{let t=ja;for(const n of e){const e=this.er(oi.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e.isFoundDocument()&&(Ba(r,e)||i.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,i){let s=ja;var r=Kc(t,n),a=Kc(t,mi.max());return qc(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,a,!0)},(e,t,n)=>{var r=this.er(oi.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(r.key,r),s.size===i&&n.done()}).next(()=>s)}newChangeBuffer(e){return new Uc(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Bc(e).get("remoteDocumentGlobalKey").next(e=>(Ur(!!e),e))}Xn(e,t){return Bc(e).put("remoteDocumentGlobalKey",t)}er(e,t){if(t){const e=function(e,t){let n;if(t.document)n=mu(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=oi.fromSegments(t.noDocument.path),i=ku(t.noDocument.readTime);n=Ys.newNoDocument(e,i),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return Vr();{const e=oi.fromSegments(t.unknownDocument.path),s=ku(t.unknownDocument.version);n=Ys.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new ti(t[0],t[1]),ni.fromTimestamp(r))),n;var r}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(ni.min()))return e}return Ys.newInvalidDocument(e)}}function Vc(e){return new Pc(e)}class Uc extends Oc{constructor(e,t){super(),this.sr=e,this.trackRemovals=t,this._r=new Ka(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(s){const a=[];let o=0,u=new ps((e,t)=>Jr(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this._r.get(e);if(a.push(this.sr.removeEntry(s,e,n.readTime)),t.isValidDocument()){var r=Cu(this.sr.serializer,t);u=u.add(e.path.popLast());var i=wc(r);o+=i-n.size,a.push(this.sr.addEntry(s,e,r))}else if(o-=n.size,this.trackRemovals){const o=Cu(this.sr.serializer,t.convertToNoDocument(ni.min()));a.push(this.sr.addEntry(s,e,o))}}),u.forEach(e=>{a.push(this.sr.indexManager.addToCollectionParentIndex(s,e))}),a.push(this.sr.updateMetadata(s,o)),_i.waitFor(a)}getFromCache(e,t){return this.sr.tr(e,t).next(e=>(this._r.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.sr.rr(e,t).next(({documents:n,ir:e})=>(e.forEach((e,t)=>{this._r.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Bc(e){return cs(e,"remoteDocumentGlobal")}function qc(e){return cs(e,"remoteDocumentsV14")}function Gc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Kc(e,t){const n=t.documentKey.path.toArray();return[e,Au(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function jc(e,t){var n=e.path.toArray(),r=t.path.toArray();let i=0;for(let s=0;s<n.length-2&&s<r.length-2;++s)if(i=Jr(n[s],r[s]),i)return i;return i=Jr(n.length,r.length),i||(i=Jr(n[n.length-2],r[r.length-2]),i||Jr(n[n.length-1],r[r.length-1]))}class zc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class $c{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&_o(r.mutation,e,ws.empty(),ti.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,Xa()).next(()=>e))}getLocalViewOfDocuments(e,t,n=Xa()){const r=Ha();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=$a();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=Ha();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,Xa()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,i){let s=ja;const a=Ha(),o=Ha();return t.forEach((e,t)=>{const n=r.get(t.key);i.has(t.key)&&(void 0===n||n.mutation instanceof Eo)?s=s.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),_o(n.mutation,t,n.mutation.getFieldMask(),ti.now())):a.set(t.key,ws.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new zc(t,null!==(n=a.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(s,a){const o=Ha();let u=new fs((e,t)=>e-t),c=Xa();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(s,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||ws.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||Xa()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,i=Ha();r.forEach(e=>{var t;c.has(e)||(null!==(t=vo(a.get(e),o.get(e)))&&i.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(s,n,i))}return _i.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,oi.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Ra(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(s,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(s,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(s,t,a.largestBatchId,o-n.size):_i.resolve(Ha());let r=-1,i=n;return e.next(e=>_i.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?_i.resolve():this.remoteDocumentCache.getEntry(s,t).next(e=>{i=i.insert(t,e)}))).next(()=>this.populateOverlays(s,e,n)).next(()=>this.computeViews(s,i,e,Xa())).next(e=>({batchId:r,changes:Qa(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new oi(t)).next(e=>{let t=$a();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(r,i,s){const a=i.collectionGroup;let o=$a();return this.indexManager.getCollectionParents(r,a).next(e=>_i.forEach(e,e=>{var t,n=(t=i,e=e.child(a),new xa(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.getDocumentsMatchingCollectionQuery(r,n,s).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,s,n){let a;return this.documentOverlayCache.getOverlaysForCollection(t,s.path,n.largestBatchId).next(e=>(a=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,s,n,a))).next(r=>{a.forEach((e,t)=>{var n=t.getKey();null===r.get(n)&&(r=r.insert(n,Ys.newInvalidDocument(n)))});let i=$a();return r.forEach((e,t)=>{var n=a.get(e);void 0!==n&&_o(n.mutation,t,ws.empty(),ti.now()),Ba(s,t)&&(i=i.insert(e,t))}),i})}}class Qc{constructor(e){this.serializer=e,this.ar=new Map,this.ur=new Map}getBundleMetadata(e,t){return _i.resolve(this.ar.get(t))}saveBundleMetadata(e,t){return this.ar.set(t.id,{id:t.id,version:t.version,createTime:su(t.createTime)}),_i.resolve()}getNamedQuery(e,t){return _i.resolve(this.ur.get(t))}saveNamedQuery(e,t){return this.ur.set(t.name,{name:(t=t).name,query:Fu(t.bundledQuery),readTime:su(t.readTime)}),_i.resolve()}}class Hc{constructor(){this.overlays=new fs(oi.comparator),this.cr=new Map}getOverlay(e,t){return _i.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Ha();return _i.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.ht(n,r,t)}),_i.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.cr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.cr.delete(n)),_i.resolve()}getOverlaysForCollection(e,t,n){const r=Ha(),i=t.length+1,s=new oi(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return _i.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let i=new fs((e,t)=>e-t);const s=this.overlays.getIterator();for(;s.hasNext();){const t=s.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=i.get(t.largestBatchId);null===e&&(e=Ha(),i=i.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=Ha(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return _i.resolve(a)}ht(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.cr.get(r.largestBatchId).delete(n.key);this.cr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new ko(t,n));let i=this.cr.get(t);void 0===i&&(i=Xa(),this.cr.set(t,i)),this.cr.set(t,i.add(n.key))}}class Wc{constructor(){this.lr=new ps(Yc.hr),this.Pr=new ps(Yc.Ir)}isEmpty(){return this.lr.isEmpty()}addReference(e,t){var n=new Yc(e,t);this.lr=this.lr.add(n),this.Pr=this.Pr.add(n)}Tr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Er(new Yc(e,t))}dr(e,t){e.forEach(e=>this.removeReference(e,t))}Ar(e){const t=new oi(new ii([])),n=new Yc(t,e),r=new Yc(t,e+1),i=[];return this.Pr.forEachInRange([n,r],e=>{this.Er(e),i.push(e.key)}),i}Rr(){this.lr.forEach(e=>this.Er(e))}Er(e){this.lr=this.lr.delete(e),this.Pr=this.Pr.delete(e)}Vr(e){var t=new oi(new ii([])),n=new Yc(t,e),t=new Yc(t,e+1);let r=Xa();return this.Pr.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Yc(e,0),t=this.lr.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class Yc{constructor(e,t){this.key=e,this.mr=t}static hr(e,t){return oi.comparator(e.key,t.key)||Jr(e.mr,t.mr)}static Ir(e,t){return Jr(e.mr,t.mr)||oi.comparator(e.key,t.key)}}class Xc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.gr=1,this.pr=new ps(Yc.hr)}checkEmpty(e){return _i.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var i=this.gr;this.gr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var s=new Ao(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.pr=this.pr.add(new Yc(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return _i.resolve(s)}lookupMutationBatch(e,t){return _i.resolve(this.yr(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.wr(t+1),n=n<0?0:n;return _i.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return _i.resolve(0===this.mutationQueue.length?-1:this.gr-1)}getAllMutationBatches(e){return _i.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Yc(t,0),r=new Yc(t,Number.POSITIVE_INFINITY),i=[];return this.pr.forEachInRange([n,r],e=>{var t=this.yr(e.mr);i.push(t)}),_i.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new ps(Jr);return t.forEach(e=>{var t=new Yc(e,0),n=new Yc(e,Number.POSITIVE_INFINITY);this.pr.forEachInRange([t,n],e=>{r=r.add(e.mr)})}),_i.resolve(this.Sr(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;oi.isDocumentKey(i)||(i=i.child(""));var s=new Yc(new oi(i),0);let a=new ps(Jr);return this.pr.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.mr)),!0)},s),_i.resolve(this.Sr(a))}Sr(e){const n=[];return e.forEach(e=>{var t=this.yr(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){Ur(0===this.br(r.batchId,"removed")),this.mutationQueue.shift();let i=this.pr;return _i.forEach(r.mutations,e=>{var t=new Yc(e.key,r.batchId);return i=i.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.pr=i})}Cn(e){}containsKey(e,t){var n=new Yc(t,0),n=this.pr.firstAfterOrEqual(n);return _i.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,_i.resolve()}br(e,t){return this.wr(e)}wr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}yr(e){var t=this.wr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Jc{constructor(e){this.Dr=e,this.docs=new fs(oi.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Dr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return _i.resolve(n?n.document.mutableCopy():Ys.newInvalidDocument(t))}getEntries(e,t){let n=ja;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Ys.newInvalidDocument(e))}),_i.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=ja;const s=t.path,a=new oi(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||pi(gi(a),n)<=0||(r.has(a.key)||Ba(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return _i.resolve(i)}getAllFromCollectionGroup(e,t,n,r){Vr()}vr(e,t){return _i.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Zc(this)}getSize(e){return _i.resolve(this.size)}}class Zc extends Oc{constructor(e){super(),this.sr=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.sr.addEntry(n,t)):this.sr.removeEntry(e)}),_i.waitFor(r)}getFromCache(e,t){return this.sr.getEntry(e,t)}getAllFromCache(e,t){return this.sr.getEntries(e,t)}}class eh{constructor(e){this.persistence=e,this.Cr=new Ka(e=>_a(e),ba),this.lastRemoteSnapshotVersion=ni.min(),this.highestTargetId=0,this.Fr=0,this.Mr=new Wc,this.targetCount=0,this.Or=Sc.xn()}forEachTarget(e,n){return this.Cr.forEach((e,t)=>n(t)),_i.resolve()}getLastRemoteSnapshotVersion(e){return _i.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return _i.resolve(this.Fr)}allocateTargetId(e){return this.highestTargetId=this.Or.next(),_i.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Fr&&(this.Fr=t),_i.resolve()}Ln(e){this.Cr.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Or=new Sc(t),this.highestTargetId=t),e.sequenceNumber>this.Fr&&(this.Fr=e.sequenceNumber)}addTargetData(e,t){return this.Ln(t),this.targetCount+=1,_i.resolve()}updateTargetData(e,t){return this.Ln(t),_i.resolve()}removeTargetData(e,t){return this.Cr.delete(t.target),this.Mr.Ar(t.targetId),--this.targetCount,_i.resolve()}removeTargets(n,r,i){let s=0;const a=[];return this.Cr.forEach((e,t)=>{t.sequenceNumber<=r&&null===i.get(t.targetId)&&(this.Cr.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),s++)}),_i.waitFor(a).next(()=>s)}getTargetCount(e){return _i.resolve(this.targetCount)}getTargetData(e,t){var n=this.Cr.get(t)||null;return _i.resolve(n)}addMatchingKeys(e,t,n){return this.Mr.Tr(t,n),_i.resolve()}removeMatchingKeys(t,e,n){this.Mr.dr(e,n);const r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(e=>{i.push(r.markPotentiallyOrphaned(t,e))}),_i.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Mr.Ar(t),_i.resolve()}getMatchingKeysForTargetId(e,t){var n=this.Mr.Vr(t);return _i.resolve(n)}containsKey(e,t){return _i.resolve(this.Mr.containsKey(t))}}class th{constructor(e,t){this.Nr={},this.overlays={},this.Br=new Ri(0),this.Lr=!1,this.Lr=!0,this.referenceDelegate=e(this),this.kr=new eh(this),this.indexManager=new oc,this.remoteDocumentCache=(e=e=>this.referenceDelegate.qr(e),new Jc(e)),this.serializer=new Du(t),this.Qr=new Qc(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Lr=!1,Promise.resolve()}get started(){return this.Lr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Hc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Nr[e.toKey()];return n||(n=new Xc(t,this.referenceDelegate),this.Nr[e.toKey()]=n),n}getTargetCache(){return this.kr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Qr}runTransaction(e,t,n){Lr("MemoryPersistence","Starting transaction:",e);const r=new nh(this.Br.next());return this.referenceDelegate.Kr(),n(r).next(e=>this.referenceDelegate.$r(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ur(t,n){return _i.or(Object.values(this.Nr).map(e=>()=>e.containsKey(t,n)))}}class nh extends vi{constructor(e){super(),this.currentSequenceNumber=e}}class rh{constructor(e){this.persistence=e,this.Wr=new Wc,this.Gr=null}static zr(e){return new rh(e)}get jr(){if(this.Gr)return this.Gr;throw Vr()}addReference(e,t,n){return this.Wr.addReference(n,t),this.jr.delete(n.toString()),_i.resolve()}removeReference(e,t,n){return this.Wr.removeReference(n,t),this.jr.add(n.toString()),_i.resolve()}markPotentiallyOrphaned(e,t){return this.jr.add(t.toString()),_i.resolve()}removeTarget(e,t){this.Wr.Ar(t.targetId).forEach(e=>this.jr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.jr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Kr(){this.Gr=new Set}$r(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return _i.forEach(this.jr,e=>{const t=oi.fromPath(e);return this.Hr(n,t).next(e=>{e||r.removeEntry(t,ni.min())})}).next(()=>(this.Gr=null,r.apply(n)))}updateLimboDocument(e,t){return this.Hr(e,t).next(e=>{e?this.jr.delete(t.toString()):this.jr.add(t.toString())})}qr(e){return 0}Hr(e,t){return _i.or([()=>_i.resolve(this.Wr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ur(e,t)])}}class ih{constructor(e){this.serializer=e}B(t,e,n,r){const i=new bi("createOrUpgrade",e);var s;n<1&&1<=r&&(t.createObjectStore("owner"),(s=t).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ui,{unique:!0}),s.createObjectStore("documentMutations"),sh(t),t.createObjectStore("remoteDocuments"));let a=_i.resolve();return n<3&&3<=r&&(0!==n&&((s=t).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),sh(t)),a=a.next(()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ni.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(i))),n<4&&4<=r&&(0!==n&&(a=a.next(()=>function(r,i){return i.store("mutations").G().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ui,{unique:!0});const t=i.store("mutations"),n=e.map(e=>t.put(e));return _i.waitFor(n)})}(t,i))),a=a.next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.Yr(i))),n<6&&6<=r&&(a=a.next(()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(t),this.Zr(i)))),n<7&&7<=r&&(a=a.next(()=>this.Xr(i))),n<8&&8<=r&&(a=a.next(()=>this.ei(t,i))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.ti(i))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:es});t.createIndex("collectionPathOverlayIndex",ts,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",ns,{unique:!1})}(t)})),n<13&&13<=r&&(a=a.next(()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Ki});t.createIndex("documentKeyIndex",ji),t.createIndex("collectionGroupIndex",zi)}(t)).next(()=>this.ni(t,i)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.ri(t,i))),n<15&&15<=r&&(a=a.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Yi}).createIndex("sequenceNumberIndex",Xi,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Ji}).createIndex("documentKeyIndex",Zi,{unique:!1})}(t))),a}Zr(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=wc(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}Yr(r){const e=r.store("mutationQueues"),t=r.store("mutations");return e.G().next(e=>_i.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.G("userMutationsIndex",e).next(e=>_i.forEach(e,e=>{Ur(e.userId===n.userId);var t=Ru(this.serializer,e);return vc(r,n.userId,t).next(()=>{})}))}))}Xr(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return t.Z((e,t)=>{const n=new ii(e),r=[0,Oi(n)];s.push(a.get(r).next(e=>e?_i.resolve():(e=>a.put({targetId:0,path:Oi(e),sequenceNumber:i.highestListenSequenceNumber}))(n)))}).next(()=>_i.waitFor(s))})}ei(e,t){e.createObjectStore("collectionParents",{keyPath:Wi});const n=t.store("collectionParents"),r=new uc,i=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Oi(r)})}};return t.store("remoteDocuments").Z({Y:!0},(e,t)=>{const n=new ii(e);return i(n.popLast())}).next(()=>t.store("documentMutations").Z({Y:!0},([,e],t)=>{const n=Vi(e);return i(n.popLast())}))}ti(e){const r=e.store("targets");return r.Z((e,t)=>{var n=Mu(t),n=Lu(this.serializer,n);return r.put(n)})}ni(e,a){const t=a.store("remoteDocuments"),o=[];return t.Z((e,t)=>{const n=a.store("remoteDocumentsV14"),r=((s=t).document?new oi(ii.fromString(s.document.name).popFirst(5)):s.noDocument?oi.fromSegments(s.noDocument.path):s.unknownDocument?oi.fromSegments(s.unknownDocument.path):Vr()).path.toArray(),i={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};var s;o.push(n.put(i))}).next(()=>_i.waitFor(o))}ri(e,s){const t=s.store("mutations"),a=Vc(this.serializer),o=new th(rh.zr,this.serializer.ct);return t.G().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:Xa();Ru(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),_i.forEach(r,(e,t)=>{var n=new Nr(t),r=Gu.lt(this.serializer,n),i=o.getIndexManager(n),n=_c.lt(n,this.serializer,i,o.referenceDelegate);return new $c(a,n,r,i).recalculateAndSaveOverlaysForDocumentKeys(new us(s,Ri.ae),e).next()})})}}function sh(e){e.createObjectStore("targetDocuments",{keyPath:Qi}).createIndex("documentTargetsIndex",Hi,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",$i,{unique:!0}),e.createObjectStore("targetGlobal")}const ah="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class oh{constructor(e,t,n,r,i,s,a,o,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ii=i,this.window=s,this.document=a,this.si=u,this.oi=c,this._i=h,this.Br=null,this.Lr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ai=null,this.inForeground=!1,this.ui=null,this.ci=null,this.li=Number.NEGATIVE_INFINITY,this.hi=e=>Promise.resolve(),!oh.v())throw new qr(Br.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Lc(this,r),this.Pi=t+"main",this.serializer=new Du(o),this.Ii=new Ii(this.Pi,this._i,new ih(this.serializer)),this.kr=new xc(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Vc(this.serializer),this.Qr=new Uu,this.window&&this.window.localStorage?this.Ti=this.window.localStorage:(this.Ti=null,!1===c&&Fr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ei().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new qr(Br.FAILED_PRECONDITION,ah);return this.di(),this.Ai(),this.Ri(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.kr.getHighestSequenceNumber(e))}).then(e=>{this.Br=new Ri(e,this.si)}).then(()=>{this.Lr=!0}).catch(e=>(this.Ii&&this.Ii.close(),Promise.reject(e)))}Vi(t){return this.hi=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ii.k(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ii.enqueueAndForget(async()=>{this.started&&await this.Ei()}))}Ei(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>ch(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.mi(t).next(e=>{e||(this.isPrimary=!1,this.ii.enqueueRetryable(()=>this.hi(!1)))})}).next(()=>this.fi(t)).next(e=>this.isPrimary&&!e?this.gi(t).next(()=>!1):!!e&&this.pi(t).next(()=>!0))).catch(e=>{if(Si(e))return Lr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return Lr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ii.enqueueRetryable(()=>this.hi(e)),this.isPrimary=e})}mi(e){return uh(e).get("owner").next(e=>_i.resolve(this.yi(e)))}wi(e){return ch(e).delete(this.clientId)}async Si(){if(this.isPrimary&&!this.bi(this.li,18e5)){this.li=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=cs(e,"clientMetadata");return r.G().next(e=>{const t=this.Di(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return _i.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ti)for(const t of e)this.Ti.removeItem(this.vi(t.clientId))}}Ri(){this.ci=this.ii.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ei().then(()=>this.Si()).then(()=>this.Ri()))}yi(e){return!!e&&e.ownerId===this.clientId}fi(t){return this.oi?_i.resolve(!0):uh(t).get("owner").next(e=>{if(null!==e&&this.bi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)){if(this.yi(e)&&this.networkEnabled)return!0;if(!this.yi(e)){if(!e.allowTabSynchronization)throw new qr(Br.FAILED_PRECONDITION,ah);return!1}}return!(!this.networkEnabled||!this.inForeground)||ch(t).G().next(e=>void 0===this.Di(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Lr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Lr=!1,this.Fi(),this.ci&&(this.ci.cancel(),this.ci=null),this.Mi(),this.xi(),await this.Ii.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new us(e,Ri.ae);return this.gi(t).next(()=>this.wi(t))}),this.Ii.close(),this.Oi()}Di(e,t){return e.filter(e=>this.bi(e.updateTimeMs,t)&&!this.Ci(e.clientId))}Ni(){return this.runTransaction("getActiveClients","readonly",e=>ch(e).G().next(e=>this.Di(e,18e5).map(e=>e.clientId)))}get started(){return this.Lr}getMutationQueue(e,t){return _c.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.kr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new hc(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Gu.lt(this.serializer,e)}getBundleCache(){return this.Qr}runTransaction(t,n,r){Lr("IndexedDbPersistence","Starting transaction:",t);var e,i="readonly"===n?"readonly":"readwrite",s=15===(e=this._i)?os:14===e?as:13===e?ss:12===e?is:11===e?rs:void Vr();let a;return this.Ii.runTransaction(t,i,s,e=>(a=new us(e,this.Br?this.Br.next():Ri.ae),"readwrite-primary"===n?this.mi(a).next(e=>!!e||this.fi(a)).next(e=>{if(!e)throw Fr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.ii.enqueueRetryable(()=>this.hi(!1)),new qr(Br.FAILED_PRECONDITION,yi);return r(a)}).next(e=>this.pi(a).next(()=>e)):this.Bi(a).next(()=>r(a)))).then(e=>(a.raiseOnCommittedEvent(),e))}Bi(e){return uh(e).get("owner").next(e=>{if(null!==e&&this.bi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)&&!this.yi(e)&&!(this.oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new qr(Br.FAILED_PRECONDITION,ah)})}pi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return uh(e).put("owner",t)}static v(){return Ii.v()}gi(e){const t=uh(e);return t.get("owner").next(e=>this.yi(e)?(Lr("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):_i.resolve())}bi(e,t){var n=Date.now();return!(e<n-t||n<e&&(Fr(`Detected an update time that is in the future: ${e} > ${n}`),1))}di(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ui=()=>{this.ii.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Ei()))},this.document.addEventListener("visibilitychange",this.ui),this.inForeground="visible"===this.document.visibilityState)}Mi(){this.ui&&(this.document.removeEventListener("visibilitychange",this.ui),this.ui=null)}Ai(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ai=()=>{this.Fi();var e=/(?:Version|Mobile)\/1[456]/;h()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ii.enterRestrictedMode(!0),this.ii.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ai))}xi(){this.ai&&(this.window.removeEventListener("pagehide",this.ai),this.ai=null)}Ci(e){var t;try{var n=null!==(null===(t=this.Ti)||void 0===t?void 0:t.getItem(this.vi(e)));return Lr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return Fr("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Fi(){if(this.Ti)try{this.Ti.setItem(this.vi(this.clientId),String(Date.now()))}catch(e){Fr("Failed to set zombie client id.",e)}}Oi(){if(this.Ti)try{this.Ti.removeItem(this.vi(this.clientId))}catch(e){}}vi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function uh(e){return cs(e,"owner")}function ch(e){return cs(e,"clientMetadata")}function hh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class lh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Li=n,this.ki=r}static qi(e,t){let n=Xa(),r=Xa();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new lh(e,t.fromCache,n,r)}}class dh{constructor(){this.Qi=!1}initialize(e,t){this.Ki=e,this.indexManager=t,this.Qi=!0}getDocumentsMatchingQuery(t,n,r,i){return this.$i(t,n).next(e=>e||this.Ui(t,n,i,r)).next(e=>e||this.Wi(t,n))}$i(i,s){if(Aa(s))return _i.resolve(null);let t=La(s);return this.indexManager.getIndexType(i,t).next(e=>0===e?null:(null!==s.limit&&1===e&&(s=Oa(s,null,"F"),t=La(s)),this.indexManager.getDocumentsMatchingTarget(i,t).next(e=>{const r=Xa(...e);return this.Ki.getDocuments(i,r).next(n=>this.indexManager.getMinOffset(i,t).next(e=>{var t=this.Gi(s,n);return this.zi(s,t,r,e.readTime)?this.$i(i,Oa(s,null,"F")):this.ji(i,t,s,e)}))})))}Ui(n,r,i,s){return Aa(r)||s.isEqual(ni.min())?this.Wi(n,r):this.Ki.getDocuments(n,i).next(e=>{var t=this.Gi(r,e);return this.zi(r,t,i,s)?this.Wi(n,r):(Mr()<=l.DEBUG&&Lr("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Ua(r)),this.ji(n,t,r,fi(s,-1)))})}Gi(n,e){let r=new ps(Ga(n));return e.forEach((e,t)=>{Ba(n,t)&&(r=r.add(t))}),r}zi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||0<i.version.compareTo(r))}Wi(e,t){return Mr()<=l.DEBUG&&Lr("QueryEngine","Using full collection scan to execute query:",Ua(t)),this.Ki.getDocumentsMatchingQuery(e,t,mi.min())}ji(e,n,t,r){return this.Ki.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class fh{constructor(e,t,n,r){this.persistence=e,this.Hi=t,this.serializer=r,this.Ji=new fs(Jr),this.Yi=new Ka(e=>_a(e),ba),this.Zi=new Map,this.Xi=e.getRemoteDocumentCache(),this.kr=e.getTargetCache(),this.Qr=e.getBundleCache(),this.es(n)}es(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new $c(this.Xi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Xi.setIndexManager(this.indexManager),this.Hi.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Ji))}}function gh(e,t,n,r){return new fh(e,t,n,r)}async function mh(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",i=>{let s;return a.mutationQueue.getAllMutationBatches(i).next(e=>(s=e,a.es(t),a.mutationQueue.getAllMutationBatches(i))).next(e=>{const t=[],n=[];let r=Xa();for(const i of s){t.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}for(const i of e){n.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(i,r).next(e=>({ts:e,removedBatchIds:t,addedBatchIds:n}))})})}function ph(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.kr.getLastRemoteSnapshotVersion(e))}function yh(e,c){const h=e,l=c.snapshotVersion;let d=h.Ji;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.Xi.newChangeBuffer({trackRemovals:!0});d=h.Ji;const u=[];c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.kr.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.kr.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var i,s,a;null!==c.targetMismatches.get(n)?e=e.withResumeToken(bs.EMPTY_BYTE_STRING,ni.min()).withLastLimboFreeSnapshotVersion(ni.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),i=r,s=e,a=t,0!==i.resumeToken.approximateByteSize()&&!(3e8<=s.snapshotVersion.toMicroseconds()-i.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.kr.updateTargetData(o,e))}});let t=ja,n=Xa();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(vh(o,e,c.documentUpdates).next(e=>{t=e.ns,n=e.rs})),!l.isEqual(ni.min())){const c=h.kr.getLastRemoteSnapshotVersion(o).next(e=>h.kr.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return _i.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.Ji=d,e))}function vh(e,s,t){let n=Xa(),a=Xa();return t.forEach(e=>n=n.add(e)),s.getEntries(e,n).next(r=>{let i=ja;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(ni.min())?(s.removeEntry(e,t.readTime),i=i.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(s.addEntry(t),i=i.insert(e,t)):Lr("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{ns:i,rs:a}})}function wh(e,r){const i=e;return i.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return i.kr.getTargetData(t,r).next(e=>e?(n=e,_i.resolve(n)):i.kr.allocateTargetId(t).next(e=>(n=new xu(r,e,"TargetPurposeListen",t.currentSequenceNumber),i.kr.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=i.Ji.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(i.Ji=i.Ji.insert(e.targetId,e),i.Yi.set(r,e.targetId)),e})}async function _h(e,t,n){const r=e,i=r.Ji.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,e=>r.persistence.referenceDelegate.removeTarget(e,i))}catch(e){if(!Si(e))throw e;Lr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ji=r.Ji.remove(t),r.Yi.delete(i.target)}function bh(e,n,r){const i=e;let s=ni.min(),a=Xa();return i.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=e,i=r.Yi.get(n);return void 0!==i?_i.resolve(r.Ji.get(i)):r.kr.getTargetData(t,n)}(i,t,La(n)).next(e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,i.kr.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>i.Hi.getDocumentsMatchingQuery(t,n,r?s:ni.min(),r?a:Xa())).next(e=>(Th(i,qa(n),e),{documents:e,ss:a})))}function Ih(e,t){const n=e,r=n.kr,i=n.Ji.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",e=>r.ut(e,t).next(e=>e?e.target:null))}function Eh(e,t){const n=e,r=n.Zi.get(t)||ni.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Xi.getAllFromCollectionGroup(e,t,fi(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(Th(n,t,e),e))}function Th(e,t,n){let r=e.Zi.get(t)||ni.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Zi.set(t,r)}function Sh(e,t){return`firestore_clients_${e}_${t}`}function xh(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Dh(e,t){return`firestore_targets_${e}_${t}`}class Ch{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static cs(e,t,n){var r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code,s&&(i=new qr(r.error.code,r.error.message))),s?new Ch(e,t,r.state,i):(Fr("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}ls(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Ah{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static cs(e,t){var n=JSON.parse(t);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(r=new qr(n.error.code,n.error.message))),i?new Ah(e,n.state,r):(Fr("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}ls(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Nh{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static cs(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=Ja;for(let s=0;r&&s<n.activeTargetIds.length;++s)r=Fi(n.activeTargetIds[s]),i=i.add(n.activeTargetIds[s]);return r?new Nh(e,i):(Fr("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class kh{constructor(e,t){this.clientId=e,this.onlineState=t}static cs(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new kh(t.clientId,t.onlineState):(Fr("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Rh{constructor(){this.activeTargetIds=Ja}hs(e){this.activeTargetIds=this.activeTargetIds.add(e)}Ps(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ls(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Mh{constructor(e,t,n,r,i){this.window=e,this.ii=t,this.persistenceKey=n,this.Is=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Ts=this.Es.bind(this),this.ds=new fs(Jr),this.started=!1,this.As=[];var s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Rs=Sh(this.persistenceKey,this.Is),this.Vs=`firestore_sequence_number_${this.persistenceKey}`,this.ds=this.ds.insert(this.Is,new Rh),this.fs=new RegExp(`^firestore_clients_${s}_([^_]*)$`),this.gs=new RegExp(`^firestore_mutations_${s}_(\\d+)(?:_(.*))?$`),this.ps=new RegExp(`^firestore_targets_${s}_(\\d+)$`),this.ys=`firestore_online_state_${this.persistenceKey}`,this.ws=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.Ts)}static v(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Ni();for(const n of e)if(n!==this.Is){const e=this.getItem(Sh(this.persistenceKey,n));var t;!e||(t=Nh.cs(n,e))&&(this.ds=this.ds.insert(t.clientId,t))}this.Ss();const n=this.storage.getItem(this.ys);if(n){const e=this.bs(n);e&&this.Ds(e)}for(const e of this.As)this.Es(e);this.As=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.vs(this.ds)}isActiveQueryTarget(n){let r=!1;return this.ds.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Cs(e,"pending")}updateMutationState(e,t,n){this.Cs(e,t,n),this.Fs(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(Dh(this.persistenceKey,e)))||(n=Ah.cs(e,n))&&(t=n.state)),this.Ms.hs(e),this.Ss(),t}removeLocalQueryTarget(e){this.Ms.Ps(e),this.Ss()}isLocalQueryTarget(e){return this.Ms.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Dh(this.persistenceKey,e))}updateQueryState(e,t,n){this.xs(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Fs(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Os(e)}notifyBundleLoaded(e){this.Ns(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Ts),this.removeItem(this.Rs),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Lr("SharedClientState","READ",e,t),t}setItem(e,t){Lr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Lr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}Es(e){const i=e;i.storageArea===this.storage&&(Lr("SharedClientState","EVENT",i.key,i.newValue),i.key!==this.Rs?this.ii.enqueueRetryable(async()=>{if(this.started){if(null!==i.key)if(this.fs.test(i.key)){if(null==i.newValue){var e=this.Bs(i.key);return this.Ls(e,null)}e=this.ks(i.key,i.newValue);if(e)return this.Ls(e.clientId,e)}else if(this.gs.test(i.key)){if(null!==i.newValue){var t=this.qs(i.key,i.newValue);if(t)return this.Qs(t)}}else if(this.ps.test(i.key)){if(null!==i.newValue){t=this.Ks(i.key,i.newValue);if(t)return this.$s(t)}}else if(i.key===this.ys){if(null!==i.newValue){var n=this.bs(i.newValue);if(n)return this.Ds(n)}}else if(i.key===this.Vs){n=function(e){let t=Ri.ae;if(null!=e)try{var n=JSON.parse(e);Ur("number"==typeof n),t=n}catch(e){Fr("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(i.newValue);n!==Ri.ae&&this.sequenceNumberHandler(n)}else if(i.key===this.ws){const r=this.Us(i.newValue);await Promise.all(r.map(e=>this.syncEngine.Ws(e)))}}else this.As.push(i)}):Fr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ms(){return this.ds.get(this.Is)}Ss(){this.setItem(this.Rs,this.Ms.ls())}Cs(e,t,n){const r=new Ch(this.currentUser,e,t,n),i=xh(this.persistenceKey,this.currentUser,e);this.setItem(i,r.ls())}Fs(e){var t=xh(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Os(e){var t={clientId:this.Is,onlineState:e};this.storage.setItem(this.ys,JSON.stringify(t))}xs(e,t,n){const r=Dh(this.persistenceKey,e),i=new Ah(e,t,n);this.setItem(r,i.ls())}Ns(e){var t=JSON.stringify(Array.from(e));this.setItem(this.ws,t)}Bs(e){var t=this.fs.exec(e);return t?t[1]:null}ks(e,t){var n=this.Bs(e);return Nh.cs(n,t)}qs(e,t){var n=this.gs.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Ch.cs(new Nr(n),r,t)}Ks(e,t){var n=this.ps.exec(e),n=Number(n[1]);return Ah.cs(n,t)}bs(e){return kh.cs(e)}Us(e){return JSON.parse(e)}async Qs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Gs(e.batchId,e.state,e.error);Lr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}$s(e){return this.syncEngine.zs(e.targetId,e.state,e.error)}Ls(e,t){const n=t?this.ds.insert(e,t):this.ds.remove(e),r=this.vs(this.ds),i=this.vs(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.js(s,a).then(()=>{this.ds=n})}Ds(e){this.ds.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}vs(e){let n=Ja;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Lh{constructor(){this.Hs=new Rh,this.Js={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Hs.hs(e),this.Js[e]||"not-current"}updateQueryState(e,t,n){this.Js[e]=t}removeLocalQueryTarget(e){this.Hs.Ps(e)}isLocalQueryTarget(e){return this.Hs.activeTargetIds.has(e)}clearQueryState(e){delete this.Js[e]}getAllActiveQueryTargets(){return this.Hs.activeTargetIds}isActiveQueryTarget(e){return this.Hs.activeTargetIds.has(e)}start(){return this.Hs=new Rh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Fh{Ys(e){}shutdown(){}}class Oh{constructor(){this.Zs=()=>this.Xs(),this.eo=()=>this.no(),this.ro=[],this.io()}Ys(e){this.ro.push(e)}shutdown(){window.removeEventListener("online",this.Zs),window.removeEventListener("offline",this.eo)}io(){window.addEventListener("online",this.Zs),window.addEventListener("offline",this.eo)}Xs(){Lr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ro)e(0)}no(){Lr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ro)e(1)}static v(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Ph=null;function Vh(){return null===Ph?Ph=268435456+Math.round(2147483648*Math.random()):Ph++,"0x"+Ph.toString(16)}const Uh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Bh{constructor(e){this.so=e.so,this.oo=e.oo}_o(e){this.ao=e}uo(e){this.co=e}onMessage(e){this.lo=e}close(){this.oo()}send(e){this.so(e)}ho(){this.ao()}Po(e){this.co(e)}Io(e){this.lo(e)}}const qh="WebChannelConnection";class Gh extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.To=t+"://"+e.host,this.Eo=`projects/${n}/databases/${r}`,this.Ao="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Ro(){return!1}Vo(t,e,n,r,i){const s=Vh(),a=this.mo(t,e);Lr("RestConnection",`Sending RPC '${t}' ${s}:`,a,n);var o={"google-cloud-resource-prefix":this.Eo,"x-goog-request-params":this.Ao};return this.fo(o,r,i),this.po(t,a,o,n).then(e=>(Lr("RestConnection",`Received RPC '${t}' ${s}: `,e),e),e=>{throw Or("RestConnection",`RPC '${t}' ${s} failed with error: `,e,"url: ",a,"request:",n),e})}yo(e,t,n,r,i,s){return this.Vo(e,t,n,r,i)}fo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+kr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}mo(e,t){var n=Uh[e];return`${this.To}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}po(u,t,n,r){const c=Vh();return new Promise((s,a)=>{const o=new xr;o.setWithCredentials(!0),o.listenOnce(_r.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case wr.NO_ERROR:var e=o.getResponseJson();Lr(qh,`XHR for RPC '${u}' ${c} received:`,JSON.stringify(e)),s(e);break;case wr.TIMEOUT:Lr(qh,`RPC '${u}' ${c} timed out`),a(new qr(Br.DEADLINE_EXCEEDED,"Request time out"));break;case wr.HTTP_ERROR:var t=o.getStatus();if(Lr(qh,`RPC '${u}' ${c} failed with status:`,t,"response text:",o.getResponseText()),0<t){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);var n=null==e?void 0:e.error;if(n&&n.status&&n.message){const u=(r=n.status,i=r.toLowerCase().replace(/_/g,"-"),0<=Object.values(Br).indexOf(i)?i:Br.UNKNOWN);a(new qr(u,n.message))}else a(new qr(Br.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new qr(Br.UNAVAILABLE,"Connection failed."));break;default:Vr()}}finally{Lr(qh,`RPC '${u}' ${c} completed.`)}var r,i});var e=JSON.stringify(r);Lr(qh,`RPC '${u}' ${c} sending request:`,r),o.send(t,"POST",e,n,15)})}wo(i,e,t){const s=Vh(),n=[this.To,"/","google.firestore.v1.Firestore","/",i,"/channel"],r=new Qn,a=vr(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.xmlHttpFactory=new Tr({})),this.fo(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;var c=n.join("");Lr(qh,`Creating RPC '${i}' stream ${s}: ${c}`,o);const h=r.createWebChannel(c,o);let l=!1,d=!1;const f=new Bh({so:e=>{d?Lr(qh,`Not sending because RPC '${i}' stream ${s} is closed:`,e):(l||(Lr(qh,`Opening RPC '${i}' stream ${s} transport.`),h.open(),l=!0),Lr(qh,`RPC '${i}' stream ${s} sending:`,e),h.send(e))},oo:()=>h.close()}),g=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return g(h,Sr.EventType.OPEN,()=>{d||Lr(qh,`RPC '${i}' stream ${s} transport opened.`)}),g(h,Sr.EventType.CLOSE,()=>{d||(d=!0,Lr(qh,`RPC '${i}' stream ${s} transport closed`),f.Po())}),g(h,Sr.EventType.ERROR,e=>{d||(d=!0,Or(qh,`RPC '${i}' stream ${s} transport errored:`,e),f.Po(new qr(Br.UNAVAILABLE,"The operation could not be completed")))}),g(h,Sr.EventType.MESSAGE,n=>{if(!d){var e=n.data[0];Ur(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){Lr(qh,`RPC '${i}' stream ${s} received error:`,r);const n=r.status;let e=function(e){var t=yr[e];if(void 0!==t)return Lo(t)}(n),t=r.message;void 0===e&&(e=Br.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),d=!0,f.Po(new qr(e,t)),h.close()}else Lr(qh,`RPC '${i}' stream ${s} received:`,e),f.Io(e)}}),g(a,br.STAT_EVENT,e=>{e.stat===Ir?Lr(qh,`RPC '${i}' stream ${s} detected buffering proxy`):e.stat===Er&&Lr(qh,`RPC '${i}' stream ${s} detected no buffering proxy`)}),setTimeout(()=>{f.ho()},0),f}}function Kh(){return"undefined"!=typeof window?window:null}function jh(){return"undefined"!=typeof document?document:null}function zh(e){return new tu(e,!0)}class $h{constructor(e,t,n=1e3,r=1.5,i=6e4){this.ii=e,this.timerId=t,this.So=n,this.bo=r,this.Do=i,this.vo=0,this.Co=null,this.Fo=Date.now(),this.reset()}reset(){this.vo=0}Mo(){this.vo=this.Do}xo(e){this.cancel();var t=Math.floor(this.vo+this.Oo()),n=Math.max(0,Date.now()-this.Fo),r=Math.max(0,t-n);0<r&&Lr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.vo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Co=this.ii.enqueueAfterDelay(this.timerId,r,()=>(this.Fo=Date.now(),e())),this.vo*=this.bo,this.vo<this.So&&(this.vo=this.So),this.vo>this.Do&&(this.vo=this.Do)}No(){null!==this.Co&&(this.Co.skipDelay(),this.Co=null)}cancel(){null!==this.Co&&(this.Co.cancel(),this.Co=null)}Oo(){return(Math.random()-.5)*this.vo}}class Qh{constructor(e,t,n,r,i,s,a,o){this.ii=e,this.Bo=n,this.Lo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.ko=0,this.qo=null,this.Qo=null,this.stream=null,this.Ko=new $h(e,t)}$o(){return 1===this.state||5===this.state||this.Uo()}Uo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Wo()}async stop(){this.$o()&&await this.close(0)}Go(){this.state=0,this.Ko.reset()}zo(){this.Uo()&&null===this.qo&&(this.qo=this.ii.enqueueAfterDelay(this.Bo,6e4,()=>this.jo()))}Ho(e){this.Jo(),this.stream.send(e)}async jo(){if(this.Uo())return this.close(0)}Jo(){this.qo&&(this.qo.cancel(),this.qo=null)}Yo(){this.Qo&&(this.Qo.cancel(),this.Qo=null)}async close(e,t){this.Jo(),this.Yo(),this.Ko.cancel(),this.ko++,4!==e?this.Ko.reset():t&&t.code===Br.RESOURCE_EXHAUSTED?(Fr(t.toString()),Fr("Using maximum backoff delay to prevent overloading the backend."),this.Ko.Mo()):t&&t.code===Br.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Zo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.uo(t)}Zo(){}auth(){this.state=1;const e=this.Xo(this.ko),n=this.ko;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.ko===n&&this.e_(e,t)},t=>{e(()=>{var e=new qr(Br.UNKNOWN,"Fetching auth token failed: "+t.message);return this.t_(e)})})}e_(e,t){const n=this.Xo(this.ko);this.stream=this.n_(e,t),this.stream._o(()=>{n(()=>(this.state=2,this.Qo=this.ii.enqueueAfterDelay(this.Lo,1e4,()=>(this.Uo()&&(this.state=3),Promise.resolve())),this.listener._o()))}),this.stream.uo(e=>{n(()=>this.t_(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Wo(){this.state=5,this.Ko.xo(async()=>{this.state=0,this.start()})}t_(e){return Lr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Xo(t){return e=>{this.ii.enqueueAndForget(()=>this.ko===t?e():(Lr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Hh extends Qh{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}n_(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.Ko.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:Vr(),i=t.targetChange.targetIds||[],s=(f=t.targetChange.resumeToken,e.useProto3Json?(Ur(void 0===f||"string"==typeof f),bs.fromBase64String(f||"")):(Ur(void 0===f||f instanceof Uint8Array),bs.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?Br.UNKNOWN:Lo(f.code),new qr(o,f.message||""));n=new Qo(r,i,s,o||null)}else if("documentChange"in t){t.documentChange;var u=t.documentChange;u.document,u.document.name,u.document.updateTime;var s=cu(e,u.document.name),o=su(u.document.updateTime),c=u.document.createTime?su(u.document.createTime):ni.min(),h=new Ws({mapValue:{fields:u.document.fields}}),c=Ys.newFoundDocument(s,o,c,h),h=u.targetIds||[],u=u.removedTargetIds||[];n=new zo(h,u,c.key,c)}else if("documentDelete"in t){t.documentDelete;h=t.documentDelete;h.document;u=cu(e,h.document),c=h.readTime?su(h.readTime):ni.min(),c=Ys.newNoDocument(u,c),h=h.removedTargetIds||[];n=new zo([],h,c.key,c)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=cu(e,l.document),l=l.removedTargetIds||[];n=new zo([],l,d,null)}else{if(!("filter"in t))return Vr();{t.filter;const e=t.filter;e.targetId;var{count:l=0,unchangedNames:d}=e,l=new Ro(l,d),d=e.targetId;n=new $o(d,l)}}var o,f;return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return ni.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?su(t.readTime):ni.min()}(e);return this.listener.r_(t,n)}i_(e){const t={};t.database=du(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=Ia(r)?{documents:vu(e,r)}:{query:wu(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=iu(e,t.resumeToken);const r=nu(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(ni.min())){n.readTime=ru(e,t.snapshotVersion.toTimestamp());const r=nu(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);var n,n=(this.serializer,e,null==(n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Vr()}}(e.purpose))?null:{"goog-listen-tags":n});n&&(t.labels=n),this.Ho(t)}s_(e){const t={};t.database=du(this.serializer),t.removeTarget=e,this.Ho(t)}}class Wh extends Qh{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.o_=!1}get __(){return this.o_}start(){this.o_=!1,this.lastStreamToken=void 0,super.start()}Zo(){this.o_&&this.a_([])}n_(e,t){return this.connection.wo("Write",e,t)}onMessage(e){if(Ur(!!e.streamToken),this.lastStreamToken=e.streamToken,this.o_){this.Ko.reset();var t=(r=e.writeResults,i=e.commitTime,r&&0<r.length?(Ur(void 0!==i),r.map(e=>function(e,t){let n=e.updateTime?su(e.updateTime):su(t);return n.isEqual(ni.min())&&(n=su(t)),new go(n,e.transformResults||[])}(e,i))):[]),n=su(e.commitTime);return this.listener.u_(n,t)}var r,i;return Ur(!e.writeResults||0===e.writeResults.length),this.o_=!0,this.listener.c_()}l_(){const e={};e.database=du(this.serializer),this.Ho(e)}a_(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>pu(this.serializer,e))};this.Ho(t)}}class Yh extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.h_=!1}P_(){if(this.h_)throw new qr(Br.FAILED_PRECONDITION,"The client has already been terminated.")}Vo(n,r,i){return this.P_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Vo(n,r,i,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Br.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new qr(Br.UNKNOWN,e.toString())})}yo(n,r,i,s){return this.P_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.yo(n,r,i,e,t,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Br.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new qr(Br.UNKNOWN,e.toString())})}terminate(){this.h_=!0}}class Xh{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.T_=0,this.E_=null,this.d_=!0}A_(){0===this.T_&&(this.R_("Unknown"),this.E_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.E_=null,this.V_("Backend didn't respond within 10 seconds."),this.R_("Offline"),Promise.resolve())))}m_(e){"Online"===this.state?this.R_("Unknown"):(this.T_++,1<=this.T_&&(this.f_(),this.V_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.R_("Offline")))}set(e){this.f_(),this.T_=0,"Online"===e&&(this.d_=!1),this.R_(e)}R_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}V_(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.d_?(Fr(t),this.d_=!1):Lr("OnlineStateTracker",t)}f_(){null!==this.E_&&(this.E_.cancel(),this.E_=null)}}class Jh{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.g_=[],this.p_=new Map,this.y_=new Set,this.w_=[],this.S_=i,this.S_.Ys(e=>{n.enqueueAndForget(async()=>{ol(this)&&(Lr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.y_.add(4),await el(t),t.b_.set("Unknown"),t.y_.delete(4),await Zh(t)}(this))})}),this.b_=new Xh(n,r)}}async function Zh(e){if(ol(e))for(const t of e.w_)await t(!0)}async function el(e){for(const t of e.w_)await t(!1)}function tl(e,t){const n=e;n.p_.has(t.targetId)||(n.p_.set(t.targetId,t),al(n)?sl(n):yl(n).Uo()&&rl(n,t))}function nl(e,t){const n=e,r=yl(n);n.p_.delete(t),r.Uo()&&il(n,t),0===n.p_.size&&(r.Uo()?r.zo():ol(n)&&n.b_.set("Unknown"))}function rl(e,t){var n;e.D_.Be(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(ni.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),yl(e).i_(t)}function il(e,t){e.D_.Be(t),yl(e).s_(t)}function sl(t){t.D_=new Wo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),ut:e=>t.p_.get(e)||null,rt:()=>t.datastore.serializer.databaseId}),yl(t).start(),t.b_.A_()}function al(e){return ol(e)&&!yl(e).$o()&&0<e.p_.size}function ol(e){return 0===e.y_.size}function ul(e){e.D_=void 0}async function cl(e,t,n){if(!Si(t))throw t;e.y_.add(1),await el(e),e.b_.set("Offline"),n=n||(()=>ph(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Lr("RemoteStore","Retrying IndexedDB access"),await n(),e.y_.delete(1),await Zh(e)})}function hl(t,n){return n().catch(e=>cl(t,e,n))}async function ll(e){const t=e,n=vl(t);let r=0<t.g_.length?t.g_[t.g_.length-1].batchId:-1;for(;ol(i=t)&&i.g_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.g_.length&&n.zo();break}r=e.batchId,function(e,t){e.g_.push(t);const n=vl(e);n.Uo()&&n.__&&n.a_(t.mutations)}(t,e)}catch(e){await cl(t,e)}var i;dl(t)&&fl(t)}function dl(e){return ol(e)&&!vl(e).$o()&&0<e.g_.length}function fl(e){vl(e).start()}async function gl(e,t){t&&vl(e).__&&await async function(e,t){if(Mo(n=t.code)&&n!==Br.ABORTED){const r=e.g_.shift();vl(e).Go(),await hl(e,()=>e.remoteSyncer.rejectFailedWrite(r.batchId,t)),await ll(e)}var n}(e,t),dl(e)&&fl(e)}async function ml(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),Lr("RemoteStore","RemoteStore received new credentials");var r=ol(n);n.y_.add(3),await el(n),r&&n.b_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.y_.delete(3),await Zh(n)}async function pl(e,t){const n=e;t?(n.y_.delete(2),await Zh(n)):(n.y_.add(2),await el(n),n.b_.set("Unknown"))}function yl(t){return t.v_||(t.v_=function(e,t,n){const r=e;return r.P_(),new Hh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{_o:(async function(n){n.p_.forEach((e,t)=>{rl(n,e)})}).bind(null,t),uo:(async function(e,t){ul(e),al(e)?(e.b_.m_(t),sl(e)):e.b_.set("Unknown")}).bind(null,t),r_:(async function(e,t,n){if(e.b_.set("Online"),t instanceof Qo&&2===t.state&&t.cause)try{await async function(e,t){var n=t.cause;for(const r of t.targetIds)e.p_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.p_.delete(r),e.D_.removeTarget(r))}(e,t)}catch(n){Lr("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await cl(e,n)}else if(t instanceof zo?e.D_.We(t):t instanceof $o?e.D_.Ze(t):e.D_.je(t),!n.isEqual(ni.min()))try{const t=await ph(e.localStore);0<=n.compareTo(t)&&await function(i,r){const e=i.D_.st(r);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=i.p_.get(t);n&&i.p_.set(t,n.withResumeToken(e.resumeToken,r))}}),e.targetMismatches.forEach((e,t)=>{const n=i.p_.get(e);var r;n&&(i.p_.set(e,n.withResumeToken(bs.EMPTY_BYTE_STRING,n.snapshotVersion)),il(i,e),r=new xu(n.target,e,t,n.sequenceNumber),rl(i,r))}),i.remoteSyncer.applyRemoteEvent(e)}(e,n)}catch(t){Lr("RemoteStore","Failed to raise snapshot:",t),await cl(e,t)}}).bind(null,t)}),t.w_.push(async e=>{e?(t.v_.Go(),al(t)?sl(t):t.b_.set("Unknown")):(await t.v_.stop(),ul(t))})),t.v_}function vl(t){return t.C_||(t.C_=function(e,t,n){const r=e;return r.P_(),new Wh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{_o:(async function(e){vl(e).l_()}).bind(null,t),uo:gl.bind(null,t),c_:(async function(e){const t=vl(e);for(const n of e.g_)t.a_(n.mutations)}).bind(null,t),u_:(async function(e,t,n){const r=e.g_.shift(),i=No.from(r,t,n);await hl(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await ll(e)}).bind(null,t)}),t.w_.push(async e=>{e?(t.C_.Go(),await ll(t)):(await t.C_.stop(),0<t.g_.length&&(Lr("RemoteStore",`Stopping write stream with ${t.g_.length} pending writes`),t.g_=[]))})),t.C_}class wl{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Gr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,a=new wl(e,t,s,r,i);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new qr(Br.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function _l(e,t){if(Fr("AsyncQueue",`${t}: ${e}`),Si(e))return new qr(Br.UNAVAILABLE,`${t}: ${e}`);throw e}class bl{constructor(n){this.comparator=n?(e,t)=>n(e,t)||oi.comparator(e.key,t.key):(e,t)=>oi.comparator(e.key,t.key),this.keyedMap=$a(),this.sortedSet=new fs(this.comparator)}static emptySet(e){return new bl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof bl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new bl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Il{constructor(){this.F_=new fs(oi.comparator)}track(e){var t=e.doc.key,n=this.F_.get(t);!n||0!==e.type&&3===n.type?this.F_=this.F_.insert(t,e):3===e.type&&1!==n.type?this.F_=this.F_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.F_=this.F_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.F_=this.F_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.F_=this.F_.remove(t):1===e.type&&2===n.type?this.F_=this.F_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.F_=this.F_.insert(t,{type:2,doc:e.doc}):Vr()}M_(){const n=[];return this.F_.inorderTraversal((e,t)=>{n.push(t)}),n}}class El{constructor(e,t,n,r,i,s,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new El(e,t,bl.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Pa(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Tl{constructor(){this.x_=void 0,this.listeners=[]}}class Sl{constructor(){this.queries=new Ka(e=>Va(e),Pa),this.onlineState="Unknown",this.O_=new Set}}async function xl(e,t){const n=e,r=t.query;let i=!1,s=n.queries.get(r);if(s||(i=!0,s=new Tl),i)try{s.x_=await n.onListen(r)}catch(e){const n=_l(e,`Initialization of query '${Ua(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,s),s.listeners.push(t),t.N_(n.onlineState),!s.x_||t.B_(s.x_)&&Cl(n)}async function Dl(e,t){const n=e,r=t.query;let i=!1;const s=n.queries.get(r);if(s){const e=s.listeners.indexOf(t);0<=e&&(s.listeners.splice(e,1),i=0===s.listeners.length)}if(i)return n.queries.delete(r),n.onUnlisten(r)}function Cl(e){e.O_.forEach(e=>{e.next()})}class Al{constructor(e,t,n){this.query=e,this.L_=t,this.k_=!1,this.q_=null,this.onlineState="Unknown",this.options=n||{}}B_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new El(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.k_?this.Q_(e)&&(this.L_.next(e),t=!0):this.K_(e,this.onlineState)&&(this.U_(e),t=!0),this.q_=e,t}onError(e){this.L_.error(e)}N_(e){this.onlineState=e;let t=!1;return this.q_&&!this.k_&&this.K_(this.q_,e)&&(this.U_(this.q_),t=!0),t}K_(e,t){return!e.fromCache||(!this.options.W_||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Q_(e){if(0<e.docChanges.length)return!0;var t=this.q_&&this.q_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}U_(e){e=El.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.k_=!0,this.L_.next(e)}}class Nl{constructor(e,t){this.G_=e,this.byteLength=t}z_(){return"metadata"in this.G_}}class kl{constructor(e){this.serializer=e}os(e){return cu(this.serializer,e)}_s(e){return e.metadata.exists?mu(this.serializer,e.document,!1):Ys.newNoDocument(this.os(e.metadata.name),this.us(e.metadata.readTime))}us(e){return su(e)}}class Rl{constructor(e,t,n){this.j_=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ml(e)}H_(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.G_.namedQuery)this.queries.push(e.G_.namedQuery);else if(e.G_.documentMetadata){this.documents.push({metadata:e.G_.documentMetadata}),e.G_.documentMetadata.exists||++t;const n=ii.fromString(e.G_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.G_.document&&(this.documents[this.documents.length-1].document=e.G_.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}J_(e){const t=new Map,n=new kl(this.serializer);for(const i of e)if(i.metadata.queries){const e=n.os(i.metadata.name);for(const n of i.metadata.queries){var r=(t.get(n)||Xa()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const i=e;let s=Xa(),a=ja;for(const e of n){const n=t.os(e.metadata.name);e.document&&(s=s.add(n));const c=t._s(e);c.setReadTime(t.us(e.metadata.readTime)),a=a.insert(n,c)}const o=i.Xi.newChangeBuffer({trackRemovals:!0}),u=await wh(i,(r=r,La(Ca(ii.fromString(`__bundle__/docs/${r}`)))));return i.persistence.runTransaction("Apply bundle documents","readwrite",t=>vh(t,o,a).next(e=>(o.apply(t),e)).next(e=>i.kr.removeMatchingKeysForTargetId(t,u.targetId).next(()=>i.kr.addMatchingKeys(t,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(t,e.ns,e.rs)).next(()=>e.ns)))}(this.localStore,new kl(this.serializer),this.documents,this.j_.id),t=this.J_(this.documents);for(const e of this.queries)await async function(e,n,r=Xa()){const i=await wh(e,La(Fu(n.bundledQuery))),s=e;return s.persistence.runTransaction("Save named query","readwrite",e=>{var t=su(n.readTime);if(0<=i.snapshotVersion.compareTo(t))return s.Qr.saveNamedQuery(e,n);t=i.withResumeToken(bs.EMPTY_BYTE_STRING,t);return s.Ji=s.Ji.insert(t.targetId,t),s.kr.updateTargetData(e,t).next(()=>s.kr.removeMatchingKeysForTargetId(e,i.targetId)).next(()=>s.kr.addMatchingKeys(e,r,i.targetId)).next(()=>s.Qr.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Y_:this.collectionGroups,Z_:e}}}function Ml(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Ll{constructor(e){this.key=e}}class Fl{constructor(e){this.key=e}}class Ol{constructor(e,t){this.query=e,this.X_=t,this.ea=null,this.hasCachedResults=!1,this.current=!1,this.ta=Xa(),this.mutatedKeys=Xa(),this.na=Ga(e),this.ra=new bl(this.na)}get ia(){return this.X_}sa(e,t){const o=t?t.oa:new Il,u=(t||this).ra;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=Ba(this.query,t)?t:null,i=!!n&&this.mutatedKeys.has(n.key),s=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?i!==s&&(o.track({type:3,doc:r}),a=!0):this._a(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.na(r,d)||f&&this.na(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),s?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{ra:h,oa:o,zi:l,mutatedKeys:c}}_a(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.ra;this.ra=e.ra,this.mutatedKeys=e.mutatedKeys;const i=e.oa.M_();i.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Vr()}};return n(e)-n(t)}(e.type,t.type)||this.na(e.doc,t.doc)),this.aa(n);var s=t?this.ua():[],a=0===this.ta.size&&this.current?1:0,o=a!==this.ea;return this.ea=a,0!==i.length||o?{snapshot:new El(this.query,e.ra,r,i,e.mutatedKeys,0==a,o,!1,!!n&&0<n.resumeToken.approximateByteSize()),ca:s}:{ca:s}}N_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ra:this.ra,oa:new Il,mutatedKeys:this.mutatedKeys,zi:!1},!1)):{ca:[]}}la(e){return!this.X_.has(e)&&!!this.ra.has(e)&&!this.ra.get(e).hasLocalMutations}aa(e){e&&(e.addedDocuments.forEach(e=>this.X_=this.X_.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.X_=this.X_.delete(e)),this.current=e.current)}ua(){if(!this.current)return[];const t=this.ta;this.ta=Xa(),this.ra.forEach(e=>{this.la(e.key)&&(this.ta=this.ta.add(e.key))});const n=[];return t.forEach(e=>{this.ta.has(e)||n.push(new Fl(e))}),this.ta.forEach(e=>{t.has(e)||n.push(new Ll(e))}),n}ha(e){this.X_=e.ss,this.ta=Xa();var t=this.sa(e.documents);return this.applyChanges(t,!0)}Pa(){return El.fromInitialDocuments(this.query,this.ra,this.mutatedKeys,0===this.ea,this.hasCachedResults)}}class Pl{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Vl{constructor(e){this.key=e,this.Ia=!1}}class Ul{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Ta={},this.Ea=new Ka(e=>Va(e),Pa),this.da=new Map,this.Aa=new Set,this.Ra=new fs(oi.comparator),this.Va=new Map,this.ma=new Wc,this.fa={},this.ga=new Map,this.pa=Sc.On(),this.onlineState="Unknown",this.ya=void 0}get isPrimaryClient(){return!0===this.ya}}async function Bl(r,e,t,n,i){r.wa=(e,t,n)=>async function(e,t,n,r){let i=t.view.sa(n);i.zi&&(i=await bh(e.localStore,t.query,!1).then(({documents:e})=>t.view.sa(e,i)));var s=r&&r.targetChanges.get(t.targetId),s=t.view.applyChanges(i,e.isPrimaryClient,s);return Wl(e,t.targetId,s.ca),s.snapshot}(r,e,t,n);const s=await bh(r.localStore,e,!0),a=new Ol(e,s.ss),o=a.sa(s.documents),u=jo.createSynthesizedTargetChangeForCurrentChange(t,n&&"Offline"!==r.onlineState,i),c=a.applyChanges(o,r.isPrimaryClient,u);Wl(r,t,c.ca);var h=new Pl(e,t,a);return r.Ea.set(e,h),r.da.has(t)?r.da.get(t).push(e):r.da.set(t,[e]),c.snapshot}async function ql(e,t,n){const r=nd(e);try{const e=await function(e,i){const s=e,a=ti.now(),o=i.reduce((e,t)=>e.add(t.key),Xa());let u,c;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=ja,r=Xa();return s.Xi.getEntries(n,o).next(e=>{t=e,t.forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>s.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of i){const i=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=ro(r.transform,e||null);null!=i&&(null===n&&(n=Ws.empty()),n.set(r.field,i))}return n||null}(n,u.get(n.key).overlayedDocument);null!=i&&t.push(new Eo(n.key,i,function r(e){const i=[];return ls(e.fields,(e,t)=>{const n=new ai([e]);if(js(t)){const e=r(t.mapValue).fields;if(0===e.length)i.push(n);else for(const t of e)i.push(n.child(t))}else i.push(n)}),new ws(i)}(i.value.mapValue),mo.exists(!0)))}return s.mutationQueue.addMutationBatch(n,a,t,i)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return s.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:Qa(u)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.fa[e.currentUser.toKey()];r=r||new fs(Jr),r=r.insert(t,n),e.fa[e.currentUser.toKey()]=r}(r,e.batchId,n),await Xl(r,e.changes),await ll(r.remoteStore)}catch(e){const t=_l(e,"Failed to persist write");n.reject(t)}}async function Gl(e,t){const r=e;try{const e=await yh(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.Va.get(t);n&&(Ur(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.Ia=!0:0<e.modifiedDocuments.size?Ur(n.Ia):0<e.removedDocuments.size&&(Ur(n.Ia),n.Ia=!1))}),await Xl(r,e,t)}catch(e){await wi(e)}}function Kl(r,i,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.Ea.forEach((e,t)=>{var n=t.view.N_(i);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.N_(n)&&(r=!0)}),r&&Cl(t)}(t.eventManager,i),r.length&&t.Ta.r_(r),t.onlineState=i,t.isPrimaryClient&&t.sharedClientState.setOnlineState(i)}}async function jl(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=i.Xi.newChangeBuffer({trackRemovals:!0});return function(e,t,r,i){const s=r.batch,n=s.keys();let a=_i.resolve();return n.forEach(n=>{a=a.next(()=>i.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);Ur(null!==t),e.version.compareTo(t)<0&&(s.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),i.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,s))}(i,e,r,n).next(()=>n.apply(e)).next(()=>i.mutationQueue.performConsistencyCheck(e)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Xa();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(r))).next(()=>i.localDocuments.getDocuments(e,t))})}(n.localStore,t);$l(n,r,null),zl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Xl(n,e)}catch(e){await wi(e)}}function zl(e,t){(e.ga.get(t)||[]).forEach(e=>{e.resolve()}),e.ga.delete(t)}function $l(e,t,n){const r=e;let i=r.fa[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.fa[r.currentUser.toKey()]=i}}function Ql(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.da.get(e))t.Ea.delete(r),n&&t.Ta.Sa(r,n);t.da.delete(e),t.isPrimaryClient&&t.ma.Ar(e).forEach(e=>{t.ma.containsKey(e)||Hl(t,e)})}function Hl(e,t){e.Aa.delete(t.path.canonicalString());var n=e.Ra.get(t);null!==n&&(nl(e.remoteStore,n),e.Ra=e.Ra.remove(t),e.Va.delete(n),Yl(e))}function Wl(e,t,n){for(const r of n)r instanceof Ll?(e.ma.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.Ra.get(n)||e.Aa.has(r)||(Lr("SyncEngine","New document in limbo: "+n),e.Aa.add(r),Yl(e))}(e,r)):r instanceof Fl?(Lr("SyncEngine","Document no longer in limbo: "+r.key),e.ma.removeReference(r.key,t),e.ma.containsKey(r.key)||Hl(e,r.key)):Vr()}function Yl(e){for(;0<e.Aa.size&&e.Ra.size<e.maxConcurrentLimboResolutions;){var t=e.Aa.values().next().value;e.Aa.delete(t);var n=new oi(ii.fromString(t)),t=e.pa.next();e.Va.set(t,new Vl(n)),e.Ra=e.Ra.insert(n,t),tl(e.remoteStore,new xu(La(Ca(n.path)),t,"TargetPurposeLimboResolution",Ri.ae))}}async function Xl(e,t,r){const i=e,s=[],a=[],o=[];i.Ea.isEmpty()||(i.Ea.forEach((e,n)=>{o.push(i.wa(n,t,r).then(e=>{var t;(e||r)&&i.isPrimaryClient&&i.sharedClientState.updateQueryState(n.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(s.push(e),t=lh.qi(n.targetId,e),a.push(t))}))}),await Promise.all(o),i.Ta.r_(s),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>_i.forEach(t,t=>_i.forEach(t.Li,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>_i.forEach(t.ki,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!Si(e))throw e;Lr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.Ji.get(t),n=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(n);r.Ji=r.Ji.insert(t,i)}}}(i.localStore,a))}async function Jl(r,e){const i=r;if(td(i),nd(i),!0===e&&!0!==i.ya){const r=i.sharedClientState.getAllActiveQueryTargets(),e=await Zl(i,r.toArray());i.ya=!0,await pl(i.remoteStore,!0);for(const r of e)tl(i.remoteStore,r)}else if(!1===e&&!1!==i.ya){const r=[];let n=Promise.resolve();i.da.forEach((e,t)=>{i.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Ql(i,t),_h(i.localStore,t,!0))),nl(i.remoteStore,t)}),await n,await Zl(i,r),function(e){const n=e;n.Va.forEach((e,t)=>{nl(n.remoteStore,t)}),n.ma.Rr(),n.Va=new Map,n.Ra=new fs(oi.comparator)}(i),i.ya=!1,await pl(i.remoteStore,!1)}}async function Zl(t,n){const r=t,i=[],s=[];for(const t of n){let e;const h=r.da.get(t);if(h&&0!==h.length){e=await wh(r.localStore,La(h[0]));for(const t of h){const n=r.Ea.get(t),h=(a=r,o=n,c=u=void 0,c=await bh((u=a).localStore,o.query,!0),c=o.view.ha(c),u.isPrimaryClient&&Wl(u,o.targetId,c.ca),await c);h.snapshot&&s.push(h.snapshot)}}else{const h=await Ih(r.localStore,t);e=await wh(r.localStore,h),await Bl(r,ed(h),t,!1,e.resumeToken)}i.push(e)}var a,o,u,c;return r.Ta.r_(s),i}function ed(e){return Da(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function td(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Gl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.Va.get(t);if(r&&r.Ia)return Xa().add(r.key);{let e=Xa();const r=n.da.get(t);if(!r)return e;for(const t of r){const r=n.Ea.get(t);e=e.unionWith(r.view.ia)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.Va.get(t),s=i&&i.key;if(s){let e=new fs(oi.comparator);e=e.insert(s,Ys.newNoDocument(s,ni.min()));const n=Xa().add(s),i=new Ko(ni.min(),new Map,new fs(Jr),e,n);await Gl(r,i),r.Ra=r.Ra.remove(s),r.Va.delete(t),Yl(r)}else await _h(r.localStore,t,!1).then(()=>Ql(r,t,n)).catch(wi)}).bind(null,t),t.Ta.r_=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.B_(e)&&(r=!0);i.x_=e}}r&&Cl(n)}).bind(null,t.eventManager),t.Ta.Sa=(function(e,t,n){const r=e,i=r.queries.get(t);if(i)for(const e of i.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function nd(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=jl.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return i.mutationQueue.lookupMutationBatch(t,r).next(e=>(Ur(null!==e),n=e.keys(),i.mutationQueue.removeMutationBatch(t,e))).next(()=>i.mutationQueue.performConsistencyCheck(t)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>i.localDocuments.getDocuments(t,n))})}(r.localStore,t);$l(r,t,n),zl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Xl(r,e)}catch(n){await wi(n)}}).bind(null,t),t}class rd{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=zh(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return gh(this.persistence,new dh,e.initialUser,this.serializer)}createPersistence(e){return new th(rh.zr,this.serializer)}createSharedClientState(e){return new Lh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class id extends rd{constructor(e,t,n){super(),this.Da=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Da.initialize(this,e),await nd(this.Da.syncEngine),await ll(this.Da.remoteStore),await this.persistence.Vi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return gh(this.persistence,new dh,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Rc(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){var n=new ki(t,this.persistence);return new Ni(e.asyncQueue,n)}createPersistence(e){var t=hh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?yc.withCacheSize(this.cacheSizeBytes):yc.DEFAULT;return new oh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Kh(),jh(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Lh}}class sd extends id{constructor(e,t){super(e,t,!1),this.Da=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.Da.syncEngine;this.sharedClientState instanceof Mh&&(this.sharedClientState.syncEngine={Gs:(async function(e,t,n,r){var i=e,s=await function(e,n){const r=e,i=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>i.Dn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):_i.resolve(null)))}(i.localStore,t);null!==s?("pending"===n?await ll(i.remoteStore):"acknowledged"===n||"rejected"===n?($l(i,t,r||null),zl(i,t),i.localStore.mutationQueue.Cn(t)):Vr(),await Xl(i,s)):Lr("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),zs:(async function(e,t,n,r){const i=e;if(i.ya)Lr("SyncEngine","Ignoring unexpected query state notification.");else{var s=i.da.get(t);if(s&&0<s.length)switch(n){case"current":case"not-current":{const e=await Eh(i.localStore,qa(s[0])),r=Ko.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,bs.EMPTY_BYTE_STRING);await Xl(i,e,r);break}case"rejected":await _h(i.localStore,t,!0),Ql(i,t,r);break;default:Vr()}}}).bind(null,t),js:(async function(e,t,n){const r=td(e);if(r.ya){for(const e of t)if(r.da.has(e))Lr("SyncEngine","Adding an already active target "+e);else{const t=await Ih(r.localStore,e),n=await wh(r.localStore,t);await Bl(r,ed(t),n.targetId,!1,n.resumeToken),tl(r.remoteStore,n)}for(const e of n)r.da.has(e)&&await _h(r.localStore,e,!1).then(()=>{nl(r.remoteStore,e),Ql(r,e)}).catch(wi)}}).bind(null,t),Ni:(function(e){return e.localStore.persistence.Ni()}).bind(null,t),Ws:(async function(e,t){const n=e;return Eh(n.localStore,t).then(e=>Xl(n,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.Vi(async e=>{await Jl(this.Da.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t=Kh();if(!Mh.v(t))throw new qr(Br.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=hh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Mh(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class ad{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Kl(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){Lr("SyncEngine","User change. New user:",t.toKey());const i=await mh(n.localStore,t);n.currentUser=t,e=n,r="'waitForPendingWrites' promise is rejected due to a user change.",e.ga.forEach(e=>{e.forEach(e=>{e.reject(new qr(Br.CANCELLED,r))})}),e.ga.clear(),n.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await Xl(n,i.ts)}var r}).bind(null,this.syncEngine),await pl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Sl}createDatastore(e){var t,n,r,i=zh(e.databaseInfo.databaseId),s=(r=e.databaseInfo,new Gh(r));return t=e.authCredentials,n=e.appCheckCredentials,r=s,e=i,new Yh(t,n,r,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>Kl(this.syncEngine,e,0),e=new(Oh.v()?Oh:Fh),new Jh(t,n,r,i,e);var t,n,r,i}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){const o=new Ul(e,t,n,r,i,s);return a&&(o.ya=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;Lr("RemoteStore","RemoteStore shutting down."),t.y_.add(5),await el(t),t.S_.shutdown(),t.b_.set("Unknown")}(this.remoteStore)}}function od(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class ud{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.va(this.observer.next,e)}error(e){this.observer.error?this.va(this.observer.error,e):Fr("Uncaught Error in snapshot listener:",e.toString())}Ca(){this.muted=!0}va(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class cd{constructor(e,t){this.Fa=e,this.serializer=t,this.metadata=new Gr,this.buffer=new Uint8Array,this.Ma=new TextDecoder("utf-8"),this.xa().then(e=>{e&&e.z_()?this.metadata.resolve(e.G_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.G_)}`))},e=>this.metadata.reject(e))}close(){return this.Fa.cancel()}async getMetadata(){return this.metadata.promise}async ba(){return await this.getMetadata(),this.xa()}async xa(){var e=await this.Oa();if(null===e)return null;var t=this.Ma.decode(e),n=Number(t);isNaN(n)&&this.Na(`length string (${t}) is not valid number`);t=await this.Ba(n);return new Nl(JSON.parse(t),e.length+n)}La(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Oa(){for(;this.La()<0&&!await this.ka(););if(0===this.buffer.length)return null;var e=this.La();e<0&&this.Na("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Ba(e){for(;this.buffer.length<e;)await this.ka()&&this.Na("Reached the end of bundle when more is expected.");var t=this.Ma.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Na(e){throw this.Fa.cancel(),new Error(`Invalid bundle format: ${e}`)}async ka(){var e=await this.Fa.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class hd{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new qr(Br.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=du(r.serializer)+"/documents",i={documents:t.map(e=>uu(r.serializer,e))},s=await r.yo("BatchGetDocuments",n,i,t.length),a=new Map;s.forEach(e=>{const t=(n=r.serializer,"found"in(e=e)?function(e,t){Ur(!!t.found),t.found.name,t.found.updateTime;var n=cu(e,t.found.name),r=su(t.found.updateTime),i=t.found.createTime?su(t.found.createTime):ni.min(),s=new Ws({mapValue:{fields:t.found.fields}});return Ys.newFoundDocument(n,r,i,s)}(n,e):"missing"in e?function(e,t){Ur(!!t.missing),Ur(!!t.readTime);var n=cu(e,t.missing),r=su(t.readTime);return Ys.newNoDocument(n,r)}(n,e):Vr());var n;a.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{var t=a.get(e.toString());Ur(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Do(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=oi.fromPath(t);this.mutations.push(new Co(n,this.precondition(n)))}),await async function(e,t){const n=e,r=du(n.serializer)+"/documents",i={writes:t.map(e=>pu(n.serializer,e))};await n.Vo("Commit",r,i)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw Vr();t=ni.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new qr(Br.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(ni.min())?mo.exists(!1):mo.updateTime(t):mo.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return mo.exists(!0);if(t.isEqual(ni.min()))throw new qr(Br.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return mo.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class ld{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.qa=n.maxAttempts,this.Ko=new $h(this.asyncQueue,"transaction_retry")}run(){--this.qa,this.Qa()}Qa(){this.Ko.xo(async()=>{const t=new hd(this.datastore),e=this.Ka(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.$a(e)}))}).catch(e=>{this.$a(e)})})}Ka(e){try{var t=this.updateFunction(e);return!Mi(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}$a(e){0<this.qa&&this.Ua(e)?(--this.qa,this.asyncQueue.enqueueAndForget(()=>(this.Qa(),Promise.resolve()))):this.deferred.reject(e)}Ua(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Mo(t)}}class dd{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=Nr.UNAUTHENTICATED,this.clientId=Xr.V(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Lr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Lr("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new qr(Br.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Gr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=_l(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function fd(e,t){e.asyncQueue.verifyOperationInProgress(),Lr("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await mh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function gd(e,n){e.asyncQueue.verifyOperationInProgress();var t=await pd(e);Lr("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await n.initialize(t,r),e.setCredentialChangeListener(e=>ml(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>ml(n.remoteStore,t)),e._onlineComponents=n}function md(e){return"FirebaseError"===e.name?e.code===Br.FAILED_PRECONDITION||e.code===Br.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function pd(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){Lr("FirestoreClient","Using user provided OfflineComponentProvider");try{await fd(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!md(n))throw n;Or("Error using user provided cache. Falling back to memory cache: "+n),await fd(t,new rd)}}else Lr("FirestoreClient","Using default OfflineComponentProvider"),await fd(t,new rd);return t._offlineComponents}async function yd(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(Lr("FirestoreClient","Using user provided OnlineComponentProvider"),await gd(e,e._uninitializedComponentsProvider._online)):(Lr("FirestoreClient","Using default OnlineComponentProvider"),await gd(e,new ad))),e._onlineComponents}function vd(e){return pd(e).then(e=>e.persistence)}function wd(e){return pd(e).then(e=>e.localStore)}function _d(e){return yd(e).then(e=>e.remoteStore)}function bd(e){return yd(e).then(e=>e.syncEngine)}async function Id(e){const t=await yd(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=td(e);let r,i;const s=n.Ea.get(t);if(s)r=s.targetId,n.sharedClientState.addLocalQueryTarget(r),i=s.view.Pa();else{const e=await wh(n.localStore,La(t)),s=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,i=await Bl(n,t,r,"current"===s,e.resumeToken),n.isPrimaryClient&&tl(n.remoteStore,e)}return i}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.Ea.get(t),i=n.da.get(r.targetId);if(1<i.length)return n.da.set(r.targetId,i.filter(e=>!Pa(e,t))),void n.Ea.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await _h(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),nl(n.remoteStore,r.targetId),Ql(n,r.targetId)}).catch(wi)):(Ql(n,r.targetId),await _h(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function Ed(e,t,n={}){const r=new Gr;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,i,s,a){const e=new ud({next:e=>{r.enqueueAndForget(()=>Dl(n,o));var t=e.docs.has(i);!t&&e.fromCache?a.reject(new qr(Br.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&s&&"server"===s.source?a.reject(new qr(Br.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new Al(Ca(i.path),e,{includeMetadataChanges:!0,W_:!0});return xl(n,o)}(await Id(e),e.asyncQueue,t,n,r)),r.promise}function Td(e,t,n={}){const r=new Gr;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,i){const s=new ud({next:e=>{n.enqueueAndForget(()=>Dl(t,a)),e.fromCache&&"server"===r.source?i.reject(new qr(Br.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(e)},error:e=>i.reject(e)}),a=new Al(e,s,{includeMetadataChanges:!0,W_:!0});return xl(t,a)}(await Id(e),e.asyncQueue,t,n,r)),r.promise}function Sd(e,t,n,r){const i=(n=n,t=zh(t),s="string"==typeof n?Po().encode(n):n,n=function(e,t){if(e instanceof Uint8Array)return od(e,t);if(e instanceof ArrayBuffer)return od(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(s),t=t,new cd(n,t));var s;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var i=await n.getMetadata();if(await function(e,t){const n=e,r=su(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Qr.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,i))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);r._updateProgress(Ml(i));const a=new Rl(i,t.localStore,n.serializer);let e=await n.ba();for(;e;){const t=await a.H_(e);t&&r._updateProgress(t),e=await n.ba()}var s=await a.complete();return await Xl(t,s.Z_,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Qr.saveBundleMetadata(e,t))}(t.localStore,i),r._completeWith(s.progress),Promise.resolve(s.Y_)}catch(t){return Or("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await bd(e),i,r)})}function xd(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Dd=new Map;function Cd(e,t,n){if(!n)throw new qr(Br.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Ad(e,t,n,r){if(!0===t&&!0===r)throw new qr(Br.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Nd(e){if(!oi.isDocumentKey(e))throw new qr(Br.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function kd(e){if(oi.isDocumentKey(e))throw new qr(Br.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Rd(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":Vr();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Md(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new qr(Br.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Rd(e);throw new qr(Br.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function Ld(e,t){if(t<=0)throw new qr(Br.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Fd{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new qr(Br.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new qr(Br.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Ad("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=xd(null!==(t=e.experimentalLongPollingOptions)&&void 0!==t?t:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(30<e.timeoutSeconds)throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class Od{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Fd({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new qr(Br.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new qr(Br.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Fd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new jr;switch(e.type){case"firstParty":return new Hr(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new qr(Br.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Dd.get(e);t&&(Lr("ComponentProvider","Removing Datastore"),Dd.delete(e),t.terminate())}(this),Promise.resolve()}}function Pd(n,e,t,r={}){var i;const s=(n=Md(n,Od))._getSettings(),a=`${e}:${t}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&Or("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=Nr.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e),[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(i)),""].join(".")}(r.mockUserToken,null===(i=n._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new qr(Br.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new Nr(s)}n._authCredentials=new zr(new Kr(e,t))}}class Vd{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Vd(this.firestore,e,this._query)}}class Ud{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Bd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Ud(this.firestore,e,this._key)}}class Bd extends Vd{constructor(e,t,n){super(e,t,Ca(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Ud(this.firestore,null,new oi(e))}withConverter(e){return new Bd(this.firestore,e,this._path)}}function qd(e,t,...n){if(e=m(e),Cd("collection","path",t),e instanceof Od){var r=ii.fromString(t,...n);return kd(r),new Bd(e,null,r)}if(!(e instanceof Ud||e instanceof Bd))throw new qr(Br.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(ii.fromString(t,...n));return kd(r),new Bd(e.firestore,null,r)}function Gd(e,t,...n){if(e=m(e),Cd("doc","path",t=1===arguments.length?Xr.V():t),e instanceof Od){var r=ii.fromString(t,...n);return Nd(r),new Ud(e,null,new oi(r))}if(!(e instanceof Ud||e instanceof Bd))throw new qr(Br.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(ii.fromString(t,...n));return Nd(r),new Ud(e.firestore,e instanceof Bd?e.converter:null,new oi(r))}function Kd(e,t){return e=m(e),t=m(t),(e instanceof Ud||e instanceof Bd)&&(t instanceof Ud||t instanceof Bd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function jd(e,t){return e=m(e),t=m(t),e instanceof Vd&&t instanceof Vd&&e.firestore===t.firestore&&Pa(e._query,t._query)&&e.converter===t.converter}class zd{constructor(){this.Wa=Promise.resolve(),this.Ga=[],this.za=!1,this.ja=[],this.Ha=null,this.Ja=!1,this.Ya=!1,this.Za=[],this.Ko=new $h(this,"async_queue_retry"),this.Xa=()=>{var e=jh();e&&Lr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Ko.No()};const e=jh();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Xa)}get isShuttingDown(){return this.za}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.eu(),this.tu(e)}enterRestrictedMode(e){if(!this.za){this.za=!0,this.Ya=e||!1;const t=jh();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Xa)}}enqueue(e){if(this.eu(),this.za)return new Promise(()=>{});const t=new Gr;return this.tu(()=>this.za&&this.Ya?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Ga.push(e),this.nu()))}async nu(){if(0!==this.Ga.length){try{await this.Ga[0](),this.Ga.shift(),this.Ko.reset()}catch(e){if(!Si(e))throw e;Lr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Ga.length&&this.Ko.xo(()=>this.nu())}}tu(e){var t=this.Wa.then(()=>(this.Ja=!0,e().catch(e=>{throw this.Ha=e,this.Ja=!1,Fr("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.Ja=!1,e))));return this.Wa=t}enqueueAfterDelay(e,t,n){this.eu(),-1<this.Za.indexOf(e)&&(t=0);var r=wl.createAndSchedule(this,e,t,n,e=>this.ru(e));return this.ja.push(r),r}eu(){this.Ha&&Vr()}verifyOperationInProgress(){}async iu(){for(var e;await(e=this.Wa),e!==this.Wa;);}su(e){for(const t of this.ja)if(t.timerId===e)return!0;return!1}ou(t){return this.iu().then(()=>{this.ja.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.ja)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.iu()})}_u(e){this.Za.push(e)}ru(e){var t=this.ja.indexOf(e);this.ja.splice(t,1)}}function $d(e){return function(e,t){if("object"==typeof e&&null!==e){var n=e;for(const e of t)if(e in n&&"function"==typeof n[e])return 1}}(e,["next","error","complete"])}class Qd{constructor(){this._progressObserver={},this._taskCompletionResolver=new Gr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var Hd,Wd,Yd,Xd,Jd;class Zd extends Od{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new zd,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||tf(this),this._firestoreClient.terminate()}}function ef(e){return e._firestoreClient||tf(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function tf(e){var t,n,r,i,s,a=e._freezeSettings(),o=(n=e._databaseId,r=(null===(o=e._app)||void 0===o?void 0:o.options.appId)||"",i=e._persistenceKey,s=a,new As(n,r,i,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,xd(s.experimentalLongPollingOptions),s.useFetchStreams));e._firestoreClient=new dd(e._authCredentials,e._appCheckCredentials,e._queue,o),null!==(o=a.localCache)&&void 0!==o&&o._offlineComponentProvider&&null!==(t=a.localCache)&&void 0!==t&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:a.localCache.kind,_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider})}function nf(e,t,n){const r=new Gr;return e.asyncQueue.enqueue(async()=>{try{await fd(e,n),await gd(e,t),r.resolve()}catch(e){const t=e;if(!md(t))throw t;Or("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function rf(e){return function(e){const t=new Gr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;ol(n.remoteStore)||Lr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=e;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}(n.localStore);if(-1===e)return void t.resolve();const r=n.ga.get(e)||[];r.push(t),n.ga.set(e,r)}catch(e){const n=_l(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await bd(e),t)),t.promise}(ef(e=Md(e,Zd)))}function sf(e){return(n=ef(e=Md(e,Zd))).asyncQueue.enqueue(async()=>{const e=await vd(n),t=await _d(n);return e.setNetworkEnabled(!0),function(e){const t=e;return t.y_.delete(0),Zh(t)}(t)});var n}function af(e){return(n=ef(e=Md(e,Zd))).asyncQueue.enqueue(async()=>{const e=await vd(n),t=await _d(n);return e.setNetworkEnabled(!1),async function(e){const t=e;t.y_.add(0),await el(t),t.b_.set("Offline")}(t)});var n}function of(t,e){return n=ef(t=Md(t,Zd)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Qr.getNamedQuery(e,t))}(await wd(n),r)).then(e=>e?new Vd(t,null,e.query):null);var n,r}function uf(e){if(e._initialized||e._terminated)throw new qr(Br.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class cf{constructor(e){this._byteString=e}static fromBase64String(e){try{return new cf(bs.fromBase64String(e))}catch(e){throw new qr(Br.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new cf(bs.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class hf{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new qr(Br.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ai(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class lf{constructor(e){this._methodName=e}}class df{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new qr(Br.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new qr(Br.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Jr(this._lat,e._lat)||Jr(this._long,e._long)}}const ff=/^__.*__$/;class gf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Eo(e,this.data,this.fieldMask,t,this.fieldTransforms):new Io(e,this.data,t,this.fieldTransforms)}}class mf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Eo(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function pf(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Vr()}}class yf{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.au(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get uu(){return this.settings.uu}cu(e){return new yf(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}lu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.cu({path:n,hu:!1});return r.Pu(e),r}Iu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.cu({path:n,hu:!1});return r.au(),r}Tu(e){return this.cu({path:void 0,hu:!0})}Eu(e){return Pf(e,this.settings.methodName,this.settings.du||!1,this.path,this.settings.Au)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}au(){if(this.path)for(let e=0;e<this.path.length;e++)this.Pu(this.path.get(e))}Pu(e){if(0===e.length)throw this.Eu("Document fields must not be empty");if(pf(this.uu)&&ff.test(e))throw this.Eu('Document fields cannot begin and end with "__"')}}class vf{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||zh(e)}Ru(e,t,n,r=!1){return new yf({uu:e,methodName:t,Au:n,path:ai.emptyPath(),hu:!1,du:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function wf(e){var t=e._freezeSettings(),n=zh(e._databaseId);return new vf(e._databaseId,!!t.ignoreUndefinedProperties,n)}function _f(e,t,n,r,i,s={}){const a=e.Ru(s.merge||s.mergeFields?2:0,t,n,i);Mf("Data must be an object, but it was:",a,r);var o=kf(r,a);let u,c;if(s.merge)u=new ws(a.fieldMask),c=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=Lf(t,r,n);if(!a.contains(i))throw new qr(Br.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);Vf(e,i)||e.push(i)}u=new ws(e),c=a.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=a.fieldTransforms;return new gf(new Ws(o),u,c)}class bf extends lf{_toFieldTransform(e){if(2!==e.uu)throw 1===e.uu?e.Eu(`${this._methodName}() can only appear at the top level of your update data`):e.Eu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof bf}}function If(e,t,n){return new yf({uu:3,Au:t.settings.Au,methodName:e._methodName,hu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class Ef extends lf{_toFieldTransform(e){return new fo(e.path,new io)}isEqual(e){return e instanceof Ef}}class Tf extends lf{constructor(e,t){super(e),this.Vu=t}_toFieldTransform(e){const t=If(this,e,!0),n=this.Vu.map(e=>Nf(e,t)),r=new so(n);return new fo(e.path,r)}isEqual(e){return this===e}}class Sf extends lf{constructor(e,t){super(e),this.Vu=t}_toFieldTransform(e){const t=If(this,e,!0),n=this.Vu.map(e=>Nf(e,t)),r=new oo(n);return new fo(e.path,r)}isEqual(e){return this===e}}class xf extends lf{constructor(e,t){super(e),this.mu=t}_toFieldTransform(e){var t=new co(e.serializer,to(e.serializer,this.mu));return new fo(e.path,t)}isEqual(e){return this===e}}function Df(e,i,s,t){const a=e.Ru(1,i,s);Mf("Data must be an object, but it was:",a,t);const o=[],u=Ws.empty();ls(t,(e,t)=>{var n=Of(i,e,s);t=m(t);var r=a.Iu(n);if(t instanceof bf)o.push(n);else{const e=Nf(t,r);null!=e&&(o.push(n),u.set(n,e))}});var n=new ws(o);return new mf(u,n,a.fieldTransforms)}function Cf(e,t,n,r,i,s){const a=e.Ru(1,t,n),o=[Lf(t,r,n)],u=[i];if(s.length%2!=0)throw new qr(Br.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<s.length;f+=2)o.push(Lf(t,s[f])),u.push(s[f+1]);const c=[],h=Ws.empty();for(let g=o.length-1;0<=g;--g)if(!Vf(c,o[g])){const t=o[g];var l=m(l=u[g]);const r=a.Iu(t);if(l instanceof bf)c.push(t);else{const e=Nf(l,r);null!=e&&(c.push(t),h.set(t,e))}}var d=new ws(c);return new mf(h,d,a.fieldTransforms)}function Af(e,t,n,r=!1){return Nf(n,e.Ru(r?4:3,t))}function Nf(e,t){if(Rf(e=m(e)))return Mf("Unsupported field value:",t,e),kf(e,t);if(e instanceof lf)return function(e,t){if(!pf(t.uu))throw t.Eu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Eu(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.hu&&4!==t.uu)throw t.Eu("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=Nf(i,t.Tu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=m(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return to(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=ti.fromDate(e);return{timestampValue:ru(t.serializer,n)}}if(e instanceof ti){n=new ti(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ru(t.serializer,n)}}if(e instanceof df)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof cf)return{bytesValue:iu(t.serializer,e._byteString)};if(e instanceof Ud){const r=t.databaseId,i=e.firestore._databaseId;if(!i.isEqual(r))throw t.Eu(`Document reference is for database ${i.projectId}/${i.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:au(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Eu(`Unsupported field value: ${Rd(e)}`)}(e,t)}function kf(e,r){const i={};return ds(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):ls(e,(e,t)=>{var n=Nf(t,r.lu(e));null!=n&&(i[e]=n)}),{mapValue:{fields:i}}}function Rf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ti||e instanceof df||e instanceof cf||e instanceof Ud||e instanceof lf)}function Mf(e,t,n){if(!Rf(n)||("object"!=typeof(i=n)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i))){var r=Rd(n);throw"an object"===r?t.Eu(e+" a custom object"):t.Eu(e+" "+r)}var i}function Lf(e,t,n){if((t=m(t))instanceof hf)return t._internalPath;if("string"==typeof t)return Of(e,t);throw Pf("Field path arguments must be of type string or ",e,!1,void 0,n)}const Ff=new RegExp("[~\\*/\\[\\]]");function Of(t,n,r){if(0<=n.search(Ff))throw Pf(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new hf(...n.split("."))._internalPath}catch(e){throw Pf(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function Pf(e,t,n,r,i){var s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(s||a)&&(u+=" (found",s&&(u+=` in field ${r}`),a&&(u+=` in document ${i}`),u+=")"),new qr(Br.INVALID_ARGUMENT,o+e+u)}function Vf(e,t){return e.some(e=>e.isEqual(t))}class Uf{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Ud(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new Bf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(qf("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Bf extends Uf{data(){return super.data()}}function qf(e,t){return"string"==typeof t?Of(e,t):(t instanceof hf?t:t._delegate)._internalPath}function Gf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new qr(Br.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Kf{}class jf extends Kf{}function zf(e,t,...n){let r=[];t instanceof Kf&&r.push(t),r=r.concat(n),function(e){var t=e.filter(e=>e instanceof Qf).length,n=e.filter(e=>e instanceof $f).length;if(1<t||0<t&&0<n)throw new qr(Br.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class $f extends jf{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new $f(e,t,n)}_apply(e){var t=this._parse(e);return tg(e._query,t),new Vd(e.firestore,e.converter,Fa(e._query,t))}_parse(e){var t=wf(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new qr(Br.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){eg(a,s);const t=[];for(const n of a)t.push(Zf(r,e,n));o={arrayValue:{values:t}}}else o=Zf(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||eg(a,s),o=Af(n,t,a,"in"===s||"not-in"===s);return na.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class Qf extends Kf{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Qf(e,t)}_parse(t){var e=this._queryConstraints.map(e=>e._parse(t)).filter(e=>0<e.getFilters().length);return 1===e.length?e[0]:ra.create(e,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(const e of t.getFlattenedFilters())tg(n,e),n=Fa(n,e)}(e._query,t),new Vd(e.firestore,e.converter,Fa(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Hf extends jf{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Hf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,i=new ea(t,n);return n=i,null!==Na(e=e)||null!==(r=ka(e))&&ng(0,r,n.field),i}(e._query,this._field,this._direction);return new Vd(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new xa(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class Wf extends jf{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new Wf(e,t,n)}_apply(e){return new Vd(e.firestore,e.converter,Oa(e._query,this._limit,this._limitType))}}class Yf extends jf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Yf(e,t,n)}_apply(e){var t,n=Jf(e,this.type,this._docOrFields,this._inclusive);return new Vd(e.firestore,e.converter,(t=e._query,e=n,new xa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class Xf extends jf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Xf(e,t,n)}_apply(e){var t,n=Jf(e,this.type,this._docOrFields,this._inclusive);return new Vd(e.firestore,e.converter,(t=e._query,e=n,new xa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function Jf(e,t,n,r){if(n[0]=m(n[0]),n[0]instanceof Uf)return function(e,t,n,r,i){if(!r)throw new qr(Br.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const s=[];for(const n of Ma(e))if(n.field.isKeyField())s.push(Us(t,r.key));else{const e=r.data.field(n.field);if(xs(e))throw new qr(Br.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new qr(Br.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new Xs(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=wf(e.firestore);return function(e,t,n,r,i,s){const a=e.explicitOrderBy;if(i.length>a.length)throw new qr(Br.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let u=0;u<i.length;u++){const c=i[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new qr(Br.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Ra(e)&&-1!==c.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(ii.fromString(c));if(!oi.isDocumentKey(n))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new oi(n);o.push(Us(t,i))}else{const e=Af(n,r,c);o.push(e)}}return new Xs(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}function Zf(e,t,n){if("string"==typeof(n=m(n))){if(""===n)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ra(t)&&-1!==n.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(ii.fromString(n));if(!oi.isDocumentKey(r))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Us(e,new oi(r))}if(n instanceof Ud)return Us(e,n._key);throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Rd(n)}.`)}function eg(e,t){if(!Array.isArray(e)||0===e.length)throw new qr(Br.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function tg(e,t){if(t.isInequality()){const r=ka(e),i=t.field;if(null!==r&&!r.isEqual(i))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${i.toString()}'`);var n=Na(e);null!==n&&ng(0,i,n)}const r=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==r)throw r===t.op?new qr(Br.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new qr(Br.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}function ng(e,t,n){if(!n.isEqual(t))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class rg{convertValue(e,t="none"){switch(Ms(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ts(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ss(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Vr()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,n="none"){const r={};return ls(e,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new df(Ts(e.latitude),Ts(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=Ds(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Cs(e));default:return null}}convertTimestamp(e){var t=Es(e);return new ti(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=ii.fromString(e);Ur(Su(n));const r=new Ns(n.get(1),n.get(3)),i=new oi(n.popFirst(5));return r.isEqual(t)||Fr(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function ig(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class sg extends rg{constructor(e){super(),this.firestore=e}convertBytes(e){return new cf(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ud(this.firestore,null,t)}}class ag{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class og extends Uf{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new ug(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(qf("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class ug extends og{data(e={}){return super.data(e)}}class cg{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new ag(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new ug(this._firestore,this._userDataWriter,e.key,e,new ag(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new qr(Br.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(s,t){if(s._snapshot.oldDocs.isEmpty()){let n=0;return s._snapshot.docChanges.map(e=>{var t=new ug(s._firestore,s._userDataWriter,e.doc.key,e.doc,new ag(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let i=s._snapshot.oldDocs;return s._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new ug(s._firestore,s._userDataWriter,e.doc.key,e.doc,new ag(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=i.indexOf(e.doc.key),i=i.delete(e.doc.key)),1!==e.type&&(i=i.add(e.doc),r=i.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Vr()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function hg(e,t){return e instanceof og&&t instanceof og?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof cg&&t instanceof cg&&e._firestore===t._firestore&&jd(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class lg extends rg{constructor(e){super(),this.firestore=e}convertBytes(e){return new cf(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ud(this.firestore,null,t)}}function dg(t){t=Md(t,Ud);const n=Md(t.firestore,Zd),e=ef(n),r=new lg(n);return function(e,t){const n=new Gr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const i=await function(e,t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(e,t);i.isFoundDocument()?n.resolve(i):i.isNoDocument()?n.resolve(null):n.reject(new qr(Br.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=_l(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await wd(e),t,n)),n.promise}(e,t._key).then(e=>new og(n,r,t._key,e,new ag(null!==e&&e.hasLocalMutations,!0),t.converter))}function fg(t){t=Md(t,Vd);const n=Md(t.firestore,Zd),e=ef(n),r=new lg(n);return function(e,t){const n=new Gr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const i=await bh(e,t,!0),s=new Ol(t,i.ss),a=s.sa(i.documents),o=s.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=_l(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await wd(e),t,n)),n.promise}(e,t._query).then(e=>new cg(n,r,t,e))}function gg(e,t,n){e=Md(e,Ud);var r=Md(e.firestore,Zd),i=ig(e.converter,t,n);return vg(r,[_f(wf(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,mo.none())])}function mg(e,t,n,...r){e=Md(e,Ud);var i=Md(e.firestore,Zd),s=wf(i);let a;return a="string"==typeof(t=m(t))||t instanceof hf?Cf(s,"updateDoc",e._key,t,n,r):Df(s,"updateDoc",e._key,t),vg(i,[a.toMutation(e._key,mo.exists(!0))])}function pg(t,...n){var e;t=m(t);let r={includeMetadataChanges:!1},i=0;"object"!=typeof n[i]||$d(n[i])||(r=n[i],i++);var s={includeMetadataChanges:r.includeMetadataChanges};if($d(n[i])){const t=n[i];n[i]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[i+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[i+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,u;if(t instanceof Ud)o=Md(t.firestore,Zd),u=Ca(t._key.path),a={next:e=>{n[i]&&n[i](wg(o,t,e))},error:n[i+1],complete:n[i+2]};else{const c=Md(t,Vd);o=Md(c.firestore,Zd),u=c._query;const h=new lg(o);a={next:e=>{n[i]&&n[i](new cg(o,h,c,e))},error:n[i+1],complete:n[i+2]},Gf(t._query)}return function(e,t,n,r){const i=new ud(r),s=new Al(t,i,n);return e.asyncQueue.enqueueAndForget(async()=>xl(await Id(e),s)),()=>{i.Ca(),e.asyncQueue.enqueueAndForget(async()=>Dl(await Id(e),s))}}(ef(o),u,s,a)}function yg(e,t){return function(e,t){const n=new ud(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.O_.add(t),t.next()}(await Id(e),n)),()=>{n.Ca(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.O_.delete(t)}(await Id(e),n))}}(ef(e=Md(e,Zd)),$d(t)?t:{next:t})}function vg(e,t){return function(e,t){const n=new Gr;return e.asyncQueue.enqueueAndForget(async()=>ql(await bd(e),t,n)),n.promise}(ef(e),t)}function wg(e,t,n){var r=n.docs.get(t._key),i=new lg(e);return new og(e,i,t._key,r,new ag(n.hasPendingWrites,n.fromCache),t.converter)}const _g={maxAttempts:5};class bg{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=wf(e)}set(e,t,n){this._verifyNotCommitted();const r=Ig(e,this._firestore),i=ig(r.converter,t,n),s=_f(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,mo.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var i=Ig(e,this._firestore);let s;return s="string"==typeof(t=m(t))||t instanceof hf?Cf(this._dataReader,"WriteBatch.update",i._key,t,n,r):Df(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(s.toMutation(i._key,mo.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=Ig(e,this._firestore);return this._mutations=this._mutations.concat(new Do(t._key,mo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new qr(Br.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Ig(e,t){if((e=m(e)).firestore!==t)throw new qr(Br.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Eg extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=wf(e)}get(e){const n=Ig(e,this._firestore),r=new sg(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return Vr();const t=e[0];if(t.isFoundDocument())return new Uf(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new Uf(this._firestore,r,n._key,null,n.converter);throw Vr()})}set(e,t,n){var r=Ig(e,this._firestore),i=ig(r.converter,t,n),i=_f(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){var i=Ig(e,this._firestore),s="string"==typeof(t=m(t))||t instanceof hf?Cf(this._dataReader,"Transaction.update",i._key,t,n,r):Df(this._dataReader,"Transaction.update",i._key,t);return this._transaction.update(i._key,s),this}delete(e){var t=Ig(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Ig(e,this._firestore),n=new lg(this._firestore);return super.get(e).then(e=>new og(this._firestore,n,t._key,e._document,new ag(!1,!1),t.converter))}}function Tg(t,n,e){t=Md(t,Zd);var r=Object.assign(Object.assign({},_g),e);return function(e){if(e.maxAttempts<1)throw new qr(Br.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,n,r){const i=new Gr;return t.asyncQueue.enqueueAndForget(async()=>{var e=await yd(t).then(e=>e.datastore);new ld(t.asyncQueue,e,r,n,i).run()}),i.promise}(ef(t),e=>n(new Eg(t,e)),r)}Wd=!0,Yd=Xg.SDK_VERSION,kr=Yd,Xg._registerComponent(new p("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),i=new Zd(new $r(e.getProvider("auth-internal")),new Yr(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new qr(Br.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ns(e.options.projectId,t)}(r,t),r);return n=Object.assign({useFetchStreams:Wd},n),i._setSettings(n),i},"PUBLIC").setMultipleInstances(!0)),Xg.registerVersion(Ar,"4.1.0",Hd),Xg.registerVersion(Ar,"4.1.0","esm2017");function Sg(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new qr("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function xg(){if("undefined"==typeof Uint8Array)throw new qr("unimplemented","Uint8Arrays are not available in this environment.")}function Dg(){if("undefined"==typeof atob)throw new qr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Cg{constructor(e){this._delegate=e}static fromBase64String(e){return Dg(),new Cg(cf.fromBase64String(e))}static fromUint8Array(e){return xg(),new Cg(cf.fromUint8Array(e))}toBase64(){return Dg(),this._delegate.toBase64()}toUint8Array(){return xg(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Ag(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class Ng{enableIndexedDbPersistence(e,t){return function(e,t){uf(e=Md(e,Zd));var n=ef(e);if(n._uninitializedComponentsProvider)throw new qr(Br.FAILED_PRECONDITION,"SDK cache is already specified.");Or("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var r=e._freezeSettings(),i=new ad;return nf(n,i,new id(i,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){uf(e=Md(e,Zd));var t=ef(e);if(t._uninitializedComponentsProvider)throw new qr(Br.FAILED_PRECONDITION,"SDK cache is already specified.");Or("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var n=e._freezeSettings(),r=new ad;return nf(t,r,new sd(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new qr(Br.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Gr;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!Ii.v())return Promise.resolve();var t=e+"main";await Ii.delete(t)}(hh(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class kg{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Ns||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Or("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){Pd(this._delegate,e,t,n)}enableNetwork(){return sf(this._delegate)}disableNetwork(){return af(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Ad("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return rf(this._delegate)}onSnapshotsInSync(e){return yg(this._delegate,e)}get app(){if(!this._appCompat)throw new qr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new zg(this,qd(this._delegate,e))}catch(e){throw Pg(e,"collection()","Firestore.collection()")}}doc(e){try{return new Og(this,Gd(this._delegate,e))}catch(e){throw Pg(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Gg(this,function(e,t){if(e=Md(e,Od),Cd("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Vd(e,null,(t=t,new xa(ii.emptyPath(),t)))}(this._delegate,e))}catch(e){throw Pg(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Tg(this._delegate,e=>t(new Mg(this,e)))}batch(){return ef(this._delegate),new Lg(new bg(this._delegate,e=>vg(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=ef(t=Md(t,Zd)),r=new Qd,Sd(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return of(this._delegate,e).then(e=>e?new Gg(this,e):null)}}class Rg extends rg{constructor(e){super(),this.firestore=e}convertBytes(e){return new Cg(new cf(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return Og.forKey(t,this.firestore,null)}}class Mg{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Rg(e)}get(e){const t=$g(e);return this._delegate.get(t).then(e=>new Bg(this._firestore,new og(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=$g(e);return n?(Sg("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=$g(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=$g(e);return this._delegate.delete(t),this}}class Lg{constructor(e){this._delegate=e}set(e,t,n){var r=$g(e);return n?(Sg("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=$g(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=$g(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Fg{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new ug(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new qg(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Fg.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let i=r.get(t);return i||(i=new Fg(e,new Rg(e),t),r.set(t,i)),i}}Fg.INSTANCES=new WeakMap;class Og{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Rg(e)}static forPath(e,t,n){if(e.length%2!=0)throw new qr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new Og(t,new Ud(t._delegate,n,new oi(e)))}static forKey(e,t,n){return new Og(t,new Ud(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new zg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new zg(this.firestore,qd(this._delegate,e))}catch(e){throw Pg(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=m(e))instanceof Ud&&Kd(this._delegate,e)}set(e,t){t=Sg("DocumentReference.set",t);try{return t?gg(this._delegate,e,t):gg(this._delegate,e)}catch(e){throw Pg(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?mg(this._delegate,e):mg(this._delegate,e,t,...n)}catch(e){throw Pg(e,"updateDoc()","DocumentReference.update()")}}delete(){return vg(Md((e=this._delegate).firestore,Zd),[new Do(e._key,mo.none())]);var e}onSnapshot(...e){var t=Vg(e),n=Ug(e,e=>new Bg(this.firestore,new og(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return pg(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?dg:"server"===(null==e?void 0:e.source)?function(t){t=Md(t,Ud);const n=Md(t.firestore,Zd);return Ed(ef(n),t._key,{source:"server"}).then(e=>wg(n,t,e))}:function(t){t=Md(t,Ud);const n=Md(t.firestore,Zd);return Ed(ef(n),t._key).then(e=>wg(n,t,e))})(this._delegate),t.then(e=>new Bg(this.firestore,new og(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new Og(this.firestore,e?this._delegate.withConverter(Fg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Pg(e,t,n){return e.message=e.message.replace(t,n),e}function Vg(e){for(const t of e)if("object"==typeof t&&!Ag(t))return t;return{}}function Ug(e,t){var n;let r;return r=Ag(e[0])?e[0]:Ag(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class Bg{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Og(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return hg(this._delegate,e._delegate)}}class qg extends Bg{data(e){var t=this._delegate.data(e);return void 0!==t||Vr(),t}}class Gg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Rg(e)}where(e,t,n){try{return new Gg(this.firestore,zf(this._delegate,(r=n,i=t,s=qf("where",e),$f._create(s,i,r))))}catch(e){throw Pg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,s}orderBy(e,t){try{return new Gg(this.firestore,zf(this._delegate,([n,r="asc"]=[e,t],i=r,s=qf("orderBy",n),Hf._create(s,i))))}catch(e){throw Pg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,i,s}limit(e){try{return new Gg(this.firestore,zf(this._delegate,(Ld("limit",t=e),Wf._create("limit",t,"F"))))}catch(e){throw Pg(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new Gg(this.firestore,zf(this._delegate,(Ld("limitToLast",t=e),Wf._create("limitToLast",t,"L"))))}catch(e){throw Pg(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new Gg(this.firestore,zf(this._delegate,function(...e){return Yf._create("startAt",e,!0)}(...e)))}catch(e){throw Pg(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Gg(this.firestore,zf(this._delegate,function(...e){return Yf._create("startAfter",e,!1)}(...e)))}catch(e){throw Pg(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Gg(this.firestore,zf(this._delegate,function(...e){return Xf._create("endBefore",e,!1)}(...e)))}catch(e){throw Pg(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Gg(this.firestore,zf(this._delegate,function(...e){return Xf._create("endAt",e,!0)}(...e)))}catch(e){throw Pg(e,"endAt()","Query.endAt()")}}isEqual(e){return jd(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?fg:"server"===(null==e?void 0:e.source)?function(t){t=Md(t,Vd);const n=Md(t.firestore,Zd),e=ef(n),r=new lg(n);return Td(e,t._query,{source:"server"}).then(e=>new cg(n,r,t,e))}:function(t){t=Md(t,Vd);const n=Md(t.firestore,Zd),e=ef(n),r=new lg(n);return Gf(t._query),Td(e,t._query).then(e=>new cg(n,r,t,e))})(this._delegate),t.then(e=>new jg(this.firestore,new cg(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=Vg(e),n=Ug(e,e=>new jg(this.firestore,new cg(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return pg(this._delegate,t,n)}withConverter(e){return new Gg(this.firestore,e?this._delegate.withConverter(Fg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class Kg{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new qg(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class jg{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Gg(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new qg(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new Kg(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new qg(this._firestore,e))})}isEqual(e){return hg(this._delegate,e._delegate)}}class zg extends Gg{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new Og(this.firestore,e):null}doc(e){try{return void 0===e?new Og(this.firestore,Gd(this._delegate)):new Og(this.firestore,Gd(this._delegate,e))}catch(e){throw Pg(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=Md(e.firestore,Zd),r=Gd(e),i=ig(e.converter,t);return vg(n,[_f(wf(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,mo.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new Og(this.firestore,e))}isEqual(e){return Kd(this._delegate,e._delegate)}withConverter(e){return new zg(this.firestore,e?this._delegate.withConverter(Fg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function $g(e){return Md(e,Ud)}const Qg={Firestore:kg,GeoPoint:df,Timestamp:ti,Blob:Cg,Transaction:Mg,WriteBatch:Lg,DocumentReference:Og,DocumentSnapshot:Bg,Query:Gg,QueryDocumentSnapshot:qg,QuerySnapshot:jg,CollectionReference:zg,FieldPath:class Hg{constructor(...e){this._delegate=new hf(...e)}static documentId(){return new Hg(ai.keyField().canonicalString())}isEqual(e){return(e=m(e))instanceof hf&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class Wg{constructor(e){this._delegate=e}static serverTimestamp(){const e=new Ef("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new Wg(e)}static delete(){const e=new bf("deleteField");return e._methodName="FieldValue.delete",new Wg(e)}static arrayUnion(...e){const t=function(...e){return new Tf("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new Wg(t)}static arrayRemove(...e){const t=function(...e){return new Sf("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new Wg(t)}static increment(e){const t=new xf("increment",e);return t._methodName="FieldValue.increment",new Wg(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,Rr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};Xd=t.default,Jd=(e,t)=>new kg(e,t,new Ng),Xd.INTERNAL.registerComponent(new p("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return Jd(t,n)},"PUBLIC").setServiceProps(Object.assign({},Qg))),Xd.registerVersion("@firebase/firestore-compat","0.3.14")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
>>>>>>> origin/main-placeholder
//# sourceMappingURL=firebase-firestore-compat.js.map
